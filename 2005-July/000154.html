<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Freenx-cvs] r63 - freenx-server
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/freenx-cvs/2005-July/index.html" >
   <LINK REL="made" HREF="mailto:freenx-cvs%40lists.berlios.de?Subject=Re%3A%20%5BFreenx-cvs%5D%20r63%20-%20freenx-server&In-Reply-To=%3C200507031438.j63EcQ5A005615%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000153.html">
   <LINK REL="Next"  HREF="000155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Freenx-cvs] r63 - freenx-server</H1>
    <B>Fabian Franz at BerliOS</B> 
    <A HREF="mailto:freenx-cvs%40lists.berlios.de?Subject=Re%3A%20%5BFreenx-cvs%5D%20r63%20-%20freenx-server&In-Reply-To=%3C200507031438.j63EcQ5A005615%40sheep.berlios.de%3E"
       TITLE="[Freenx-cvs] r63 - freenx-server">fabianx at berlios.de
       </A><BR>
    <I>Sun Jul  3 16:38:26 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000153.html">[Freenx-cvs] r62 - / freenx-server freenx-server/CVS
</A></li>
        <LI>Next message: <A HREF="000155.html">[Freenx-cvs] r64 - freenx-server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#154">[ date ]</a>
              <a href="thread.html#154">[ thread ]</a>
              <a href="subject.html#154">[ subject ]</a>
              <a href="author.html#154">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fabianx
Date: 2005-07-03 16:38:23 +0200 (Sun, 03 Jul 2005)
New Revision: 63

Removed:
   freenx-server/RoadMap
   freenx-server/nxserver.old
Log:
Deleted two superflous files.


Deleted: freenx-server/RoadMap
===================================================================
--- freenx-server/RoadMap	2005-07-03 14:35:34 UTC (rev 62)
+++ freenx-server/RoadMap	2005-07-03 14:38:23 UTC (rev 63)
@@ -1,21 +0,0 @@
-0.4.0
-	- Samba File and Printer sharing
-	- Sound via SOUNDSERVER
-
-0.4.1
-	- Bugfixes
-	
-0.4.2
-	- Solaris Support
-	- Stability Support
-
-[Between]
-	- Umfrage zu NX (Ask Slashdot?)
-	- Dokumentation
-	
-0.5.0
-	- &quot;Rewrite&quot; of Session-Management
-	- Transparent Socks-Implementation
-		- Seamless printing
-		- Seamless FileSharing (fish)
-	- Transparent tunnel of devices

Deleted: freenx-server/nxserver.old
===================================================================
--- freenx-server/nxserver.old	2005-07-03 14:35:34 UTC (rev 62)
+++ freenx-server/nxserver.old	2005-07-03 14:38:23 UTC (rev 63)
@@ -1,1381 +0,0 @@
-#!/bin/bash
-
-# Free implementation of nxserver components
-#
-# To use nxserver add the user &quot;nx&quot; 
-# and use nxserver as default shell.
-#
-# Also make sure that hostkey based authentification works.
-# 
-# Copyright (c) 2004 by Fabian Franz &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/freenx-cvs">FreeNX at fabian-franz.de</A>&gt;.
-#
-# License: GNU GPL, version 2
-#
-# CVS: $Id: nxserver,v 1.42 2005/03/14 00:51:21 fabianx Exp $
-#
-
-# Read the config file
-. $(PATH=$(cd $(dirname $0) &amp;&amp; pwd):$PATH which nxloadconfig) --
-
-if [ &quot;$USER&quot; = &quot;nxuser&quot; ]
-then
-	export NX_SESS_DIR=&quot;$HOME/.nx/db/&quot;
-	export NX_LOGFILE=&quot;$HOME/.nx/temp/nxserver.log&quot;
-	mkdir -p $NX_SESS_DIR/{closed,running,failed}
-	ENABLE_FAKE_AUTHENTICATION=&quot;1&quot;
-fi
-
-# following two functions are Copyright by Klaus Knopper
-
-stringinstring(){
-case &quot;$2&quot; in *$1*) return 0;; esac
-return 1
-}
-
-# Reread boot command line; echo last parameter's argument or return false.
-getparam(){
-stringinstring &quot;&amp;$1=&quot; &quot;$CMDLINE&quot; || return 1
-echo &quot;$CMDLINE&quot; | awk &quot;/^$1=/&quot;' { VAL=$2 } END { print VAL }' FS=&quot;=&quot; RS=&quot;(&amp;|\n)&quot;
-return 0
-}
-
-
-############### PACKAGE passdb.bm #######################
-#
-# Library of passdb functions (outsource)
-#
-
-# Policy: Variable and function names _must_ start with passdb_ / PASSDB_
-
-# Needed global vars: $NX_ETC_DIR, $PATH_BIN
-
-# Needed nonstd functions: md5sum
-
-
-passdb_get_crypt_pass()
-{
-	echo &quot;$@&quot; | md5sum | cut -d&quot; &quot; -f1
-}
-
-passdb_get_pass()
-{
-	PASSDB_CHUSER=&quot;$1&quot;
-	PASSDB_PASS=$(egrep &quot;^$PASSDB_CHUSER:&quot; $NX_ETC_DIR/passwords 2&gt;/dev/null | cut -d&quot;:&quot; -f2)
-	if [ &quot;$ENABLE_PASSDB_AUTHENTICATION&quot; = &quot;1&quot; ]
-	then
-		egrep -q &quot;^$PASSDB_CHUSER:&quot; $NX_ETC_DIR/passwords 2&gt;/dev/null &amp;&amp; echo $PASSDB_PASS
-		egrep -q &quot;^$PASSDB_CHUSER:&quot; $NX_ETC_DIR/passwords 2&gt;/dev/null || echo &quot;NOT_VALID&quot;
-	else
-		echo &quot;NOT_VALID&quot;
-	fi
-}
-
-passdb_chpass()
-{
-	PASSDB_CHUSER=&quot;$1&quot;
-	PASSDB_ENC_PASS=&quot;$2&quot;
-	cp -f $NX_ETC_DIR/passwords $NX_ETC_DIR/passwords.orig
-	perl -pi -e &quot;s/$PASSDB_CHUSER:.*/$PASSDB_CHUSER:$PASSDB_ENC_PASS/g&quot; $NX_ETC_DIR/passwords
-}
-
-passdb_user_exists()
-{
-	PASSDB_CHUSER=&quot;$1&quot;
-	egrep -q &quot;^$PASSDB_CHUSER:&quot; $NX_ETC_DIR/passwords 2&gt;/dev/null
-}
-
-
-passdb_remove_user()
-{
-	PASSDB_CHUSER=&quot;$1&quot;
-	cp -f $NX_ETC_DIR/passwords $NX_ETC_DIR/passwords.orig
-	perl -pi -e &quot;s/$PASSDB_CHUSER:.*\n//g&quot; $NX_ETC_DIR/passwords
-}
-
-passdb_add_user()
-{
-	PASSDB_CHUSER=&quot;$1&quot;
-	cp -f $NX_ETC_DIR/passwords $NX_ETC_DIR/passwords.orig
-	echo &quot;$PASSDB_CHUSER:*&quot; &gt;&gt; $NX_ETC_DIR/passwords
-	# deactivated to avoid problems with comm-server
-	su - $PASSDB_CHUSER -c &quot;$PATH_BIN/nxnode --setkey&quot;
-}
-
-passdb_list_user()
-{
-	cat $NX_ETC_DIR/passwords | cut -d&quot;:&quot; -f1
-}
-
-#
-# End of passdb Library
-#
-
-############### PACKAGE session.bm #######################
-#
-# Library of session management functions
-#
-
-# Needed global vars: $NX_SESS_DIR
-
-session_list()
-{
-	cat $NX_SESS_DIR/running/sessionId&quot;{$1}&quot;
-}
-
-# Find all running session-filenames 
-
-session_find_all()
-{
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		echo $i
-	done
-}
-
-# Find all running sessions of a id
-session_find_id()
-{
-	[ -f $NX_SESS_DIR/running/sessionId&quot;{$1}&quot; ] &amp;&amp; echo $NX_SESS_DIR/running/sessionId&quot;{$1}&quot;
-}
-
-# finds out if a session belongs to a user
-
-session_find_id_user()
-{
-	[ -f $NX_SESS_DIR/running/sessionId&quot;{$1}&quot; ] &amp;&amp; egrep -q &quot;^userName=$2$&quot; $NX_SESS_DIR/running/sessionId&quot;{$1}&quot; &amp;&amp; return 0
-	return 1
-}
-
-# Find all running sessions of a user
-session_find_user()
-{
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		egrep -q &quot;^userName=$1$&quot; $i &amp;&amp; echo $i
-	done
-}
-
-# Find all running sessions of a display
-session_find_display()
-{	
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		egrep -q &quot;^display=$1$&quot; $i &amp;&amp; echo $i
-	done
-}
-
-# session_get_cmdline &lt;session filename&gt;
-
-session_get_cmdline()
-{
-	echo &quot;a=b&quot; | cat - $1 | tr '\n' '&amp;'
-}
-
-# session_get &lt;uniqueid&gt;
-
-session_get()
-{
-	session_get_cmdline $NX_SESS_DIR/running/sessionId&quot;{$1}&quot;
-}
-
-
-# Get the first session, which can be resumed
-
-session_get_user_suspended()
-{
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		if egrep -q &quot;^userName=$1$&quot; $i &amp;&amp; egrep -q &quot;^status=$2$&quot; $i
-		then
-			CMDLINE=$(session_get_cmdline $i)
-			echo &quot;$(getparam sessionId)&quot;
-			break
-		fi
-	done
-}
-
-# Count all sessions of a user
-# and save it in SESSION_COUNT and SESSION_COUNT_USER
-
-session_count_user()
-{
-	SESSION_COUNT=0
-	SESSION_COUNT_USER=0
-
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		let SESSION_COUNT=$SESSION_COUNT+1
-		egrep -q &quot;^userName=$1$&quot; $i &amp;&amp; let SESSION_COUNT_USER=$SESSION_COUNT_USER+1
-	done
-}
-
-# List all sessions of a user
-
-session_list_user_suspended()
-{
-	SESSION_COUNT=0
-	SESSION_COUNT_USER=0
-
-	TMPFILE=$(mktemp /tmp/nxserver_tmp.XXXXXXXXX)
-	echo &quot;NX&gt; 127 Sessions list of user '$1' for reconnect:&quot; &gt; $TMPFILE
-	echo &gt;&gt; $TMPFILE
-	if [ -z &quot;$4&quot; ]
-	then
-		
-		echo &quot;Display Type             Session ID                       Options  Depth Screensize     Available Session Name&quot; &gt;&gt; $TMPFILE
-		echo &quot;------- ---------------- -------------------------------- -------- ----- -------------- --------- ----------------------&quot; &gt;&gt; $TMPFILE
-	else
-		echo &quot;Display Type             Session ID                       Options  Depth Screen         Status      Session Name&quot; &gt;&gt; $TMPFILE
-		echo &quot; ------- ---------------- -------------------------------- -------- ----- -------------- ----------- ------------------------------&quot; &gt;&gt; $TMPFILE
-	fi
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		let SESSION_COUNT=$SESSION_COUNT+1
-		if egrep -q &quot;^userName=$1$&quot; $i &amp;&amp; egrep -q &quot;^status=$2$&quot; $i #&amp;&amp; grep -q &quot;screeninfo=$3&quot; $i
-		then
-			CMDLINE=$(session_get_cmdline $i)
-			depth=$(getparam screeninfo | cut -d &quot;x&quot; -f3 | cut -d &quot;+&quot; -f1 )
-			geom=$(getparam screeninfo | cut -d &quot;x&quot; -f1,2) 
-			render=$(getparam screeninfo | cut -d &quot;+&quot; -f2 )
-			available=&quot;N/A&quot;
-			udepth=$(echo $3 | cut -d &quot;x&quot; -f3 | cut -d &quot;+&quot; -f1 )
-			urender=$(echo $3 | cut -d &quot;+&quot; -f2 )
-			[ &quot;$(getparam geometry)&quot; = &quot;fullscreen&quot; ] &amp;&amp; options=&quot;F&quot;
-			[ &quot;$(getparam geometry)&quot; = &quot;fullscreen&quot; ] || options=&quot;-&quot;
-			[ &quot;$urender&quot; = &quot;render&quot; ] &amp;&amp; options=&quot;${options}R---PSA&quot;
-			[ &quot;$urender&quot; = &quot;render&quot; ] || options=&quot;${options}----PSA&quot;
-			[ &quot;$udepth&quot; = &quot;$depth&quot; -a &quot;$urender&quot; = &quot;$render&quot; ] &amp;&amp; available=$(getparam status)
-			# FIXME: HACK !!! to keep compatibility with old snapshot version (Knoppix 3.6 based for example)
-			if [ -z &quot;$4&quot; -a &quot;$available&quot; != &quot;N/A&quot; ] 
-			then
-				available=&quot;Yes&quot;
-			fi
-			echo -e &quot;$(getparam display)\t$(getparam type)\t$(getparam sessionId)\t$options\t$depth\t$geom\t$available\t$(getparam sessionName)&quot; &gt;&gt; $TMPFILE
-		fi
-		egrep -q &quot;^userName=$1$&quot; $i &amp;&amp; let SESSION_COUNT_USER=$SESSION_COUNT_USER+1
-	done
-	echo &quot;&quot; &gt;&gt; $TMPFILE
-	echo &quot;&quot; &gt;&gt; $TMPFILE
-	cat $TMPFILE
-	rm -f $TMPFILE
-	if [ &quot;$SESSION_COUNT&quot; -ge &quot;$SESSION_LIMIT&quot; -o &quot;$SESSION_COUNT_USER&quot; -ge &quot;$SESSION_USER_LIMIT&quot; ]
-	then
-		echo &quot;NX&gt; 147 Server capacity: reached for user: $1&quot;
-	else
-		echo &quot;NX&gt; 148 Server capacity: not reached for user: $1&quot;
-	fi
-}
-
-session_list_user()
-{
-	echo &quot;NX&gt; 127 Sessions list of user '$1'&quot;
-	echo
-	echo &quot;Display Username        Remote IP       Session ID&quot;
-	echo &quot;------- --------------- --------------- --------------------------------&quot;
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		if egrep -q &quot;^userName=$1$&quot; $i
-		then
-			CMDLINE=$(session_get_cmdline $i)
-			echo -e &quot;$(getparam display)\t$(getparam userName)\t$(getparam foreignAddress)\t$(getparam sessionId)&quot;
-		fi
-	done
-}
-
-session_history()
-{
-	userName=$1
-	sessionId=$2
-	echo &quot;NX&gt; 127 Session list:&quot;
-	echo
-	echo &quot;Display Username        Remote IP       Session ID                       Date                Status&quot;
-	echo &quot;------- --------------- --------------- -------------------------------- ------------------- -----------&quot;
-	for j in $(ls --time-style +%s -la &quot;$NX_SESS_DIR&quot;/{closed,failed,running} | awk '/sessionId/ { print $6 &quot; &quot; $7 }' | sort -n | cut -d&quot; &quot; -f2)
-	do
-		if [ -n &quot;$sessionId&quot; ]
-		then
-			[ &quot;$j&quot; = &quot;sessionId{$sessionId}&quot; ] || continue
-		fi
-		i=&quot;$NX_SESS_DIR&quot;/*/&quot;$j&quot;
-		[ -f $i ] || break
-		CMDLINE=$(session_get_cmdline $i)
-		if [ -n &quot;$userName&quot; ]
-		then
-			[ &quot;$userName&quot; = &quot;$(getparam userName)&quot; ] || continue
-		fi
-		echo -e &quot;$(getparam display)\t$(getparam userName)\t$(getparam foreignAddress)\t$(getparam sessionId)\t$(ls --time-style=&quot;+%F %X&quot; -l $i | awk '/sessionId/ { print $6 &quot; &quot; $7 }')\t$(getparam status)&quot;
-	done
-}
-
-# remove all sessions older than $SESSION_HISTORY seconds in failed/closed.
-
-session_cleanup()
-{
-	[ &quot;$SESSION_HISTORY&quot; -gt &quot;-1&quot; ] || return
-	let SESSION_HISTORY_MINUTES=$SESSION_HISTORY/60
-	find $NX_SESS_DIR/closed/ $NX_SESS_DIR/failed/ -type f -mmin +&quot;$SESSION_HISTORY_MINUTES&quot; -exec rm -f '{}' ';'
-}
-
-session_list_all()
-{
-	echo &quot;NX&gt; 127 Sessions list:&quot;
-	echo
-	echo &quot;Display Username        Remote IP       Session ID&quot;
-	echo &quot;------- --------------- --------------- --------------------------------&quot;
-	for i in $NX_SESS_DIR/running/*
-	do
-		[ -f $i ] || break
-		CMDLINE=$(session_get_cmdline $i)
-		echo -e &quot;$(getparam display)\t$(getparam userName)\t$(getparam foreignAddress)\t$(getparam sessionId)&quot;
-	done
-}
-
-
-# session_add &lt;session_id&gt; &lt;options&gt;
-
-session_add()
-{
-	id=$1
-	shift
-	echo &quot;$@&quot; | tr '&amp;' '\n' &gt; $NX_SESS_DIR/running/sessionId'{'$id'}'
-}
-
-# session_change &lt;session_id&gt; &lt;parameter&gt; &lt;new_value&gt;
-
-session_change()
-{
-	[ -f $NX_SESS_DIR/running/sessionId'{'$1'}' ] &amp;&amp; perl -pi -e &quot;s/$2=.*/$2=$3/&quot; $NX_SESS_DIR/running/sessionId'{'$1'}'
-}
-
-# session_id &lt;new status&gt;
-
-session_status()
-{
-	session_change &quot;$1&quot; &quot;status&quot; &quot;$2&quot;
-}
-
-# session_close &lt;session_id&gt; &lt;end-time&gt;
-
-session_close()
-{
-	perl -pi -e &quot;s/startTime=\(.*\)/startTime=\1\nendTime=$(date +%s)/&quot; $NX_SESS_DIR/running/sessionId'{'$1'}'
-	session_status $1 &quot;Finished&quot;
-	[ &quot;$SESSION_HISTORY&quot; = &quot;0&quot; ] &amp;&amp; rm -f $NX_SESS_DIR/running/sessionId'{'$1'}'
-	[ &quot;$SESSION_HISTORY&quot; = &quot;0&quot; ] || mv -f $NX_SESS_DIR/running/sessionId'{'$1'}' $NX_SESS_DIR/closed/sessionId'{'$1'}'
-}
-
-session_fail()
-{
-	perl -pi -e &quot;s/startTime=\(.*\)/startTime=\1\nendTime=$(date +%s)/&quot; $NX_SESS_DIR/running/sessionId'{'$1'}'
-	session_status $1 &quot;Failed&quot;
-	[ &quot;$SESSION_HISTORY&quot; = &quot;0&quot; ] &amp;&amp; rm -f $NX_SESS_DIR/running/sessionId'{'$1'}'
-	[ &quot;$SESSION_HISTORY&quot; = &quot;0&quot; ] || mv -f $NX_SESS_DIR/running/sessionId'{'$1'}' $NX_SESS_DIR/failed/sessionId'{'$1'}'
-}
-
-session_suspend()
-{
-	session_status $1 &quot;Suspended&quot;
-}
-
-#
-# end of library
-#
-
-
-#
-# Main nxserver &lt;-&gt; nxclient communication module
-#
-
-if [ $USER = &quot;nxuser&quot; -o &quot;$USER&quot; = &quot;nx&quot; ]
-then
-	
-log()
-{
-	[ &quot;$NX_LOGGING&quot; = &quot;1&quot; -a -w &quot;$NX_LOGFILE&quot; ] &amp;&amp; echo &quot;$@&quot; &gt;&gt; &quot;$NX_LOGFILE&quot;
-}
-
-log_tee()
-{
-	[ &quot;$NX_LOGGING&quot; = &quot;1&quot; -a -w &quot;$NX_LOGFILE&quot; ] &amp;&amp; exec tee -a &quot;$NX_LOGFILE&quot;
-	[ &quot;$NX_LOGGING&quot; = &quot;1&quot; -a -w &quot;$NX_LOGFILE&quot; ] || exec cat -
-}
-
-echo_x()
-{
-	log &quot;$@&quot;
-	echo &quot;$@&quot;
-}
-
-# Forward the connection to the commercial NoMachine server
-server_forward_nomachine()
-{
-	set -- &quot;${RECORD_CMD[@]}&quot;
-	
-	# setup the FIFOs
-	SERVER_IN=~/server.in.$$
-	SERVER_OUT=~/server.out.$$
-	rm -f $SERVER_IN $SERVER_OUT
-	mkfifo $SERVER_IN $SERVER_OUT
-	exec 3&lt;&gt;$SERVER_IN
-	exec 4&lt;&gt;$SERVER_OUT
-	
-	$NOMACHINE_SERVER &lt;&amp;3 &gt;&amp;4 &amp;
-	NX_PID=$!
-	
-	while true
-	do
-		read -n7 opcode &lt;&amp;4
-		line=&quot;&quot;
-		case &quot;$opcode&quot; in
-			&quot;NX&gt; 105&quot;)
-				echo $1 &gt;&amp;3
-				shift
-			;;
-			&quot;NX&gt; 101&quot;)
-				echo $USER &gt;&amp;3
-				read line &lt;&amp;4
-				break
-			;;
-			*)
-				read line &lt;&amp;4
-			;;
-		esac
-	done
-	log &quot;done.&quot;
-	cat &lt;&amp;4 &amp;
-	CAT_PID=$!
-	cat - &gt;&amp;3
-	rm -f $SERVER_IN $SERVER_OUT
-	kill $CAT_PID
-	kill $NX_PID
-	exit 0
-}
-
-# Start!
-log &quot;-- NX SERVER START: $@&quot;
-
-if [ &quot;$ENABLE_SERVER_FORWARD&quot; = &quot;1&quot; -a -n &quot;$SERVER_FORWARD_HOST&quot; ]
-then
-	log &quot;Forwarding connection to $SERVER_FORWARD_HOST with secret key $SERVER_FORWARD_KEY.&quot;
-	ssh -i &quot;$SERVER_FORWARD_KEY&quot; &quot;nx@$SERVER_FORWARD_HOST:$SERVER_FORWARD_PORT&quot;
-	exit 0
-fi
-
-# forward the connection to commercial NoMachine server?
-if [ &quot;$ENABLE_NOMACHINE_FORWARD_PORT&quot; = &quot;1&quot; -a &quot;$NOMACHINE_FORWARD_PORT&quot; = &quot;$(echo $SSH_CLIENT | cut -d' ' -f3)&quot; -a -n &quot;$NOMACHINE_SERVER&quot; ]
-then
-	log &quot;Info: Detected SSH destination port $NOMACHINE_FORWARD_PORT. Forwarding connection to commercial NoMachine server.&quot;
-	exec $NOMACHINE_SERVER
-	log &quot;Error: Forwarding to NoMachine Server $NOMACHINE_SERVER failed. Using FreeNX server instead.&quot;
-fi
-
-echo_x &quot;HELLO NXSERVER - Version $NX_VERSION $NX_LICENSE&quot;
-
-[ &quot;$ENABLE_NOMACHINE_FORWARD_USER&quot; = &quot;1&quot; ] &amp;&amp; RECORD_CMD=()
-
-# Login stage
-while true
-do
-	echo_x -n &quot;NX&gt; 105 &quot;
-	read CMD
-	# FIXME?
-	[ &quot;$CMD&quot; = &quot;&quot; ] &amp;&amp; CMD=&quot;quit&quot;
-	echo_x &quot;$CMD&quot;
-	
-	# record $CMD in RECORD_CMD array
-	[ &quot;$ENABLE_NOMACHINE_FORWARD_USER&quot; = &quot;1&quot; ] &amp;&amp; RECORD_CMD=( &quot;${RECORD_CMD[@]}&quot; &quot;$CMD&quot; )
-	
-	case &quot;$CMD&quot; in 
-		quit|QUIT)
-			echo_x &quot;Quit&quot;
-			echo_x &quot;NX&gt; 999 Bye&quot;
-			exit 0
-		;;
-		exit|EXIT)
-			echo_x &quot;Exit&quot;
-			echo_x &quot;NX&gt; 999 Bye&quot;
-			exit 0
-		;;
-		bye|BYE)
-			echo_x &quot;Bye&quot;
-			echo_x &quot;NX&gt; 999 Bye&quot;
-			exit 0
-		;;
-		hello*|HELLO*)
-			PROTO=$(echo $CMD | sed 's/.*Version \(.*\)/\1/g')
-			echo_x &quot;NX&gt; 134 Accepted protocol: $PROTO&quot;
-			if [ &quot;$PROTO&quot; = &quot;1.3.0&quot; -o &quot;$PROTO&quot; = &quot;1.3.2&quot; ]
-			then
-				[ &quot;$ENABLE_AUTORECONNECT_BEFORE_140&quot; = &quot;1&quot; ] &amp;&amp; ENABLE_AUTORECONNECT=&quot;1&quot;
-			fi
-		;;
-		set*|SET)
-			if [ &quot;$CMD&quot; = &quot;set auth_mode password&quot; -o &quot;$CMD&quot; = &quot;SET AUTH_MODE PASSWORD&quot; ]
-			then
-				echo_x &quot;Set auth_mode: password&quot;
-			else
-				echo_x &quot;NX&gt; 500 ERROR: unknown auth mode ''&quot;
-			fi
-		;;
-		login|LOGIN)
-			LOGIN_SUCCESS=&quot;0&quot;
-			
-			echo_x -n &quot;NX&gt; 101 User: &quot;
-			read USER
-			echo_x $USER
-			
-			# forward the connection to commercial NoMachine server?
-			if [ &quot;$ENABLE_NOMACHINE_FORWARD_USER&quot; = &quot;1&quot; -a -n &quot;$NOMACHINE_SERVER&quot; ]
-			then
-				case &quot;$USER&quot; in
-					freenx.*)
-						log &quot;Not forwarding connection. FreeNX user found.&quot;
-						USER=${USER##freenx.}
-					;;
-					*)
-						log -n &quot;Forwarding connection to NoMachine server...&quot;
-						server_forward_nomachine
-						log &quot;failed.&quot;
-					;;
-				esac
-			fi
-			
-			echo_x -n &quot;NX&gt; 102 Password: &quot;
-			read -s PASS
-			echo_x &quot;&quot;
-			log -n &quot;Auth method: &quot;
-
-			if [ &quot;$ENABLE_FAKE_AUTHENTICATION&quot; = &quot;1&quot; ]
-			then
-				LOGIN_SUCCESS=&quot;1&quot;
-				LOGIN_METHOD=&quot;FAKE&quot;
-			fi
-			
-			# PASSDB based auth
-			if [ &quot;$ENABLE_PASSDB_AUTHENTICATION&quot; = &quot;1&quot; -a &quot;$LOGIN_SUCCESS&quot; = &quot;0&quot; ]
-			then
-				log -n &quot;passdb &quot;
-				if [ $(passdb_get_crypt_pass &quot;$PASS&quot;) = $(passdb_get_pass &quot;$USER&quot;) ]
-				then
-					LOGIN_SUCCESS=&quot;1&quot;
-					LOGIN_METHOD=&quot;PASSDB&quot;
-				fi
-			fi
-			
-			# SSH based auth
-			if [ &quot;$ENABLE_SSH_AUTHENTICATION&quot; = &quot;1&quot; -a &quot;$LOGIN_SUCCESS&quot; = &quot;0&quot; ]
-			then
-				log -n &quot;ssh &quot;
-				echo &quot;$PASS&quot; | $PATH_BIN/nxnode-login -- ssh &quot;$USER&quot; &quot;$SSHD_PORT&quot; &quot;$PATH_BIN/nxnode&quot; --check &gt; /dev/null 2&gt;/dev/null
-				if [ $? -eq 0 ]
-				then
-					LOGIN_SUCCESS=&quot;1&quot;
-					LOGIN_METHOD=&quot;SSH&quot;
-				fi
-			fi
-			
-			# SU based auth
-			if [ &quot;$ENABLE_SU_AUTHENTICATION&quot; = &quot;1&quot; -a &quot;$LOGIN_SUCCESS&quot; = &quot;0&quot; ]
-			then
-				log -n &quot;su &quot;
-				echo &quot;$PASS&quot; | $PATH_BIN/nxnode-login -- su &quot;$USER&quot; &quot;&quot; &quot;$PATH_BIN/nxnode&quot; --check &gt; /dev/null 2&gt;/dev/null
-				if [ $? -eq 0 ]
-				then
-					LOGIN_SUCCESS=&quot;1&quot;
-					LOGIN_METHOD=&quot;SU&quot;
-				fi
-			fi
-			log &quot;&quot;
-			
-			# Check if user in passdb
-			if [ &quot;$ENABLE_USER_DB&quot; = &quot;1&quot; ]
-			then
-				log &quot;userdb check&quot;
-				passdb_user_exists &quot;$USER&quot; || LOGIN_SUCCESS=&quot;0&quot;
-			fi
-
-			if [ &quot;$LOGIN_SUCCESS&quot; = &quot;1&quot; ]
-			then
-				# Reread the config files (so that $USER.node.conf get sourced)
-				. $(PATH=$(cd $(dirname $0) &amp;&amp; pwd):$PATH which nxloadconfig) --userconf
-
-if [ &quot;$USER&quot; = &quot;nxuser&quot; ]
-then
-	export NX_SESS_DIR=&quot;$HOME/.nx/db/&quot;
-	export NX_LOGFILE=&quot;$HOME/.nx/temp/nxserver.log&quot;
-	mkdir -p $NX_SESS_DIR/{closed,running,failed}
-	ENABLE_FAKE_AUTHENTICATION=&quot;1&quot;
-fi
-
-
-				echo_x &quot;NX&gt; 103 Welcome to: $SERVER_NAME user: $USER&quot;
-				break
-			else
-				echo_x &quot;NX&gt; 404 ERROR: wrong password or login&quot;
-				echo_x &quot;NX&gt; 999 Bye&quot;
-				exit 1
-			fi
-		;;
-	esac
-done
-
-# remove old session infos from history
-session_cleanup
-
-#
-# call it with: server_get_params $CMD # no &quot;&quot;!
-#
-
-server_get_params()
-{
-	SERVER_PARAMS=$(echo &quot;$@&quot; | sed &quot;s/^$1/\&quot;/g; s/\&quot; --/\&amp;/g; s/\&quot;//g&quot;)
-	if [ &quot;$SERVER_PARAMS&quot; = &quot;&quot; ]
-	then
-		echo_x -n &quot;NX&gt; 106 Parameters: &quot;
-		read SERVER_PARAMS2
-		SERVER_PARAMS=$(echo $SERVER_PARAMS2 | sed 's/%2B/+/g')
-		echo_x
-	fi
-}
-
-nxnode_start()
-{
-	:
-	#CMD=&quot;$1&quot;
-	#shift
-	#echo &quot;$@&quot; | $PATH_BIN/nxnode &quot;$CMD&quot;
-}
-
-#NX&gt; 1002 Commit
-#NX&gt; 1006 Session status: running
-
-server_nxnode_start()
-{
-	CMD=&quot;$1&quot;
-	USER=&quot;$2&quot;
-	shift
-	shift
-	# Use nxnode-login?
-	if [ &quot;$LOGIN_METHOD&quot; = &quot;SSH&quot; ]
-	then
-	    echo &quot;$PASS&quot; | $PATH_BIN/nxnode-login -- ssh &quot;$USER&quot; &quot;$SSHD_PORT&quot; &quot;$PATH_BIN/nxnode&quot; &quot;$CMD&quot; &quot;$@&quot; 2&gt;&amp;1 | log_tee
-	elif [ &quot;$LOGIN_METHOD&quot; = &quot;SU&quot; ]
-	then
-	    echo &quot;$PASS&quot; | $PATH_BIN/nxnode-login -- su &quot;$USER&quot; &quot;&quot; &quot;$PATH_BIN/nxnode&quot; &quot;$CMD&quot; &quot;$@&quot; 2&gt;&amp;1 | log_tee
-	elif [ &quot;$LOGIN_METHOD&quot; = &quot;FAKE&quot; ]
-	then
-	    echo &quot;$@&quot; | $PATH_BIN/nxnode &quot;$CMD&quot; 2&gt;&amp;1 | log_tee
-	else 
-	    echo &quot;$@&quot; | ssh -l &quot;$USER&quot; 127.0.0.1 -p $SSHD_PORT -x -2 -i $NX_ETC_DIR/users.id_dsa -o 'PubkeyAuthentication yes' -o 'RSAAuthentication yes' -o 'RhostsAuthentication no' -o 'PasswordAuthentication no' -o 'RhostsRSAAuthentication no' -o 'StrictHostKeyChecking no' $PATH_BIN/nxnode &quot;$CMD&quot; | log_tee
-	fi
-}
-
-server_add_usession()
-{
-	[ &quot;$ENABLE_USESSION&quot; = &quot;1&quot; ] || return
-	
-	$COMMAND_SESSREG -l &quot;:$SESS_DISPLAY&quot; -h &quot;$USERIP&quot; -a $USER 2&gt;/dev/null
-}
-
-server_remove_usession()
-{
-	[ &quot;$ENABLE_USESSION&quot; = &quot;1&quot; ] || return
-	$COMMAND_SESSREG -l &quot;:$SESS_DISPLAY&quot; -h &quot;$USERIP&quot; -d $USER 2&gt;/dev/null
-}
-
-server_nxnode_start_wait()
-{
-	server_add_usession
-	
-	STOP_SEND=&quot;&quot;
-	server_nxnode_start &quot;$@&quot; | while read CMD
-	do
-		case &quot;$CMD&quot; in 
-			&quot;NX&gt; 1006&quot;*|&quot;NX&gt; 1005&quot;*|&quot;NX&gt; 1009&quot;*)
-				case &quot;$CMD&quot; in 
-					*running*)
-						rm -f $WAIT
-						session_status $uniqueid &quot;Running&quot;
-					;;
-					*closed*)
-						session_close $uniqueid
-					;;
-					*suspended*)
-						session_suspend $uniqueid
-					;;
-					*terminating*)
-						session_status $uniqueid &quot;Terminating&quot;
-						# we need to stop sending to client as it will have already
-						# closed his side of the channel and this will lead to not 
-						# closed sessions.
-						STOP_SEND=&quot;1&quot;
-				esac
-			;;
-			&quot;NX&gt; 1004&quot;*)
-				session_fail $uniqueid
-				# FIXME: Need correct error code.
-				echo_x &quot;NX&gt; 504 Session startup failed.&quot;
-			;;
-		esac
-
-		case $CMD in
-			&quot;NX&gt; 718&quot;*)
-				[ -z &quot;$STOP_SEND&quot; ] &amp;&amp; echo $CMD &gt;&amp;2
-				#echo &quot;NX&gt; 1006 Session status: running&quot; 1&gt;&amp;2
-				#echo &quot;NX&gt; 1001 Bye.&quot; 1&gt;&amp;2
-
-			;;
-			&quot;NX&gt; &quot;*)
-				[ -z &quot;$STOP_SEND&quot; ] &amp;&amp; echo $CMD
-			;;
-		esac
-	done
-	
-	server_remove_usession
-
-	# remove lock file
-	[ -e &quot;/tmp/.nX$SESS_DISPLAY-lock&quot; ] &amp;&amp; rm -f /tmp/.nX$SESS_DISPLAY-lock
-}
-
-server_check_session_count()
-{
-	session_count_user &quot;$USER&quot;
-	
-	if [ &quot;$SESSION_COUNT&quot; -ge &quot;$SESSION_LIMIT&quot; ]
-	then
-		echo_x &quot;NX&gt; 599 Reached the maximum number of concurrent sessions on this server.&quot;
-		echo_x &quot;NX&gt; 500 ERROR: Last operation failed.&quot;
-		return 1
-	fi
-	
-	if [ &quot;$SESSION_COUNT_USER&quot; -ge &quot;$SESSION_USER_LIMIT&quot; ]
-	then
-		echo_x &quot;NX&gt; 599 Server capacity: reached for user: $USER&quot;
-		echo_x &quot;NX&gt; 500 ERROR: Last operation failed.&quot;
-		return 1
-	fi
-
-	return 0
-}
-
-server_startrestore_session()
-{
-	ACTION=&quot;$1&quot;
-	
-	server_get_params $CMD
-	PARAMS=$SERVER_PARAMS
-	CMDLINE=$PARAMS
-	echo_x
-	
-	# If we can't get the userip and SSHD_CHECK_IP is set to 1
-	# we bail out.
-	if [ -z &quot;$SSH_CLIENT&quot; ]
-	then 
-		if [ &quot;$SSHD_CHECK_IP&quot; = &quot;1&quot; ]
-		then
-			echo &quot;NX&gt; 504 Session startup failed. (Missing SSH_CLIENT environment variable)&quot;
-			return 1
-		else
-			log &quot;WARNING: Failed to determine the client IP.&quot;
-			log &quot;WARNING: The SSH_CLIENT variable was not provided by SSHD.&quot;
-			log &quot;WARNING: Please set SSHD_CHECK_IP=1 if you want to refuse the connection.&quot;
-		fi
-	fi
-
-	# check if there is a suspended session, which we could resume
-	if [ &quot;$ENABLE_AUTORECONNECT&quot; = &quot;1&quot; -a &quot;$ACTION&quot; = &quot;start&quot; ]
-	then
-		restore=$(session_get_user_suspended &quot;$USER&quot; &quot;Suspended&quot;)
-		if [ -n &quot;$restore&quot; ]
-		then
-			PARAMS=&quot;$PARAMS&amp;restore=$restore&quot;
-			CMDLINE=$PARAMS
-			ACTION=&quot;resume&quot;
-		fi
-	fi
-
-	USERIP=$(echo $SSH_CLIENT | cut -d&quot; &quot; -f1 | sed 's/::<A HREF="ffff://g">ffff://g</A>')
-	[ -z &quot;$USERIP&quot; ] &amp;&amp; USERIP=&quot;*&quot;
-	if [ &quot;$ACTION&quot; = &quot;start&quot; ]
-	then
-		server_check_session_count || return 1
-		
-		# start nxnode
-		SESS_DISPLAY=$DISPLAY_BASE
-		let SESS_DISPLAY_LIMIT=$DISPLAY_BASE+$DISPLAY_LIMIT
-	
-		# stupid but working algo ...
-			
-		# TODO: need to check for _all_ offset and ports :-/
-			
-		while true
-		do
-			while [ -e /tmp/.X$SESS_DISPLAY-lock -o -e &quot;/tmp/.nX$SESS_DISPLAY-lock&quot; ]
-			do
-				let SESS_DISPLAY=$SESS_DISPLAY+1
-			done
-
-			SESS_LOCKFILE=$(mktemp &quot;/tmp/.nX$SESS_DISPLAY-lock.XXXXXXXXX&quot;)
-			# ln is an atomic operation
-			ln &quot;$SESS_LOCKFILE&quot; &quot;/tmp/.nX$SESS_DISPLAY-lock&quot; 2&gt;/dev/null &amp;&amp; break
-		done
-		
-		if [ &quot;$SESS_DISPLAY&quot; -gt &quot;$SESS_DISPLAY_LIMIT&quot; ]
-		then
-			# fixme we need the correct error code
-			echo_x &quot;NX&gt; 504 Error: Display limit exceeded. Please remove some files from /tmp/.X*-lock.&quot;
-			return
-		fi
-
-		rm -f &quot;$SESS_LOCKFILE&quot;
-	
-		uniqueid=$(echo $[$RANDOM*$RANDOM] | md5sum | cut -d&quot; &quot; -f1 | tr &quot;[a-z]&quot; &quot;[A-Z]&quot;)
-		FULL_PARAMS=&quot;user=$USER&amp;userip=$USERIP&amp;uniqueid=$uniqueid&amp;display=$SESS_DISPLAY&amp;$PARAMS&quot;
-		log &quot;$FULL_PARAMS&quot;
-
-		# now update the session listing
-		CMDLINE=&quot;a=b&amp;$FULL_PARAMS&quot;
-		session_add $uniqueid &quot;sessionName=$(getparam session)&amp;display=$(getparam display)&amp;status=Running&amp;startTime=$(date +%s)&amp;foreignAddress=$(getparam userip)&amp;type=$(getparam type)&amp;sessionId=$uniqueid&amp;creationTime=$(date +%s)&amp;userName=$USER&amp;serverPid=$SERVER_PID&amp;screeninfo=$(getparam screeninfo)&amp;geometry=$(getparam geometry)&quot;
-		export ENCRYPTION=$(getparam encryption)
-	else
-		uniqueid=$(getparam restore)
-		[ -z &quot;$uniqueid&quot; ] &amp;&amp; uniqueid=$(getparam id) # 1.4.0-5 compatibility
-		export ENCRYPTION=$(getparam encryption)
-		session_change &quot;$uniqueid&quot; &quot;foreignAddress&quot; &quot;$USERIP&quot;
-
-		CMDLINE=$(session_get &quot;$uniqueid&quot;)
-		FULL_PARAMS=&quot;user=$USER&amp;userip=$(getparam foreignAddress)&amp;uniqueid=$uniqueid&amp;display=$(getparam display)$PARAMS&quot;
-		SESS_DISPLAY=$(getparam display)
-	fi
-
-	# now start the node
-	export WAIT=$(mktemp /tmp/nxserver_wait.XXXXXXXXX)
-	touch $WAIT
-	(sleep 10; rm -f $WAIT) &amp;
-	server_nxnode_start_wait --&quot;$ACTION&quot;session $USER &quot;$FULL_PARAMS&quot; &amp;
-	SERVER_PID=$!
-	disown $SERVER_PID
-	while [ -f &quot;$WAIT&quot; ]
-	do
-		sleep 1
-	done
-}
-
-# Session stage
-while true
-do
-	echo_x -n &quot;NX&gt; 105 &quot;
-	unset CMD
-	read CMD 2&gt;/dev/null
-	# FIXME?
-	[ &quot;$CMD&quot; = &quot;&quot; ] &amp;&amp; CMD=&quot;quit&quot;
-	echo_x &quot;$CMD&quot;
-	case &quot;$CMD&quot; in 
-		quit|QUIT)
-			echo_x &quot;Quit&quot;
-			echo_x &quot;NX&gt; 999 Bye&quot;
-			exit 0
-		;;
-		exit|EXIT)
-			echo_x &quot;Exit&quot;
-			echo_x &quot;NX&gt; 999 Bye&quot;
-			exit 0
-		;;
-		bye|BYE)
-			echo_x &quot;Bye&quot;
-			echo_x &quot;NX&gt; 999 Bye&quot;
-			if [ &quot;$ENCRYPTION&quot; = &quot;1&quot; ] 
-			then 
-				let PROXY_DISPLAY=$SESS_DISPLAY+4000
-				$COMMAND_NETCAT 127.0.0.1 $PROXY_DISPLAY
-				exit 0
-			else
-				echo_x &quot;NX&gt; 1001 Bye.&quot;
-			fi
-		;;
-		startsession*)
-			server_startrestore_session &quot;start&quot;
-		;;
-		list*)
-			server_get_params $CMD
-			PARAMS=$SERVER_PARAMS
-			CMDLINE=$PARAMS
-			
-			# FIXME: To NX-Node!
-
-			status=$(getparam status)
-
-			if [ &quot;$status&quot; = &quot;Suspended&quot; ]
-			then
-				session_list_user_suspended &quot;$USER&quot; &quot;Suspended&quot; &quot;$(getparam screeninfo)&quot; &quot;$(getparam type)&quot; | log_tee
-			elif [ &quot;$status&quot; = &quot;Suspended,Running&quot; ] # since 1.4.0-5
-			then
-				# disabled due to problems with 1.4.0-5 client
-				session_list_user_suspended &quot;$USER&quot; 'Suspended$|^status=Running$' &quot;$(getparam geometry)&quot; &quot;$(getparam type)&quot; | log_tee
-				#session_list_user_suspended &quot;$USER&quot; 'Suspended' &quot;$(getparam geometry)&quot; &quot;$(getparam type)&quot; | log_tee
-			else
-				session_list_user &quot;$USER&quot; | log_tee
-			fi
-		;;
-		suspend*)
-			server_get_params $CMD
-			PARAMS=$SERVER_PARAMS
-			CMDLINE=$PARAMS
-			if session_find_id_user &quot;$(getparam sessionid)&quot; &quot;$USER&quot;
-			then
-				# FIXME: Check for success/error
-				server_nxnode_start --suspend &quot;$USER&quot; &quot;$PARAMS&quot;
-				session_suspend $(getparam sessionid)
-			fi
-		;;
-		terminate*)
-			server_get_params $CMD
-			PARAMS=$SERVER_PARAMS
-			CMDLINE=$PARAMS
-			if session_find_id_user &quot;$(getparam sessionid)&quot; &quot;$USER&quot;
-			then
-				# FIXME: Check for success/error
-				server_nxnode_start --terminate &quot;$USER&quot; &quot;$PARAMS&quot;
-				session_close $(getparam sessionid)
-			fi
-		;;
-		restoresession*)
-			server_startrestore_session &quot;resume&quot;
-		;;
-		passwd)
-			echo &quot;NX&gt; 113 Changing password of user '$USER'&quot;
-			echo -n &quot;NX&gt; 102 Current password:&quot;
-			read -s PASS
-			ENC_PASS=$(passdb_get_crypt_pass &quot;$PASS&quot;)
-			REAL_PASS=$(passdb_get_pass &quot;$USER&quot;)
-			echo_x
-			if [ &quot;$ENC_PASS&quot; = &quot;$REAL_PASS&quot; ]
-			then
-				echo_x -n &quot;NX&gt; 102 Password:&quot;
-				read -s NEW_PASS1
-				
-				if [ ${#NEW_PASS1} -lt 5 ]
-				then
-					echo_x &quot;NX&gt; 500 ERROR: incorrect password format, password must be long at least five characters&quot;
-					continue
-				fi
-
-				echo_x
-				echo_x -n &quot;NX&gt; 102 Confirm password:&quot;
-				read -s NEW_PASS1
-				echo_x
-				if [ &quot;$NEW_PASS1&quot; = &quot;$NEW_PASS2&quot; ]
-				then
-					ENC_PASS=$(passdb_get_crypt_pass &quot;$NEW_PASS1&quot;)
-					passdb_chpass &quot;$USER&quot; &quot;$ENC_PASS&quot;
-					echo_x &quot;NX&gt; 114 Password of user '$USER' changed&quot;
-				else
-					echo_x &quot;NX&gt; 537 ERROR: passwords do not match&quot;
-				fi
-			else
-				echo_x &quot;NX&gt; 500 ERROR: current password doesn't match&quot;
-			fi
-		;;
-		addmount*)
-			server_get_params $CMD
-			PARAMS=$SERVER_PARAMS
-			server_nxnode_start --smbmount &quot;$USER&quot; &quot;$PARAMS&quot; &gt;/dev/null 2&gt;&amp;1
-			echo_x &quot;NX&gt; 719 SMB filesystem: running&quot;
-		;;
-		addprintercups*)
-			server_get_params $CMD
-			PARAMS=$SERVER_PARAMS
-			server_nxnode_start --addprintercups &quot;$USER&quot; &quot;$PARAMS&quot; &gt;/dev/null 2&gt;&amp;1
-		;;
-		*)
-			# disabled for 1.4.0-5 snapshot client
-			#echo_x &quot;NX&gt; 503 Error: undefined command: '$CMD'&quot;
-		;;
-	esac
-done
-
-fi
-
-#
-# End of Main nxserver &lt;--&gt; nxclient communication module
-#
-
-################### PACKAGE cmd.bm ############################
-
-#
-# library functions for nxserver-commandline cmds
-#
-
-# Policy: All functions and variables need to start with CMD_ / cmd_
-
-# Needed global vars: $NX_VERSION, $NX_LICENSE, $NX_ETC_DIR, $PATH_BIN, $NX_HOME_DIR, $SSH_AUTHORIZED_KEYS
-
-# Needed package: passdb
-
-cmd_usage()
-{
-	echo &quot;NXSERVER - Version $NX_VERSION $NX_LICENSE&quot;
-	echo &quot;Usage: nxserver &lt;option&gt;&quot; 1&gt;&amp;2
-
-	if [ &quot;$1&quot; = &quot;root&quot; ]
-	then
-		echo &quot;--adduser &lt;user&gt;: Add a new user&quot; 1&gt;&amp;2
-		echo &quot;--passwd &lt;user&gt;: Change password of &lt;user&gt;&quot; 1&gt;&amp;2
-		echo &quot;--deluser &lt;user&gt;: Remove a user from nx&quot; 1&gt;&amp;2
-		echo &quot;--listuser: List enabled users&quot; 1&gt;&amp;2
-		echo &quot;&quot; 1&gt;&amp;2
-		echo &quot;--start: Start the nx server&quot; 1&gt;&amp;2
-		echo &quot;--stop: Stop the nx server&quot; 1&gt;&amp;2
-		echo &quot;--status: Show status of nx server&quot; 1&gt;&amp;2
-		echo &quot;--restart: Restart the nx server and terminate all running sessions&quot; 1&gt;&amp;2
-		echo &quot;&quot; 1&gt;&amp;2
-		echo &quot;--list [ user | sessionid ]: List running sessions of user or sessionid &quot; 1&gt;&amp;2
-		echo &quot;--history [ user | sessionid | clear ]: Show history [ of user | sessionid ] or clear the history&quot; 1&gt;&amp;2
-		echo &quot;--terminate &lt;user | :display | sessionid&gt;: Terminate the session pointed to by&quot; 1&gt;&amp;2
-		echo &quot;       sessionid or display, or all sessions of the specified user.&quot; 1&gt;&amp;2
-		echo &quot;--suspend &lt;user | :display | sessionid&gt;: Suspend the session pointed to by&quot; 1&gt;&amp;2
-		echo &quot;       sessionid or display, or all sessions of the specified user.&quot; 1&gt;&amp;2
-		echo &quot;&quot; 1&gt;&amp;2
-		echo &quot;--broadcast &lt;message&gt;: Send a message to all users&quot; 1&gt;&amp;2
-		echo &quot;--send &lt;user | :display | sessionid&gt; &lt;message&gt;: Send a message to the specified user or sessionid&quot; 1&gt;&amp;2
-	else
-		echo &quot;--passwd: Change password&quot; 1&gt;&amp;2
-	fi
-	exit 1
-}
-
-
-cmd_abort()
-{
-	echo &quot;NX&gt; 500&quot; &quot;$@&quot; 1&gt;&amp;2
-	echo &quot;NX&gt; 999 Bye&quot; 1&gt;&amp;2
-	exit 1
-}
-
-cmd_user_passwd()
-{
-	echo &quot;NX&gt; 100 NXSERVER - Version $NX_VERSION $NX_LICENSE&quot;
-	echo &quot;Sorry: Password changing for user is _not_ implemented, yet.&quot;
-	echo &quot;Please login to NX-Server to change password&quot;
-	echo &quot;or ask your local system administrator.&quot;
-	#echo &quot;NX&gt; 113 Changing password of user '$USER'&quot;
-	#echo &quot;Old password:&quot;
-	#read -s OLDPASS
-	#echo &quot;New password:&quot;
-	#read -s NEWPASS1
-	#echo &quot;Repeat:&quot;
-	#read -s NEWPASS2
-
-}
-
-cmd_passwd()
-{
-	CMD_CHUSER=$2
-	egrep -q &quot;^$CMD_CHUSER:&quot; $NX_ETC_DIR/passwords || cmd_abort &quot;Error: User $CMD_CHUSER not found in database.&quot;
-	echo -n &quot;New password: &quot;
-	read -s CMD_NEWPASS
-	echo
-	CMD_ENC_PASS=$(passdb_get_crypt_pass &quot;$CMD_NEWPASS&quot;)
-	passdb_chpass &quot;$CMD_CHUSER&quot; &quot;$CMD_ENC_PASS&quot;
-	echo &quot;Password changed.&quot;
-}
-
-cmd_adduser()
-{
-	CMD_CHUSER=$2
-	
-	[ ${#CMD_CHUSER} -ge 32 ] &amp;&amp; cmd_abort &quot;Error: User $CMD_CHUSER must be shorter than 32 characters.&quot;
-	egrep -q &quot;^$CMD_CHUSER:&quot; $NX_ETC_DIR/passwords &amp;&amp; cmd_abort &quot;Error: User $CMD_CHUSER already in database.&quot;
-	getent passwd | egrep -q &quot;^$CMD_CHUSER:&quot; || cmd_abort &quot;Error: User $CMD_CHUSER not existing on local system. Can't add.&quot;
-	passdb_add_user &quot;$CMD_CHUSER&quot;
-}
-
-cmd_deluser()
-{
-	CMD_CHUSER=$2
-	egrep -q &quot;^$CMD_CHUSER:&quot; $NX_ETC_DIR/passwords || cmd_abort &quot;Error: User $CMD_CHUSER not found in database.&quot;
-	passdb_remove_user &quot;$CMD_CHUSER&quot;
-}
-
-cmd_listuser()
-{
-	echo &quot;NX&gt; 146 NX users list&quot;
-	echo
-	echo &quot;Username&quot;
-	echo &quot;---------------&quot;
-	echo
-	passdb_list_user
-	echo
-}
-
-cmd_start()
-{
-	
-	[ -f $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS ] &amp;&amp; cmd_abort &quot;ERROR: Service already running&quot;
-	mv $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS.disabled $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS
-	echo &quot;NX&gt; 122 Service started&quot;
-}
-
-cmd_stop()
-{
-	[ -f $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS ] || cmd_abort &quot;Service was already stopped&quot;
-	mv $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS.disabled
-	# TODO: Stop all running sessions
-	echo &quot;NX&gt; 123 Service stopped&quot;
-}
-
-cmd_status()
-{
-	[ -f $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS ] &amp;&amp; echo &quot;NX&gt; 110 NX Server is running&quot;
-	[ -f $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS ] || echo &quot;NX&gt; 110 NX Server is stopped&quot;
-}
-
-cmd_restart()
-{
-	cmd_stop
-	cmd_start
-}
-
-cmd_parse_2_params()
-{
-	if [ ${#1} -eq 32 ]
-	then
-		CMD_APARAMS=&quot;sessionid=sessionId{$1}&quot;
-	else
-	if [ &quot;$1&quot; != &quot;&quot; ]
-	then
-		#egrep -q &quot;^$1:&quot; $NX_ETC_DIR/passwords || cmd_abort &quot;Error: User $1 not found in database.&quot;
-		CMD_APARAMS=&quot;user=$1&quot;
-	fi
-	fi
-	echo $CMD_APARAMS
-
-}
-
-cmd_parse_3_params()
-{
-	if [ ${#1} -eq 32 ]
-	then
-		CMD_APARAMS=$(session_find_id $1)
-		[ -n &quot;$CMD_APARAMS&quot; ] || cmd_abort &quot;Error: Session $1 could not be found.&quot;
-	else
-	if [ &quot;${1:0:1}&quot; = &quot;:&quot; ]
-	then
-		CMD_APARAMS=$(session_find_display &quot;${1:1}&quot;)
-		[ -n &quot;$CMD_APARAMS&quot; ] || cmd_abort &quot;Error: No running sessions found for display $1.&quot;
-	else
-	if [ &quot;$1&quot; != &quot;&quot; ]
-	then
-		#egrep -q &quot;^$1:&quot; $NX_ETC_DIR/passwords || cmd_abort &quot;Error: User $1 not found in database.&quot;
-		CMD_APARAMS=$(session_find_user &quot;$1&quot;)
-		[ -n &quot;$CMD_APARAMS&quot; ] || cmd_abort &quot;Error: No running sessions found for user $1.&quot;
-	else
-		cmd_abort &quot;Error: Not enough parameters.&quot;
-	fi
-	fi
-	fi
-	echo $CMD_APARAMS
-}
-
-cmd_list_suspended()
-{
-	CMD_PARAMS=$(cmd_parse_2_params &quot;$2&quot;)
-	[ -n &quot;$2&quot; -a -z &quot;$CMD_PARAMS&quot; ] &amp;&amp; exit 1
-	case $CMD_PARAMS in
-		user=*)
-			session_list_user_suspended $2 &quot;Suspended&quot;
-		;;
-	esac
-}
-cmd_list()
-{
-	CMD_PARAMS=$(cmd_parse_2_params &quot;$2&quot;)
-	[ -n &quot;$2&quot; -a -z &quot;$CMD_PARAMS&quot; ] &amp;&amp; exit 1
-	case $CMD_PARAMS in
-		user=*)
-			session_list_user $2
-		;;
-		sessionid=*)
-			session_list $2
-		;;
-		*)
-			session_list_all
-		;;
-	esac
-}
-
-cmd_history_clear()
-{
-	rm -f $NX_SESS_DIR/closed/*
-	rm -f $NX_SESS_DIR/failed/*
-}
-
-cmd_history()
-{
-	if [ &quot;$2&quot; = &quot;clear&quot; ]
-	then
-		cmd_history_clear
-	fi
-	
-	CMD_PARAMS=$(cmd_parse_2_params &quot;$2&quot;)
-	user=&quot;&quot;
-	sessid=&quot;&quot;
-	case $CMD_PARAMS in
-		user=*)
-			user=&quot;$2&quot;
-		;;
-		sessionid=*)
-			sessid=&quot;$2&quot;
-		;;
-	esac
-
-	session_history &quot;$user&quot; &quot;$sessid&quot;
-}
-
-cmd_terminate()
-{
-	CMD_PARAMS=$(cmd_parse_3_params &quot;$2&quot;)
-	[ -z &quot;$CMD_PARAMS&quot; ] &amp;&amp; exit 1
-	for i in $CMD_PARAMS;
-	do
-			CMDLINE=$(session_get_cmdline $i)
-			cmd_sessionid=$(getparam sessionId)
-			cmd_user=$(getparam userName)
-			cmd_type=$(getparam type)
-			cmd_status=$(getparam status)
-
-			# is it a &quot;good&quot; session?
-			case &quot;$1&quot; in 
-			--suspend)
-				if [ &quot;$cmd_status&quot; = &quot;Running&quot; ] &amp;&amp; stringinstring &quot;unix-&quot; &quot;$cmd_type&quot;
-				then
-					echo &quot;sessionid=$cmd_sessionid&quot; | su - &quot;$cmd_user&quot; -c &quot;$PATH_BIN/nxnode --suspend&quot;
-					session_suspend $cmd_sessionid
-				fi
-				;;
-			--terminate)
-			#if stringinstring &quot;unix-&quot; &quot;$cmd_type&quot;
-			#	then
-					echo &quot;sessionid=$cmd_sessionid&quot; | su - &quot;$cmd_user&quot; -c &quot;$PATH_BIN/nxnode --terminate&quot;
-					session_close $cmd_sessionid
-			#	fi
-
-			;;
-			esac
-	done
-
-}
-
-cmd_send()
-{
-	if [ &quot;$1&quot; = &quot;--broadcast&quot; ]
-	then
-	  CMD_PARAMS=$(session_find_all)
-	  [ -z &quot;$CMD_PARAMS&quot; ] &amp;&amp; cmd_abort &quot;Error: No running session could be found.&quot;
-	else
-	  CMD_PARAMS=$(cmd_parse_3_params &quot;$2&quot;)
-	  [ -z &quot;$CMD_PARAMS&quot; ] &amp;&amp; exit 1
-	fi
-	shift
-	shift
-	for i in $CMD_PARAMS;
-	do
-			CMDLINE=$(session_get_cmdline $i)
-			cmd_display=$(getparam display)
-			cmd_user=$(getparam userName)
-			cmd_type=$(getparam type)
-			cmd_status=$(getparam status)
-
-			# is it a &quot;good&quot; session?
-			if [ &quot;$cmd_status&quot; = &quot;Running&quot; ] &amp;&amp; stringinstring &quot;unix-&quot; &quot;$cmd_type&quot;
-			then
-				su - &quot;$cmd_user&quot; -c &quot;$PATH_BIN/nxclient --dialog ok --caption \&quot;NX Administrator Message\&quot; --message \&quot;$@\&quot; --noautokill 
--display \&quot;:$cmd_display\&quot;&quot; &amp;
-				disown $!
-			fi
-	done
-	#nxnode_start --send &quot;$CMD_PARAMS&quot;
-}
-
-#
-# user mode available functions
-#
-
-if [ $UID -ne 0 ]
-then
-	[ &quot;$1&quot; != &quot;--passwd&quot; ] &amp;&amp; cmd_usage
-	cmd_user_passwd
-	exit 0
-fi
-
-#
-# root mode available functions
-#
-
-[ $# -lt 1 ] &amp;&amp; cmd_usage &quot;root&quot;
-[ &quot;$1&quot; = &quot;--help&quot; ] &amp;&amp; cmd_usage &quot;root&quot;
-
-if [ &quot;$1&quot; = &quot;--version&quot; ]
-then
-  echo &quot;NXSERVER - Version $NX_VERSION $NX_LICENSE&quot;
-  exit 0
-fi
-
-CMD=$1
-
-echo &quot;NX&gt; 100 NXSERVER - Version $NX_VERSION $NX_LICENSE&quot;
-
-case $CMD in
-	# 
-	# User functions ...
-	# 
-	--passwd)
-		cmd_passwd &quot;$@&quot;
-	;;
-	--adduser|--useradd)
-		cmd_adduser &quot;$@&quot;
-	;;
-	--deluser|--userdel)
-		cmd_deluser &quot;$@&quot;
-	;;
-	--listuser|--userlist)
-		cmd_listuser
-	;;
-	--start)
-		cmd_start
-	;;
-	--stop)
-		cmd_stop
-	;;
-	--status)
-		cmd_status
-	;;
-	--restart)
-		cmd_restart
-	;;
-	--list)
-		cmd_list &quot;$@&quot;
-	;;
-	--list-suspended)
-		cmd_list_suspended &quot;$@&quot;
-	;;
-	--history)
-		cmd_history &quot;$@&quot;
-	;;
-	--terminate|--suspend)
-		cmd_terminate &quot;$@&quot;
-	;;
-	--send|--broadcast)
-		cmd_send &quot;$@&quot;
-	;;
-	*)
-		cmd_abort &quot;Error: Function $CMD not implemented yet.&quot;
-esac
-echo &quot;NX&gt; 999 Bye&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000153.html">[Freenx-cvs] r62 - / freenx-server freenx-server/CVS
</A></li>
	<LI>Next message: <A HREF="000155.html">[Freenx-cvs] r64 - freenx-server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#154">[ date ]</a>
              <a href="thread.html#154">[ thread ]</a>
              <a href="subject.html#154">[ subject ]</a>
              <a href="author.html#154">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/freenx-cvs">More information about the Freenx-cvs
mailing list</a><br>
</body></html>
