From freenx-cvs at berlios.de  Wed Mar  2 15:17:44 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Wed, 02 Mar 2005 15:17:44 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 4 files
Message-ID: <4225CB08.mailJAE11WPAE@lists.berlios.de>

User:      fabianx
Date:      2005-03-02 14:17:43 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxserver
Log:
Added mechanism to forward connection to another nxserver. This allows using a "chain" of nxservers.

Added keys to nxloadconfig: ENABLE_SERVER_FORWARD, SERVER_FORWARD_HOST, SERVER_FORWARD_KEY.

Revision  Changes    Path
1.16      +2 -0      freenx/ChangeLog


rev 1.16, prev_rev 1.15
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.15
retrieving revision 1.16
diff -u -r1.15 -r1.16
--- ChangeLog	17 Feb 2005 15:59:31 -0000	1.15
+++ ChangeLog	2 Mar 2005 14:17:43 -0000	1.16
@@ -15,6 +15,8 @@
 	  directives.
 	* Added mechanism to forward connection to commercial NoMachine 
 	  nxserver (as available from www.nomachine.com).
+	* Added mechanism to forward connection to another nxserver. This
+	  allows using a "chain" of nxservers.
 	* Added "floating window" support by using rootless nxagent as
 	  it will be standard in NX 1.5.0.
 	* Added "floating window" support by just nxproxy/nxproxy connection



1.4       +11 -1     freenx/node.conf.sample


rev 1.4, prev_rev 1.3
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -r1.3 -r1.4
--- node.conf.sample	14 Feb 2005 10:07:43 -0000	1.3
+++ node.conf.sample	2 Mar 2005 14:17:43 -0000	1.4
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.3 2005/02/14 10:07:43 pipitas Exp $
+# CVS: $Id: node.conf.sample,v 1.4 2005/03/02 14:17:43 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -87,6 +87,16 @@
 # like: $NODE_AUTOSTART {start|restore}
 #NODE_AUTOSTART=""
 
+# FreeNX with ENABLE_SERVER_FORWARD="1" will automatically forward all
+# connections to the host specified in SERVER_FORWARD_HOST with the 
+# secret key SERVER_FORWARD_KEY.
+#
+# This allows to have a "chain" of NX Servers. Note that you will need to 
+# use "SSL encryption" for all connections.
+
+#ENABLE_SERVER_FORWARD="0"
+#SERVER_FORWARD_HOST=""
+#SERVER_FORWARD_KEY="/usr/NX/share/client.id_dsa.key"
 
 # FreeNX with ENABLE_NOMACHINE_FORWARD="1" will automatically forward all
 # connections to the commercial NoMachine nxserver installed on the same



1.4       +5 -1      freenx/nxloadconfig


rev 1.4, prev_rev 1.3
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -r1.3 -r1.4
--- nxloadconfig	14 Feb 2005 08:23:16 -0000	1.3
+++ nxloadconfig	2 Mar 2005 14:17:43 -0000	1.4
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.3 2005/02/14 08:23:16 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.4 2005/03/02 14:17:43 fabianx Exp $
 #
 # ========================================================================
 
@@ -52,6 +52,10 @@
 EXPORT_USERIP="0"
 EXPORT_SESSIONID="0"
 NODE_AUTOSTART=""
+
+ENABLE_SERVER_FORWARD="0"
+SERVER_FORWARD_HOST=""
+SERVER_FORWARD_KEY="/usr/NX/share/client.id_dsa.key"
 
 ENABLE_NOMACHINE_FORWARD="0"
 NOMACHINE_SERVER="/usr/NX/bin/nxserver"



1.24      +8 -1      freenx/nxserver


rev 1.24, prev_rev 1.23
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.23
retrieving revision 1.24
diff -u -r1.23 -r1.24
--- nxserver	14 Feb 2005 17:46:06 -0000	1.23
+++ nxserver	2 Mar 2005 14:17:43 -0000	1.24
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.23 2005/02/14 17:46:06 jonno Exp $
+# CVS: $Id: nxserver,v 1.24 2005/03/02 14:17:43 fabianx Exp $
 #
 
 # Read the config file
@@ -415,6 +415,13 @@
 
 # Start!
 log "-- NX SERVER START: $@"
+
+if [ "$ENABLE_SERVER_FORWARD" = "1" -a -n "$SERVER_FORWARD_HOST" ]
+then
+	log "Forwarding connection to $SERVER_FORWARD_HOST with secret key $SERVER_FORWARD_KEY."
+	ssh -i "$SERVER_FORWARD_KEY" nx@"$SERVER_FORWARD_HOST"
+	exit 0
+fi
 
 echo_x "HELLO NXSERVER - Version $NX_VERSION $NX_LICENSE"
 






From freenx-cvs at berlios.de  Sun Mar  6 14:12:19 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 06 Mar 2005 14:12:19 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <422B01B3.mailOCC194NHM@lists.berlios.de>

User:      fabianx
Date:      2005-03-06 13:12:19 GMT
Modified:  .        ChangeLog nxloadconfig
Log:
Opened the 0.4.0 branch.

Revision  Changes    Path
1.17      +4 -1      freenx/ChangeLog


rev 1.17, prev_rev 1.16
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16
retrieving revision 1.17
diff -u -r1.16 -r1.17
--- ChangeLog	2 Mar 2005 14:17:43 -0000	1.16
+++ ChangeLog	6 Mar 2005 13:12:19 -0000	1.17
@@ -1,4 +1,7 @@
-14.02.2005 FreeNX 0.3.0-WIP
+06.03.2005 FreeNX 0.4.0-CVS
+	* Opened the 0.4.0 branch.
+
+05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.
 	* Added unix-default as session type - by Kalev Lember 
 	  <kalev at smartlink.ee>



1.5       +2 -2      freenx/nxloadconfig


rev 1.5, prev_rev 1.4
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -r1.4 -r1.5
--- nxloadconfig	2 Mar 2005 14:17:43 -0000	1.4
+++ nxloadconfig	6 Mar 2005 13:12:19 -0000	1.5
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.4 2005/03/02 14:17:43 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.5 2005/03/06 13:12:19 fabianx Exp $
 #
 # ========================================================================
 
@@ -14,7 +14,7 @@
 # DO NOT TOUCH unless you REALLY know what you are doing
 #########################################################################
 
-NX_VERSION=1.4.0-03-CVS
+NX_VERSION=1.4.0-04-CVS
 NX_LICENSE="OS (GPL)"
 
 # Where can different nx components be found






From freenx-cvs at berlios.de  Sun Mar  6 16:26:01 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 06 Mar 2005 16:26:01 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <422B2109.mail51V1VVANA@lists.berlios.de>

User:      fabianx
Date:      2005-03-06 15:26:01 GMT
Modified:  .        nxnode nxserver
Log:
Added initial support for filesharing via samba.

Revision  Changes    Path
1.24      +26 -7     freenx/nxnode


rev 1.24, prev_rev 1.23
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.23
retrieving revision 1.24
diff -u -r1.23 -r1.24
--- nxnode	17 Feb 2005 15:59:31 -0000	1.23
+++ nxnode	6 Mar 2005 15:26:01 -0000	1.24
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.23 2005/02/17 15:59:31 fabianx Exp $
+# CVS: $Id: nxnode,v 1.24 2005/03/06 15:26:01 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -57,6 +57,8 @@
 getparam_sessionid()
 {
 	sessionid=$(getparam sessionid)
+	
+	[ -n "$sessionid" ] || sessionid=$(getparam session_id)
 	[ -n "$sessionid" ] || node_abort "NX> 500 Error: missing parameter session id"
 	echo $sessionid
 }
@@ -223,6 +225,15 @@
 	[ -n "$PROXY_PID" ] && kill $PROXY_PID 2>/dev/null
 }
 
+node_umount_smb()
+{
+	[ -e "$HOME/.nx/C-$sess_id/scripts/mpoint" ] || return
+	cat "$HOME/.nx/C-$sess_id/scripts/mpoint" | while read mpoint
+	do
+		smbumount "$mpoint" >/dev/null 2>/dev/null
+	done
+}
+
 #
 # Monitoring the nxagent: Its also kind of a "state-machine" 
 #                         as it has to keep track of different 
@@ -284,7 +295,10 @@
 		if stringinstring "Info: Going to sleep waiting for reconnection." "$line"
 		then
 			kill $TAIL_PID 2>/dev/null
+			
 			echo "NX> 1005 Session status: suspended"
+			# umount shares 
+			node_umount_smb
 			break
 		fi
 
@@ -308,7 +322,6 @@
 			kill $PROXY_PID 2>/dev/null
 		fi
 		
-		# TODO: Kill also waiting smbmount processes
 		if stringinstring "Info: Waiting for a further signal to complete." "$line" && [ "$RECONNECT" = "0" ]
 		then
 			kill $TAIL_PID 2>/dev/null
@@ -319,6 +332,9 @@
 			sleep 2
 			kill -9 $PROXY_PID 2>/dev/null
 
+			# umount shares 
+			node_umount_smb
+
 			# kill the session
 			node_terminate_session "$sess_id"
 			
@@ -549,14 +565,17 @@
 	password=$(getparam password)
 	share=$(getparam share)
 	computername=$(getparam computername)
-	dir=$(getparam dir | sed 's|$(SHARES)|~/MyShares|g')
+	dir=$(getparam dir | sed 's|$(SHARES)|MyShares|g')
 	rdir=$(getparam dir | sed 's|$(SHARES)/||g')
 	display=$(cd $HOME/.nx/; echo C-$SERVER_NAME-*-$sessionid | cut -d"-" -f3)
-	mkdir -p $dir
-	$COMMAND_SMBMOUNT //$computername/$rdir $HOME/$dir -o username $username ip 127.0.0.1 port $port
+	mkdir -p "$HOME/$dir"
+	ERROR=$(PASSWD="$password" "$COMMAND_SMBMOUNT" "//$computername/$rdir" "$HOME/$dir" -o username="$username" ip="127.0.0.1" port="$port" 2>&1)
 	if [ $? -eq 0 ]
 	then
-		$PATH_BIN/nxclient -dialog ok -caption "NXServer Message" -message "Info: Share: '//$computername/$rdir' mounted on: '$HOME/$dir'" -noautokill -display :$display
+		$PATH_BIN/nxclient -dialog ok -caption "NXServer Message" -message "Info: Share: '//$computername/$rdir' mounted on: '$HOME/$dir'" -noautokill -display :$display &
+		echo "$HOME/$dir" >> "$HOME/.nx/C-$SERVER_NAME-$display-$sessionid/scripts/mpoint"
+	else
+		$PATH_BIN/nxclient -dialog ok -caption "NXServer Message" -message "Info: Share: '//$computername/$rdir' failed to mount: $ERROR" -noautokill -display :$display &
 	fi
 }
 
@@ -574,7 +593,7 @@
 		cmd_node_suspend
 	;;
 	--smbmount)
-		cmd_node_smbmount
+		cmd_node_smbmount >/dev/null 2>/dev/null
 	;;
 	--check)
 		echo "NX> 716 finished"



1.25      +5 -4      freenx/nxserver


rev 1.25, prev_rev 1.24
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.24
retrieving revision 1.25
diff -u -r1.24 -r1.25
--- nxserver	2 Mar 2005 14:17:43 -0000	1.24
+++ nxserver	6 Mar 2005 15:26:01 -0000	1.25
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.24 2005/03/02 14:17:43 fabianx Exp $
+# CVS: $Id: nxserver,v 1.25 2005/03/06 15:26:01 fabianx Exp $
 #
 
 # Read the config file
@@ -825,15 +825,16 @@
 				echo_x "NX> 500 ERROR: current password doesn't match"
 			fi
 		;;
-		smbmount*)
+		addmount*)
 			server_get_params $CMD
 			PARAMS=$SERVER_PARAMS
-			server_nxnode_start --smbmount "$PARAMS"
+			server_nxnode_start --smbmount "$USER" "$PARAMS" >/dev/null 2>&1
+			echo_x "NX> 719 SMB filesystem: running"
 		;;
 		addprintercups*)
 			server_get_params $CMD
 			PARAMS=$SERVER_PARAMS
-			server_nxnode_start --addprintercups "$PARAMS"
+			server_nxnode_start --addprintercups "$USER" "$PARAMS" >/dev/null 2>&1
 		;;
 		*)
 			# disabled for 1.4.0-5 snapshot client






From freenx-cvs at berlios.de  Sun Mar  6 16:45:01 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 06 Mar 2005 16:45:01 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxserver
Message-ID: <422B257D.mail5OJ1VAOJ6@lists.berlios.de>

User:      fabianx
Date:      2005-03-06 15:45:01 GMT
Modified:  .        nxserver
Log:
Implemented DISPLAY_LIMIT variable.

Revision  Changes    Path
1.26      +10 -2     freenx/nxserver


rev 1.26, prev_rev 1.25
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.25
retrieving revision 1.26
diff -u -r1.25 -r1.26
--- nxserver	6 Mar 2005 15:26:01 -0000	1.25
+++ nxserver	6 Mar 2005 15:45:01 -0000	1.26
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.25 2005/03/06 15:26:01 fabianx Exp $
+# CVS: $Id: nxserver,v 1.26 2005/03/06 15:45:01 fabianx Exp $
 #
 
 # Read the config file
@@ -668,6 +668,7 @@
 	then
 		# start nxnode
 		SESS_DISPLAY=$DISPLAY_BASE
+		let SESS_DISPLAY_LIMIT=$DISPLAY_BASE+$DISPLAY_LIMIT
 	
 		# stupid but working algo ...
 			
@@ -677,7 +678,14 @@
 		do
 			let SESS_DISPLAY=$SESS_DISPLAY+1
 		done
-	
+		
+		if [ "$SESS_DISPLAY" -gt "$SESS_DISPLAY_LIMIT" ]
+		then
+			# fixme we need the correct error code
+			echo_x "NX> 504 Error: Display limit exceeded. Please remove some files from /tmp/.X*-lock."
+			return
+		fi
+
 		uniqueid=$(echo $[$RANDOM*$RANDOM] | md5sum | cut -d" " -f1 | tr "[a-z]" "[A-Z]")
 		FULL_PARAMS="user=$USER&userip=$USERIP&uniqueid=$uniqueid&display=$SESS_DISPLAY&$PARAMS"
 		log "$FULL_PARAMS"






From freenx-cvs at berlios.de  Mon Mar  7 00:52:49 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Mon, 07 Mar 2005 00:52:49 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <422B97D1.mailQ11YA638@lists.berlios.de>

User:      fabianx
Date:      2005-03-06 23:52:49 GMT
Modified:  .        ChangeLog nxnode
Log:
Added support for AGENT_FONT_SERVER directive to nxnode.

Revision  Changes    Path
1.18      +1 -0      freenx/ChangeLog


rev 1.18, prev_rev 1.17
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.17
retrieving revision 1.18
diff -u -r1.17 -r1.18
--- ChangeLog	6 Mar 2005 13:12:19 -0000	1.17
+++ ChangeLog	6 Mar 2005 23:52:48 -0000	1.18
@@ -1,5 +1,6 @@
 06.03.2005 FreeNX 0.4.0-CVS
 	* Opened the 0.4.0 branch.
+	* Improvements to be more node.conf compatible.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.25      +4 -2      freenx/nxnode


rev 1.25, prev_rev 1.24
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.24
retrieving revision 1.25
diff -u -r1.24 -r1.25
--- nxnode	6 Mar 2005 15:26:01 -0000	1.24
+++ nxnode	6 Mar 2005 23:52:48 -0000	1.25
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.24 2005/03/06 15:26:01 fabianx Exp $
+# CVS: $Id: nxnode,v 1.25 2005/03/06 23:52:48 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -204,8 +204,10 @@
 			# nxproxy single application mode session
 			$PATH_BIN/nxproxy -C :$display $PROXY_EXTRA_OPTIONS 2>>~/.nx/C-$sess_id/session &
 		else
+			FP=""
+			[ -n "$AGENT_FONT_SERVER" ] && FP="-fp $AGENT_FONT_SERVER"
 			# nxagent session
-			$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $B :$display $AGENT_EXTRA_OPTIONS_X 2>>~/.nx/C-$sess_id/session &
+			$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>~/.nx/C-$sess_id/session &
 		fi
 	fi
 	fi






From freenx-cvs at berlios.de  Mon Mar  7 00:54:33 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Mon, 07 Mar 2005 00:54:33 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified ChangeLog
Message-ID: <422B9839.mail2UY115OZL@lists.berlios.de>

User:      fabianx
Date:      2005-03-06 23:54:33 GMT
Modified:  .        ChangeLog
Log:
Added initial support for filesharing via samba. (ChangeLog entry)

Revision  Changes    Path
1.19      +1 -0      freenx/ChangeLog


rev 1.19, prev_rev 1.18
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.18
retrieving revision 1.19
diff -u -r1.18 -r1.19
--- ChangeLog	6 Mar 2005 23:52:48 -0000	1.18
+++ ChangeLog	6 Mar 2005 23:54:33 -0000	1.19
@@ -1,5 +1,6 @@
 06.03.2005 FreeNX 0.4.0-CVS
 	* Opened the 0.4.0 branch.
+	* Added initial support for filesharing via samba.
 	* Improvements to be more node.conf compatible.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"






From freenx-cvs at berlios.de  Mon Mar  7 01:19:40 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Mon, 07 Mar 2005 01:19:40 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <422B9E1C.mailD231DZ05F@lists.berlios.de>

User:      fabianx
Date:      2005-03-07 00:19:40 GMT
Modified:  .        ChangeLog nxnode nxserver
Log:
Fixed unix-custom mode; now allowing parameters to be passed.

This means: "kontact --nofork" will now actually work.

Revision  Changes    Path
1.20      +1 -0      freenx/ChangeLog


rev 1.20, prev_rev 1.19
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.19
retrieving revision 1.20
diff -u -r1.19 -r1.20
--- ChangeLog	6 Mar 2005 23:54:33 -0000	1.19
+++ ChangeLog	7 Mar 2005 00:19:39 -0000	1.20
@@ -2,6 +2,7 @@
 	* Opened the 0.4.0 branch.
 	* Added initial support for filesharing via samba.
 	* Improvements to be more node.conf compatible.
+	* Fixed unix-custom mode; now allowing parameters to be passed.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.26      +2 -2      freenx/nxnode


rev 1.26, prev_rev 1.25
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.25
retrieving revision 1.26
diff -u -r1.25 -r1.26
--- nxnode	6 Mar 2005 23:52:48 -0000	1.25
+++ nxnode	7 Mar 2005 00:19:39 -0000	1.26
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.25 2005/03/06 23:52:48 fabianx Exp $
+# CVS: $Id: nxnode,v 1.26 2005/03/07 00:19:39 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -136,7 +136,7 @@
 			STARTX=$COMMAND_START_CDE
 		;;
 		unix-application)
-			STARTX=$(which $application)
+			STARTX=$application
 		;;
 		unix-default)
 			if [ -f "$HOME/.Xclients" ]; then



1.27      +2 -2      freenx/nxserver


rev 1.27, prev_rev 1.26
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.26
retrieving revision 1.27
diff -u -r1.26 -r1.27
--- nxserver	6 Mar 2005 15:45:01 -0000	1.26
+++ nxserver	7 Mar 2005 00:19:39 -0000	1.27
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.26 2005/03/06 15:45:01 fabianx Exp $
+# CVS: $Id: nxserver,v 1.27 2005/03/07 00:19:39 fabianx Exp $
 #
 
 # Read the config file
@@ -563,7 +563,7 @@
 
 server_get_params()
 {
-	SERVER_PARAMS=$(echo "$@" | sed "s/^$1//g; s/ --/\&/g; s/\"//g")
+	SERVER_PARAMS=$(echo "$@" | sed "s/^$1/\"/g; s/\" --/\&/g; s/\"//g")
 	if [ "$SERVER_PARAMS" = "" ]
 	then
 		echo_x -n "NX> 106 Parameters: "






From freenx-cvs at berlios.de  Tue Mar  8 13:24:48 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Tue, 08 Mar 2005 13:24:48 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxnode
Message-ID: <422D9990.mail1I61DEC3P@lists.berlios.de>

User:      fabianx
Date:      2005-03-08 12:24:48 GMT
Modified:  .        nxnode
Log:
Prepare support for later CUPS integration.

Revision  Changes    Path
1.27      +2 -3      freenx/nxnode


rev 1.27, prev_rev 1.26
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.26
retrieving revision 1.27
diff -u -r1.26 -r1.27
--- nxnode	7 Mar 2005 00:19:39 -0000	1.26
+++ nxnode	8 Mar 2005 12:24:48 -0000	1.27
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.26 2005/03/07 00:19:39 fabianx Exp $
+# CVS: $Id: nxnode,v 1.27 2005/03/08 12:24:48 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -466,7 +466,6 @@
 	# write options file
 	[ -z "$samba" ] && samba=0
 	[ -z "$media" ] && media=0
-	[ -z "$sync" ] && sync=0
 
 	CACHE="cache=$cache,"
 	[ -z "$cache" ] && CACHE=""
@@ -477,7 +476,7 @@
 	umask 0077
 
 cat << EOF > ~/.nx/C-$sess_id/options
-${kbtype:+kbtype=$kbtype,}${CACHE}${IMAGES}${PACK}link=$link,type=$type,cleanup=0,accept=$userip,cookie=$proxy_cookie,id=$sess_id,samba=$samba,media=$media,sync=$sync:$display
+${kbtype:+kbtype=$kbtype,}${CACHE}${IMAGES}${PACK}link=$link,type=$type,cleanup=0,accept=$userip,cookie=$proxy_cookie,id=$sess_id,samba=$samba,media=$media${sync:+,sync=$sync}${cups:+,cups=$cups}:$display
 EOF
 	umask $OLD_UMASK
 #samba=$samba,






From freenx-cvs at berlios.de  Tue Mar  8 15:27:55 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Tue, 08 Mar 2005 15:27:55 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <422DB66B.mail8GN1CK9SO@lists.berlios.de>

User:      fabianx
Date:      2005-03-08 14:27:55 GMT
Modified:  .        node.conf.sample nxloadconfig nxnode
Log:
Initial support for Sound using ESD for Windows NX Client.

New config file directives:

ENABLE_ESD_PRELOAD="0"
ESD_BIN_PRELOAD="esddsp"

Revision  Changes    Path
1.5       +12 -1     freenx/node.conf.sample


rev 1.5, prev_rev 1.4
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -r1.4 -r1.5
--- node.conf.sample	2 Mar 2005 14:17:43 -0000	1.4
+++ node.conf.sample	8 Mar 2005 14:27:55 -0000	1.5
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.4 2005/03/02 14:17:43 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.5 2005/03/08 14:27:55 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -116,6 +116,17 @@
 
 # When set to 1 will start nxagent in rootless mode.
 #ENABLE_ROOTLESS_MODE="0"
+
+# FreeNX with ENABLE_ESD_PRELOAD="1" will automatically try to setup 
+# the sound with the help of the esd media helper.
+#
+# Currently ESD will be used just by the Windows NX Client.
+#
+# Be sure that $ESD_BIN_PRELOAD is in your path, does exist and work 
+# before enabling this directive.
+
+#ENABLE_ESD_PRELOAD="0"
+#ESD_BIN_PRELOAD="esddsp"
 
 #########################################################################
 # NoMachine node.conf compatible (almost) directives



1.6       +6 -1      freenx/nxloadconfig


rev 1.6, prev_rev 1.5
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -r1.5 -r1.6
--- nxloadconfig	6 Mar 2005 13:12:19 -0000	1.5
+++ nxloadconfig	8 Mar 2005 14:27:55 -0000	1.6
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.5 2005/03/06 13:12:19 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.6 2005/03/08 14:27:55 fabianx Exp $
 #
 # ========================================================================
 
@@ -62,6 +62,11 @@
 NOMACHINE_NX_HOME_DIR="/usr/NX/home/nx"
 
 ENABLE_ROOTLESS_MODE="0"
+
+ENABLE_ESD_PRELOAD="0"
+ESD_BIN_PRELOAD="esddsp"
+
+# NoMachine node.conf compatible vars
 
 SSHD_CHECK_IP="0"
 SSHD_PORT=22



1.28      +23 -1     freenx/nxnode


rev 1.28, prev_rev 1.27
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.27
retrieving revision 1.28
diff -u -r1.27 -r1.28
--- nxnode	8 Mar 2005 12:24:48 -0000	1.27
+++ nxnode	8 Mar 2005 14:27:55 -0000	1.28
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.27 2005/03/08 12:24:48 fabianx Exp $
+# CVS: $Id: nxnode,v 1.28 2005/03/08 14:27:55 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -148,6 +148,27 @@
 	esac
 	[ -n "$STARTX" ] || return
 
+	if [ "$mediahelper" = "esd" ]
+	then
+		# Set Espeaker variable
+		let ESPEAKER=$display+7000
+		export ESPEAKER="127.0.0.1:$ESPEAKER"
+		
+		# Check for config file directive
+		if [ "$ENABLE_ESD_PRELOAD" = "1" ]
+		then
+			STARTX="$ESD_BIN_PRELOAD $STARTX"
+			
+			# Do not spawn new ESD daemons
+			export ESD_NO_SPAWN="yes"
+			
+			echo "Info: NXNODE - Using $ESD_BIN_PRELOAD wrapper script." >> ~/.nx/C-$sess_id/session
+		fi
+	elif [ "$mediahelper" = "arts" ]
+	then
+		echo "Error: NXNODE - No support for artsd, yet." >> ~/.nx/C-$sess_id/session
+	fi
+
 	DISPLAY=unix:$display $STARTX >>~/.nx/C-$sess_id/session 2>&1 &
 	APP_PID=$!
 	mkdir -p ~/.nx/C-$sess_id/pids/
@@ -436,6 +457,7 @@
 	keyboard=$(getparam keyboard)
 	kbtype=$(getparam kbtype)
 	media=$(getparam media)
+	mediahelper=$(getparam mediahelper)
 	sync=$(getparam sync)
 	samba=$(getparam samba)
 	agent_server=$(getparam agent_server)






From freenx-cvs at berlios.de  Wed Mar  9 12:45:16 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Wed, 09 Mar 2005 12:45:16 +0100
Subject: [Freenx-cvs] CVS: nxc - fabianx modified 3 files
Message-ID: <422EE1CC.mail5BB1O7DNJ@lists.berlios.de>

User:      fabianx
Date:      2005-03-09 11:45:15 GMT
Log:
Initial import into CVS.

Status:

Vendor Tag:	FreeNX-Team
Release Tags:	start

N nxc/nxc.dsw
N nxc/nxc.ncb
N nxc/nxc.opt
N nxc/moznx/Makefile
N nxc/moznx/resource.h
N nxc/moznx/plugin.cpp
N nxc/moznx/npmoznx.dsp
N nxc/moznx/npmoznx.plg
N nxc/moznx/Makefile.in
N nxc/moznx/nx.def
N nxc/moznx/moznx.rc
N nxc/moznx/plugin.h
N nxc/nxrun/NEWS
N nxc/nxrun/Main.cpp
N nxc/nxrun/ConsoleCallback.Po
N nxc/nxrun/depcomp
N nxc/nxrun/Makefile
N nxc/nxrun/ConsoleCallback.h
N nxc/nxrun/resource.h
N nxc/nxrun/aclocal.m4
N nxc/nxrun/config.status
N nxc/nxrun/README
N nxc/nxrun/ltmain.sh
N nxc/nxrun/configure
N nxc/nxrun/output.txt
N nxc/nxrun/libtool
N nxc/nxrun/client.id_dsa.key
N nxc/nxrun/configure.in
N nxc/nxrun/config.guess
N nxc/nxrun/install-sh
N nxc/nxrun/autogen.sh
N nxc/nxrun/config.log
N nxc/nxrun/config.sub
N nxc/nxrun/missing
N nxc/nxrun/CHANGELOG
N nxc/nxrun/mkinstalldirs
N nxc/nxrun/config.h
N nxc/nxrun/Makefile.am
N nxc/nxrun/Makefile.in
N nxc/nxrun/ConsoleCallback.cpp
N nxc/nxrun/config.h.in
N nxc/nxrun/stamp-h1
N nxc/nxrun/AUTHORS
N nxc/nxrun/MainUnix.cpp
N nxc/nxrun/nxrun.dsp
N nxc/nxrun/nxrun.plg
N nxc/nxrun/INSTALL
N nxc/nxrun/make_nxrun.tgz.sh
N nxc/nxrun/COPYING
N nxc/nxcompsh/ParameterItem.h
N nxc/nxcompsh/NEWS
N nxc/nxcompsh/libXcompsh.pc.in
N nxc/nxcompsh/StringUtilities.cpp
N nxc/nxcompsh/depcomp
N nxc/nxcompsh/Makefile
N nxc/nxcompsh/NXErrors.h
N nxc/nxcompsh/nxcompsh.dsp
N nxc/nxcompsh/nxcompsh.dsw
N nxc/nxcompsh/nxcompsh.ncb
N nxc/nxcompsh/nxcompsh.opt
N nxc/nxcompsh/nxcompsh.plg
N nxc/nxcompsh/MD5.c
N nxc/nxcompsh/MD5.h
N nxc/nxcompsh/NXParameters.h
N nxc/nxcompsh/Media.cpp
N nxc/nxcompsh/Protocol.h
N nxc/nxcompsh/aclocal.m4
N nxc/nxcompsh/config.status
N nxc/nxcompsh/README
N nxc/nxcompsh/Cookie.h
N nxc/nxcompsh/ltmain.sh
N nxc/nxcompsh/configure
N nxc/nxcompsh/libtool
N nxc/nxcompsh/ProcessUnix.cpp
N nxc/nxcompsh/configure.in
N nxc/nxcompsh/Proxy.h
N nxc/nxcompsh/Process.h
N nxc/nxcompsh/ParametersList.cpp
N nxc/nxcompsh/SessionInterface.cpp
N nxc/nxcompsh/config.guess
N nxc/nxcompsh/make_nxcompsh.tgz.sh
N nxc/nxcompsh/NXCompSh.h
N nxc/nxcompsh/install-sh
N nxc/nxcompsh/autogen.sh
N nxc/nxcompsh/Session.cpp
N nxc/nxcompsh/Transport.cpp
N nxc/nxcompsh/config.log
N nxc/nxcompsh/config.sub
N nxc/nxcompsh/missing
N nxc/nxcompsh/Logger.h
N nxc/nxcompsh/Samba.cpp
N nxc/nxcompsh/Exception.cpp
N nxc/nxcompsh/mkinstalldirs
N nxc/nxcompsh/config.h
N nxc/nxcompsh/Exception.h
N nxc/nxcompsh/Makefile.am
N nxc/nxcompsh/Makefile.in
N nxc/nxcompsh/Samba.h
N nxc/nxcompsh/TransportSSH.h
N nxc/nxcompsh/Transport.h
N nxc/nxcompsh/config.h.in
N nxc/nxcompsh/NXStates.h
N nxc/nxcompsh/ProcessWin32.h
N nxc/nxcompsh/Proxy.cpp
N nxc/nxcompsh/Cookie.cpp
N nxc/nxcompsh/StringUtilities.h
N nxc/nxcompsh/XServer.cpp
N nxc/nxcompsh/ParametersList.h
N nxc/nxcompsh/Media.h
N nxc/nxcompsh/stamp-h1
N nxc/nxcompsh/Utilities.h
N nxc/nxcompsh/AUTHORS
N nxc/nxcompsh/INSTALL
N nxc/nxcompsh/libXcompsh.pc
N nxc/nxcompsh/TransportSSH.cpp
N nxc/nxcompsh/Utilities.cpp
N nxc/nxcompsh/XInterface.cpp
N nxc/nxcompsh/ChangeLog
N nxc/nxcompsh/COPYING
N nxc/nxcompsh/XServer.h
N nxc/nxcompsh/XInterface.h
N nxc/nxcompsh/ProcessUnix.h
N nxc/nxcompsh/SessionInterface.h
N nxc/nxcompsh/Process.cpp
N nxc/nxcompsh/Session.h
N nxc/nxcompsh/Protocol.cpp
N nxc/nxcompsh/ProcessWin32.cpp
N nxc/nxdriver/NEWS
N nxc/nxdriver/depcomp
N nxc/nxdriver/Makefile
N nxc/nxdriver/resource.h
N nxc/nxdriver/aclocal.m4
N nxc/nxdriver/CallbackMessageTypes.h
N nxc/nxdriver/config.status
N nxc/nxdriver/README
N nxc/nxdriver/ltmain.sh
N nxc/nxdriver/configure
N nxc/nxdriver/NXSettings.h
N nxc/nxdriver/libtool
N nxc/nxdriver/Options.h
N nxc/nxdriver/configure.in
N nxc/nxdriver/CallbackInterface.h
N nxc/nxdriver/config.guess
N nxc/nxdriver/make_nxcompsh.tgz.sh
N nxc/nxdriver/NXDriver.h
N nxc/nxdriver/install-sh
N nxc/nxdriver/autogen.sh
N nxc/nxdriver/config.log
N nxc/nxdriver/config.sub
N nxc/nxdriver/missing
N nxc/nxdriver/nxdriver.dsp
N nxc/nxdriver/nxdriver.plg
N nxc/nxdriver/mkinstalldirs
N nxc/nxdriver/config.h
N nxc/nxdriver/NXDriver.cpp
N nxc/nxdriver/Makefile.am
N nxc/nxdriver/Makefile.in
N nxc/nxdriver/NXSettings.cpp
N nxc/nxdriver/config.h.in
N nxc/nxdriver/libXdriver.pc.in
N nxc/nxdriver/SettingsToParameters.cpp
N nxc/nxdriver/NXRunVersion.h
N nxc/nxdriver/stamp-h1
N nxc/nxdriver/AUTHORS
N nxc/nxdriver/libXdriver.pc
N nxc/nxdriver/SettingsToParameters.h
N nxc/nxdriver/Options.cpp
N nxc/nxdriver/NXConnection.h
N nxc/nxdriver/INSTALL
N nxc/nxdriver/NXConnection.cpp
N nxc/nxdriver/ChangeLog
N nxc/nxdriver/COPYING
N nxc/nxdriver/autom4te.cache/requests
N nxc/nxdriver/autom4te.cache/output.0
N nxc/nxdriver/autom4te.cache/traces.0
N nxc/nxdriverdll/nxdriverdll.dsp
N nxc/nxdriverdll/nxdriverdll.plg

No conflicts created by this import



From freenx-cvs at berlios.de  Thu Mar 10 12:00:26 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Thu, 10 Mar 2005 12:00:26 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 4 files
Message-ID: <423028CA.mail75V1XDT17@lists.berlios.de>

User:      fabianx
Date:      2005-03-10 11:00:26 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxserver
Log:
Made "netcat" command configurable.

Added COMMAND_NETCAT config file directive.

Revision  Changes    Path
1.21      +1 -0      freenx/ChangeLog


rev 1.21, prev_rev 1.20
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.20
retrieving revision 1.21
diff -u -r1.20 -r1.21
--- ChangeLog	7 Mar 2005 00:19:39 -0000	1.20
+++ ChangeLog	10 Mar 2005 11:00:25 -0000	1.21
@@ -3,6 +3,7 @@
 	* Added initial support for filesharing via samba.
 	* Improvements to be more node.conf compatible.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
+	* Added COMMAND_NETCAT directive
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.6       +4 -1      freenx/node.conf.sample


rev 1.6, prev_rev 1.5
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.5
retrieving revision 1.6
diff -u -r1.5 -r1.6
--- node.conf.sample	8 Mar 2005 14:27:55 -0000	1.5
+++ node.conf.sample	10 Mar 2005 11:00:25 -0000	1.6
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.5 2005/03/08 14:27:55 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.6 2005/03/10 11:00:25 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -127,6 +127,9 @@
 
 #ENABLE_ESD_PRELOAD="0"
 #ESD_BIN_PRELOAD="esddsp"
+
+# The key that contains the name of the complete path of the 'netcat' command. 
+#COMMAND_NETCAT=netcat
 
 #########################################################################
 # NoMachine node.conf compatible (almost) directives



1.7       +3 -1      freenx/nxloadconfig


rev 1.7, prev_rev 1.6
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.6
retrieving revision 1.7
diff -u -r1.6 -r1.7
--- nxloadconfig	8 Mar 2005 14:27:55 -0000	1.6
+++ nxloadconfig	10 Mar 2005 11:00:25 -0000	1.7
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.6 2005/03/08 14:27:55 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.7 2005/03/10 11:00:25 fabianx Exp $
 #
 # ========================================================================
 
@@ -65,6 +65,8 @@
 
 ENABLE_ESD_PRELOAD="0"
 ESD_BIN_PRELOAD="esddsp"
+
+COMMAND_NETCAT=netcat
 
 # NoMachine node.conf compatible vars
 



1.28      +2 -2      freenx/nxserver


rev 1.28, prev_rev 1.27
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.27
retrieving revision 1.28
diff -u -r1.27 -r1.28
--- nxserver	7 Mar 2005 00:19:39 -0000	1.27
+++ nxserver	10 Mar 2005 11:00:25 -0000	1.28
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.27 2005/03/07 00:19:39 fabianx Exp $
+# CVS: $Id: nxserver,v 1.28 2005/03/10 11:00:25 fabianx Exp $
 #
 
 # Read the config file
@@ -744,7 +744,7 @@
 			if [ "$ENCRYPTION" = "1" ] 
 			then 
 				let PROXY_DISPLAY=$SESS_DISPLAY+4000
-				netcat 127.0.0.1 $PROXY_DISPLAY
+				$COMMAND_NETCAT 127.0.0.1 $PROXY_DISPLAY
 				exit 0
 			else
 				echo_x "NX> 1001 Bye."






From freenx-cvs at berlios.de  Thu Mar 10 13:47:49 2005
From: freenx-cvs at berlios.de (jonno)
Date: Thu, 10 Mar 2005 13:47:49 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 2 files
Message-ID: <423041F5.mailAZQ1JX7MO@lists.berlios.de>

User:      jonno
Date:      2005-03-10 12:47:49 GMT
Modified:  .        ChangeLog nxloadconfig
Log:
Added support for 'nxloadconfig --check' to validate node.conf settings

Revision  Changes    Path
1.22      +1 -0      freenx/ChangeLog


rev 1.22, prev_rev 1.21
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.21
retrieving revision 1.22
diff -u -r1.21 -r1.22
--- ChangeLog	10 Mar 2005 11:00:25 -0000	1.21
+++ ChangeLog	10 Mar 2005 12:47:48 -0000	1.22
@@ -4,6 +4,7 @@
 	* Improvements to be more node.conf compatible.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Added COMMAND_NETCAT directive
+	* Added support for 'nxloadconfig --check' to validate node.conf settings
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.8       +202 -2    freenx/nxloadconfig


rev 1.8, prev_rev 1.7
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -r1.7 -r1.8
--- nxloadconfig	10 Mar 2005 11:00:25 -0000	1.7
+++ nxloadconfig	10 Mar 2005 12:47:48 -0000	1.8
@@ -5,11 +5,46 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.7 2005/03/10 11:00:25 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.8 2005/03/10 12:47:48 jonno Exp $
 #
 # ========================================================================
 
 #########################################################################
+# Commandline support for --help, --check and --userconf
+#######################################################################
+
+HELP="no"
+CHECK="no"
+USERCONF="no"
+
+while [ "$1" ]
+do
+	case "$1" in
+		--help) HELP="yes"; shift ;;
+		--check) CHECK="yes"; shift ;;
+		--userconf) USERCONF="yes" ; 
+					case "$2" in
+						"" | --*) shift ;;
+						*) USER=$2 ; shift 2 ;;
+					esac ;;
+		--) shift ; break ;;
+		*) echo "Invalid flag $1" ; HELP="yes"; shift ; break ;;
+	esac
+done
+
+if [ "$HELP" = "yes" ]
+then
+	echo "nxloadconfig - Load the FreeNX configuration variables into the environment."
+	echo "Syntax: nxloadconfig --help"
+	echo "        nxloadconfig [--check] [--userconf [<username>]]"
+	echo
+	echo "  --check                  Write errors to standard output."
+	echo "  --userconf [<username>]  Parse <username>.node.conf as well as node.conf."
+	echo "                           Assume current user if no username is specified."
+	exit 0
+fi
+
+#########################################################################
 # INTERNAL STUFF
 # DO NOT TOUCH unless you REALLY know what you are doing
 #########################################################################
@@ -123,7 +158,7 @@
 #########################################################################
 
 [ -e $NX_ETC_DIR/node.conf ] && . $NX_ETC_DIR/node.conf
-[ "$1" = "--userconf" -a -e $NX_ETC_DIR/$USER.node.conf ] && . $NX_ETC_DIR/$USER.node.conf
+[ "$USERCONF" = "yes" -a -e $NX_ETC_DIR/$USER.node.conf ] && . $NX_ETC_DIR/$USER.node.conf
 
 #########################################################################
 # Calculated values
@@ -136,3 +171,168 @@
 [ -z "$PROXY_LIBRARY_PATH" ] && PROXY_LIBRARY_PATH=$PATH_LIB
 [ -z "$APPLICATION_LIBRARY_PATH" ] && APPLICATION_LIBRARY_PATH=$PATH_LIB
 [ -z "$APPLICATION_LIBRARY_PRELOAD" ] && APPLICATION_LIBRARY_PRELOAD="$APPLICATION_LIBRARY_PATH/libX11.so.6.2:$APPLICATION_LIBRARY_PATH/libXext.so.6.4:$APPLICATION_LIBRARY_PATH/libXcomp.so.1:$APPLICATION_LIBRARY_PATH/libXcompext.so.1:$APPLICATION_LIBRARY_PATH/libXrender.so.1.2"
+
+#########################################################################
+# Support for --check
+#########################################################################
+
+if [ "$CHECK" = "yes" ]
+then
+	ERROR="no"
+	WARNING="no"
+	
+	[ -z $(echo "$NX_LOGGING" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NX_LOGGING=$NX_LOGGING\""
+	[ "$NX_LOGGING" = "1" -a ! -e "$NX_LOGFILE" ] && \
+		WARNING="yes" && echo "Warning: Invalid value \"NX_LOGFILE=$NX_LOGFILE\"" \
+					  && echo "         No loggfile will be kept."
+		# How do I check if another user might write to a file? ( -w checks only current user)
+	[ -z $(echo "$SESSION_HISTORY" | egrep "^-?[0-9]*$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SESSION_HISTORY=$SESSION_HISTORY\""
+	
+	[ -z $(echo "$ENABLE_PASSDB_AUTHENTICATION" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_PASSDB_AUTHENTICATION=$ENABLE_PASSDB_AUTHENTICATION\""
+	[ -z $(echo "$ENABLE_SSH_AUTHENTICATION" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_SSH_AUTHENTICATION=$ENABLE_SSH_AUTHENTICATION:\""
+	[ -z $(echo "$ENABLE_SU_AUTHENTICATION" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_SU_AUTHENTICATION=$NENABLE_SU_AUTHENTICATION\""
+	[ -z $(echo "$ENABLE_USER_DB" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_USER_DB=$ENABLE_USER_DB\""
+	
+	[ -z $(echo "$ENABLE_AUTORECONNECT" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_AUTORECONNECT=$ENABLE_AUTORECONNECT\""
+	[ -z $(echo "$ENABLE_AUTORECONNECT_BEFORE_140" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_AUTORECONNECT_BEFORE_140=$ENABLE_AUTORECONNECT_BEFORE_140\""
+	
+	[ -z $(echo "$EXPORT_USERIP" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"EXPORT_USERIP=$EXPORT_USERIP\""
+	[ -z $(echo "$EXPORT_SESSIONID" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"EXPORT_SESSIONID=$EXPORT_SESSIONID\""
+	[ -n "$NODE_AUTOSTART" ] && ! which "$NODE_AUTOSTART" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"NODE_AUTOSTART=$NODE_AUTOSTART\"" \
+					  && echo "         No autostart will be performed."
+	
+	[ -z $(echo "$ENABLE_SERVER_FORWARD" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_SERVER_FORWARD=$ENABLE_SERVER_FORWARD\""
+	[ "$ENABLE_SERVER_FORWARD" = "1" -a -n "$SERVER_FORWARD_HOST" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SERVER_FORWARD_HOST=$SERVER_FORWARD_HOST\"" 
+		# Any ideas on how I can check for a VALID host is velcome!
+		# In my private scripts I use 'resolveip -q' and check if output conforms to [0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}, 
+		# but resolveip is part of mysql, and I don't think I should add that dependancy...
+	[ "$ENABLE_SERVER_FORWARD" = "1" -a ! -e "$SERVER_FORWARD_KEY" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SERVER_FORWARD_KEY=$SERVER_FORWARD_KEY\""
+	
+	[ -z $(echo "$ENABLE_NOMACHINE_FORWARD" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_NOMACHINE_FORWARD=$ENABLE_NOMACHINE_FORWARD\""
+	[ "$ENABLE_NOMACHINE_FORWARD" = "1" ] && ! which "$NOMACHINE_SERVER" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"NOMACHINE_SERVER=$NOMACHINE_SERVER\""
+	[ "$ENABLE_NOMACHINE_FORWARD" = "1" -a ! -d "$NOMACHINE_NX_HOME_DIR" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NOMACHINE_NX_HOME_DIR=$NOMACHINE_NX_HOME_DIR\""
+	
+	[ -z $(echo "$ENABLE_ROOTLESS_MODE" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_ROOTLESS_MODE=$ENABLE_ROOTLESS_MODE\""
+	
+	[ -z $(echo "$ENABLE_ESD_PRELOAD" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_ESD_PRELOAD=$ENABLE_ESD_PRELOAD\""
+	[ "$ENABLE_ESD_PRELOAD" = "1" ] && ! which "$ESD_BIN_PRELOAD" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"ESD_BIN_PRELOAD=$ESD_BIN_PRELOAD\"" \
+					  && echo "         No esd preload will be performed."
+	
+	[ -z "$SERVER_NAME" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SERVER_NAME=$SERVER_NAME\"" 
+	
+	[ -z $(echo "$SSHD_CHECK_IP" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SSHD_CHECK_IP=$SSHD_CHECK_IP\""
+	[ -z $(echo "$SSHD_PORT" | egrep "^[0-9]*$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SSHD_PORT=$SSHD_PORT\""
+	
+	[ -z $(echo "$DISPLAY_BASE" | egrep "^[0-9]*$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"DISPLAY_BASE=$DISPLAY_BASE\""
+		[ -z $(echo "$SESSION_LIMIT" | egrep "^[0-9]*$") ] &&  \
+			ERROR="yes" && echo "Error: Invalid value \"SESSION_LIMIT=$SESSION_LIMIT\""
+	[ -z $(echo "$SESSION_USER_LIMIT" | egrep "^[0-9]*$") -o $SESSION_USER_LIMIT -gt $SESSION_LIMIT ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SESSION_USER_LIMIT=$SESSION_USER_LIMIT\""
+	[ -z $(echo "$DISPLAY_LIMIT" | egrep "^[0-9]*$") -o $DISPLAY_LIMIT -lt $SESSION_LIMIT ] && \
+		ERROR="yes" && echo "Error: Invalid value \"DISPLAY_LIMIT=$DISPLAY_LIMIT\""
+	
+	! which "$DEFAULT_X_WM" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"DEFAULT_X_WM=$DEFAULT_X_WM\""
+	! which "$DEFAULT_X_SESSION" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"DEFAULT_X_SESSION=$DEFAULT_X_SESSION\""
+	! which "$COMMAND_START_KDE" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"COMMAND_START_KDE=$COMMAND_START_KDE\"" \
+					  && echo "         Users will not be able to request a KDE session."
+	! which "$COMMAND_START_GNOME" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"COMMAND_START_GNOME=$COMMAND_START_GNOME\"" \
+					  && echo "         Users will not be able to request a Gnome session."
+	! which "$COMMAND_START_CDE" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"COMMAND_START_CDE=$COMMAND_START_CDE\"" \
+					  && echo "         Users will not be able to request a CDE session."
+	! which "$COMMAND_XTERM" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"COMMAND_XTERM:=$COMMAND_XTERM:\"" \
+					  && echo "         Users will not be able to request an xterm session."
+	! which "$COMMAND_XAUTH" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_XAUTH=$COMMAND_XAUTH\""
+	! which "$COMMAND_XSET" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_XSET=$COMMAND_XSET\""
+	! which "$COMMAND_XMODMAP" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_XMODMAP=$COMMAND_XMODMAP\""
+	! which "$COMMAND_XKBCOMP" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_XKBCOMP=$COMMAND_XKBCOMP\""
+	[ ! -e "$XKBCOMP_KEYMAP_FILE" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"XKBCOMP_KEYMAP_FILE=$XKBCOMP_KEYMAP_FILE\""
+	! which "$COMMAND_SMBMOUNT" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_SMBMOUNT=$COMMAND_SMBMOUNT\""
+	! which "$COMMAND_SMBUMOUNT" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_SMBUMOUNT=$COMMAND_SMBUMOUNT\""
+	
+	OLD_IFS=$IFS
+	IFS=","
+	if [ "$ENABLE_PERSISTENT_SESSION" != "all" ]
+	then
+		for USERNAME in $ENABLE_PERSISTENT_SESSION; do
+			[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+				ERROR="yes" && echo "Error: Invalid value \"ENABLE_PERSISTENT_SESSION=$ENABLE_PERSISTENT_SESSION\"" && break ;
+		done
+	fi
+	for USERNAME in $DISABLE_PERSISTENT_SESSION; do
+		[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+			ERROR="yes" && echo "Error: Invalid value \"DISABLE_PERSISTENT_SESSION=$DISABLE_PERSISTENT_SESSION\"" && break ;
+	done
+	IFS=$OLD_IFS
+	
+	#AGENT_FONT_SERVER=""
+		#Any ideas on how I can check for a VALID host is velcome!
+	
+	[ -z $(echo "$CUPS_SUPPORT" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"CUPS_SUPPORT=$CUPS_SUPPORT\""
+	# CUPS_BACKEND=""
+		# As this isn't used yet I don't know how to realy check for it. Fix this when adding support!
+	[ "$CUPS_SUPPORT" = "1" -a ! -d "$CUPS_BIN" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"CUPS_BIN=$CUPS_BIN\""
+	[ "$CUPS_SUPPORT" = "1" -a ! -d "$CUPS_SBIN" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"CUPS_SBIN=$CUPS_SBIN\""
+	
+	[ ! -d "$AGENT_LIBRARY_PATH" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"AGENT_LIBRARY_PATH=$AGENT_LIBRARY_PATH\""
+	[ ! -d "$PROXY_LIBRARY_PATH" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"PROXY_LIBRARY_PATH=$PROXY_LIBRARY_PATH\""
+	[ ! -d "$APPLICATION_LIBRARY_PATH" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"APPLICATION_LIBRARY_PATH=$APPLICATION_LIBRARY_PATH\""
+	#APPLICATION_LIBRARY_PRELOAD=""
+		# As this isn't used yet I don't know how to realy check for it. Fix this when adding support!
+	
+	if [ "$ERROR" = "yes" ]
+	then
+		echo
+		echo "  Errors occured during config check."
+		echo "  Please correct the configuration file."
+		echo
+	elif [ "$WARNING" = "yes" ]
+	then
+		echo
+		echo "  Warnings occured during config check."
+		echo "  To enable these features please correct the configuration file."
+		echo
+	fi
+fi






From freenx-cvs at berlios.de  Thu Mar 10 13:59:37 2005
From: freenx-cvs at berlios.de (jonno)
Date: Thu, 10 Mar 2005 13:59:37 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 3 files
Message-ID: <423044B9.mailBKQ11LZ8Y@lists.berlios.de>

User:      jonno
Date:      2005-03-10 12:59:37 GMT
Modified:  .        node.conf.sample nxloadconfig nxserver
Log:
Added support to forward to non-standard ssh port (config directive SERVER_FORWARD_PORT)

Revision  Changes    Path
1.7       +2 -1      freenx/node.conf.sample


rev 1.7, prev_rev 1.6
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.6
retrieving revision 1.7
diff -u -r1.6 -r1.7
--- node.conf.sample	10 Mar 2005 11:00:25 -0000	1.6
+++ node.conf.sample	10 Mar 2005 12:59:37 -0000	1.7
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.6 2005/03/10 11:00:25 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.7 2005/03/10 12:59:37 jonno Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -96,6 +96,7 @@
 
 #ENABLE_SERVER_FORWARD="0"
 #SERVER_FORWARD_HOST=""
+#SERVER_FORWARD_PORT=22
 #SERVER_FORWARD_KEY="/usr/NX/share/client.id_dsa.key"
 
 # FreeNX with ENABLE_NOMACHINE_FORWARD="1" will automatically forward all



1.9       +4 -1      freenx/nxloadconfig


rev 1.9, prev_rev 1.8
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -r1.8 -r1.9
--- nxloadconfig	10 Mar 2005 12:47:48 -0000	1.8
+++ nxloadconfig	10 Mar 2005 12:59:37 -0000	1.9
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.8 2005/03/10 12:47:48 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.9 2005/03/10 12:59:37 jonno Exp $
 #
 # ========================================================================
 
@@ -90,6 +90,7 @@
 
 ENABLE_SERVER_FORWARD="0"
 SERVER_FORWARD_HOST=""
+SERVER_FORWARD_PORT=22
 SERVER_FORWARD_KEY="/usr/NX/share/client.id_dsa.key"
 
 ENABLE_NOMACHINE_FORWARD="0"
@@ -219,6 +220,8 @@
 		# Any ideas on how I can check for a VALID host is velcome!
 		# In my private scripts I use 'resolveip -q' and check if output conforms to [0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}, 
 		# but resolveip is part of mysql, and I don't think I should add that dependancy...
+	[ "$ENABLE_SERVER_FORWARD" = "1" -a -z $(echo "$SERVER_FORWARD_PORT" | egrep "^[0-9]*$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SERVER_FORWARD_PORT=$SERVER_FORWARD_PORT\""
 	[ "$ENABLE_SERVER_FORWARD" = "1" -a ! -e "$SERVER_FORWARD_KEY" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SERVER_FORWARD_KEY=$SERVER_FORWARD_KEY\""
 	



1.29      +2 -2      freenx/nxserver


rev 1.29, prev_rev 1.28
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.28
retrieving revision 1.29
diff -u -r1.28 -r1.29
--- nxserver	10 Mar 2005 11:00:25 -0000	1.28
+++ nxserver	10 Mar 2005 12:59:37 -0000	1.29
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.28 2005/03/10 11:00:25 fabianx Exp $
+# CVS: $Id: nxserver,v 1.29 2005/03/10 12:59:37 jonno Exp $
 #
 
 # Read the config file
@@ -419,7 +419,7 @@
 if [ "$ENABLE_SERVER_FORWARD" = "1" -a -n "$SERVER_FORWARD_HOST" ]
 then
 	log "Forwarding connection to $SERVER_FORWARD_HOST with secret key $SERVER_FORWARD_KEY."
-	ssh -i "$SERVER_FORWARD_KEY" nx@"$SERVER_FORWARD_HOST"
+	ssh -i "$SERVER_FORWARD_KEY" "nx@$SERVER_FORWARD_HOST:$SERVER_FORWARD_PORT"
 	exit 0
 fi
 






From freenx-cvs at berlios.de  Thu Mar 10 15:52:45 2005
From: freenx-cvs at berlios.de (jonno)
Date: Thu, 10 Mar 2005 15:52:45 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 3 files
Message-ID: <42305F3D.mail7SW1VS3QI@lists.berlios.de>

User:      jonno
Date:      2005-03-10 14:52:45 GMT
Modified:  .        node.conf.sample nxloadconfig nxnode
Log:
Added support for moving the .nx dir outside the user home directory using the USER_FAKE_HOME config variable.
Note that due to ssh, xauthority etc the real user home directory ($HOME) must still be readable to be able to log in, but it does not have to be writeable, and it will not be under the same amount of stress.
If used correctly this should solve the stale NFS problems.

Revision  Changes    Path
1.8       +7 -1      freenx/node.conf.sample


rev 1.8, prev_rev 1.7
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.7
retrieving revision 1.8
diff -u -r1.7 -r1.8
--- node.conf.sample	10 Mar 2005 12:59:37 -0000	1.7
+++ node.conf.sample	10 Mar 2005 14:52:45 -0000	1.8
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.7 2005/03/10 12:59:37 jonno Exp $
+# CVS: $Id: node.conf.sample,v 1.8 2005/03/10 14:52:45 jonno Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -131,6 +131,12 @@
 
 # The key that contains the name of the complete path of the 'netcat' command. 
 #COMMAND_NETCAT=netcat
+
+# USER_FAKE_HOME is the base directory for the .nx directory. Use this
+# parameter instead of the users home directory if $HOME is on a NFS share.
+# Note that this directory must be unique for every user! To accomplish this 
+# it is recomended to include $USER in the path.
+#USER_FAKE_HOME=$HOME
 
 #########################################################################
 # NoMachine node.conf compatible (almost) directives



1.10      +6 -1      freenx/nxloadconfig


rev 1.10, prev_rev 1.9
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.9
retrieving revision 1.10
diff -u -r1.9 -r1.10
--- nxloadconfig	10 Mar 2005 12:59:37 -0000	1.9
+++ nxloadconfig	10 Mar 2005 14:52:45 -0000	1.10
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.9 2005/03/10 12:59:37 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.10 2005/03/10 14:52:45 jonno Exp $
 #
 # ========================================================================
 
@@ -153,6 +153,7 @@
 PROXY_LIBRARY_PATH=""
 APPLICATION_LIBRARY_PATH=""
 APPLICATION_LIBRARY_PRELOAD=""
+USER_FAKE_HOME=""
 
 #########################################################################
 # node.conf file evaluation
@@ -172,6 +173,7 @@
 [ -z "$PROXY_LIBRARY_PATH" ] && PROXY_LIBRARY_PATH=$PATH_LIB
 [ -z "$APPLICATION_LIBRARY_PATH" ] && APPLICATION_LIBRARY_PATH=$PATH_LIB
 [ -z "$APPLICATION_LIBRARY_PRELOAD" ] && APPLICATION_LIBRARY_PRELOAD="$APPLICATION_LIBRARY_PATH/libX11.so.6.2:$APPLICATION_LIBRARY_PATH/libXext.so.6.4:$APPLICATION_LIBRARY_PATH/libXcomp.so.1:$APPLICATION_LIBRARY_PATH/libXcompext.so.1:$APPLICATION_LIBRARY_PATH/libXrender.so.1.2"
+[ -z "$USER_FAKE_HOME" ] && USER_FAKE_HOME=$HOME
 
 #########################################################################
 # Support for --check
@@ -240,6 +242,9 @@
 	[ "$ENABLE_ESD_PRELOAD" = "1" ] && ! which "$ESD_BIN_PRELOAD" >/dev/null 2>&1 && \
 		WARNING="yes" && echo "Warning: Invalid value \"ESD_BIN_PRELOAD=$ESD_BIN_PRELOAD\"" \
 					  && echo "         No esd preload will be performed."
+	
+	[ ! -d "$USER_FAKE_HOME" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"USER_FAKE_HOME=$USER_FAKE_HOME\""
 	
 	[ -z "$SERVER_NAME" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SERVER_NAME=$SERVER_NAME\"" 



1.29      +47 -46    freenx/nxnode


rev 1.29, prev_rev 1.28
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.28
retrieving revision 1.29
diff -u -r1.28 -r1.29
--- nxnode	8 Mar 2005 14:27:55 -0000	1.28
+++ nxnode	10 Mar 2005 14:52:45 -0000	1.29
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.28 2005/03/08 14:27:55 fabianx Exp $
+# CVS: $Id: nxnode,v 1.29 2005/03/10 14:52:45 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -73,14 +73,14 @@
 
 node_terminate_agent()
 {
-	AGENT_PID=$(cat $HOME/.nx/C-$1/pids/agent 2>/dev/null)
+	AGENT_PID=$(cat $USER_FAKE_HOME/.nx/C-$1/pids/agent 2>/dev/null)
 	[ -n "$AGENT_PID" ] && kill $AGENT_PID 2>/dev/null
 }
 
 node_terminate_session()
 {
-	[ -d "$HOME/.nx/C-$1/" ] || return
-	AGENT_PID=$(cat $HOME/.nx/C-$1/pids/agent 2>/dev/null)
+	[ -d "$USER_FAKE_HOME/.nx/C-$1/" ] || return
+	AGENT_PID=$(cat $USER_FAKE_HOME/.nx/C-$1/pids/agent 2>/dev/null)
 	if [ -n "$AGENT_PID" ]
 	then 
 		kill $AGENT_PID 2>/dev/null
@@ -96,16 +96,16 @@
 	fi
 	
 	# remove cookie
-	$COMMAND_XAUTH -v source ~/.nx/C-$sess_id/scripts/authority >/dev/null 2>&1
+	$COMMAND_XAUTH -v source $USER_FAKE_HOME/.nx/C-$sess_id/scripts/authority >/dev/null 2>&1
 	# FIXME: What to do on errors ... ?
 	# TODO: Add parsing of var ...
-	#mv $HOME/.nx/C-$1/ $HOME/.nx/F-C-$1/
-	rm -rf $HOME/.nx/C-$1/
+	#mv $USER_FAKE_HOME/.nx/C-$1/ $USER_FAKE_HOME/.nx/F-C-$1/
+	rm -rf $USER_FAKE_HOME/.nx/C-$1/
 }
 
 node_suspend_session()
 {
-	AGENT_PID=$(cat $HOME/.nx/C-$1/pids/agent 2>/dev/null)
+	AGENT_PID=$(cat $USER_FAKE_HOME/.nx/C-$1/pids/agent 2>/dev/null)
 	[ -n "$AGENT_PID" ] && kill -HUP $AGENT_PID
 }
 
@@ -122,7 +122,7 @@
 	. /etc/profile
 	[ -f ~/.bash_profile ] && . ~/.bash_profile
 
-	mkdir -p ~/.nx/C-$sess_id/pids/
+	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/
 
 	STARTX=""
 	case $type in
@@ -162,19 +162,19 @@
 			# Do not spawn new ESD daemons
 			export ESD_NO_SPAWN="yes"
 			
-			echo "Info: NXNODE - Using $ESD_BIN_PRELOAD wrapper script." >> ~/.nx/C-$sess_id/session
+			echo "Info: NXNODE - Using $ESD_BIN_PRELOAD wrapper script." >> $USER_FAKE_HOME/.nx/C-$sess_id/session
 		fi
 	elif [ "$mediahelper" = "arts" ]
 	then
-		echo "Error: NXNODE - No support for artsd, yet." >> ~/.nx/C-$sess_id/session
+		echo "Error: NXNODE - No support for artsd, yet." >> $USER_FAKE_HOME/.nx/C-$sess_id/session
 	fi
 
-	DISPLAY=unix:$display $STARTX >>~/.nx/C-$sess_id/session 2>&1 &
+	DISPLAY=unix:$display $STARTX >>$USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
 	APP_PID=$!
-	mkdir -p ~/.nx/C-$sess_id/pids/
-	echo "$APP_PID" > ~/.nx/C-$sess_id/pids/applications
+	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/
+	echo "$APP_PID" > $USER_FAKE_HOME/.nx/C-$sess_id/pids/applications
 	wait $APP_PID
-	rm -f ~/.nx/C-$sess_id/pids/applications
+	rm -f $USER_FAKE_HOME/.nx/C-$sess_id/pids/applications
 	node_terminate_agent $sess_id
 }
 
@@ -185,9 +185,10 @@
 	exec 1>&-
 	exec 2>&-
 	
-	export DISPLAY="nx/nx,options=$HOME/.nx/C-$sess_id/options:$display"
-	export XAUTHORITY="$HOME/.nx/C-$sess_id/authority"
-
+	export DISPLAY="nx/nx,options=$USER_FAKE_HOME/.nx/C-$sess_id/options:$display"
+	export XAUTHORITY="$USER_FAKE_HOME/.nx/C-$sess_id/authority"
+	export HOME="$USER_FAKE_HOME"
+	
 	# backwards compatibility
 	K=""
 	[ -n "$keyboard" ] && K="-keyboard $keyboard"
@@ -208,50 +209,50 @@
 		P=""
 		[ -n "$agent_user" ] && U="-u $agent_user"
 		[ -n "$agent_password" ] && P="-p -"
-		echo "$agent_password" | $PATH_BIN/nxdesktop -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $U $P $agent_server $AGENT_EXTRA_OPTIONS_RDP 2>>~/.nx/C-$sess_id/session &
+		echo "$agent_password" | $PATH_BIN/nxdesktop -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $U $P $agent_server $AGENT_EXTRA_OPTIONS_RDP 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	else
 
 	# nxviewer session
 	
 	if [ "$type" = "vnc" ]
 	then
-		mkdir -p ~/.nx/C-$sess_id/scripts/
-		echo "$agent_password" | $PATH_BIN/nxpasswd ~/.nx/C-$sess_id/scripts/.passwd doit
-		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd ~/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)"  $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>~/.nx/C-$sess_id/session &
+		mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/scripts/
+		echo "$agent_password" | $PATH_BIN/nxpasswd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd doit
+		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)"  $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	else
 		# "normal" nxagent session
 		if [ -n "$R" -a "$ENABLE_ROOTLESS_MODE" != "1" ]
 		then
 			# nxproxy single application mode session
-			$PATH_BIN/nxproxy -C :$display $PROXY_EXTRA_OPTIONS 2>>~/.nx/C-$sess_id/session &
+			$PATH_BIN/nxproxy -C :$display $PROXY_EXTRA_OPTIONS 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 		else
 			FP=""
 			[ -n "$AGENT_FONT_SERVER" ] && FP="-fp $AGENT_FONT_SERVER"
 			# nxagent session
-			$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>~/.nx/C-$sess_id/session &
+			$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 		fi
 	fi
 	fi
 	PID=$!
-	mkdir -p ~/.nx/C-$sess_id/pids/
-	echo "$PID" > ~/.nx/C-$sess_id/pids/agent
+	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/
+	echo "$PID" > $USER_FAKE_HOME/.nx/C-$sess_id/pids/agent
 	wait $PID
-	rm -f ~/.nx/C-$sess_id/pids/agent
+	rm -f $USER_FAKE_HOME/.nx/C-$sess_id/pids/agent
 	[ "$type" = "windows" -o "$type" = "vnc" ] && node_terminate_session "$sess_id"
 }
 
 node_kill_proxy()
 {
 	# Info: Proxy running in server mode with pid '5279'.
-	PROXY_PID=$(grep "Info: Proxy running in server mode with pid" $HOME/.nx/C-$1/session | cut -d"'" -f2)
+	PROXY_PID=$(grep "Info: Proxy running in server mode with pid" $USER_FAKE_HOME/.nx/C-$1/session | cut -d"'" -f2)
 	sleep 2
 	[ -n "$PROXY_PID" ] && kill $PROXY_PID 2>/dev/null
 }
 
 node_umount_smb()
 {
-	[ -e "$HOME/.nx/C-$sess_id/scripts/mpoint" ] || return
-	cat "$HOME/.nx/C-$sess_id/scripts/mpoint" | while read mpoint
+	[ -e "$USER_FAKE_HOME/.nx/C-$sess_id/scripts/mpoint" ] || return
+	cat "$USER_FAKE_HOME/.nx/C-$sess_id/scripts/mpoint" | while read mpoint
 	do
 		smbumount "$mpoint" >/dev/null 2>/dev/null
 	done
@@ -270,7 +271,7 @@
 	TAIL_PID=""
 	TIMEOUT_PID=""
 	
-	sh -c 'echo "Info: tail -f running with pid '\'\$$\''."; exec tail -n1 -f ~/.nx/C-'$sess_id'/session' | while read line 
+	sh -c 'echo "Info: tail -f running with pid '\'\$$\''."; exec tail -n1 -f '$USER_FAKE_HOME'/.nx/C-'$sess_id'/session' | while read line 
 	do
 		#
 		# Catch tail pid
@@ -422,8 +423,8 @@
 		then
 			kill $TAIL_PID 2>/dev/null
 			echo "NX> 1004 Error:"
-			echo "Session '$sess_id' has failed after reaching usable state. Session directory '$HOME/.nx/F-C-$sess_id' will be not deleted to allow for further investigation."
-		#	mv ~/.nx/C-$sess_id/ ~/.nx/F-C-$sess_id/
+			echo "Session '$sess_id' has failed after reaching usable state. Session directory '$USER_FAKE_HOME/.nx/F-C-$sess_id' will be not deleted to allow for further investigation."
+		#	mv $USER_FAKE_HOME/.nx/C-$sess_id/ $USER_FAKE_HOME/.nx/F-C-$sess_id/
 			break
 		fi
 	done 
@@ -476,7 +477,7 @@
 	sess_id="$SERVER_NAME-$display-$uniqueid"
 	[ "$EXPORT_SESSIONID" = "1" ] && export NXSESSIONID="$sess_id"
 	
-	mkdir -p ~/.nx/C-$sess_id
+	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id
 	
 	# cache=8M,images=32M,pack=nopack,link=lan,type=unix-kde,cleanup=0,accept=192.168.1.66,cookie=E38A94A77F975443AF04EC911881B120,id=Knoppix-1000-6A8269CC467264EAEF6349D062689755,samba=1,render=1:1000
 	
@@ -497,7 +498,7 @@
 	OLD_UMASK=$(umask)
 	umask 0077
 
-cat << EOF > ~/.nx/C-$sess_id/options
+cat << EOF > $USER_FAKE_HOME/.nx/C-$sess_id/options
 ${kbtype:+kbtype=$kbtype,}${CACHE}${IMAGES}${PACK}link=$link,type=$type,cleanup=0,accept=$userip,cookie=$proxy_cookie,id=$sess_id,samba=$samba,media=$media${sync:+,sync=$sync}${cups:+,cups=$cups}:$display
 EOF
 	umask $OLD_UMASK
@@ -513,25 +514,25 @@
 exit
 EOF
 
-$COMMAND_XAUTH -f "$HOME/.nx/C-$sess_id/authority" >/dev/null 2>&1 <<EOF
+$COMMAND_XAUTH -f "$USER_FAKE_HOME/.nx/C-$sess_id/authority" >/dev/null 2>&1 <<EOF
 add localhost:$display MIT-MAGIC-COOKIE-1 $cookie
 add unix:$display MIT-MAGIC-COOKIE-1 $cookie
 exit
 EOF
 
-	mkdir -m700 ~/.nx/C-$sess_id/scripts/ 2>/dev/null || chmod 700 ~/.nx/C-$sess_id/scripts/
+	mkdir -m700 $USER_FAKE_HOME/.nx/C-$sess_id/scripts/ 2>/dev/null || chmod 700 $USER_FAKE_HOME/.nx/C-$sess_id/scripts/
 
-cat << EOF >~/.nx/C-$sess_id/scripts/authority
+cat << EOF >$USER_FAKE_HOME/.nx/C-$sess_id/scripts/authority
 remove localhost:$display
 remove unix:$display
 exit
 EOF
 
-echo > ~/.nx/C-$sess_id/session
+echo > $USER_FAKE_HOME/.nx/C-$sess_id/session
 node_start_monitor &
 SPID=$!
-mkdir -p ~/.nx/C-$sess_id/pids/
-echo "$SPID" > ~/.nx/C-$sess_id/pids/monitor
+mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/
+echo "$SPID" > $USER_FAKE_HOME/.nx/C-$sess_id/pids/monitor
 
 if [ "$1" = "restore" ]
 then
@@ -561,14 +562,14 @@
 #Session 'Knoppix-1000-40EFB9F64FA55C64C41C72CA39EBD720' has failed after reaching usable state. Session directory '/home/knoppix/.nx/F-C-Knoppix-1000-40EFB9F64FA55C64C41C72CA39EBD720' will be not deleted to allow for further investigation.
 
 wait $SPID
-rm -f ~/.nx/C-$sess_id/pids/monitor
+rm -f $USER_FAKE_HOME/.nx/C-$sess_id/pids/monitor
 }
 
 cmd_node_terminate()
 {
 	sessionid=$(getparam_sessionid)
 	echo "NX> 716 Terminating session $sessionid on user request."
-	display=$(cd $HOME/.nx/; echo C-$SERVER_NAME-*-$sessionid | cut -d"-" -f3)
+	display=$(cd $USER_FAKE_HOME/.nx/; echo C-$SERVER_NAME-*-$sessionid | cut -d"-" -f3)
 	node_terminate_session "$SERVER_NAME-$display-$sessionid"
 }
 
@@ -576,7 +577,7 @@
 {
 	sessionid=$(getparam_sessionid)
 	echo "NX> 716 Suspending session $sessionid on user request."
-	display=$(cd $HOME/.nx/; echo C-$SERVER_NAME-*-$sessionid | cut -d"-" -f3)
+	display=$(cd $USER_FAKE_HOME/.nx/; echo C-$SERVER_NAME-*-$sessionid | cut -d"-" -f3)
 	node_suspend_session "$SERVER_NAME-$display-$sessionid"
 }
 
@@ -590,13 +591,13 @@
 	computername=$(getparam computername)
 	dir=$(getparam dir | sed 's|$(SHARES)|MyShares|g')
 	rdir=$(getparam dir | sed 's|$(SHARES)/||g')
-	display=$(cd $HOME/.nx/; echo C-$SERVER_NAME-*-$sessionid | cut -d"-" -f3)
+	display=$(cd $USER_FAKE_HOME/.nx/; echo C-$SERVER_NAME-*-$sessionid | cut -d"-" -f3)
 	mkdir -p "$HOME/$dir"
 	ERROR=$(PASSWD="$password" "$COMMAND_SMBMOUNT" "//$computername/$rdir" "$HOME/$dir" -o username="$username" ip="127.0.0.1" port="$port" 2>&1)
 	if [ $? -eq 0 ]
 	then
 		$PATH_BIN/nxclient -dialog ok -caption "NXServer Message" -message "Info: Share: '//$computername/$rdir' mounted on: '$HOME/$dir'" -noautokill -display :$display &
-		echo "$HOME/$dir" >> "$HOME/.nx/C-$SERVER_NAME-$display-$sessionid/scripts/mpoint"
+		echo "$HOME/$dir" >> "$USER_FAKE_HOME/.nx/C-$SERVER_NAME-$display-$sessionid/scripts/mpoint"
 	else
 		$PATH_BIN/nxclient -dialog ok -caption "NXServer Message" -message "Info: Share: '//$computername/$rdir' failed to mount: $ERROR" -noautokill -display :$display &
 	fi






From freenx-cvs at berlios.de  Thu Mar 10 16:07:28 2005
From: freenx-cvs at berlios.de (jonno)
Date: Thu, 10 Mar 2005 16:07:28 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified nxsetup
Message-ID: <423062B0.mailCMH1CTVNW@lists.berlios.de>

User:      jonno
Date:      2005-03-10 15:07:28 GMT
Modified:  .        nxsetup
Log:
Fixed a typo

Revision  Changes    Path
1.17      +3 -3      freenx/nxsetup


rev 1.17, prev_rev 1.16
Index: nxsetup
===================================================================
RCS file: /cvsroot/freenx/freenx/nxsetup,v
retrieving revision 1.16
retrieving revision 1.17
diff -u -r1.16 -r1.17
--- nxsetup	16 Feb 2005 00:00:31 -0000	1.16
+++ nxsetup	10 Mar 2005 15:07:28 -0000	1.17
@@ -5,7 +5,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxsetup,v 1.16 2005/02/16 00:00:31 fabianx Exp $ 
+# CVS: $Id: nxsetup,v 1.17 2005/03/10 15:07:28 jonno Exp $ 
 #
 
 HELP="no"
@@ -270,7 +270,7 @@
 		echo "    nxserver --passwd <username>"
 	fi
 	echo
-	echo "  You can change this behaviour in the $NX_CONFIG_FILE file."
+	echo "  You can change this behaviour in the $NX_ETC_DIR/node.conf file."
 	
 	if [ "$SETUP_NOMACHINE_KEY" = "no" -a "$SETUP_NX_KEY" = "yes" ]
 	then
@@ -295,7 +295,7 @@
 	if [ "$PURGE" = "yes" ]
 	then
 		echo "To complete the uninstallation process, remove the nx scripts in $PATH_BIN"
-		echo "and the $NX_CONFIG_FILE configuration file."
+		echo "and the $NX_ETC_DIR/node.conf configuration file."
 	else
 		echo "To complete the uninstallation process, remove the nx scripts in $PATH_BIN"
 		echo






From freenx-cvs at berlios.de  Fri Mar 11 00:55:29 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 00:55:29 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 5 files
Message-ID: <4230DE71.mailEOL15T1P3@lists.berlios.de>

User:      fabianx
Date:      2005-03-10 23:55:28 GMT
Modified:  .        nxkeygen nxloadconfig nxnode nxserver nxsetup
Log:
Fixed broken nxloadconfig.

Note: Sourced programs will not accept commandline options, but rather use the commandline options already present in "$@".

Revision  Changes    Path
1.9       +2 -2      freenx/nxkeygen


rev 1.9, prev_rev 1.8
Index: nxkeygen
===================================================================
RCS file: /cvsroot/freenx/freenx/nxkeygen,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -r1.8 -r1.9
--- nxkeygen	14 Feb 2005 01:52:08 -0000	1.8
+++ nxkeygen	10 Mar 2005 23:55:27 -0000	1.9
@@ -11,12 +11,12 @@
 # Copyright	(c) 2004 Gentoo Foundation
 #		Released under v2 of the GNU GPL
 #
-# CVS: $Id: nxkeygen,v 1.8 2005/02/14 01:52:08 fabianx Exp $
+# CVS: $Id: nxkeygen,v 1.9 2005/03/10 23:55:27 fabianx Exp $
 #
 # ========================================================================
 
 # Read the config file
-. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+NX_LOADCONFIG=1 . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
 
 NX_KEY_DIR="$NX_HOME_DIR/.ssh"
 DATE="`date '+%Y%m%d-%H%M%S'`"



1.11      +7 -1      freenx/nxloadconfig


rev 1.11, prev_rev 1.10
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.10
retrieving revision 1.11
diff -u -r1.10 -r1.11
--- nxloadconfig	10 Mar 2005 14:52:45 -0000	1.10
+++ nxloadconfig	10 Mar 2005 23:55:28 -0000	1.11
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.10 2005/03/10 14:52:45 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.11 2005/03/10 23:55:28 fabianx Exp $
 #
 # ========================================================================
 
@@ -15,6 +15,10 @@
 
 HELP="no"
 CHECK="no"
+
+if [ -z "$NX_LOADCONFIG" ]
+then
+
 USERCONF="no"
 
 while [ "$1" ]
@@ -42,6 +46,8 @@
 	echo "  --userconf [<username>]  Parse <username>.node.conf as well as node.conf."
 	echo "                           Assume current user if no username is specified."
 	exit 0
+fi
+
 fi
 
 #########################################################################



1.30      +2 -2      freenx/nxnode


rev 1.30, prev_rev 1.29
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.29
retrieving revision 1.30
diff -u -r1.29 -r1.30
--- nxnode	10 Mar 2005 14:52:45 -0000	1.29
+++ nxnode	10 Mar 2005 23:55:28 -0000	1.30
@@ -13,12 +13,12 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.29 2005/03/10 14:52:45 jonno Exp $
+# CVS: $Id: nxnode,v 1.30 2005/03/10 23:55:28 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
 # Read the config file
-. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig) --userconf
+NX_LOADCONFIG=1 USERCONF="yes" . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
 
 echo "NX> 1000 NXNODE - Version $NX_VERSION $NX_LICENSE"
 



1.30      +3 -3      freenx/nxserver


rev 1.30, prev_rev 1.29
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.29
retrieving revision 1.30
diff -u -r1.29 -r1.30
--- nxserver	10 Mar 2005 12:59:37 -0000	1.29
+++ nxserver	10 Mar 2005 23:55:28 -0000	1.30
@@ -11,11 +11,11 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.29 2005/03/10 12:59:37 jonno Exp $
+# CVS: $Id: nxserver,v 1.30 2005/03/10 23:55:28 fabianx Exp $
 #
 
 # Read the config file
-. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+NX_LOADCONFIG=1 . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
 
 # following two functions are Copyright by Klaus Knopper
 
@@ -545,7 +545,7 @@
 			if [ "$LOGIN_SUCCESS" = "1" ]
 			then
 				# Reread the config files (so that $USER.node.conf get sourced)
-				. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig) --userconf
+				NX_LOADCONFIG=1 USERCONF="yes" . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
 				echo_x "NX> 103 Welcome to: $SERVER_NAME user: $USER"
 				break
 			else



1.18      +2 -2      freenx/nxsetup


rev 1.18, prev_rev 1.17
Index: nxsetup
===================================================================
RCS file: /cvsroot/freenx/freenx/nxsetup,v
retrieving revision 1.17
retrieving revision 1.18
diff -u -r1.17 -r1.18
--- nxsetup	10 Mar 2005 15:07:28 -0000	1.17
+++ nxsetup	10 Mar 2005 23:55:28 -0000	1.18
@@ -5,7 +5,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxsetup,v 1.17 2005/03/10 15:07:28 jonno Exp $ 
+# CVS: $Id: nxsetup,v 1.18 2005/03/10 23:55:28 fabianx Exp $ 
 #
 
 HELP="no"
@@ -66,7 +66,7 @@
 fi
 
 # Read the config file
-. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+NX_LOADCONFIG=1 . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
 
 # Tries to add a system user
 useradd_nx()






From freenx-cvs at berlios.de  Fri Mar 11 01:11:16 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 01:11:16 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <4230E224.mailNFR11PP26@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 00:11:16 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog nxloadconfig
Modified:           nxnode
Log:
Fixed keyboard mapping problems.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.1  +4 -1      freenx/ChangeLog


rev 1.16.2.1, prev_rev 1.16
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16
retrieving revision 1.16.2.1
diff -u -r1.16 -r1.16.2.1
--- ChangeLog	2 Mar 2005 14:17:43 -0000	1.16
+++ ChangeLog	11 Mar 2005 00:11:15 -0000	1.16.2.1
@@ -1,4 +1,7 @@
-14.02.2005 FreeNX 0.3.0-WIP
+11.03.2005 FreeNX 0.3.1
+	* Fixed keyboard mapping problems.
+
+05.03.2005 FreeNX 0.3.0
 	* Initial CVS checkin.
 	* Added unix-default as session type - by Kalev Lember 
 	  <kalev at smartlink.ee>



1.4.2.1   +2 -2      freenx/nxloadconfig


rev 1.4.2.1, prev_rev 1.4
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.4
retrieving revision 1.4.2.1
diff -u -r1.4 -r1.4.2.1
--- nxloadconfig	2 Mar 2005 14:17:43 -0000	1.4
+++ nxloadconfig	11 Mar 2005 00:11:15 -0000	1.4.2.1
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.4 2005/03/02 14:17:43 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.4.2.1 2005/03/11 00:11:15 fabianx Exp $
 #
 # ========================================================================
 
@@ -14,7 +14,7 @@
 # DO NOT TOUCH unless you REALLY know what you are doing
 #########################################################################
 
-NX_VERSION=1.4.0-03-CVS
+NX_VERSION=1.4.0-03
 NX_LICENSE="OS (GPL)"
 
 # Where can different nx components be found



1.23.2.1  +2 -1      freenx/nxnode


rev 1.23.2.1, prev_rev 1.23
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.23
retrieving revision 1.23.2.1
diff -u -r1.23 -r1.23.2.1
--- nxnode	17 Feb 2005 15:59:31 -0000	1.23
+++ nxnode	11 Mar 2005 00:11:15 -0000	1.23.2.1
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.23 2005/02/17 15:59:31 fabianx Exp $
+# CVS: $Id: nxnode,v 1.23.2.1 2005/03/11 00:11:15 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -168,6 +168,7 @@
 	# backwards compatibility
 	K=""
 	[ -n "$keyboard" ] && K="-keyboard $keyboard"
+	[ -n "$kbtype" ] && K="-kbtype $kbtype"
 	B=""
 	[ -n "$backingstore" ] && B="-bs $backingstore"
 	G=""






From freenx-cvs at berlios.de  Fri Mar 11 01:19:24 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 01:19:24 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <4230E40C.mail9FG1Y202S@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 00:19:24 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog nxnode
Modified:           nxserver
Log:
Fixed unix-custom mode; now allowing parameters to be passed.

This means: "kontact --nofork" will now actually work.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.2  +1 -0      freenx/ChangeLog


rev 1.16.2.2, prev_rev 1.16.2.1
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.1
retrieving revision 1.16.2.2
diff -u -r1.16.2.1 -r1.16.2.2
--- ChangeLog	11 Mar 2005 00:11:15 -0000	1.16.2.1
+++ ChangeLog	11 Mar 2005 00:19:23 -0000	1.16.2.2
@@ -1,5 +1,6 @@
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.
+	* Fixed unix-custom mode; now allowing parameters to be passed.
 
 05.03.2005 FreeNX 0.3.0
 	* Initial CVS checkin.



1.23.2.2  +2 -2      freenx/nxnode


rev 1.23.2.2, prev_rev 1.23.2.1
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.23.2.1
retrieving revision 1.23.2.2
diff -u -r1.23.2.1 -r1.23.2.2
--- nxnode	11 Mar 2005 00:11:15 -0000	1.23.2.1
+++ nxnode	11 Mar 2005 00:19:23 -0000	1.23.2.2
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.23.2.1 2005/03/11 00:11:15 fabianx Exp $
+# CVS: $Id: nxnode,v 1.23.2.2 2005/03/11 00:19:23 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -134,7 +134,7 @@
 			STARTX=$COMMAND_START_CDE
 		;;
 		unix-application)
-			STARTX=$(which $application)
+			STARTX=$application
 		;;
 		unix-default)
 			if [ -f "$HOME/.Xclients" ]; then



1.24.2.1  +2 -2      freenx/nxserver


rev 1.24.2.1, prev_rev 1.24
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.24
retrieving revision 1.24.2.1
diff -u -r1.24 -r1.24.2.1
--- nxserver	2 Mar 2005 14:17:43 -0000	1.24
+++ nxserver	11 Mar 2005 00:19:23 -0000	1.24.2.1
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.24 2005/03/02 14:17:43 fabianx Exp $
+# CVS: $Id: nxserver,v 1.24.2.1 2005/03/11 00:19:23 fabianx Exp $
 #
 
 # Read the config file
@@ -563,7 +563,7 @@
 
 server_get_params()
 {
-	SERVER_PARAMS=$(echo "$@" | sed "s/^$1//g; s/ --/\&/g; s/\"//g")
+	SERVER_PARAMS=$(echo "$@" | sed "s/^$1/\"/g; s/\" --/\&/g; s/\"//g")
 	if [ "$SERVER_PARAMS" = "" ]
 	then
 		echo_x -n "NX> 106 Parameters: "






From freenx-cvs at berlios.de  Fri Mar 11 01:35:48 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 01:35:48 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <4230E7E4.mailLD11AJH3A@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 00:35:48 GMT
Modified:  .        ChangeLog nxnode
Log:
Joined from 0_3_0-bugfixes branch:

- Fixed keyboard mapping problems.

Revision  Changes    Path
1.23      +4 -1      freenx/ChangeLog


rev 1.23, prev_rev 1.22
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.22
retrieving revision 1.23
diff -u -r1.22 -r1.23
--- ChangeLog	10 Mar 2005 12:47:48 -0000	1.22
+++ ChangeLog	11 Mar 2005 00:35:47 -0000	1.23
@@ -2,9 +2,12 @@
 	* Opened the 0.4.0 branch.
 	* Added initial support for filesharing via samba.
 	* Improvements to be more node.conf compatible.
-	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Added COMMAND_NETCAT directive
 	* Added support for 'nxloadconfig --check' to validate node.conf settings
+
+11.03.2005 FreeNX 0.3.1
+	* Fixed keyboard mapping problems.
+	* Fixed unix-custom mode; now allowing parameters to be passed.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.31      +2 -1      freenx/nxnode


rev 1.31, prev_rev 1.30
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.30
retrieving revision 1.31
diff -u -r1.30 -r1.31
--- nxnode	10 Mar 2005 23:55:28 -0000	1.30
+++ nxnode	11 Mar 2005 00:35:47 -0000	1.31
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.30 2005/03/10 23:55:28 fabianx Exp $
+# CVS: $Id: nxnode,v 1.31 2005/03/11 00:35:47 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -192,6 +192,7 @@
 	# backwards compatibility
 	K=""
 	[ -n "$keyboard" ] && K="-keyboard $keyboard"
+	[ -n "$kbtype" ] && K="-kbtype $kbtype"
 	B=""
 	[ -n "$backingstore" ] && B="-bs $backingstore"
 	G=""






From freenx-cvs at berlios.de  Fri Mar 11 01:44:08 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 01:44:08 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <4230E9D8.mailNFR148I4@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 00:44:08 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog nxnode-login
Log:
Fixed password prompt detection support in nxnode.

(Patch by Marcus Better <marcus at better.se>)

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.3  +1 -0      freenx/ChangeLog


rev 1.16.2.3, prev_rev 1.16.2.2
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.2
retrieving revision 1.16.2.3
diff -u -r1.16.2.2 -r1.16.2.3
--- ChangeLog	11 Mar 2005 00:19:23 -0000	1.16.2.2
+++ ChangeLog	11 Mar 2005 00:44:07 -0000	1.16.2.3
@@ -1,6 +1,7 @@
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
+	* Fixed password prompt detection support in nxnode-login.
 
 05.03.2005 FreeNX 0.3.0
 	* Initial CVS checkin.



1.8.2.1   +2 -2      freenx/nxnode-login


rev 1.8.2.1, prev_rev 1.8
Index: nxnode-login
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode-login,v
retrieving revision 1.8
retrieving revision 1.8.2.1
diff -u -r1.8 -r1.8.2.1
--- nxnode-login	13 Feb 2005 13:12:17 -0000	1.8
+++ nxnode-login	11 Mar 2005 00:44:07 -0000	1.8.2.1
@@ -3,7 +3,7 @@
 # Copyright (c) 2004 by Fabian Franz.
 # License: GPL, version 2
 #
-# CVS: $Id: nxnode-login,v 1.8 2005/02/13 13:12:17 fabianx Exp $
+# CVS: $Id: nxnode-login,v 1.8.2.1 2005/03/11 00:44:07 fabianx Exp $
 #
 
 # Syntax: nxnode-login {ssh|su} user ssh-port executable command tosend
@@ -31,7 +31,7 @@
 while {1} {
 	expect {
 		"Are you sure you want to continue connecting (yes/no)?" { send "yes\r" }
-		"assword:"  { sleep 0.3; send "$password\r" }
+		"assword*:"  { sleep 0.3; send "$password\r" }
 		"Permission denied*" { exit 1 }
 		"su: Authentication failure" { exit 1 }
 		"NX> 1000 NXNODE - Version" { 






From freenx-cvs at berlios.de  Fri Mar 11 01:50:16 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 01:50:16 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <4230EB48.mailO51CPYMY@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 00:50:16 GMT
Modified:  .        ChangeLog nxnode-login
Log:
Fixed password prompt detection support in nxnode. (joined from 0_3_0-bugfixes branch)

(Patch by Marcus Better <marcus at better.se>)

Revision  Changes    Path
1.24      +1 -0      freenx/ChangeLog


rev 1.24, prev_rev 1.23
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.23
retrieving revision 1.24
diff -u -r1.23 -r1.24
--- ChangeLog	11 Mar 2005 00:35:47 -0000	1.23
+++ ChangeLog	11 Mar 2005 00:50:15 -0000	1.24
@@ -8,6 +8,7 @@
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
+	* Fixed password prompt detection support in nxnode-login.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.9       +2 -2      freenx/nxnode-login


rev 1.9, prev_rev 1.8
Index: nxnode-login
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode-login,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -r1.8 -r1.9
--- nxnode-login	13 Feb 2005 13:12:17 -0000	1.8
+++ nxnode-login	11 Mar 2005 00:50:15 -0000	1.9
@@ -3,7 +3,7 @@
 # Copyright (c) 2004 by Fabian Franz.
 # License: GPL, version 2
 #
-# CVS: $Id: nxnode-login,v 1.8 2005/02/13 13:12:17 fabianx Exp $
+# CVS: $Id: nxnode-login,v 1.9 2005/03/11 00:50:15 fabianx Exp $
 #
 
 # Syntax: nxnode-login {ssh|su} user ssh-port executable command tosend
@@ -31,7 +31,7 @@
 while {1} {
 	expect {
 		"Are you sure you want to continue connecting (yes/no)?" { send "yes\r" }
-		"assword:"  { sleep 0.3; send "$password\r" }
+		"assword*:"  { sleep 0.3; send "$password\r" }
 		"Permission denied*" { exit 1 }
 		"su: Authentication failure" { exit 1 }
 		"NX> 1000 NXNODE - Version" { 






From freenx-cvs at berlios.de  Fri Mar 11 02:22:18 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 02:22:18 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified ChangeLog
Message-ID: <4230F2CA.mail6VG11J6ZX@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 01:22:18 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog
Log:
Fixed wrong release tag.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.4  +1 -1      freenx/ChangeLog


rev 1.16.2.4, prev_rev 1.16.2.3
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.3
retrieving revision 1.16.2.4
diff -u -r1.16.2.3 -r1.16.2.4
--- ChangeLog	11 Mar 2005 00:44:07 -0000	1.16.2.3
+++ ChangeLog	11 Mar 2005 01:22:18 -0000	1.16.2.4
@@ -3,7 +3,7 @@
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.
 
-05.03.2005 FreeNX 0.3.0
+05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.
 	* Added unix-default as session type - by Kalev Lember 
 	  <kalev at smartlink.ee>






From freenx-cvs at berlios.de  Fri Mar 11 03:29:17 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 03:29:17 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 4 files
Message-ID: <4231027D.mailGT51TFXCN@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 02:29:16 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxnode
Log:
Added initial support for sound.

Note that you can enable preloading of esddsp or artsd wrapper library to have all applications just magically work.

Revision  Changes    Path
1.25      +1 -0      freenx/ChangeLog


rev 1.25, prev_rev 1.24
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.24
retrieving revision 1.25
diff -u -r1.24 -r1.25
--- ChangeLog	11 Mar 2005 00:50:15 -0000	1.24
+++ ChangeLog	11 Mar 2005 02:29:14 -0000	1.25
@@ -4,6 +4,7 @@
 	* Improvements to be more node.conf compatible.
 	* Added COMMAND_NETCAT directive
 	* Added support for 'nxloadconfig --check' to validate node.conf settings
+	* Added initial support for sound (esd/artsd).
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.9       +12 -1     freenx/node.conf.sample


rev 1.9, prev_rev 1.8
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.8
retrieving revision 1.9
diff -u -r1.8 -r1.9
--- node.conf.sample	10 Mar 2005 14:52:45 -0000	1.8
+++ node.conf.sample	11 Mar 2005 02:29:14 -0000	1.9
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.8 2005/03/10 14:52:45 jonno Exp $
+# CVS: $Id: node.conf.sample,v 1.9 2005/03/11 02:29:14 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -128,6 +128,17 @@
 
 #ENABLE_ESD_PRELOAD="0"
 #ESD_BIN_PRELOAD="esddsp"
+
+# FreeNX with ENABLE_ARTSD_PRELOAD="1" will automatically try to setup 
+# the sound with the help of the artsd media helper.
+#
+# Currently ARTSD will be used just by the Linux NX Client.
+#
+# Be sure that $ARTSD_BIN_PRELOAD is in your path, does exist and work 
+# before enabling this directive.
+
+#ENABLE_ARTSD_PRELOAD="0"
+#ARTSD_BIN_PRELOAD="artsdsp"
 
 # The key that contains the name of the complete path of the 'netcat' command. 
 #COMMAND_NETCAT=netcat



1.12      +4 -1      freenx/nxloadconfig


rev 1.12, prev_rev 1.11
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.11
retrieving revision 1.12
diff -u -r1.11 -r1.12
--- nxloadconfig	10 Mar 2005 23:55:28 -0000	1.11
+++ nxloadconfig	11 Mar 2005 02:29:14 -0000	1.12
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.11 2005/03/10 23:55:28 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.12 2005/03/11 02:29:14 fabianx Exp $
 #
 # ========================================================================
 
@@ -107,6 +107,9 @@
 
 ENABLE_ESD_PRELOAD="0"
 ESD_BIN_PRELOAD="esddsp"
+
+ENABLE_ARTSD_PRELOAD="0"
+ARTSD_BIN_PRELOAD="artsdsp"
 
 COMMAND_NETCAT=netcat
 



1.32      +9 -3      freenx/nxnode


rev 1.32, prev_rev 1.31
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.31
retrieving revision 1.32
diff -u -r1.31 -r1.32
--- nxnode	11 Mar 2005 00:35:47 -0000	1.31
+++ nxnode	11 Mar 2005 02:29:15 -0000	1.32
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.31 2005/03/11 00:35:47 fabianx Exp $
+# CVS: $Id: nxnode,v 1.32 2005/03/11 02:29:15 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -164,9 +164,15 @@
 			
 			echo "Info: NXNODE - Using $ESD_BIN_PRELOAD wrapper script." >> $USER_FAKE_HOME/.nx/C-$sess_id/session
 		fi
-	elif [ "$mediahelper" = "arts" ]
+	elif [ "$mediahelper" = "artsd" ]
 	then
-		echo "Error: NXNODE - No support for artsd, yet." >> $USER_FAKE_HOME/.nx/C-$sess_id/session
+		# Overwrite users mcoprc
+		echo -n "GlobalComm=Arts::X11GlobalComm" > $USER_FAKE_HOME/.mcoprc
+		if [ "$ENABLE_ARTSD_PRELOAD" = "1" ]
+		then
+			STARTX="$ARTSD_BIN_PRELOAD $STARTX"
+			echo "Info: NXNODE - Using $ARTSD_BIN_PRELOAD wrapper script." >> $USER_FAKE_HOME/.nx/C-$sess_id/session
+		fi
 	fi
 
 	DISPLAY=unix:$display $STARTX >>$USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &






From freenx-cvs at berlios.de  Fri Mar 11 04:47:11 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Fri, 11 Mar 2005 04:47:11 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 4 files
Message-ID: <423114BF.mail6J411MHDU@lists.berlios.de>

User:      fabianx
Date:      2005-03-11 03:47:11 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxserver
Log:
Added optional support for utmp/wtmp/lastlog database via the X11 sessreg program.

Note: The administrator must have the nx user in the utmp/tty/... group to have this working.

Revision  Changes    Path
1.26      +1 -0      freenx/ChangeLog


rev 1.26, prev_rev 1.25
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.25
retrieving revision 1.26
diff -u -r1.25 -r1.26
--- ChangeLog	11 Mar 2005 02:29:14 -0000	1.25
+++ ChangeLog	11 Mar 2005 03:47:09 -0000	1.26
@@ -5,6 +5,7 @@
 	* Added COMMAND_NETCAT directive
 	* Added support for 'nxloadconfig --check' to validate node.conf settings
 	* Added initial support for sound (esd/artsd).
+	* Added optional support for utmp/wtmp/lastlog database.
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.10      +11 -1     freenx/node.conf.sample


rev 1.10, prev_rev 1.9
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.9
retrieving revision 1.10
diff -u -r1.9 -r1.10
--- node.conf.sample	11 Mar 2005 02:29:14 -0000	1.9
+++ node.conf.sample	11 Mar 2005 03:47:09 -0000	1.10
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.9 2005/03/11 02:29:14 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.10 2005/03/11 03:47:09 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -142,6 +142,16 @@
 
 # The key that contains the name of the complete path of the 'netcat' command. 
 #COMMAND_NETCAT=netcat
+
+# If enabled writes entries via the COMMAND_SESSREG program into utmp/wtmp/lastlog 
+# database.
+#
+# Note: You have to make sure that you add the nx user to the 
+#       utmp or tty group or how its called on your system
+#       before this directive works.
+
+#ENABLE_USESSION="0"
+#COMMAND_SESSREG="sessreg"
 
 # USER_FAKE_HOME is the base directory for the .nx directory. Use this
 # parameter instead of the users home directory if $HOME is on a NFS share.



1.13      +4 -1      freenx/nxloadconfig


rev 1.13, prev_rev 1.12
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.12
retrieving revision 1.13
diff -u -r1.12 -r1.13
--- nxloadconfig	11 Mar 2005 02:29:14 -0000	1.12
+++ nxloadconfig	11 Mar 2005 03:47:09 -0000	1.13
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.12 2005/03/11 02:29:14 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.13 2005/03/11 03:47:09 fabianx Exp $
 #
 # ========================================================================
 
@@ -112,6 +112,9 @@
 ARTSD_BIN_PRELOAD="artsdsp"
 
 COMMAND_NETCAT=netcat
+
+ENABLE_USESSION="0"
+COMMAND_SESSREG="sessreg"
 
 # NoMachine node.conf compatible vars
 



1.31      +18 -1     freenx/nxserver


rev 1.31, prev_rev 1.30
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.30
retrieving revision 1.31
diff -u -r1.30 -r1.31
--- nxserver	10 Mar 2005 23:55:28 -0000	1.30
+++ nxserver	11 Mar 2005 03:47:09 -0000	1.31
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.30 2005/03/10 23:55:28 fabianx Exp $
+# CVS: $Id: nxserver,v 1.31 2005/03/11 03:47:09 fabianx Exp $
 #
 
 # Read the config file
@@ -602,8 +602,23 @@
 	fi
 }
 
+server_add_usession()
+{
+	[ "$ENABLE_USESSION" = "1" ] || return
+	
+	$COMMAND_SESSREG -l ":$SESS_DISPLAY" -h "$USERIP" -a $USER 2>/dev/null
+}
+
+server_remove_usession()
+{
+	[ "$ENABLE_USESSION" = "1" ] || return
+	$COMMAND_SESSREG -l ":$SESS_DISPLAY" -h "$USERIP" -d $USER 2>/dev/null
+}
+
 server_nxnode_start_wait()
 {
+	server_add_usession
+	
 	server_nxnode_start "$@" | while read CMD
 	do
 		case "$CMD" in 
@@ -640,6 +655,8 @@
 			;;
 		esac
 	done
+	
+	server_remove_usession
 }
 
 server_startrestore_session()






From freenx-cvs at berlios.de  Fri Mar 11 17:53:02 2005
From: freenx-cvs at berlios.de (jonno)
Date: Fri, 11 Mar 2005 17:53:02 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 5 files
Message-ID: <4231CCEE.mail66Y1OQHL1@lists.berlios.de>

User:      jonno
Date:      2005-03-11 16:53:02 GMT
Modified:  .        nxkeygen nxloadconfig nxnode nxserver nxsetup
Log:
Fixed a better solution of the nxloadconfig fix by fabian

Revision  Changes    Path
1.10      +2 -2      freenx/nxkeygen


rev 1.10, prev_rev 1.9
Index: nxkeygen
===================================================================
RCS file: /cvsroot/freenx/freenx/nxkeygen,v
retrieving revision 1.9
retrieving revision 1.10
diff -u -r1.9 -r1.10
--- nxkeygen	10 Mar 2005 23:55:27 -0000	1.9
+++ nxkeygen	11 Mar 2005 16:53:01 -0000	1.10
@@ -11,12 +11,12 @@
 # Copyright	(c) 2004 Gentoo Foundation
 #		Released under v2 of the GNU GPL
 #
-# CVS: $Id: nxkeygen,v 1.9 2005/03/10 23:55:27 fabianx Exp $
+# CVS: $Id: nxkeygen,v 1.10 2005/03/11 16:53:01 jonno Exp $
 #
 # ========================================================================
 
 # Read the config file
-NX_LOADCONFIG=1 . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig) --
 
 NX_KEY_DIR="$NX_HOME_DIR/.ssh"
 DATE="`date '+%Y%m%d-%H%M%S'`"



1.14      +1 -7      freenx/nxloadconfig


rev 1.14, prev_rev 1.13
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.13
retrieving revision 1.14
diff -u -r1.13 -r1.14
--- nxloadconfig	11 Mar 2005 03:47:09 -0000	1.13
+++ nxloadconfig	11 Mar 2005 16:53:01 -0000	1.14
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.13 2005/03/11 03:47:09 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.14 2005/03/11 16:53:01 jonno Exp $
 #
 # ========================================================================
 
@@ -15,10 +15,6 @@
 
 HELP="no"
 CHECK="no"
-
-if [ -z "$NX_LOADCONFIG" ]
-then
-
 USERCONF="no"
 
 while [ "$1" ]
@@ -46,8 +42,6 @@
 	echo "  --userconf [<username>]  Parse <username>.node.conf as well as node.conf."
 	echo "                           Assume current user if no username is specified."
 	exit 0
-fi
-
 fi
 
 #########################################################################



1.33      +2 -2      freenx/nxnode


rev 1.33, prev_rev 1.32
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.32
retrieving revision 1.33
diff -u -r1.32 -r1.33
--- nxnode	11 Mar 2005 02:29:15 -0000	1.32
+++ nxnode	11 Mar 2005 16:53:02 -0000	1.33
@@ -13,12 +13,12 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.32 2005/03/11 02:29:15 fabianx Exp $
+# CVS: $Id: nxnode,v 1.33 2005/03/11 16:53:02 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
 # Read the config file
-NX_LOADCONFIG=1 USERCONF="yes" . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig) --userconf
 
 echo "NX> 1000 NXNODE - Version $NX_VERSION $NX_LICENSE"
 



1.32      +3 -3      freenx/nxserver


rev 1.32, prev_rev 1.31
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.31
retrieving revision 1.32
diff -u -r1.31 -r1.32
--- nxserver	11 Mar 2005 03:47:09 -0000	1.31
+++ nxserver	11 Mar 2005 16:53:02 -0000	1.32
@@ -11,11 +11,11 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.31 2005/03/11 03:47:09 fabianx Exp $
+# CVS: $Id: nxserver,v 1.32 2005/03/11 16:53:02 jonno Exp $
 #
 
 # Read the config file
-NX_LOADCONFIG=1 . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig) --
 
 # following two functions are Copyright by Klaus Knopper
 
@@ -545,7 +545,7 @@
 			if [ "$LOGIN_SUCCESS" = "1" ]
 			then
 				# Reread the config files (so that $USER.node.conf get sourced)
-				NX_LOADCONFIG=1 USERCONF="yes" . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+				. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig) --userconf
 				echo_x "NX> 103 Welcome to: $SERVER_NAME user: $USER"
 				break
 			else



1.19      +2 -2      freenx/nxsetup


rev 1.19, prev_rev 1.18
Index: nxsetup
===================================================================
RCS file: /cvsroot/freenx/freenx/nxsetup,v
retrieving revision 1.18
retrieving revision 1.19
diff -u -r1.18 -r1.19
--- nxsetup	10 Mar 2005 23:55:28 -0000	1.18
+++ nxsetup	11 Mar 2005 16:53:02 -0000	1.19
@@ -5,7 +5,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxsetup,v 1.18 2005/03/10 23:55:28 fabianx Exp $ 
+# CVS: $Id: nxsetup,v 1.19 2005/03/11 16:53:02 jonno Exp $ 
 #
 
 HELP="no"
@@ -66,7 +66,7 @@
 fi
 
 # Read the config file
-NX_LOADCONFIG=1 . $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig)
+. $(PATH=$(cd $(dirname $0) && pwd):$PATH which nxloadconfig) --
 
 # Tries to add a system user
 useradd_nx()






From freenx-cvs at berlios.de  Sat Mar 12 03:42:04 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 03:42:04 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <423256FC.mail4BS11WCWH@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 02:42:03 GMT
Modified:  .        ChangeLog nxnode
Log:
Removed support for OSS components prior version 1.4.0,snapshot 6 in nxnode. (They do not accept the -option option)

Added -option option to nxagent/nxdesktop.

Revision  Changes    Path
1.27      +2 -0      freenx/ChangeLog


rev 1.27, prev_rev 1.26
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.26
retrieving revision 1.27
diff -u -r1.26 -r1.27
--- ChangeLog	11 Mar 2005 03:47:09 -0000	1.26
+++ ChangeLog	12 Mar 2005 02:42:01 -0000	1.27
@@ -6,6 +6,8 @@
 	* Added support for 'nxloadconfig --check' to validate node.conf settings
 	* Added initial support for sound (esd/artsd).
 	* Added optional support for utmp/wtmp/lastlog database.
+	* Removed support for OSS components prior version 1.4.0 in nxnode.
+	  Added -option option to nxagent/nxdesktop.
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.34      +3 -3      freenx/nxnode


rev 1.34, prev_rev 1.33
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.33
retrieving revision 1.34
diff -u -r1.33 -r1.34
--- nxnode	11 Mar 2005 16:53:02 -0000	1.33
+++ nxnode	12 Mar 2005 02:42:02 -0000	1.34
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.33 2005/03/11 16:53:02 jonno Exp $
+# CVS: $Id: nxnode,v 1.34 2005/03/12 02:42:02 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -216,7 +216,7 @@
 		P=""
 		[ -n "$agent_user" ] && U="-u $agent_user"
 		[ -n "$agent_password" ] && P="-p -"
-		echo "$agent_password" | $PATH_BIN/nxdesktop -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $U $P $agent_server $AGENT_EXTRA_OPTIONS_RDP 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
+		echo "$agent_password" | $PATH_BIN/nxdesktop -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $U $P $agent_server $AGENT_EXTRA_OPTIONS_RDP 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	else
 
 	# nxviewer session
@@ -236,7 +236,7 @@
 			FP=""
 			[ -n "$AGENT_FONT_SERVER" ] && FP="-fp $AGENT_FONT_SERVER"
 			# nxagent session
-			$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
+			$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 		fi
 	fi
 	fi






From freenx-cvs at berlios.de  Sat Mar 12 03:49:29 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 03:49:29 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 4 files
Message-ID: <423258B9.mail58911WU5V@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 02:49:29 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxserver
Log:
Added forwarding to commercial server via destination port.

This means you can use for example 23 for FreeNX and 22 for commercial server. This should be more reliable than the other forwarding method.

Note: You have to have ssh listen on several ports yourself.

Added configuration directives:

ENABLE_NOMACHINE_FORWARD_{PORT,USER}="0"

NOMACHINE_FORWARD_PORT="22"

Removed directive:

ENABLE_NOMACHINE_FORWARD="0"

Revision  Changes    Path
1.28      +1 -0      freenx/ChangeLog


rev 1.28, prev_rev 1.27
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.27
retrieving revision 1.28
diff -u -r1.27 -r1.28
--- ChangeLog	12 Mar 2005 02:42:01 -0000	1.27
+++ ChangeLog	12 Mar 2005 02:49:28 -0000	1.28
@@ -8,6 +8,7 @@
 	* Added optional support for utmp/wtmp/lastlog database.
 	* Removed support for OSS components prior version 1.4.0 in nxnode.
 	  Added -option option to nxagent/nxdesktop.
+	* Added forwarding to commercial server via destination port.
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.11      +13 -4     freenx/node.conf.sample


rev 1.11, prev_rev 1.10
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.10
retrieving revision 1.11
diff -u -r1.10 -r1.11
--- node.conf.sample	11 Mar 2005 03:47:09 -0000	1.10
+++ node.conf.sample	12 Mar 2005 02:49:28 -0000	1.11
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.10 2005/03/11 03:47:09 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.11 2005/03/12 02:49:28 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -99,9 +99,9 @@
 #SERVER_FORWARD_PORT=22
 #SERVER_FORWARD_KEY="/usr/NX/share/client.id_dsa.key"
 
-# FreeNX with ENABLE_NOMACHINE_FORWARD="1" will automatically forward all
+# FreeNX with ENABLE_NOMACHINE_FORWARD_USER="1" will automatically forward all
 # connections to the commercial NoMachine nxserver installed on the same
-# machine. This feature is introduced to enable the usage of FreeNX adn
+# machine. This feature is introduced to enable the usage of FreeNX and
 # NoMachine NX side by side on the same machine without conflicts.
 #
 # To make a connection to the FreeNX server, just use 'freenx.<user>' as 
@@ -111,9 +111,18 @@
 # To make a connection to the NoMachine nxserver, use the unmodified
 # '<user>' username.
 
-#ENABLE_NOMACHINE_FORWARD="0"
+#ENABLE_NOMACHINE_FORWARD_USER="0"
 #NOMACHINE_SERVER="/usr/NX/bin/nxserver"
 #NOMACHINE_NX_HOME_DIR="/usr/NX/home/nx"
+
+# To just forward connections to the NoMachine server, which connect to a 
+# certain port enable the following two directives.
+# 
+# Note: You need to let SSHD listen to several ports to make use of this 
+#       directive.
+
+#ENABLE_NOMACHINE_FORWARD_PORT="0"
+#NOMACHINE_FORWARD_PORT="22"
 
 # When set to 1 will start nxagent in rootless mode.
 #ENABLE_ROOTLESS_MODE="0"



1.15      +5 -2      freenx/nxloadconfig


rev 1.15, prev_rev 1.14
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.14
retrieving revision 1.15
diff -u -r1.14 -r1.15
--- nxloadconfig	11 Mar 2005 16:53:01 -0000	1.14
+++ nxloadconfig	12 Mar 2005 02:49:28 -0000	1.15
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.14 2005/03/11 16:53:01 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.15 2005/03/12 02:49:28 fabianx Exp $
 #
 # ========================================================================
 
@@ -93,9 +93,12 @@
 SERVER_FORWARD_PORT=22
 SERVER_FORWARD_KEY="/usr/NX/share/client.id_dsa.key"
 
-ENABLE_NOMACHINE_FORWARD="0"
+ENABLE_NOMACHINE_FORWARD_USER="0"
 NOMACHINE_SERVER="/usr/NX/bin/nxserver"
 NOMACHINE_NX_HOME_DIR="/usr/NX/home/nx"
+
+ENABLE_NOMACHINE_FORWARD_PORT="0"
+NOMACHINE_FORWARD_PORT="22"
 
 ENABLE_ROOTLESS_MODE="0"
 



1.33      +12 -4     freenx/nxserver


rev 1.33, prev_rev 1.32
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.32
retrieving revision 1.33
diff -u -r1.32 -r1.33
--- nxserver	11 Mar 2005 16:53:02 -0000	1.32
+++ nxserver	12 Mar 2005 02:49:28 -0000	1.33
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.32 2005/03/11 16:53:02 jonno Exp $
+# CVS: $Id: nxserver,v 1.33 2005/03/12 02:49:28 fabianx Exp $
 #
 
 # Read the config file
@@ -423,9 +423,17 @@
 	exit 0
 fi
 
+# forward the connection to commercial NoMachine server?
+if [ "$ENABLE_NOMACHINE_FORWARD_PORT" = "1" -a "$NOMACHINE_FORWARD_PORT" = "$(echo $SSH_CLIENT | cut -d' ' -f3)" -a -n "$NOMACHINE_SERVER" ]
+then
+	log "Info: Detected SSH destination port $NOMACHINE_FORWARD_PORT. Forwarding connection to commercial NoMachine server."
+	exec $NOMACHINE_SERVER
+	log "Error: Forwarding to NoMachine Server $NOMACHINE_SERVER failed. Using FreeNX server instead."
+fi
+
 echo_x "HELLO NXSERVER - Version $NX_VERSION $NX_LICENSE"
 
-[ "$ENABLE_NOMACHINE_FORWARD" = "1" ] && RECORD_CMD=()
+[ "$ENABLE_NOMACHINE_FORWARD_USER" = "1" ] && RECORD_CMD=()
 
 # Login stage
 while true
@@ -437,7 +445,7 @@
 	echo_x "$CMD"
 	
 	# record $CMD in RECORD_CMD array
-	[ "$ENABLE_NOMACHINE_FORWARD" = "1" ] && RECORD_CMD=( "${RECORD_CMD[@]}" "$CMD" )
+	[ "$ENABLE_NOMACHINE_FORWARD_USER" = "1" ] && RECORD_CMD=( "${RECORD_CMD[@]}" "$CMD" )
 	
 	case "$CMD" in 
 		quit|QUIT)
@@ -479,7 +487,7 @@
 			echo_x $USER
 			
 			# forward the connection to commercial NoMachine server?
-			if [ "$ENABLE_NOMACHINE_FORWARD" = "1" -a -n "$NOMACHINE_SERVER" ]
+			if [ "$ENABLE_NOMACHINE_FORWARD_USER" = "1" -a -n "$NOMACHINE_SERVER" ]
 			then
 				case "$USER" in
 					freenx.*)






From freenx-cvs at berlios.de  Sat Mar 12 04:24:31 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 04:24:31 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <423260EF.mailC3E1UG97A@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 03:24:30 GMT
Modified:  .        ChangeLog nxnode nxserver
Log:
Added more compatible getparam function.

Revision  Changes    Path
1.29      +1 -0      freenx/ChangeLog


rev 1.29, prev_rev 1.28
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.28
retrieving revision 1.29
diff -u -r1.28 -r1.29
--- ChangeLog	12 Mar 2005 02:49:28 -0000	1.28
+++ ChangeLog	12 Mar 2005 03:24:30 -0000	1.29
@@ -9,6 +9,7 @@
 	* Removed support for OSS components prior version 1.4.0 in nxnode.
 	  Added -option option to nxagent/nxdesktop.
 	* Added forwarding to commercial server via destination port.
+	* Added more compatible getparam function
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.35      +2 -4      freenx/nxnode


rev 1.35, prev_rev 1.34
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.34
retrieving revision 1.35
diff -u -r1.34 -r1.35
--- nxnode	12 Mar 2005 02:42:02 -0000	1.34
+++ nxnode	12 Mar 2005 03:24:30 -0000	1.35
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.34 2005/03/12 02:42:02 fabianx Exp $
+# CVS: $Id: nxnode,v 1.35 2005/03/12 03:24:30 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -42,9 +42,7 @@
 # Reread boot command line; echo last parameter's argument or return false.
 getparam(){
 stringinstring "&$1=" "$CMDLINE" || return 1
-result="${CMDLINE##*&$1=}"
-result="${result%%[&&&&&]*}"
-echo "$result"
+echo "$CMDLINE" | awk "/^$1=/"' { VAL=$2 } END { print VAL }' FS="=" RS="(&|\n)"
 return 0
 }
 



1.34      +2 -4      freenx/nxserver


rev 1.34, prev_rev 1.33
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.33
retrieving revision 1.34
diff -u -r1.33 -r1.34
--- nxserver	12 Mar 2005 02:49:28 -0000	1.33
+++ nxserver	12 Mar 2005 03:24:30 -0000	1.34
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.33 2005/03/12 02:49:28 fabianx Exp $
+# CVS: $Id: nxserver,v 1.34 2005/03/12 03:24:30 fabianx Exp $
 #
 
 # Read the config file
@@ -27,9 +27,7 @@
 # Reread boot command line; echo last parameter's argument or return false.
 getparam(){
 stringinstring "&$1=" "$CMDLINE" || return 1
-result="${CMDLINE##*&$1=}"
-result="${result%%[&&&&&]*}"
-echo "$result"
+echo "$CMDLINE" | awk "/^$1=/"' { VAL=$2 } END { print VAL }' FS="=" RS="(&|\n)"
 return 0
 }
 






From freenx-cvs at berlios.de  Sat Mar 12 05:05:04 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 05:05:04 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxserver
Message-ID: <42326A70.mailIPH1XSIOU@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 04:05:04 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes nxserver
Log:
Added correct locking to find an unused display. The used method is also used by KDE for example.

Revision  Changes    Path
No                   revision



No                   revision



1.24.2.2  +15 -3     freenx/nxserver


rev 1.24.2.2, prev_rev 1.24.2.1
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.24.2.1
retrieving revision 1.24.2.2
diff -u -r1.24.2.1 -r1.24.2.2
--- nxserver	11 Mar 2005 00:19:23 -0000	1.24.2.1
+++ nxserver	12 Mar 2005 04:05:03 -0000	1.24.2.2
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.24.2.1 2005/03/11 00:19:23 fabianx Exp $
+# CVS: $Id: nxserver,v 1.24.2.2 2005/03/12 04:05:03 fabianx Exp $
 #
 
 # Read the config file
@@ -640,6 +640,9 @@
 			;;
 		esac
 	done
+
+	# remove lock file
+	[ -e "/tmp/.nX$SESS_DISPLAY-lock" ] && rm -f /tmp/.nX$SESS_DISPLAY-lock
 }
 
 server_startrestore_session()
@@ -673,10 +676,19 @@
 			
 		# TODO: need to check for _all_ offset and ports :-/
 			
-		while [ -e /tmp/.X$SESS_DISPLAY-lock ]
+		while true
 		do
-			let SESS_DISPLAY=$SESS_DISPLAY+1
+			while [ -e /tmp/.X$SESS_DISPLAY-lock -o -e "/tmp/.nX$SESS_DISPLAY-lock" ]
+			do
+				let SESS_DISPLAY=$SESS_DISPLAY+1
+			done
+
+			SESS_LOCKFILE=$(mktemp "/tmp/.nX$SESS_DISPLAY-lock.XXXXXXXXX")
+			# ln is an atomic operation
+			ln "$SESS_LOCKFILE" "/tmp/.nX$SESS_DISPLAY-lock" 2>/dev/null && break
 		done
+		
+		rm -f "$SESS_LOCKFILE"
 	
 		uniqueid=$(echo $[$RANDOM*$RANDOM] | md5sum | cut -d" " -f1 | tr "[a-z]" "[A-Z]")
 		FULL_PARAMS="user=$USER&userip=$USERIP&uniqueid=$uniqueid&display=$SESS_DISPLAY&$PARAMS"






From freenx-cvs at berlios.de  Sat Mar 12 05:06:48 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 05:06:48 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified ChangeLog
Message-ID: <42326AD8.mailJEL14W67O@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 04:06:48 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog
Log:
Added correct locking to find an unused display. The used method is also used by KDE for example. (forgot ChangeLog in last commit)

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.5  +1 -0      freenx/ChangeLog


rev 1.16.2.5, prev_rev 1.16.2.4
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.4
retrieving revision 1.16.2.5
diff -u -r1.16.2.4 -r1.16.2.5
--- ChangeLog	11 Mar 2005 01:22:18 -0000	1.16.2.4
+++ ChangeLog	12 Mar 2005 04:06:48 -0000	1.16.2.5
@@ -2,6 +2,7 @@
 	* Fixed keyboard mapping problems.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.
+	* Fixed locking to prevent usage of the same display.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.






From freenx-cvs at berlios.de  Sat Mar 12 05:17:03 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 05:17:03 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <42326D3F.mailMJI113GTT@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 04:17:03 GMT
Modified:  .        ChangeLog nxserver
Log:
Added correct locking to find an unused display. The used method is also used by KDE for example. (ported from FreeNX-0_3_0-bugfixes branch)

Revision  Changes    Path
1.30      +1 -0      freenx/ChangeLog


rev 1.30, prev_rev 1.29
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.29
retrieving revision 1.30
diff -u -r1.29 -r1.30
--- ChangeLog	12 Mar 2005 03:24:30 -0000	1.29
+++ ChangeLog	12 Mar 2005 04:17:03 -0000	1.30
@@ -15,6 +15,7 @@
 	* Fixed keyboard mapping problems.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.
+	* Fixed locking to prevent usage of the same display.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.35      +15 -3     freenx/nxserver


rev 1.35, prev_rev 1.34
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.34
retrieving revision 1.35
diff -u -r1.34 -r1.35
--- nxserver	12 Mar 2005 03:24:30 -0000	1.34
+++ nxserver	12 Mar 2005 04:17:03 -0000	1.35
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.34 2005/03/12 03:24:30 fabianx Exp $
+# CVS: $Id: nxserver,v 1.35 2005/03/12 04:17:03 fabianx Exp $
 #
 
 # Read the config file
@@ -663,6 +663,9 @@
 	done
 	
 	server_remove_usession
+
+	# remove lock file
+	[ -e "/tmp/.nX$SESS_DISPLAY-lock" ] && rm -f /tmp/.nX$SESS_DISPLAY-lock
 }
 
 server_startrestore_session()
@@ -697,9 +700,16 @@
 			
 		# TODO: need to check for _all_ offset and ports :-/
 			
-		while [ -e /tmp/.X$SESS_DISPLAY-lock ]
+		while true
 		do
-			let SESS_DISPLAY=$SESS_DISPLAY+1
+			while [ -e /tmp/.X$SESS_DISPLAY-lock -o -e "/tmp/.nX$SESS_DISPLAY-lock" ]
+			do
+				let SESS_DISPLAY=$SESS_DISPLAY+1
+			done
+
+			SESS_LOCKFILE=$(mktemp "/tmp/.nX$SESS_DISPLAY-lock.XXXXXXXXX")
+			# ln is an atomic operation
+			ln "$SESS_LOCKFILE" "/tmp/.nX$SESS_DISPLAY-lock" 2>/dev/null && break
 		done
 		
 		if [ "$SESS_DISPLAY" -gt "$SESS_DISPLAY_LIMIT" ]
@@ -709,6 +719,8 @@
 			return
 		fi
 
+		rm -f "$SESS_LOCKFILE"
+	
 		uniqueid=$(echo $[$RANDOM*$RANDOM] | md5sum | cut -d" " -f1 | tr "[a-z]" "[A-Z]")
 		FULL_PARAMS="user=$USER&userip=$USERIP&uniqueid=$uniqueid&display=$SESS_DISPLAY&$PARAMS"
 		log "$FULL_PARAMS"






From freenx-cvs at berlios.de  Sat Mar 12 05:36:41 2005
From: freenx-cvs at berlios.de (lroufail)
Date: Sat, 12 Mar 2005 05:36:41 +0100
Subject: [Freenx-cvs] CVS: nxc - lroufail modified nxcompsh/ProcessUnix.cpp
Message-ID: <423271D9.mailNAR1KJEZY@lists.berlios.de>

User:      lroufail
Date:      2005-03-12 04:36:41 GMT
Modified:  nxcompsh ProcessUnix.cpp
Log:
Logging Cleanup.

Revision  Changes    Path
1.2       +7 -19     nxc/nxcompsh/ProcessUnix.cpp


rev 1.2, prev_rev 1.1
Index: ProcessUnix.cpp
===================================================================
RCS file: /cvsroot/freenx/nxc/nxcompsh/ProcessUnix.cpp,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -r1.1 -r1.2
--- ProcessUnix.cpp	9 Mar 2005 11:39:01 -0000	1.1
+++ ProcessUnix.cpp	12 Mar 2005 04:36:41 -0000	1.2
@@ -160,11 +160,10 @@
 
     m_exception.SetRuntimeError( "Fork failed: cannot launch new process." );
 
-#ifdef NX_DEBUG
-    cerr << "NXProcess: cannot fork, errno = " << errno
+    stringstream ss;
+    ss << "NXProcess: cannot fork, errno = " << errno
     << " (" << strerror( errno ) << ")." << endl << flush;
-#endif
-
+    NX_LOG_LOGERROR(ss.str());
     return false;
   }
 
@@ -177,9 +176,7 @@
     if( mp_stdin == NULL )
     {
       m_exception.SetRuntimeError( "Unable to open stdin." );
-#ifdef NX_DEBUG
-      cerr << "NXProcess: cannot redirect stdin." << endl << flush;
-#endif
+      NX_LOG_LOGDEBUG( "NXProcess: cannot redirect stdin." );
       return false;
     }
   }
@@ -191,9 +188,7 @@
     if( mp_stdouterr == NULL )
     {
       m_exception.SetRuntimeError( "Unable to open stdout or stderr." );
-#ifdef NX_DEBUG
-      cerr << "NXProcess: cannot redirect stdout and stderr (2)." << endl << flush;
-#endif
+      NX_LOG_LOGERROR( "NXProcess: cannot redirect stdout and stderr (2).");
       return false;
     }
   }
@@ -206,9 +201,7 @@
   if( mp_stdin == NULL )
   {
     m_exception.SetRuntimeError( "Unable to write. Stdin is not redirected." );
-#ifdef NX_DEBUG
-    cerr << "NXProcess: unable to write, stdin is not redirected." << endl << flush;
-#endif
+    NX_LOG_LOGERROR( "NXProcess: unable to write, stdin is not redirected." );
     return false;
   }
 
@@ -232,9 +225,7 @@
   if( mp_stdouterr == NULL )
   {
     m_exception.SetRuntimeError( "Unable to read. Stdout and stderr are not redirected." );
-#ifdef NX_DEBUG
-    cerr << "NXProcess: unable to read, stdout and stderr are not redirected." << endl << flush;
-#endif
+    NX_LOG_LOGERROR( "NXProcess: unable to read, stdout and stderr are not redirected." );
     out = "";
     return -1;
   }
@@ -252,12 +243,10 @@
   tv.tv_sec = 0;
   tv.tv_usec = 1000 * timeout;
 
-  NX_LOG_LOGDEBUG( "NXProcess: wait for select." );
   retval = select( myfd + 1, &rfds, NULL, NULL, &tv );
 
   if( retval == 0 )
   {
-    NX_LOG_LOGDEBUG( "NXProcess: no data to read." );
     out = "";
     return 0;
   }
@@ -269,7 +258,6 @@
   }
   else
   {
-    NX_LOG_LOGDEBUG( "NXProcess: there is data to read." );
     char buff[MAX_BUFFER_SIZE] = {0};
 
     unsigned int nBytes = fread( buff, sizeof( char ), (MAX_BUFFER_SIZE -1), mp_stdouterr );






From freenx-cvs at berlios.de  Sat Mar 12 05:43:55 2005
From: freenx-cvs at berlios.de (lroufail)
Date: Sat, 12 Mar 2005 05:43:55 +0100
Subject: [Freenx-cvs] CVS: nxc - lroufail modified nxcompsh/TransportSSH.cpp
Message-ID: <4232738B.mailNG41MA3KX@lists.berlios.de>

User:      lroufail
Date:      2005-03-12 04:43:54 GMT
Modified:  nxcompsh TransportSSH.cpp
Log:
Added patch to support alternate ssh ports if defined in the configuration file

Revision  Changes    Path
1.2       +7 -0      nxc/nxcompsh/TransportSSH.cpp


rev 1.2, prev_rev 1.1
Index: TransportSSH.cpp
===================================================================
RCS file: /cvsroot/freenx/nxc/nxcompsh/TransportSSH.cpp,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -r1.1 -r1.2
--- TransportSSH.cpp	9 Mar 2005 11:39:10 -0000	1.1
+++ TransportSSH.cpp	12 Mar 2005 04:43:54 -0000	1.2
@@ -257,6 +257,13 @@
     mp_process->AddArgument( sTmp );
   }
 
+  sTmp = parameters.GetString(NX_HostPort, "");
+  if (!sTmp.empty())
+  {
+     mp_process->AddArgument("-p");
+     mp_process->AddArgument(sTmp);
+  }
+
   sTmp = parameters.GetString( NX_SshLogPath, "" );
   if( sTmp.empty() )
   {






From freenx-cvs at berlios.de  Sat Mar 12 05:54:26 2005
From: freenx-cvs at berlios.de (lroufail)
Date: Sat, 12 Mar 2005 05:54:26 +0100
Subject: [Freenx-cvs] CVS: nxc - lroufail modified nxrun/Makefile.am
Message-ID: <42327602.mailNQF1EXIVS@lists.berlios.de>

User:      lroufail
Date:      2005-03-12 04:54:26 GMT
Modified:  nxrun    Makefile.am
Log:
Applied patch for outdated automake input file

Revision  Changes    Path
1.2       +3 -5      nxc/nxrun/Makefile.am


rev 1.2, prev_rev 1.1
Index: Makefile.am
===================================================================
RCS file: /cvsroot/freenx/nxc/nxrun/Makefile.am,v
retrieving revision 1.1
retrieving revision 1.2
diff -u -r1.1 -r1.2
--- Makefile.am	9 Mar 2005 11:45:05 -0000	1.1
+++ Makefile.am	12 Mar 2005 04:54:26 -0000	1.2
@@ -1,10 +1,8 @@
 
-INCLUDES = -I../nxcompsh
+INCLUDES = -I../nxcompsh -I../nxdriver
 
 bin_PROGRAMS = nxrun
 
-nxrun_SOURCES = MainUnix.cpp NXSettings.h NXSettings.cpp SettingsToParameters.h \
-				SettingsToParameters.cpp NXConnection.h NXConnection.cpp \
-				Options.h Options.cpp
+nxrun_SOURCES = MainUnix.cpp ConsoleCallback.cpp
 
-LDADD = ../nxcompsh/.libs/libXcompsh.a -lexpat -L/usr/X11R6/lib -lxkbfile -lXext
+LDADD = ../nxcompsh/.libs/libXcompsh.a ../nxriver/.libs/libXdriver.a -lexpat -L/usr/X11R6/lib -lxkbfile -lXext






From freenx-cvs at berlios.de  Sat Mar 12 06:08:28 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 06:08:28 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <4232794C.mailNZI13TUGY@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 05:08:28 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog nxnode
Modified:           nxserver
Log:
Fixed resume when agent is no longer there
(i.e. it crashed or someone rebooted the computer).
Fixed error message shown to user, when session startup fails.
(before there was a long waiting for the timeout)

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.6  +2 -0      freenx/ChangeLog


rev 1.16.2.6, prev_rev 1.16.2.5
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.5
retrieving revision 1.16.2.6
diff -u -r1.16.2.5 -r1.16.2.6
--- ChangeLog	12 Mar 2005 04:06:48 -0000	1.16.2.5
+++ ChangeLog	12 Mar 2005 05:08:27 -0000	1.16.2.6
@@ -3,6 +3,8 @@
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.
 	* Fixed locking to prevent usage of the same display.
+	* Fixed resume when agent is no longer there.
+	* Fixed error message shown to user, when session startup fails.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.23.2.3  +16 -3     freenx/nxnode


rev 1.23.2.3, prev_rev 1.23.2.2
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.23.2.2
retrieving revision 1.23.2.3
diff -u -r1.23.2.2 -r1.23.2.3
--- nxnode	11 Mar 2005 00:19:23 -0000	1.23.2.2
+++ nxnode	12 Mar 2005 05:08:27 -0000	1.23.2.3
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.23.2.2 2005/03/11 00:19:23 fabianx Exp $
+# CVS: $Id: nxnode,v 1.23.2.3 2005/03/12 05:08:27 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -101,10 +101,22 @@
 	rm -rf $HOME/.nx/C-$1/
 }
 
+node_fail_restore_session()
+{
+	echo "NX> 1004 Error: Could not resume session. nxagent process could not be found."
+	node_terminate_session "$sess_id"
+	exit 1
+}
+
 node_suspend_session()
 {
 	AGENT_PID=$(cat $HOME/.nx/C-$1/pids/agent 2>/dev/null)
-	[ -n "$AGENT_PID" ] && kill -HUP $AGENT_PID
+	if [ -n "$AGENT_PID" ]
+	then 
+		kill -0 $AGENT_PID || return 1
+		kill -HUP $AGENT_PID && return 0
+	fi
+	return 1
 }
 
 # ---------
@@ -251,6 +263,7 @@
 		          echo "NX> 1004 Error: nxagent failed to start. Session timed out."
 			  echo "                Blocking $display again ..."
 			  touch /tmp/.X$display-lock
+			  mv $HOME/.nx/C-$sess_id/ $HOME/.nx/F-C-$sess_id/
 			  kill $TAIL_PID 2>/dev/null
 			) &
 			TIMEOUT_PID=$!
@@ -497,7 +510,7 @@
 
 if [ "$1" = "restore" ]
 then
-	node_suspend_session $sess_id
+	node_suspend_session $sess_id || node_fail_restore_session
 else
 	node_start_agent &
 	node_start_applications &



1.24.2.3  +3 -1      freenx/nxserver


rev 1.24.2.3, prev_rev 1.24.2.2
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.24.2.2
retrieving revision 1.24.2.3
diff -u -r1.24.2.2 -r1.24.2.3
--- nxserver	12 Mar 2005 04:05:03 -0000	1.24.2.2
+++ nxserver	12 Mar 2005 05:08:27 -0000	1.24.2.3
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.24.2.2 2005/03/12 04:05:03 fabianx Exp $
+# CVS: $Id: nxserver,v 1.24.2.3 2005/03/12 05:08:27 fabianx Exp $
 #
 
 # Read the config file
@@ -625,6 +625,8 @@
 			;;
 			"NX> 1004"*)
 				session_fail $uniqueid
+				# FIXME: Need correct error code.
+				echo_x "NX> 504 Session startup failed."
 			;;
 		esac
 






From freenx-cvs at berlios.de  Sat Mar 12 09:03:45 2005
From: freenx-cvs at berlios.de (jonno)
Date: Sat, 12 Mar 2005 09:03:45 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified nxnode
Message-ID: <4232A261.mail1691D2B9U@lists.berlios.de>

User:      jonno
Date:      2005-03-12 08:03:45 GMT
Modified:  .        nxnode
Log:
Restructured the node_start_agent() for better readability. No changes in logic

Revision  Changes    Path
1.36      +12 -20    freenx/nxnode


rev 1.36, prev_rev 1.35
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.35
retrieving revision 1.36
diff -u -r1.35 -r1.36
--- nxnode	12 Mar 2005 03:24:30 -0000	1.35
+++ nxnode	12 Mar 2005 08:03:45 -0000	1.36
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.35 2005/03/12 03:24:30 fabianx Exp $
+# CVS: $Id: nxnode,v 1.36 2005/03/12 08:03:45 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -206,37 +206,29 @@
 
 	[ "$NX_NOMACHINE_WAY" = "1" ] && export LD_LIBRARY_PATH="$PATH_LIB:$LD_LIBRARY_PATH"
 
-	# nxdesktop session
-
 	if [ "$type" = "windows" ]
 	then
+		# nxdesktop session (Windows RDP)
 		U=""
 		P=""
 		[ -n "$agent_user" ] && U="-u $agent_user"
 		[ -n "$agent_password" ] && P="-p -"
 		echo "$agent_password" | $PATH_BIN/nxdesktop -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $U $P $agent_server $AGENT_EXTRA_OPTIONS_RDP 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
-	else
-
-	# nxviewer session
-	
-	if [ "$type" = "vnc" ]
+	elif [ "$type" = "vnc" ]
 	then
+		# nxviewer session (VNC RFP)
 		mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/scripts/
 		echo "$agent_password" | $PATH_BIN/nxpasswd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd doit
 		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)"  $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
+	elif [ -n "$R" -a "$ENABLE_ROOTLESS_MODE" != "1" ]
+	then
+		# nxproxy single application mode session
+		$PATH_BIN/nxproxy -C :$display $PROXY_EXTRA_OPTIONS 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	else
-		# "normal" nxagent session
-		if [ -n "$R" -a "$ENABLE_ROOTLESS_MODE" != "1" ]
-		then
-			# nxproxy single application mode session
-			$PATH_BIN/nxproxy -C :$display $PROXY_EXTRA_OPTIONS 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
-		else
-			FP=""
-			[ -n "$AGENT_FONT_SERVER" ] && FP="-fp $AGENT_FONT_SERVER"
-			# nxagent session
-			$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
-		fi
-	fi
+		# nxagent session (X11)
+		FP=""
+		[ -n "$AGENT_FONT_SERVER" ] && FP="-fp $AGENT_FONT_SERVER"
+		$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	fi
 	PID=$!
 	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/






From freenx-cvs at berlios.de  Sat Mar 12 13:13:25 2005
From: freenx-cvs at berlios.de (jonno)
Date: Sat, 12 Mar 2005 13:13:25 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 3 files
Message-ID: <4232DCE5.mailCGB1MX3X5@lists.berlios.de>

User:      jonno
Date:      2005-03-12 12:13:25 GMT
Modified:  .        nxloadconfig nxnode nxserver
Log:
Fixed broken nxloadconfig --check as well as improved the checks considerably

Revision  Changes    Path
1.16      +81 -31    freenx/nxloadconfig


rev 1.16, prev_rev 1.15
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.15
retrieving revision 1.16
diff -u -r1.15 -r1.16
--- nxloadconfig	12 Mar 2005 02:49:28 -0000	1.15
+++ nxloadconfig	12 Mar 2005 12:13:25 -0000	1.16
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.15 2005/03/12 02:49:28 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.16 2005/03/12 12:13:25 jonno Exp $
 #
 # ========================================================================
 
@@ -193,13 +193,30 @@
 	ERROR="no"
 	WARNING="no"
 	
+	[ ! -d "$PATH_BIN" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"PATH_BIN=$PATH_BIN\""
+	[ ! -d "$PATH_LIB" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"PATH_LIB=$PATH_LIB\""
+	[ ! -d "$NX_ETC_DIR" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NX_ETC_DIR=$NX_ETC_DIR\""
+	[ ! -d "$NX_SESS_DIR" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NX_SESS_DIR=$NX_SESS_DIR\""
+	[ ! -d "$NX_HOME_DIR" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NX_HOME_DIR=$NX_HOME_DIR\""
+	
+	[ -z $(echo "$NX_NOMACHINE_WAY" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NX_NOMACHINE_WAY=$NX_NOMACHINE_WAY\""
+
+	[ -z "$SSH_AUTHORIZED_KEYS" ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SSH_AUTHORIZED_KEYS=$SSH_AUTHORIZED_KEYS\"" 
+	
 	[ -z $(echo "$NX_LOGGING" | egrep "^[0|1]$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"NX_LOGGING=$NX_LOGGING\""
 	[ "$NX_LOGGING" = "1" -a ! -e "$NX_LOGFILE" ] && \
 		WARNING="yes" && echo "Warning: Invalid value \"NX_LOGFILE=$NX_LOGFILE\"" \
 					  && echo "         No loggfile will be kept."
 		# How do I check if another user might write to a file? ( -w checks only current user)
-	[ -z $(echo "$SESSION_HISTORY" | egrep "^-?[0-9]*$") ] && \
+	[ -z $(echo "$SESSION_HISTORY" | egrep "^-?[0-9]+$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SESSION_HISTORY=$SESSION_HISTORY\""
 	
 	[ -z $(echo "$ENABLE_PASSDB_AUTHENTICATION" | egrep "^[0|1]$") ] && \
@@ -226,22 +243,26 @@
 	
 	[ -z $(echo "$ENABLE_SERVER_FORWARD" | egrep "^[0|1]$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"ENABLE_SERVER_FORWARD=$ENABLE_SERVER_FORWARD\""
-	[ "$ENABLE_SERVER_FORWARD" = "1" -a -n "$SERVER_FORWARD_HOST" ] && \
+	[ "$ENABLE_SERVER_FORWARD" = "1" -a -z "$SERVER_FORWARD_HOST" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SERVER_FORWARD_HOST=$SERVER_FORWARD_HOST\"" 
 		# Any ideas on how I can check for a VALID host is velcome!
 		# In my private scripts I use 'resolveip -q' and check if output conforms to [0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}, 
 		# but resolveip is part of mysql, and I don't think I should add that dependancy...
-	[ "$ENABLE_SERVER_FORWARD" = "1" -a -z $(echo "$SERVER_FORWARD_PORT" | egrep "^[0-9]*$") ] && \
+	[ "$ENABLE_SERVER_FORWARD" = "1" -a -z $(echo "$SERVER_FORWARD_PORT" | egrep "^[1-9][0-9]{0,4}$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SERVER_FORWARD_PORT=$SERVER_FORWARD_PORT\""
 	[ "$ENABLE_SERVER_FORWARD" = "1" -a ! -e "$SERVER_FORWARD_KEY" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SERVER_FORWARD_KEY=$SERVER_FORWARD_KEY\""
 	
-	[ -z $(echo "$ENABLE_NOMACHINE_FORWARD" | egrep "^[0|1]$") ] && \
-		ERROR="yes" && echo "Error: Invalid value \"ENABLE_NOMACHINE_FORWARD=$ENABLE_NOMACHINE_FORWARD\""
-	[ "$ENABLE_NOMACHINE_FORWARD" = "1" ] && ! which "$NOMACHINE_SERVER" >/dev/null 2>&1 && \
+	[ -z $(echo "$ENABLE_NOMACHINE_FORWARD_USER" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_NOMACHINE_FORWARD_USER=$ENABLE_NOMACHINE_FORWARD_USER\""
+	[ -z $(echo "$ENABLE_NOMACHINE_FORWARD_PORT" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_NOMACHINE_FORWARD_PORT=$ENABLE_NOMACHINE_FORWARD_PORT\""
+	[ "$ENABLE_NOMACHINE_FORWARD_USER" = "1" -o "$ENABLE_NOMACHINE_FORWARD_PORT" = "1" ] && ! which "$NOMACHINE_SERVER" >/dev/null 2>&1 && \
 		ERROR="yes" && echo "Error: Invalid value \"NOMACHINE_SERVER=$NOMACHINE_SERVER\""
-	[ "$ENABLE_NOMACHINE_FORWARD" = "1" -a ! -d "$NOMACHINE_NX_HOME_DIR" ] && \
+	[ "$ENABLE_NOMACHINE_FORWARD_USER" = "1" -a ! -d "$NOMACHINE_NX_HOME_DIR" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"NOMACHINE_NX_HOME_DIR=$NOMACHINE_NX_HOME_DIR\""
+	[ "$ENABLE_NOMACHINE_FORWARD_PORT" = "1" -a -z $(echo "$NOMACHINE_FORWARD_PORT" | egrep "^[1-9][0-9]{0,4}$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NOMACHINE_FORWARD_PORT=$NOMACHINE_FORWARD_PORT\""
 	
 	[ -z $(echo "$ENABLE_ROOTLESS_MODE" | egrep "^[0|1]$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"ENABLE_ROOTLESS_MODE=$ENABLE_ROOTLESS_MODE\""
@@ -252,6 +273,21 @@
 		WARNING="yes" && echo "Warning: Invalid value \"ESD_BIN_PRELOAD=$ESD_BIN_PRELOAD\"" \
 					  && echo "         No esd preload will be performed."
 	
+	[ -z $(echo "$ENABLE_ARTSD_PRELOAD" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_ARTSD_PRELOAD=$ENABLE_ARTSD_PRELOAD\""
+	[ "$ARTSD_BIN_PRELOAD" = "1" ] && ! which "$ARTSD_BIN_PRELOAD" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"ARTSD_BIN_PRELOAD=$ARTSD_BIN_PRELOAD\"" \
+					  && echo "         No arts preload will be performed."
+	
+	! which "$COMMAND_NETCAT" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_NETCAT=$COMMAND_NETCAT\""
+	
+	[ -z $(echo "$ENABLE_USESSION" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"ENABLE_USESSION=$ENABLE_USESSION\""
+	[ "$ENABLE_USESSION" = "1" ] && ! which "$COMMAND_SESSREG" >/dev/null 2>&1 && \
+		WARNING="yes" && echo "Warning: Invalid value \"COMMAND_SESSREG=$COMMAND_SESSREG\"" \
+					  && echo "         Logged in users will not be registered with sessreg."
+	
 	[ ! -d "$USER_FAKE_HOME" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"USER_FAKE_HOME=$USER_FAKE_HOME\""
 	
@@ -260,22 +296,23 @@
 	
 	[ -z $(echo "$SSHD_CHECK_IP" | egrep "^[0|1]$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SSHD_CHECK_IP=$SSHD_CHECK_IP\""
-	[ -z $(echo "$SSHD_PORT" | egrep "^[0-9]*$") ] && \
+	[ -z $(echo "$SSHD_PORT" | egrep "^[1-9][0-9]{0,4}$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SSHD_PORT=$SSHD_PORT\""
 	
-	[ -z $(echo "$DISPLAY_BASE" | egrep "^[0-9]*$") ] && \
+	[ -z $(echo "$DISPLAY_BASE" | egrep "^[1-9][0-9]{0,4}$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"DISPLAY_BASE=$DISPLAY_BASE\""
-		[ -z $(echo "$SESSION_LIMIT" | egrep "^[0-9]*$") ] &&  \
-			ERROR="yes" && echo "Error: Invalid value \"SESSION_LIMIT=$SESSION_LIMIT\""
-	[ -z $(echo "$SESSION_USER_LIMIT" | egrep "^[0-9]*$") -o $SESSION_USER_LIMIT -gt $SESSION_LIMIT ] && \
+	[ -z $(echo "$SESSION_LIMIT" | egrep "^[1-9][0-9]{0,4}$") ] &&  \
+		ERROR="yes" && echo "Error: Invalid value \"SESSION_LIMIT=$SESSION_LIMIT\""
+	[ -z $(echo "$SESSION_USER_LIMIT" | egrep "^[1-9][0-9]{0,4}$") -o $SESSION_USER_LIMIT -gt $SESSION_LIMIT ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SESSION_USER_LIMIT=$SESSION_USER_LIMIT\""
-	[ -z $(echo "$DISPLAY_LIMIT" | egrep "^[0-9]*$") -o $DISPLAY_LIMIT -lt $SESSION_LIMIT ] && \
+	[ -z $(echo "$DISPLAY_LIMIT" | egrep "^[1-9][0-9]{0,4}$") -o $DISPLAY_LIMIT -lt $SESSION_LIMIT ] && \
 		ERROR="yes" && echo "Error: Invalid value \"DISPLAY_LIMIT=$DISPLAY_LIMIT\""
 	
 	! which "$DEFAULT_X_WM" >/dev/null 2>&1 && \
 		ERROR="yes" && echo "Error: Invalid value \"DEFAULT_X_WM=$DEFAULT_X_WM\""
 	! which "$DEFAULT_X_SESSION" >/dev/null 2>&1 && \
-		ERROR="yes" && echo "Error: Invalid value \"DEFAULT_X_SESSION=$DEFAULT_X_SESSION\""
+		WARNING="yes" && echo "Warning: Invalid value \"DEFAULT_X_SESSION=$DEFAULT_X_SESSION\"" \
+					  && echo "         Users might not be able to request a default X session."
 	! which "$COMMAND_START_KDE" >/dev/null 2>&1 && \
 		WARNING="yes" && echo "Warning: Invalid value \"COMMAND_START_KDE=$COMMAND_START_KDE\"" \
 					  && echo "         Users will not be able to request a KDE session."
@@ -303,24 +340,18 @@
 	! which "$COMMAND_SMBUMOUNT" >/dev/null 2>&1 && \
 		ERROR="yes" && echo "Error: Invalid value \"COMMAND_SMBUMOUNT=$COMMAND_SMBUMOUNT\""
 	
-	OLD_IFS=$IFS
-	IFS=","
-	if [ "$ENABLE_PERSISTENT_SESSION" != "all" ]
-	then
-		for USERNAME in $ENABLE_PERSISTENT_SESSION; do
-			[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
-				ERROR="yes" && echo "Error: Invalid value \"ENABLE_PERSISTENT_SESSION=$ENABLE_PERSISTENT_SESSION\"" && break ;
-		done
-	fi
-	for USERNAME in $DISABLE_PERSISTENT_SESSION; do
-		[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
-			ERROR="yes" && echo "Error: Invalid value \"DISABLE_PERSISTENT_SESSION=$DISABLE_PERSISTENT_SESSION\"" && break ;
-	done
-	IFS=$OLD_IFS
+	#AGENT_EXTRA_OPTIONS_RFB=""
+	#AGENT_EXTRA_OPTIONS_RDP=""
+	#AGENT_EXTRA_OPTIONS_X=""
+	#PROXY_EXTRA_OPTIONS=""
+		#Can these be checked???
 	
 	#AGENT_FONT_SERVER=""
 		#Any ideas on how I can check for a VALID host is velcome!
 	
+	[ -z $(echo "$PROXY_TCP_NODELAY" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"PROXY_TCP_NODELAY=$PROXY_TCP_NODELAY\""
+	
 	[ -z $(echo "$CUPS_SUPPORT" | egrep "^[0|1]$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"CUPS_SUPPORT=$CUPS_SUPPORT\""
 	# CUPS_BACKEND=""
@@ -336,8 +367,27 @@
 		ERROR="yes" && echo "Error: Invalid value \"PROXY_LIBRARY_PATH=$PROXY_LIBRARY_PATH\""
 	[ ! -d "$APPLICATION_LIBRARY_PATH" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"APPLICATION_LIBRARY_PATH=$APPLICATION_LIBRARY_PATH\""
-	#APPLICATION_LIBRARY_PRELOAD=""
-		# As this isn't used yet I don't know how to realy check for it. Fix this when adding support!
+	
+	OLD_IFS=$IFS
+	IFS=","
+	if [ "$ENABLE_PERSISTENT_SESSION" != "all" ]
+	then
+		for USERNAME in $ENABLE_PERSISTENT_SESSION; do
+			[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+				ERROR="yes" && echo "Error: Invalid value \"ENABLE_PERSISTENT_SESSION=$ENABLE_PERSISTENT_SESSION\"" && break ;
+		done
+	fi
+	for USERNAME in $DISABLE_PERSISTENT_SESSION; do
+		[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+			ERROR="yes" && echo "Error: Invalid value \"DISABLE_PERSISTENT_SESSION=$DISABLE_PERSISTENT_SESSION\"" && break ;
+	done
+	
+	IFS=":"
+	for LIBRARY in $APPLICATION_LIBRARY_PRELOAD; do
+		[ ! -e $LIBRARY ] && \
+			ERROR="yes" && echo "Error: Invalid value \"APPLICATION_LIBRARY_PRELOAD=$APPLICATION_LIBRARY_PRELOAD\"" && break ;
+	done
+	IFS=$OLD_IFS
 	
 	if [ "$ERROR" = "yes" ]
 	then



1.37      +6 -6      freenx/nxnode


rev 1.37, prev_rev 1.36
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.36
retrieving revision 1.37
diff -u -r1.36 -r1.37
--- nxnode	12 Mar 2005 08:03:45 -0000	1.36
+++ nxnode	12 Mar 2005 12:13:25 -0000	1.37
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.36 2005/03/12 08:03:45 jonno Exp $
+# CVS: $Id: nxnode,v 1.37 2005/03/12 12:13:25 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -137,9 +137,9 @@
 			STARTX=$application
 		;;
 		unix-default)
-			if [ -f "$HOME/.Xclients" ]; then
+			if [ -x "$HOME/.Xclients" ]; then
 				STARTX="$HOME/.Xclients"
-			elif [ -f "$DEFAULT_X_SESSION" ]; then
+			elif which "$DEFAULT_X_SESSION" >/dev/null 2>&1 ; then
 				STARTX="$DEFAULT_X_SESSION"
 			fi
 		;;
@@ -153,7 +153,7 @@
 		export ESPEAKER="127.0.0.1:$ESPEAKER"
 		
 		# Check for config file directive
-		if [ "$ENABLE_ESD_PRELOAD" = "1" ]
+		if [ "$ENABLE_ESD_PRELOAD" = "1" -a -x $ESD_BIN_PRELOAD ]
 		then
 			STARTX="$ESD_BIN_PRELOAD $STARTX"
 			
@@ -166,7 +166,7 @@
 	then
 		# Overwrite users mcoprc
 		echo -n "GlobalComm=Arts::X11GlobalComm" > $USER_FAKE_HOME/.mcoprc
-		if [ "$ENABLE_ARTSD_PRELOAD" = "1" ]
+		if [ "$ENABLE_ARTSD_PRELOAD" = "1" -a -x $ARTSD_BIN_PRELOAD ]
 		then
 			STARTX="$ARTSD_BIN_PRELOAD $STARTX"
 			echo "Info: NXNODE - Using $ARTSD_BIN_PRELOAD wrapper script." >> $USER_FAKE_HOME/.nx/C-$sess_id/session
@@ -539,7 +539,7 @@
 	node_start_applications &
 fi
 
-[ -n "$NODE_AUTOSTART" ] && "$NODE_AUTOSTART" "$1"
+which "$NODE_AUTOSTART" >/dev/null 2>&1 && "$NODE_AUTOSTART" "$1"
 	
 cat << EOF
 NX> 700 Session id: $sess_id



1.36      +4 -5      freenx/nxserver


rev 1.36, prev_rev 1.35
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.35
retrieving revision 1.36
diff -u -r1.35 -r1.36
--- nxserver	12 Mar 2005 04:17:03 -0000	1.35
+++ nxserver	12 Mar 2005 12:13:25 -0000	1.36
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.35 2005/03/12 04:17:03 fabianx Exp $
+# CVS: $Id: nxserver,v 1.36 2005/03/12 12:13:25 jonno Exp $
 #
 
 # Read the config file
@@ -350,14 +350,13 @@
 
 log()
 {
-	[ "$NX_LOGGING" = "1" ] && echo "$@" >> "$NX_LOGFILE"
+	[ "$NX_LOGGING" = "1" -a -w "$NX_LOGFILE" ] && echo "$@" >> "$NX_LOGFILE"
 }
 
 log_tee()
 {
-
-  [ "$NX_LOGGING" = "1" ] && exec tee -a "$NX_LOGFILE"
-  [ "$NX_LOGGING" = "1" ] || exec cat -
+	[ "$NX_LOGGING" = "1" -a -w "$NX_LOGFILE" ] && exec tee -a "$NX_LOGFILE"
+	[ "$NX_LOGGING" = "1" -a -w "$NX_LOGFILE" ] || exec cat -
 }
 
 echo_x()






From freenx-cvs at berlios.de  Sat Mar 12 17:54:47 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 17:54:47 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxnode
Message-ID: <42331ED7.mail9AD11R8G8@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 16:54:47 GMT
Modified:  .        nxnode
Log:
Fixed ARTSD support in case $USER_FAKE_HOME != $HOME.
(Thanks to jonno for spotting this mistake)

Revision  Changes    Path
1.38      +2 -2      freenx/nxnode


rev 1.38, prev_rev 1.37
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.37
retrieving revision 1.38
diff -u -r1.37 -r1.38
--- nxnode	12 Mar 2005 12:13:25 -0000	1.37
+++ nxnode	12 Mar 2005 16:54:47 -0000	1.38
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.37 2005/03/12 12:13:25 jonno Exp $
+# CVS: $Id: nxnode,v 1.38 2005/03/12 16:54:47 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -165,7 +165,7 @@
 	elif [ "$mediahelper" = "artsd" ]
 	then
 		# Overwrite users mcoprc
-		echo -n "GlobalComm=Arts::X11GlobalComm" > $USER_FAKE_HOME/.mcoprc
+		echo -n "GlobalComm=Arts::X11GlobalComm" > $HOME/.mcoprc
 		if [ "$ENABLE_ARTSD_PRELOAD" = "1" -a -x $ARTSD_BIN_PRELOAD ]
 		then
 			STARTX="$ARTSD_BIN_PRELOAD $STARTX"






From freenx-cvs at berlios.de  Sat Mar 12 18:55:14 2005
From: freenx-cvs at berlios.de (jonno)
Date: Sat, 12 Mar 2005 18:55:14 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 5 files
Message-ID: <42332D02.mailCGT1LQFGE@lists.berlios.de>

User:      jonno
Date:      2005-03-12 17:55:14 GMT
Modified:  .        ChangeLog gentoo-nomachine.diff node.conf.sample
Modified:           nxloadconfig nxnode
Log:
Adds LD_PRELOAD and LD_LIBRARY_PATH by default and replaces NX_NOMACHINE_WAY with SET_LD_LIBRARY_PATH.

Revision  Changes    Path
1.31      +3 -0      freenx/ChangeLog


rev 1.31, prev_rev 1.30
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.30
retrieving revision 1.31
diff -u -r1.30 -r1.31
--- ChangeLog	12 Mar 2005 04:17:03 -0000	1.30
+++ ChangeLog	12 Mar 2005 17:55:13 -0000	1.31
@@ -10,6 +10,9 @@
 	  Added -option option to nxagent/nxdesktop.
 	* Added forwarding to commercial server via destination port.
 	* Added more compatible getparam function
+	* Sets LD_PRELOAD for applications and LD_LIBRARY_PATH for nxagent/nxproxy by default.
+		- SET_LD_LIBRARY_PATH replaces NX_NOMACHINE_WAY and is 
+		  enabled by default, as it is now safe to do so
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.14      +1 -6      freenx/gentoo-nomachine.diff


rev 1.14, prev_rev 1.13
Index: gentoo-nomachine.diff
===================================================================
RCS file: /cvsroot/freenx/freenx/gentoo-nomachine.diff,v
retrieving revision 1.13
retrieving revision 1.14
diff -u -r1.13 -r1.14
--- gentoo-nomachine.diff	25 Feb 2005 15:35:09 -0000	1.13
+++ gentoo-nomachine.diff	12 Mar 2005 17:55:13 -0000	1.14
@@ -1,6 +1,6 @@
 --- nxloadconfig.old	2005-02-14 01:08:56.482546352 +0100
 +++ nxloadconfig	2005-02-14 01:09:40.109913984 +0100
-@@ -18,16 +18,16 @@
+@@ -53,12 +53,12 @@
  NX_LICENSE="OS (GPL)"
  
  # Where can different nx components be found
@@ -14,11 +14,6 @@
 +NX_ETC_DIR=$NX_DIR/etc
 +NX_SESS_DIR=$NX_DIR/var/db
 +NX_HOME_DIR=$NX_DIR/home/nx
- 
- # adds PATH_LIB to the startup of nxagents
- # Should be set to 1 if PATH_LIB is not a system default library path
--NX_NOMACHINE_WAY="0"
-+NX_NOMACHINE_WAY="1"
  
  # the name of the authorized keys file for ssh
  SSH_AUTHORIZED_KEYS="authorized_keys2"



1.12      +6 -1      freenx/node.conf.sample


rev 1.12, prev_rev 1.11
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.11
retrieving revision 1.12
diff -u -r1.11 -r1.12
--- node.conf.sample	12 Mar 2005 02:49:28 -0000	1.11
+++ node.conf.sample	12 Mar 2005 17:55:13 -0000	1.12
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.11 2005/03/12 02:49:28 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.12 2005/03/12 17:55:13 jonno Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -167,6 +167,11 @@
 # Note that this directory must be unique for every user! To accomplish this 
 # it is recomended to include $USER in the path.
 #USER_FAKE_HOME=$HOME
+
+# Add the nx libraries to LD_LIBRARY_PATH before starting nx agents.
+# WARNING: This will NOT (and should not) affect aplications. ONLY Disable this
+#          if the nx libraries is in a standard system path (such as /usr/lib)!
+#SET_LD_LIBRARY_PATH="1"
 
 #########################################################################
 # NoMachine node.conf compatible (almost) directives



1.17      +6 -8      freenx/nxloadconfig


rev 1.17, prev_rev 1.16
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.16
retrieving revision 1.17
diff -u -r1.16 -r1.17
--- nxloadconfig	12 Mar 2005 12:13:25 -0000	1.16
+++ nxloadconfig	12 Mar 2005 17:55:13 -0000	1.17
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.16 2005/03/12 12:13:25 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.17 2005/03/12 17:55:13 jonno Exp $
 #
 # ========================================================================
 
@@ -60,10 +60,6 @@
 NX_SESS_DIR=/var/lib/nxserver/db
 NX_HOME_DIR=/var/lib/nxserver/home
 
-# adds PATH_LIB to the startup of nxagents
-# Should be set to 1 if PATH_LIB is not a system default library path
-NX_NOMACHINE_WAY="0"
-
 # the name of the authorized keys file for ssh
 SSH_AUTHORIZED_KEYS="authorized_keys2"
 
@@ -113,6 +109,8 @@
 ENABLE_USESSION="0"
 COMMAND_SESSREG="sessreg"
 
+SET_LD_LIBRARY_PATH="1"
+
 # NoMachine node.conf compatible vars
 
 SSHD_CHECK_IP="0"
@@ -204,9 +202,6 @@
 	[ ! -d "$NX_HOME_DIR" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"NX_HOME_DIR=$NX_HOME_DIR\""
 	
-	[ -z $(echo "$NX_NOMACHINE_WAY" | egrep "^[0|1]$") ] && \
-		ERROR="yes" && echo "Error: Invalid value \"NX_NOMACHINE_WAY=$NX_NOMACHINE_WAY\""
-
 	[ -z "$SSH_AUTHORIZED_KEYS" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SSH_AUTHORIZED_KEYS=$SSH_AUTHORIZED_KEYS\"" 
 	
@@ -361,6 +356,9 @@
 	[ "$CUPS_SUPPORT" = "1" -a ! -d "$CUPS_SBIN" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"CUPS_SBIN=$CUPS_SBIN\""
 	
+	[ -z $(echo "$SET_LD_LIBRARY_PATH" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SET_LD_LIBRARY_PATH=$SET_LD_LIBRARY_PATH\""
+		
 	[ ! -d "$AGENT_LIBRARY_PATH" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"AGENT_LIBRARY_PATH=$AGENT_LIBRARY_PATH\""
 	[ ! -d "$PROXY_LIBRARY_PATH" ] && \



1.39      +6 -3      freenx/nxnode


rev 1.39, prev_rev 1.38
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.38
retrieving revision 1.39
diff -u -r1.38 -r1.39
--- nxnode	12 Mar 2005 16:54:47 -0000	1.38
+++ nxnode	12 Mar 2005 17:55:13 -0000	1.39
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.38 2005/03/12 16:54:47 fabianx Exp $
+# CVS: $Id: nxnode,v 1.39 2005/03/12 17:55:13 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -173,6 +173,7 @@
 		fi
 	fi
 
+	[ "$virtualdesktop" = "0" -a "$ENABLE_ROOTLESS_MODE" != "1" ] && export LD_PRELOAD="$APPLICATION_LIBRARY_PRELOAD:$LD_PRELOAD"
 	DISPLAY=unix:$display $STARTX >>$USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
 	APP_PID=$!
 	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/
@@ -204,11 +205,10 @@
 	R=""
 	[ "$virtualdesktop" = "0" ] && R="-rootless"
 
-	[ "$NX_NOMACHINE_WAY" = "1" ] && export LD_LIBRARY_PATH="$PATH_LIB:$LD_LIBRARY_PATH"
-
 	if [ "$type" = "windows" ]
 	then
 		# nxdesktop session (Windows RDP)
+		[ "$SET_LD_LIBRARY_PATH" = "1" ] && export LD_LIBRARY_PATH="$AGENT_LIBRARY_PATH:$LD_LIBRARY_PATH"
 		U=""
 		P=""
 		[ -n "$agent_user" ] && U="-u $agent_user"
@@ -217,15 +217,18 @@
 	elif [ "$type" = "vnc" ]
 	then
 		# nxviewer session (VNC RFP)
+		[ "$SET_LD_LIBRARY_PATH" = "1" ] && export LD_LIBRARY_PATH="$AGENT_LIBRARY_PATH:$LD_LIBRARY_PATH"
 		mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/scripts/
 		echo "$agent_password" | $PATH_BIN/nxpasswd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd doit
 		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)"  $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	elif [ -n "$R" -a "$ENABLE_ROOTLESS_MODE" != "1" ]
 	then
 		# nxproxy single application mode session
+		[ "$SET_LD_LIBRARY_PATH" = "1" ] && export LD_LIBRARY_PATH="$PROXY_LIBRARY_PATH:$LD_LIBRARY_PATH"
 		$PATH_BIN/nxproxy -C :$display $PROXY_EXTRA_OPTIONS 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	else
 		# nxagent session (X11)
+		[ "$SET_LD_LIBRARY_PATH" = "1" ] && export LD_LIBRARY_PATH="$AGENT_LIBRARY_PATH:$LD_LIBRARY_PATH"
 		FP=""
 		[ -n "$AGENT_FONT_SERVER" ] && FP="-fp $AGENT_FONT_SERVER"
 		$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &






From freenx-cvs at berlios.de  Sat Mar 12 18:57:35 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 18:57:35 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <42332D8F.mailFVN11CKHM@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 17:57:35 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog nxnode
Log:
Fixed handling of /tmp/.X*-lock files.

If agent fails to resume, these are now correctly removed.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.7  +1 -0      freenx/ChangeLog


rev 1.16.2.7, prev_rev 1.16.2.6
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.6
retrieving revision 1.16.2.7
diff -u -r1.16.2.6 -r1.16.2.7
--- ChangeLog	12 Mar 2005 05:08:27 -0000	1.16.2.6
+++ ChangeLog	12 Mar 2005 17:57:35 -0000	1.16.2.7
@@ -5,6 +5,7 @@
 	* Fixed locking to prevent usage of the same display.
 	* Fixed resume when agent is no longer there.
 	* Fixed error message shown to user, when session startup fails.
+	* Fixed handling of /tmp/.X*-lock files.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.23.2.4  +12 -9     freenx/nxnode


rev 1.23.2.4, prev_rev 1.23.2.3
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.23.2.3
retrieving revision 1.23.2.4
diff -u -r1.23.2.3 -r1.23.2.4
--- nxnode	12 Mar 2005 05:08:27 -0000	1.23.2.3
+++ nxnode	12 Mar 2005 17:57:35 -0000	1.23.2.4
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.23.2.3 2005/03/12 05:08:27 fabianx Exp $
+# CVS: $Id: nxnode,v 1.23.2.4 2005/03/12 17:57:35 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -87,11 +87,11 @@
 			sleep 1
 			kill -9 $AGENT_PID 2>/dev/null
 		fi
-		# remove possible leftover display ...
-		display=$(echo $1 | cut -d"-" -f2)
-		rm -f /tmp/.X$display-lock
-		rm -f /tmp/.X11-unix/X$display
 	fi
+	# remove possible leftover display ...
+	display=$(echo $1 | cut -d"-" -f2)
+	rm -f /tmp/.X$display-lock
+	rm -f /tmp/.X11-unix/X$display
 	
 	# remove cookie
 	$COMMAND_XAUTH -v source ~/.nx/C-$sess_id/scripts/authority >/dev/null 2>&1
@@ -260,10 +260,13 @@
 			# now set a timeout of 10 seconds ...
 			( 
                           sleep 10
-		          echo "NX> 1004 Error: nxagent failed to start. Session timed out."
-			  echo "                Blocking $display again ..."
-			  touch /tmp/.X$display-lock
-			  mv $HOME/.nx/C-$sess_id/ $HOME/.nx/F-C-$sess_id/
+			  if [ -d "$HOME/.nx/C-$sess_id/" ]
+			  then
+		          	echo "NX> 1004 Error: nxagent failed to start. Session timed out."
+			  	echo "                Blocking $display again ..."
+				touch /tmp/.X$display-lock
+			  	mv $HOME/.nx/C-$sess_id/ $HOME/.nx/F-C-$sess_id/ 2>/dev/null
+			  fi
 			  kill $TAIL_PID 2>/dev/null
 			) &
 			TIMEOUT_PID=$!






From freenx-cvs at berlios.de  Sat Mar 12 19:19:03 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sat, 12 Mar 2005 19:19:03 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <42333297.mailECB11148U@lists.berlios.de>

User:      fabianx
Date:      2005-03-12 18:19:02 GMT
Modified:  .        ChangeLog nxnode nxserver
Log:
* Fixed resume when agent is no longer there:

(i.e. it crashed or someone rebooted the computer).

* Fixed error message shown to user, when session startup fails:

(before there was a long waiting for the timeout)

* Fixed handling of /tmp/.X*-lock files:

If agent fails to resume, these are now correctly removed.

(ported from 0.3.0-bugfixes branch)

Revision  Changes    Path
1.32      +3 -0      freenx/ChangeLog


rev 1.32, prev_rev 1.31
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.31
retrieving revision 1.32
diff -u -r1.31 -r1.32
--- ChangeLog	12 Mar 2005 17:55:13 -0000	1.31
+++ ChangeLog	12 Mar 2005 18:19:02 -0000	1.32
@@ -19,6 +19,9 @@
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.
 	* Fixed locking to prevent usage of the same display.
+	* Fixed resume when agent is no longer there.
+	* Fixed error message shown to user, when session startup fails.
+	* Fixed handling of /tmp/.X*-lock files.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.40      +26 -10    freenx/nxnode


rev 1.40, prev_rev 1.39
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.39
retrieving revision 1.40
diff -u -r1.39 -r1.40
--- nxnode	12 Mar 2005 17:55:13 -0000	1.39
+++ nxnode	12 Mar 2005 18:19:02 -0000	1.40
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.39 2005/03/12 17:55:13 jonno Exp $
+# CVS: $Id: nxnode,v 1.40 2005/03/12 18:19:02 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -87,11 +87,11 @@
 			sleep 1
 			kill -9 $AGENT_PID 2>/dev/null
 		fi
-		# remove possible leftover display ...
-		display=$(echo $1 | cut -d"-" -f2)
-		rm -f /tmp/.X$display-lock
-		rm -f /tmp/.X11-unix/X$display
 	fi
+	# remove possible leftover display ...
+	display=$(echo $1 | cut -d"-" -f2)
+	rm -f /tmp/.X$display-lock
+	rm -f /tmp/.X11-unix/X$display
 	
 	# remove cookie
 	$COMMAND_XAUTH -v source $USER_FAKE_HOME/.nx/C-$sess_id/scripts/authority >/dev/null 2>&1
@@ -101,10 +101,22 @@
 	rm -rf $USER_FAKE_HOME/.nx/C-$1/
 }
 
+node_fail_restore_session()
+{
+	echo "NX> 1004 Error: Could not resume session. nxagent process could not be found."
+	node_terminate_session "$sess_id"
+	exit 1
+}
+
 node_suspend_session()
 {
 	AGENT_PID=$(cat $USER_FAKE_HOME/.nx/C-$1/pids/agent 2>/dev/null)
-	[ -n "$AGENT_PID" ] && kill -HUP $AGENT_PID
+	if [ -n "$AGENT_PID" ]
+	then 
+		kill -0 $AGENT_PID || return 1
+		kill -HUP $AGENT_PID && return 0
+	fi
+	return 1
 }
 
 # ---------
@@ -282,9 +294,13 @@
 			# now set a timeout of 10 seconds ...
 			( 
                           sleep 10
-		          echo "NX> 1004 Error: nxagent failed to start. Session timed out."
-			  echo "                Blocking $display again ..."
-			  touch /tmp/.X$display-lock
+			  if [ -d "$HOME/.nx/C-$sess_id/" ]
+			  then
+		          	echo "NX> 1004 Error: nxagent failed to start. Session timed out."
+			  	echo "                Blocking $display again ..."
+				touch /tmp/.X$display-lock
+			  	mv $HOME/.nx/C-$sess_id/ $HOME/.nx/F-C-$sess_id/ 2>/dev/null
+			  fi
 			  kill $TAIL_PID 2>/dev/null
 			) &
 			TIMEOUT_PID=$!
@@ -536,7 +552,7 @@
 
 if [ "$1" = "restore" ]
 then
-	node_suspend_session $sess_id
+	node_suspend_session $sess_id || node_fail_restore_session
 else
 	node_start_agent &
 	node_start_applications &



1.37      +3 -1      freenx/nxserver


rev 1.37, prev_rev 1.36
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.36
retrieving revision 1.37
diff -u -r1.36 -r1.37
--- nxserver	12 Mar 2005 12:13:25 -0000	1.36
+++ nxserver	12 Mar 2005 18:19:02 -0000	1.37
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.36 2005/03/12 12:13:25 jonno Exp $
+# CVS: $Id: nxserver,v 1.37 2005/03/12 18:19:02 fabianx Exp $
 #
 
 # Read the config file
@@ -645,6 +645,8 @@
 			;;
 			"NX> 1004"*)
 				session_fail $uniqueid
+				# FIXME: Need correct error code.
+				echo_x "NX> 504 Session startup failed."
 			;;
 		esac
 






From freenx-cvs at berlios.de  Sat Mar 12 23:12:04 2005
From: freenx-cvs at berlios.de (lroufail)
Date: Sat, 12 Mar 2005 23:12:04 +0100
Subject: [Freenx-cvs] CVS: nxc - lroufail modified nxrun/Makefile.am
Message-ID: <42336934.mailEGN11IDCM@lists.berlios.de>

User:      lroufail
Date:      2005-03-12 22:12:04 GMT
Modified:  nxrun    Makefile.am
Log:
Correct typographical error in automake file.

Revision  Changes    Path
1.3       +1 -1      nxc/nxrun/Makefile.am


rev 1.3, prev_rev 1.2
Index: Makefile.am
===================================================================
RCS file: /cvsroot/freenx/nxc/nxrun/Makefile.am,v
retrieving revision 1.2
retrieving revision 1.3
diff -u -r1.2 -r1.3
--- Makefile.am	12 Mar 2005 04:54:26 -0000	1.2
+++ Makefile.am	12 Mar 2005 22:12:04 -0000	1.3
@@ -5,4 +5,4 @@
 
 nxrun_SOURCES = MainUnix.cpp ConsoleCallback.cpp
 
-LDADD = ../nxcompsh/.libs/libXcompsh.a ../nxriver/.libs/libXdriver.a -lexpat -L/usr/X11R6/lib -lxkbfile -lXext
+LDADD = ../nxcompsh/.libs/libXcompsh.a ../nxdriver/.libs/libXdriver.a -lexpat -L/usr/X11R6/lib -lxkbfile -lXext






From freenx-cvs at berlios.de  Sun Mar 13 11:57:36 2005
From: freenx-cvs at berlios.de (jonno)
Date: Sun, 13 Mar 2005 11:57:36 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 3 files
Message-ID: <42341CA0.mailNHL14MRAF@lists.berlios.de>

User:      jonno
Date:      2005-03-13 10:57:36 GMT
Modified:  .        node.conf.sample nxloadconfig nxnode
Log:
Added support for ENABLE_PERSISTENT_SESSION DISABLE_PERSISTENT_SESSION

Revision  Changes    Path
1.13      +5 -5      freenx/node.conf.sample


rev 1.13, prev_rev 1.12
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.12
retrieving revision 1.13
diff -u -r1.12 -r1.13
--- node.conf.sample	12 Mar 2005 17:55:13 -0000	1.12
+++ node.conf.sample	13 Mar 2005 10:57:36 -0000	1.13
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.12 2005/03/12 17:55:13 jonno Exp $
+# CVS: $Id: node.conf.sample,v 1.13 2005/03/13 10:57:36 jonno Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -265,12 +265,12 @@
 #COMMAND_SMBUMOUNT=smbumount
 
 
-# User for which sessions should be persistent. Either a comma-separated
-# list of usernames or the word "all".
+# User for which sessions should be persistent. Either the keyword "all" or a
+# comma-separated list of usernames or groups in the @groupname syntax.
 #ENABLE_PERSISTENT_SESSION="all"
 
-# Users in the ENABLE_PERSISTENT_SESSION for which persistent should be
-# disabled. Especially usefull if ENABLE_PERSISTENT_SESSION="all"
+# Users and groups for whom persistent sessions should be disabled. 
+# Especially usefull if ENABLE_PERSISTENT_SESSION="all"
 #DISABLE_PERSISTENT_SESSION=""
 
 # Extra options sent to the different nx agents. See !M documentation



1.18      +7 -3      freenx/nxloadconfig


rev 1.18, prev_rev 1.17
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.17
retrieving revision 1.18
diff -u -r1.17 -r1.18
--- nxloadconfig	12 Mar 2005 17:55:13 -0000	1.17
+++ nxloadconfig	13 Mar 2005 10:57:36 -0000	1.18
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.17 2005/03/12 17:55:13 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.18 2005/03/13 10:57:36 jonno Exp $
 #
 # ========================================================================
 
@@ -371,12 +371,16 @@
 	if [ "$ENABLE_PERSISTENT_SESSION" != "all" ]
 	then
 		for USERNAME in $ENABLE_PERSISTENT_SESSION; do
-			[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+			[ "${USERNAME:0:1}" != "@" ] && [ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+				ERROR="yes" && echo "Error: Invalid value \"ENABLE_PERSISTENT_SESSION=$ENABLE_PERSISTENT_SESSION\"" && break ;
+			[ "${USERNAME:0:1}" = "@" ] && [ -z $(getent group | egrep "^${USERNAME:1}:") ] && \
 				ERROR="yes" && echo "Error: Invalid value \"ENABLE_PERSISTENT_SESSION=$ENABLE_PERSISTENT_SESSION\"" && break ;
 		done
 	fi
 	for USERNAME in $DISABLE_PERSISTENT_SESSION; do
-		[ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+		[ "${USERNAME:0:1}" != "@" ] && [ -z $(getent passwd | egrep "^$USERNAME:") ] && \
+			ERROR="yes" && echo "Error: Invalid value \"DISABLE_PERSISTENT_SESSION=$DISABLE_PERSISTENT_SESSION\"" && break ;
+		[ "${USERNAME:0:1}" = "@" ] && [ -z $(getent group | egrep "^${USERNAME:1}:") ] && \
 			ERROR="yes" && echo "Error: Invalid value \"DISABLE_PERSISTENT_SESSION=$DISABLE_PERSISTENT_SESSION\"" && break ;
 	done
 	



1.41      +15 -2     freenx/nxnode


rev 1.41, prev_rev 1.40
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.40
retrieving revision 1.41
diff -u -r1.40 -r1.41
--- nxnode	12 Mar 2005 18:19:02 -0000	1.40
+++ nxnode	13 Mar 2005 10:57:36 -0000	1.41
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.40 2005/03/12 18:19:02 fabianx Exp $
+# CVS: $Id: nxnode,v 1.41 2005/03/13 10:57:36 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -241,9 +241,22 @@
 	else
 		# nxagent session (X11)
 		[ "$SET_LD_LIBRARY_PATH" = "1" ] && export LD_LIBRARY_PATH="$AGENT_LIBRARY_PATH:$LD_LIBRARY_PATH"
+		P="-nopersistent"
+		OLD_IFS=$IFS
+		IFS=","
+		[ "$ENABLE_PERSISTENT_SESSION" = "all" ] && P="-persistent"
+		[ "$ENABLE_PERSISTENT_SESSION" = "all" ] || for USERNAME in $ENABLE_PERSISTENT_SESSION; do
+			[ "${USERNAME:0:1}" != "@" ] && [ "$USER" = "$USERNAME" ] && P="-persistent" && break ;
+			[ "${USERNAME:0:1}" = "@" ] && [ -z $(groups "$USER" | egrep "^${USERNAME:1}:") ] && P="-persistent" && break ;
+		done
+		for USERNAME in $DISABLE_PERSISTENT_SESSION; do
+			[ "${USERNAME:0:1}" != "@" ] && [ "$USER" = "$USERNAME" ] && P="-nopersistent" && break ;
+			[ "${USERNAME:0:1}" = "@" ] && [ -z $(groups "$USER" | egrep "^${USERNAME:1}:") ] && P="-nopersistent" && break ;
+		done
+		IFS=$OLD_IFS
 		FP=""
 		[ -n "$AGENT_FONT_SERVER" ] && FP="-fp $AGENT_FONT_SERVER"
-		$PATH_BIN/nxagent -persistent $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
+		$PATH_BIN/nxagent $P $R -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $K $G $B $FP :$display $AGENT_EXTRA_OPTIONS_X 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	fi
 	PID=$!
 	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/






From freenx-cvs at berlios.de  Sun Mar 13 12:48:20 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 12:48:20 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 3 files
Message-ID: <42342884.mailNWB1E69EX@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 11:48:20 GMT
Modified:  .        ChangeLog nxnode nxserver
Log:
Implemented SSHD_CHECK_IP directive according to FRSL042166:

-> http://www.nomachine.com/fr/view.php?id=FRSL042166

An option should exist to let users login even if the remote IP is not exported by SSH.

Revision  Changes    Path
1.33      +1 -0      freenx/ChangeLog


rev 1.33, prev_rev 1.32
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.32
retrieving revision 1.33
diff -u -r1.32 -r1.33
--- ChangeLog	12 Mar 2005 18:19:02 -0000	1.32
+++ ChangeLog	13 Mar 2005 11:48:19 -0000	1.33
@@ -13,6 +13,7 @@
 	* Sets LD_PRELOAD for applications and LD_LIBRARY_PATH for nxagent/nxproxy by default.
 		- SET_LD_LIBRARY_PATH replaces NX_NOMACHINE_WAY and is 
 		  enabled by default, as it is now safe to do so
+	* Implemented SSHD_CHECK_IP directive.
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.42      +5 -2      freenx/nxnode


rev 1.42, prev_rev 1.41
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.41
retrieving revision 1.42
diff -u -r1.41 -r1.42
--- nxnode	13 Mar 2005 10:57:36 -0000	1.41
+++ nxnode	13 Mar 2005 11:48:19 -0000	1.42
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.41 2005/03/13 10:57:36 jonno Exp $
+# CVS: $Id: nxnode,v 1.42 2005/03/13 11:48:19 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -524,11 +524,14 @@
 	IMAGES="images=$images,"
 	[ -z "$images" ] && IMAGES=""
 
+	ACCEPT="accept=$userip,"
+	[ "$userip" = "*" ] && ACCEPT=""
+
 	OLD_UMASK=$(umask)
 	umask 0077
 
 cat << EOF > $USER_FAKE_HOME/.nx/C-$sess_id/options
-${kbtype:+kbtype=$kbtype,}${CACHE}${IMAGES}${PACK}link=$link,type=$type,cleanup=0,accept=$userip,cookie=$proxy_cookie,id=$sess_id,samba=$samba,media=$media${sync:+,sync=$sync}${cups:+,cups=$cups}:$display
+${kbtype:+kbtype=$kbtype,}${CACHE}${IMAGES}${PACK}link=$link,type=$type,cleanup=0,${ACCEPT}cookie=$proxy_cookie,id=$sess_id,samba=$samba,media=$media${sync:+,sync=$sync}${cups:+,cups=$cups}:$display
 EOF
 	umask $OLD_UMASK
 #samba=$samba,



1.38      +17 -1     freenx/nxserver


rev 1.38, prev_rev 1.37
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.37
retrieving revision 1.38
diff -u -r1.37 -r1.38
--- nxserver	12 Mar 2005 18:19:02 -0000	1.37
+++ nxserver	13 Mar 2005 11:48:19 -0000	1.38
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.37 2005/03/12 18:19:02 fabianx Exp $
+# CVS: $Id: nxserver,v 1.38 2005/03/13 11:48:19 fabianx Exp $
 #
 
 # Read the config file
@@ -677,6 +677,21 @@
 	PARAMS=$SERVER_PARAMS
 	CMDLINE=$PARAMS
 	echo_x
+	
+	# If we can't get the userip and SSHD_CHECK_IP is set to 1
+	# we bail out.
+	if [ -z "$SSH_CLIENT" ]
+	then 
+		if [ "$SSHD_CHECK_IP" = "1" ]
+		then
+			echo "NX> 504 Session startup failed. (Missing SSH_CLIENT environment variable)"
+			return 1
+		else
+			log "WARNING: Failed to determine the client IP."
+			log "WARNING: The SSH_CLIENT variable was not provided by SSHD."
+			log "WARNING: Please set SSHD_CHECK_IP=1 if you want to refuse the connection."
+		fi
+	fi
 
 	# check if there is a suspended session, which we could resume
 	if [ "$ENABLE_AUTORECONNECT" = "1" -a "$ACTION" = "start" ]
@@ -691,6 +706,7 @@
 	fi
 
 	USERIP=$(echo $SSH_CLIENT | cut -d" " -f1 | sed 's/::ffff://g')
+	[ -z "$USERIP" ] && USERIP="*"
 	if [ "$ACTION" = "start" ]
 	then
 		# start nxnode






From freenx-cvs at berlios.de  Sun Mar 13 12:53:08 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 12:53:08 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxnode
Message-ID: <423429A4.mail2Q51OHHWS@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 11:53:08 GMT
Modified:  .        nxnode
Log:
Implemented $COMMAND_XTERM.

Note: If a unix-application "xterm" session is started, it is automatically replaced with $COMMAND_XTERM.

Revision  Changes    Path
1.43      +2 -1      freenx/nxnode


rev 1.43, prev_rev 1.42
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.42
retrieving revision 1.43
diff -u -r1.42 -r1.43
--- nxnode	13 Mar 2005 11:48:19 -0000	1.42
+++ nxnode	13 Mar 2005 11:53:08 -0000	1.43
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.42 2005/03/13 11:48:19 fabianx Exp $
+# CVS: $Id: nxnode,v 1.43 2005/03/13 11:53:08 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -146,6 +146,7 @@
 			STARTX=$COMMAND_START_CDE
 		;;
 		unix-application)
+			[ "$application" = "xterm" ] && application="$COMMAND_XTERM"
 			STARTX=$application
 		;;
 		unix-default)






From freenx-cvs at berlios.de  Sun Mar 13 13:04:50 2005
From: freenx-cvs at berlios.de (jonno)
Date: Sun, 13 Mar 2005 13:04:50 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 2 files
Message-ID: <42342C62.mail8K911HRB2@lists.berlios.de>

User:      jonno
Date:      2005-03-13 12:04:50 GMT
Modified:  .        ChangeLog nxserver
Log:
Added the SESSION_HISTORY directive. Code by Fabian, I only provided a smal fix.

Revision  Changes    Path
1.34      +1 -0      freenx/ChangeLog


rev 1.34, prev_rev 1.33
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.33
retrieving revision 1.34
diff -u -r1.33 -r1.34
--- ChangeLog	13 Mar 2005 11:48:19 -0000	1.33
+++ ChangeLog	13 Mar 2005 12:04:49 -0000	1.34
@@ -14,6 +14,7 @@
 		- SET_LD_LIBRARY_PATH replaces NX_NOMACHINE_WAY and is 
 		  enabled by default, as it is now safe to do so
 	* Implemented SSHD_CHECK_IP directive.
+	* Added the SESSION_HISTORY directive. Session history will by default be kept for 30 days.
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.39      +17 -3     freenx/nxserver


rev 1.39, prev_rev 1.38
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.38
retrieving revision 1.39
diff -u -r1.38 -r1.39
--- nxserver	13 Mar 2005 11:48:19 -0000	1.38
+++ nxserver	13 Mar 2005 12:04:49 -0000	1.39
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.38 2005/03/13 11:48:19 fabianx Exp $
+# CVS: $Id: nxserver,v 1.39 2005/03/13 12:04:49 jonno Exp $
 #
 
 # Read the config file
@@ -277,6 +277,15 @@
 	done
 }
 
+# remove all sessions older than $SESSION_HISTORY seconds in failed/closed.
+
+session_cleanup()
+{
+	[ "$SESSION_HISTORY" -gt "-1" ] || return
+	let SESSION_HISTORY_MINUTES=$SESSION_HISTORY/60
+	find $NX_SESS_DIR/closed/ $NX_SESS_DIR/failed/ -type f -mmin +"$SESSION_HISTORY_MINUTES" -exec rm -f '{}' ';'
+}
+
 session_list_all()
 {
 	echo "NX> 127 Sessions list:"
@@ -321,14 +330,16 @@
 {
 	perl -pi -e "s/startTime=\(.*\)/startTime=\1\nendTime=$(date +%s)/" $NX_SESS_DIR/running/sessionId'{'$1'}'
 	session_status $1 "Finished"
-	mv -f $NX_SESS_DIR/running/sessionId'{'$1'}' $NX_SESS_DIR/closed/sessionId'{'$1'}'
+	[ "$SESSION_HISTORY" = "0" ] && rm -f $NX_SESS_DIR/running/sessionId'{'$1'}'
+	[ "$SESSION_HISTORY" = "0" ] || mv -f $NX_SESS_DIR/running/sessionId'{'$1'}' $NX_SESS_DIR/closed/sessionId'{'$1'}'
 }
 
 session_fail()
 {
 	perl -pi -e "s/startTime=\(.*\)/startTime=\1\nendTime=$(date +%s)/" $NX_SESS_DIR/running/sessionId'{'$1'}'
 	session_status $1 "Failed"
-	mv -f $NX_SESS_DIR/running/sessionId'{'$1'}' $NX_SESS_DIR/failed/sessionId'{'$1'}'
+	[ "$SESSION_HISTORY" = "0" ] && rm -f $NX_SESS_DIR/running/sessionId'{'$1'}'
+	[ "$SESSION_HISTORY" = "0" ] || mv -f $NX_SESS_DIR/running/sessionId'{'$1'}' $NX_SESS_DIR/failed/sessionId'{'$1'}'
 }
 
 session_suspend()
@@ -561,6 +572,9 @@
 		;;
 	esac
 done
+
+# remove old session infos from history
+session_cleanup
 
 #
 # call it with: server_get_params $CMD # no ""!






From freenx-cvs at berlios.de  Sun Mar 13 13:58:00 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 13:58:00 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 4 files
Message-ID: <423438D8.mail1LR1WQ5PB@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 12:58:00 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxnode
Log:
Implemented DEFAULT_X_WM for unix-application virtual desktop mode.

To enable this feature set ENABLE_DEFAULT_X_WM="1".

If ENABLE_DEFAULT_X_WM_KILL is set, the WM is terminated
after the started application finishes. Else FreeNX will
wait for the window manager to complete.

New configuration directives: ENABLE_DEFAULT_X_WM, ENABLE_DEFAULT_X_WM_KILL

Revision  Changes    Path
1.35      +1 -0      freenx/ChangeLog


rev 1.35, prev_rev 1.34
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.34
retrieving revision 1.35
diff -u -r1.34 -r1.35
--- ChangeLog	13 Mar 2005 12:04:49 -0000	1.34
+++ ChangeLog	13 Mar 2005 12:57:59 -0000	1.35
@@ -15,6 +15,7 @@
 		  enabled by default, as it is now safe to do so
 	* Implemented SSHD_CHECK_IP directive.
 	* Added the SESSION_HISTORY directive. Session history will by default be kept for 30 days.
+	* Implemented DEFAULT_X_WM for unix-application virtual desktop mode.
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.14      +10 -1     freenx/node.conf.sample


rev 1.14, prev_rev 1.13
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.13
retrieving revision 1.14
diff -u -r1.13 -r1.14
--- node.conf.sample	13 Mar 2005 10:57:36 -0000	1.13
+++ node.conf.sample	13 Mar 2005 12:57:59 -0000	1.14
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.13 2005/03/13 10:57:36 jonno Exp $
+# CVS: $Id: node.conf.sample,v 1.14 2005/03/13 12:57:59 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -218,6 +218,15 @@
 # twm in the default path or if you want to use another window manager,
 # you have to set it to the absolute file name of the command binary you 
 # want to use.
+
+# FreeNX: To enable this feature set ENABLE_DEFAULT_X_WM="1"
+#         
+#         If ENABLE_DEFAULT_X_WM_KILL is set the WM is terminated
+#         after the started application finishes. Else FreeNX will 
+#         wait for the window manager to complete. 
+
+#ENABLE_DEFAULT_X_WM="0"
+#ENABLE_DEFAULT_X_WM_KILL="0"
 #DEFAULT_X_WM=twm
 
 # The key that contains the name of the script that starts a KDE session. 



1.19      +5 -1      freenx/nxloadconfig


rev 1.19, prev_rev 1.18
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.18
retrieving revision 1.19
diff -u -r1.18 -r1.19
--- nxloadconfig	13 Mar 2005 10:57:36 -0000	1.18
+++ nxloadconfig	13 Mar 2005 12:57:59 -0000	1.19
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.18 2005/03/13 10:57:36 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.19 2005/03/13 12:57:59 fabianx Exp $
 #
 # ========================================================================
 
@@ -110,6 +110,10 @@
 COMMAND_SESSREG="sessreg"
 
 SET_LD_LIBRARY_PATH="1"
+
+# see below for DEFAULT_X_WM directive
+ENABLE_DEFAULT_X_WM="0"
+ENABLE_DEFAULT_X_WM_KILL="0"
 
 # NoMachine node.conf compatible vars
 



1.44      +13 -1     freenx/nxnode


rev 1.44, prev_rev 1.43
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.43
retrieving revision 1.44
diff -u -r1.43 -r1.44
--- nxnode	13 Mar 2005 11:53:08 -0000	1.43
+++ nxnode	13 Mar 2005 12:57:59 -0000	1.44
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.43 2005/03/13 11:53:08 fabianx Exp $
+# CVS: $Id: nxnode,v 1.44 2005/03/13 12:57:59 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -187,11 +187,23 @@
 	fi
 
 	[ "$virtualdesktop" = "0" -a "$ENABLE_ROOTLESS_MODE" != "1" ] && export LD_PRELOAD="$APPLICATION_LIBRARY_PRELOAD:$LD_PRELOAD"
+	if [ "$ENABLE_DEFAULT_X_WM" = "1" -a "$virtualdesktop" = "1" -a "$type" = "unix-application" -a -x "$(which $DEFAULT_X_WM)" ]
+	then
+		DISPLAY=unix:$display $DEFAULT_X_WM >> $USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
+		WM_PID=$!
+	fi
 	DISPLAY=unix:$display $STARTX >>$USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
 	APP_PID=$!
 	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/
 	echo "$APP_PID" > $USER_FAKE_HOME/.nx/C-$sess_id/pids/applications
 	wait $APP_PID
+	if [ -n "$WM_PID" ]
+	then
+		# kill the WM after application is finished?
+		[ "$ENABLE_DEFAULT_X_WM_KILL" = "1" ] && kill $WM_PID 2>/dev/null
+		# or just wait until it finishes?
+		[ "$ENABLE_DEFAULT_X_WM_KILL" = "1" ] || wait $WM_PID
+	fi
 	rm -f $USER_FAKE_HOME/.nx/C-$sess_id/pids/applications
 	node_terminate_agent $sess_id
 }






From freenx-cvs at berlios.de  Sun Mar 13 14:15:43 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 14:15:43 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxnode
Message-ID: <42343CFF.mail3V211IL99@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 13:15:43 GMT
Modified:  .        nxnode
Log:
Implemented better function to check if an application is in the PATH and executable.

Fixes {ESD,ARTSD}_BIN_PRELOAD, if its no global path.

Revision  Changes    Path
1.45      +10 -4     freenx/nxnode


rev 1.45, prev_rev 1.44
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.44
retrieving revision 1.45
diff -u -r1.44 -r1.45
--- nxnode	13 Mar 2005 12:57:59 -0000	1.44
+++ nxnode	13 Mar 2005 13:15:43 -0000	1.45
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.44 2005/03/13 12:57:59 fabianx Exp $
+# CVS: $Id: nxnode,v 1.45 2005/03/13 13:15:43 fabianx Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -46,6 +46,12 @@
 return 0
 }
 
+find_app()
+{
+	set -- $*
+	which $1 2>/dev/null
+}
+
 getparam_user()
 {
 	[ $UID -eq 0 ] && echo $(getparam user)
@@ -166,7 +172,7 @@
 		export ESPEAKER="127.0.0.1:$ESPEAKER"
 		
 		# Check for config file directive
-		if [ "$ENABLE_ESD_PRELOAD" = "1" -a -x $ESD_BIN_PRELOAD ]
+		if [ "$ENABLE_ESD_PRELOAD" = "1" -a -x "$(find_app $ESD_BIN_PRELOAD)" ]
 		then
 			STARTX="$ESD_BIN_PRELOAD $STARTX"
 			
@@ -179,7 +185,7 @@
 	then
 		# Overwrite users mcoprc
 		echo -n "GlobalComm=Arts::X11GlobalComm" > $HOME/.mcoprc
-		if [ "$ENABLE_ARTSD_PRELOAD" = "1" -a -x $ARTSD_BIN_PRELOAD ]
+		if [ "$ENABLE_ARTSD_PRELOAD" = "1" -a -x "$(find_app $ARTSD_BIN_PRELOAD)" ]
 		then
 			STARTX="$ARTSD_BIN_PRELOAD $STARTX"
 			echo "Info: NXNODE - Using $ARTSD_BIN_PRELOAD wrapper script." >> $USER_FAKE_HOME/.nx/C-$sess_id/session
@@ -187,7 +193,7 @@
 	fi
 
 	[ "$virtualdesktop" = "0" -a "$ENABLE_ROOTLESS_MODE" != "1" ] && export LD_PRELOAD="$APPLICATION_LIBRARY_PRELOAD:$LD_PRELOAD"
-	if [ "$ENABLE_DEFAULT_X_WM" = "1" -a "$virtualdesktop" = "1" -a "$type" = "unix-application" -a -x "$(which $DEFAULT_X_WM)" ]
+	if [ "$ENABLE_DEFAULT_X_WM" = "1" -a "$virtualdesktop" = "1" -a "$type" = "unix-application" -a -x "$(find_app $DEFAULT_X_WM)" ]
 	then
 		DISPLAY=unix:$display $DEFAULT_X_WM >> $USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
 		WM_PID=$!






From freenx-cvs at berlios.de  Sun Mar 13 14:31:10 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 14:31:10 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified node.conf.sample
Message-ID: <4234409E.mail58711VUWZ@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 13:31:10 GMT
Modified:  .        node.conf.sample
Log:
Added notices to not used config directives.

Fixed some spell checking errors (e.g. usefull -> useful).

Restructured some parts.

Revision  Changes    Path
1.15      +16 -8     freenx/node.conf.sample


rev 1.15, prev_rev 1.14
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.14
retrieving revision 1.15
diff -u -r1.14 -r1.15
--- node.conf.sample	13 Mar 2005 12:57:59 -0000	1.14
+++ node.conf.sample	13 Mar 2005 13:31:10 -0000	1.15
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.14 2005/03/13 12:57:59 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.15 2005/03/13 13:31:10 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -152,8 +152,8 @@
 # The key that contains the name of the complete path of the 'netcat' command. 
 #COMMAND_NETCAT=netcat
 
-# If enabled writes entries via the COMMAND_SESSREG program into utmp/wtmp/lastlog 
-# database.
+# If enabled writes entries via the COMMAND_SESSREG program 
+# into utmp/wtmp/lastlog database.
 #
 # Note: You have to make sure that you add the nx user to the 
 #       utmp or tty group or how its called on your system
@@ -169,8 +169,8 @@
 #USER_FAKE_HOME=$HOME
 
 # Add the nx libraries to LD_LIBRARY_PATH before starting nx agents.
-# WARNING: This will NOT (and should not) affect aplications. ONLY Disable this
-#          if the nx libraries is in a standard system path (such as /usr/lib)!
+# WARNING: This will NOT (and should not) affect applications. ONLY Disable this
+#          if the nx libraries are in a standard system path (such as /usr/lib)!
 #SET_LD_LIBRARY_PATH="1"
 
 #########################################################################
@@ -252,17 +252,25 @@
 
 # The key that contains the name of the complete path of command name 
 # 'xset'. 
+# FreeNX: This key is not used in the FreeNX project.
+
 #COMMAND_XSET=/usr/X11R6/bin/xset
 
 # The key that contains the name of the complete path of command name 
 # 'xmodmap'. 
+# FreeNX: This key is not used in the FreeNX project.
+
 #COMMAND_XMODMAP=/usr/X11R6/bin/xmodmap
 
 # The key that contains the name of the complete path of command name 
 # 'xkbcomp'. 
+# FreeNX: This key is not used in the FreeNX project.
+
 #COMMAND_XKBCOMP=/usr/X11R6/bin/xkbcomp
 
 # The keymap file for xkbcomp
+# FreeNX: This key is not used in the FreeNX project.
+
 #XKBCOMP_KEYMAP_FILE=/etc/X11/xkb/keymap/xfree86
 
 # The key that contains the name of the complete path of command name 
@@ -279,11 +287,11 @@
 #ENABLE_PERSISTENT_SESSION="all"
 
 # Users and groups for whom persistent sessions should be disabled. 
-# Especially usefull if ENABLE_PERSISTENT_SESSION="all"
+# Especially useful if ENABLE_PERSISTENT_SESSION="all"
 #DISABLE_PERSISTENT_SESSION=""
 
 # Extra options sent to the different nx agents. See !M documentation
-# for examples of usefull parameters.
+# for examples of useful parameters.
 #AGENT_EXTRA_OPTIONS_RFB=""
 #AGENT_EXTRA_OPTIONS_RDP=""
 #AGENT_EXTRA_OPTIONS_X=""
@@ -301,6 +309,6 @@
 # loss of interaction in sessions.
 #PROXY_TCP_NODELAY="0"
 
-# Extra options to nxproxy. See !M documentation for usefull parameters.
+# Extra options to nxproxy. See !M documentation for useful parameters.
 #PROXY_EXTRA_OPTIONS=""
 






From freenx-cvs at berlios.de  Sun Mar 13 16:12:17 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 16:12:17 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 4 files
Message-ID: <42345851.mailA45118IEK@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 15:12:17 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxserver
Log:
Implemented SESSION_LIMIT and SESSION_USER_LIMIT config file directives.

Note: There is no way to disable them. Just set it to SESSION_DISPLAY_LIMIT,
      which is the maximum anyway.

      Setting any of them to "0" will disable the start of new sessions
      effectively.

Revision  Changes    Path
1.36      +1 -0      freenx/ChangeLog


rev 1.36, prev_rev 1.35
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.35
retrieving revision 1.36
diff -u -r1.35 -r1.36
--- ChangeLog	13 Mar 2005 12:57:59 -0000	1.35
+++ ChangeLog	13 Mar 2005 15:12:16 -0000	1.36
@@ -16,6 +16,7 @@
 	* Implemented SSHD_CHECK_IP directive.
 	* Added the SESSION_HISTORY directive. Session history will by default be kept for 30 days.
 	* Implemented DEFAULT_X_WM for unix-application virtual desktop mode.
+	* Implemented SESSION_LIMIT and SESSION_USER_LIMIT.
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.



1.16      +3 -3      freenx/node.conf.sample


rev 1.16, prev_rev 1.15
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.15
retrieving revision 1.16
diff -u -r1.15 -r1.16
--- node.conf.sample	13 Mar 2005 13:31:10 -0000	1.15
+++ node.conf.sample	13 Mar 2005 15:12:16 -0000	1.16
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.15 2005/03/13 13:31:10 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.16 2005/03/13 15:12:16 fabianx Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -201,11 +201,11 @@
 #DISPLAY_BASE=1000
 
 # The maximum number of contemporary sessions that can be run on FreeNX
-#SESSION_LIMIT=20
+#SESSION_LIMIT=200
 
 # The maximum number of contemporary sessions that a single user can run
 # on FreeNX. Defaults to the value of SESSION_LIMIT.
-#SESSION_USER_LIMIT=20
+#SESSION_USER_LIMIT=200
 
 # The number of displays reserved for sessions, it has to be greater or equal
 # to the maximum number of contemporary sessions that a server can run. 



1.20      +2 -2      freenx/nxloadconfig


rev 1.20, prev_rev 1.19
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.19
retrieving revision 1.20
diff -u -r1.19 -r1.20
--- nxloadconfig	13 Mar 2005 12:57:59 -0000	1.19
+++ nxloadconfig	13 Mar 2005 15:12:16 -0000	1.20
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.19 2005/03/13 12:57:59 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.20 2005/03/13 15:12:16 fabianx Exp $
 #
 # ========================================================================
 
@@ -121,7 +121,7 @@
 SSHD_PORT=22
 
 DISPLAY_BASE=1000
-SESSION_LIMIT=20
+SESSION_LIMIT=200
 DISPLAY_LIMIT=200
 
 DEFAULT_X_WM=twm



1.40      +51 -2     freenx/nxserver


rev 1.40, prev_rev 1.39
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.39
retrieving revision 1.40
diff -u -r1.39 -r1.40
--- nxserver	13 Mar 2005 12:04:49 -0000	1.39
+++ nxserver	13 Mar 2005 15:12:17 -0000	1.40
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.39 2005/03/13 12:04:49 jonno Exp $
+# CVS: $Id: nxserver,v 1.40 2005/03/13 15:12:17 fabianx Exp $
 #
 
 # Read the config file
@@ -190,10 +190,29 @@
 	done
 }
 
+# Count all sessions of a user
+# and save it in SESSION_COUNT and SESSION_COUNT_USER
+
+session_count_user()
+{
+	SESSION_COUNT=0
+	SESSION_COUNT_USER=0
+
+	for i in $NX_SESS_DIR/running/*
+	do
+		[ -f $i ] || break
+		let SESSION_COUNT=$SESSION_COUNT+1
+		egrep -q "^userName=$1$" $i && let SESSION_COUNT_USER=$SESSION_COUNT_USER+1
+	done
+}
+
 # List all sessions of a user
 
 session_list_user_suspended()
 {
+	SESSION_COUNT=0
+	SESSION_COUNT_USER=0
+
 	TMPFILE=$(mktemp /tmp/nxserver_tmp.XXXXXXXXX)
 	echo "NX> 127 Sessions list of user '$1' for reconnect:" > $TMPFILE
 	echo >> $TMPFILE
@@ -209,6 +228,7 @@
 	for i in $NX_SESS_DIR/running/*
 	do
 		[ -f $i ] || break
+		let SESSION_COUNT=$SESSION_COUNT+1
 		if egrep -q "^userName=$1$" $i && egrep -q "^status=$2$" $i #&& grep -q "screeninfo=$3" $i
 		then
 			CMDLINE=$(session_get_cmdline $i)
@@ -227,12 +247,18 @@
 			fi
 			echo -e "$(getparam display)\t$(getparam type)\t$(getparam sessionId)\t$options\t$depth\t$geom\t$available\t$(getparam sessionName)" >> $TMPFILE
 		fi
+		egrep -q "^userName=$1$" $i && let SESSION_COUNT_USER=$SESSION_COUNT_USER+1
 	done
 	echo "" >> $TMPFILE
 	echo "" >> $TMPFILE
 	cat $TMPFILE
 	rm -f $TMPFILE
-	echo "NX> 148 Server capacity: not reached for user: $1"
+	if [ "$SESSION_COUNT" -ge "$SESSION_LIMIT" -o "$SESSION_COUNT_USER" -ge "$SESSION_USER_LIMIT" ]
+	then
+		echo "NX> 147 Server capacity: reached for user: $1"
+	else
+		echo "NX> 148 Server capacity: not reached for user: $1"
+	fi
 }
 
 session_list_user()
@@ -683,6 +709,27 @@
 	[ -e "/tmp/.nX$SESS_DISPLAY-lock" ] && rm -f /tmp/.nX$SESS_DISPLAY-lock
 }
 
+server_check_session_count()
+{
+	session_count_user "$USER"
+	
+	if [ "$SESSION_COUNT" -ge "$SESSION_LIMIT" ]
+	then
+		echo_x "NX> 599 Reached the maximum number of concurrent sessions on this server."
+		echo_x "NX> 500 ERROR: Last operation failed."
+		return 1
+	fi
+	
+	if [ "$SESSION_COUNT_USER" -ge "$SESSION_USER_LIMIT" ]
+	then
+		echo_x "NX> 599 Server capacity: reached for user: $USER"
+		echo_x "NX> 500 ERROR: Last operation failed."
+		return 1
+	fi
+
+	return 0
+}
+
 server_startrestore_session()
 {
 	ACTION="$1"
@@ -723,6 +770,8 @@
 	[ -z "$USERIP" ] && USERIP="*"
 	if [ "$ACTION" = "start" ]
 	then
+		server_check_session_count || return 1
+		
 		# start nxnode
 		SESS_DISPLAY=$DISPLAY_BASE
 		let SESS_DISPLAY_LIMIT=$DISPLAY_BASE+$DISPLAY_LIMIT






From freenx-cvs at berlios.de  Sun Mar 13 16:35:27 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 16:35:27 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <42345DBF.mailBSG1VK94L@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 15:35:27 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog nxserver
Log:
Fixed handling of not closed sessions in "Terminating" status.

Explanation: When nxserver did get the 1009 Terminating it did "forward"
             it to nxclient. But nxclient had already have closed its
	     control channel at that time. This did lead to an io error, which
	     terminated the loop immediately.

	     Stopping sending of messages after receiving a "Terminating"
	     fixes the problem.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.8  +1 -0      freenx/ChangeLog


rev 1.16.2.8, prev_rev 1.16.2.7
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.7
retrieving revision 1.16.2.8
diff -u -r1.16.2.7 -r1.16.2.8
--- ChangeLog	12 Mar 2005 17:57:35 -0000	1.16.2.7
+++ ChangeLog	13 Mar 2005 15:35:27 -0000	1.16.2.8
@@ -6,6 +6,7 @@
 	* Fixed resume when agent is no longer there.
 	* Fixed error message shown to user, when session startup fails.
 	* Fixed handling of /tmp/.X*-lock files.
+	* Fixed handling of not closed sessions in "Terminating" status.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.24.2.4  +8 -3      freenx/nxserver


rev 1.24.2.4, prev_rev 1.24.2.3
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.24.2.3
retrieving revision 1.24.2.4
diff -u -r1.24.2.3 -r1.24.2.4
--- nxserver	12 Mar 2005 05:08:27 -0000	1.24.2.3
+++ nxserver	13 Mar 2005 15:35:27 -0000	1.24.2.4
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.24.2.3 2005/03/12 05:08:27 fabianx Exp $
+# CVS: $Id: nxserver,v 1.24.2.4 2005/03/13 15:35:27 fabianx Exp $
 #
 
 # Read the config file
@@ -604,6 +604,7 @@
 
 server_nxnode_start_wait()
 {
+	STOP_SEND=""
 	server_nxnode_start "$@" | while read CMD
 	do
 		case "$CMD" in 
@@ -621,6 +622,10 @@
 					;;
 					*terminating*)
 						session_status $uniqueid "Terminating"
+						# we need to stop sending to client as it will have already
+						# closed his side of the channel and this will lead to not 
+						# closed sessions.
+						STOP_SEND="1"
 				esac
 			;;
 			"NX> 1004"*)
@@ -632,13 +637,13 @@
 
 		case $CMD in
 			"NX> 718"*)
-				echo $CMD >&2
+				[ -z "$STOP_SEND" ] && echo $CMD >&2
 				#echo "NX> 1006 Session status: running" 1>&2
 				#echo "NX> 1001 Bye." 1>&2
 
 			;;
 			"NX> "*)
-				echo $CMD
+				[ -z "$STOP_SEND" ] && echo $CMD
 			;;
 		esac
 	done






From freenx-cvs at berlios.de  Sun Mar 13 16:39:33 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 13 Mar 2005 16:39:33 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <42345EB5.mailC2R1WYDCZ@lists.berlios.de>

User:      fabianx
Date:      2005-03-13 15:39:33 GMT
Modified:  .        ChangeLog nxserver
Log:
Fixed handling of not closed sessions in "Terminating" status.

Explanation: When nxserver did get the 1009 Terminating it did "forward"
             it to nxclient. But nxclient had already have closed its
             control channel at that time. This did lead to an io error, which
             terminated the loop immediately.

             Stopping sending of messages after receiving a "Terminating"
             fixes the problem.

(Ported from 0.3.0-bugfixes branch)

Revision  Changes    Path
1.37      +1 -0      freenx/ChangeLog


rev 1.37, prev_rev 1.36
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.36
retrieving revision 1.37
diff -u -r1.36 -r1.37
--- ChangeLog	13 Mar 2005 15:12:16 -0000	1.36
+++ ChangeLog	13 Mar 2005 15:39:33 -0000	1.37
@@ -26,6 +26,7 @@
 	* Fixed resume when agent is no longer there.
 	* Fixed error message shown to user, when session startup fails.
 	* Fixed handling of /tmp/.X*-lock files.
+	* Fixed handling of not closed sessions in "Terminating" status.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.41      +8 -3      freenx/nxserver


rev 1.41, prev_rev 1.40
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.40
retrieving revision 1.41
diff -u -r1.40 -r1.41
--- nxserver	13 Mar 2005 15:12:17 -0000	1.40
+++ nxserver	13 Mar 2005 15:39:33 -0000	1.41
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.40 2005/03/13 15:12:17 fabianx Exp $
+# CVS: $Id: nxserver,v 1.41 2005/03/13 15:39:33 fabianx Exp $
 #
 
 # Read the config file
@@ -664,6 +664,7 @@
 {
 	server_add_usession
 	
+	STOP_SEND=""
 	server_nxnode_start "$@" | while read CMD
 	do
 		case "$CMD" in 
@@ -681,6 +682,10 @@
 					;;
 					*terminating*)
 						session_status $uniqueid "Terminating"
+						# we need to stop sending to client as it will have already
+						# closed his side of the channel and this will lead to not 
+						# closed sessions.
+						STOP_SEND="1"
 				esac
 			;;
 			"NX> 1004"*)
@@ -692,13 +697,13 @@
 
 		case $CMD in
 			"NX> 718"*)
-				echo $CMD >&2
+				[ -z "$STOP_SEND" ] && echo $CMD >&2
 				#echo "NX> 1006 Session status: running" 1>&2
 				#echo "NX> 1001 Bye." 1>&2
 
 			;;
 			"NX> "*)
-				echo $CMD
+				[ -z "$STOP_SEND" ] && echo $CMD
 			;;
 		esac
 	done






From kov at sheep.berlios.de  Sun Mar 13 17:04:23 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Sun, 13 Mar 2005 17:04:23 +0100
Subject: [Freenx-cvs] r48 - / gnx gnx/trunk trunk
Message-ID: <200503131604.j2DG4NG9017188@sheep.berlios.de>

Author: kov
Date: 2005-03-13 17:04:22 +0100 (Sun, 13 Mar 2005)
New Revision: 48

Added:
   gnx/
   gnx/trunk/
   gnx/trunk/COPYING
   gnx/trunk/HACKING
   gnx/trunk/nxclient/
Removed:
   trunk/nxclient/
Log:
reorganizing the repository


Copied: gnx/trunk/COPYING (from rev 47, trunk/COPYING)

Copied: gnx/trunk/HACKING (from rev 47, trunk/HACKING)

Copied: gnx/trunk/nxclient (from rev 47, trunk/nxclient)



From kov at sheep.berlios.de  Sun Mar 13 17:07:09 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Sun, 13 Mar 2005 17:07:09 +0100
Subject: [Freenx-cvs] r49 - / thinnx
Message-ID: <200503131607.j2DG79fF017691@sheep.berlios.de>

Author: kov
Date: 2005-03-13 17:07:08 +0100 (Sun, 13 Mar 2005)
New Revision: 49

Added:
   thinnx/
   thinnx/trunk/
Log:
thinnx as a standlone 'tree'



Copied: thinnx/trunk (from rev 47, trunk)



From kov at sheep.berlios.de  Sun Mar 13 17:07:37 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Sun, 13 Mar 2005 17:07:37 +0100
Subject: [Freenx-cvs] r50 - /
Message-ID: <200503131607.j2DG7ba2017740@sheep.berlios.de>

Author: kov
Date: 2005-03-13 17:07:36 +0100 (Sun, 13 Mar 2005)
New Revision: 50

Removed:
   trunk/
Log:
no more need for this one




From kov at sheep.berlios.de  Sun Mar 13 17:33:46 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Sun, 13 Mar 2005 17:33:46 +0100
Subject: [Freenx-cvs] r51 - thinnx/trunk/thinnx
Message-ID: <200503131633.j2DGXkR3020056@sheep.berlios.de>

Author: kov
Date: 2005-03-13 17:33:45 +0100 (Sun, 13 Mar 2005)
New Revision: 51

Added:
   thinnx/trunk/thinnx/thinnx.conf.example
Removed:
   thinnx/trunk/thinnx/thinnx.conf
Log:
changing the name of the file to make sure it'll never overwrite the
admin's edits when make install'ing


Deleted: thinnx/trunk/thinnx/thinnx.conf
===================================================================
--- thinnx/trunk/thinnx/thinnx.conf	2005-03-13 16:07:36 UTC (rev 50)
+++ thinnx/trunk/thinnx/thinnx.conf	2005-03-13 16:33:45 UTC (rev 51)
@@ -1,41 +0,0 @@
-# ThinNX configuration file
-
-# Server and port to connect to.
-#
-#host = localhost
-#port = 22
-
-# You need to specify the path for the private key used to
-# authenticate with the ssh public key that's on the server.
-# This will default to $HOME/.ssh/id_dsa
-#
-#sshkey = /usr/NX/share/client.id_dsa.key
-
-# The name of the session
-#
-#session = thinnx
-
-# The session type. Can be unix-gnome, unix-kde and others.
-#
-#type = unix-gnome
-
-# The bandwidth under which the nx session will run. Defaults
-# to ADSL. Can be 'adsl, modem...'
-#
-#link = adsl
-
-# Use SSL encrypted connection? 'yes' or 'no'?
-#
-#ssl = no
-
-# Keyboard model and layout to use, in 'model/layout' form.
-# Defaults to the model/layout used in XKB configuration, if
-# available, or to pc104/us if not.
-#
-#kbdtype = pc104/us
-
-# Geometry for the window in which the session will run. The
-# default is to auto-detect the geometry of the X root window
-# and request nx to use it and fullscreen.
-#
-#geometry = fullscreen

Copied: thinnx/trunk/thinnx/thinnx.conf.example (from rev 49, thinnx/trunk/thinnx/thinnx.conf)



From kov at sheep.berlios.de  Sun Mar 13 17:48:03 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Sun, 13 Mar 2005 17:48:03 +0100
Subject: [Freenx-cvs] r52 - thinnx/trunk/thinnx
Message-ID: <200503131648.j2DGm3WH020897@sheep.berlios.de>

Author: kov
Date: 2005-03-13 17:48:01 +0100 (Sun, 13 Mar 2005)
New Revision: 52

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
fix warnings and problems brought up by compiling with gcc3 and
-Wall


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-13 16:33:45 UTC (rev 51)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-13 16:48:01 UTC (rev 52)
@@ -20,12 +20,14 @@
 
 #include <stdio.h>
 #include <stdlib.h>
+#include <string.h>
 
 #include <errno.h>
 
 #include <sys/types.h>
 #include <sys/time.h>
 #include <sys/stat.h>
+#include <sys/wait.h>
 #include <unistd.h>
 
 #include <sys/select.h>
@@ -350,11 +352,10 @@
       g_free (buffer);
       return retval;
     }
-  else
-    {
-      g_warning ("Waiting for %s, got %s\n", code, buffer);
-      protocol_error ("session info!");
-    }
+
+  g_warning ("Waiting for %s, got %s\n", code, buffer);
+  protocol_error ("session info!");
+  return NULL;
 }
 
 int
@@ -392,7 +393,7 @@
   int parent_pipe[2];	/* For talking to the parent */
   int child_pipe[2];	/* For talking to the child */
 
-  gint in, out;
+  gint in = 0, out = 0;
 
   gtk_init (&argc, &argv);
 
@@ -822,7 +823,7 @@
 	g_free (dirname);
 
 	if (use_ssl)
-	  buffer = g_strdup_printf ("cookie=%s,root=%s/.nx,session=%s,id=%s,listen=20000:%d", pcookie, homedir, session, session_id, session_display);
+	  buffer = g_strdup_printf ("cookie=%s,root=%s/.nx,session=%s,id=%s,listen=20000:%d", pcookie, homedir, session, session_id, 12345); /* last arg should be a free port */
 	else
 	  buffer = g_strdup_printf ("cookie=%s,root=%s/.nx,session=%s,id=%s,connect=%s:%s", pcookie, homedir, session, session_id, host, session_display);
 



From kov at sheep.berlios.de  Sun Mar 13 17:51:27 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Sun, 13 Mar 2005 17:51:27 +0100
Subject: [Freenx-cvs] r53 - in thinnx/trunk: . m4 thinnx
Message-ID: <200503131651.j2DGpRn9021110@sheep.berlios.de>

Author: kov
Date: 2005-03-13 17:51:24 +0100 (Sun, 13 Mar 2005)
New Revision: 53

Added:
   thinnx/trunk/AUTHORS
   thinnx/trunk/ChangeLog
   thinnx/trunk/Makefile.am
   thinnx/trunk/NEWS
   thinnx/trunk/README
   thinnx/trunk/aclocal.m4
   thinnx/trunk/config.guess
   thinnx/trunk/config.h.in
   thinnx/trunk/config.sub
   thinnx/trunk/configure.ac
   thinnx/trunk/install-sh
   thinnx/trunk/m4/
   thinnx/trunk/m4/Makefile.am
   thinnx/trunk/m4/gtk.m4
   thinnx/trunk/missing
   thinnx/trunk/mkinstalldirs
   thinnx/trunk/stamp-h.in
   thinnx/trunk/thinnx/Makefile.am
Log:
our new build system!


Added: thinnx/trunk/AUTHORS
===================================================================
--- thinnx/trunk/AUTHORS	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/AUTHORS	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1 @@
+Gustavo Noronha Silva <gns at gnome.org>

Added: thinnx/trunk/ChangeLog
===================================================================
--- thinnx/trunk/ChangeLog	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/ChangeLog	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,5 @@
+2005-03-13  Gustavo Noronha Silva  <gns at gnome.org>
+
+	* thinnx gains today a new build system that goes
+	  beyond a simple and dumb build.sh shell script
+

Added: thinnx/trunk/Makefile.am
===================================================================
--- thinnx/trunk/Makefile.am	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/Makefile.am	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,8 @@
+DISTCLEANFILES = *~
+
+SUBDIRS = m4 thinnx
+DIST_SUBDIRS = $(SUBDIRS)
+
+ACLOCAL_AMFLAGS = -I m4
+
+EXTRA_DIST = config.rpath

Added: thinnx/trunk/NEWS
===================================================================
--- thinnx/trunk/NEWS	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/NEWS	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,3 @@
+03, March, 2005
+
+    thinnx now has a true build system

Added: thinnx/trunk/README
===================================================================
--- thinnx/trunk/README	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/README	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,5 @@
+------
+thinnx
+------
+
+Information that is useful should come here.

Added: thinnx/trunk/aclocal.m4
===================================================================
--- thinnx/trunk/aclocal.m4	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/aclocal.m4	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,1167 @@
+dnl aclocal.m4 generated automatically by aclocal 1.4-p6
+
+dnl Copyright (C) 1994, 1995-8, 1999, 2001 Free Software Foundation, Inc.
+dnl This file is free software; the Free Software Foundation
+dnl gives unlimited permission to copy and/or distribute it,
+dnl with or without modifications, as long as this notice is preserved.
+
+dnl This program is distributed in the hope that it will be useful,
+dnl but WITHOUT ANY WARRANTY, to the extent permitted by law; without
+dnl even the implied warranty of MERCHANTABILITY or FITNESS FOR A
+dnl PARTICULAR PURPOSE.
+
+# lib-prefix.m4 serial 4 (gettext-0.14.2)
+dnl Copyright (C) 2001-2005 Free Software Foundation, Inc.
+dnl This file is free software; the Free Software Foundation
+dnl gives unlimited permission to copy and/or distribute it,
+dnl with or without modifications, as long as this notice is preserved.
+
+dnl From Bruno Haible.
+
+dnl AC_LIB_ARG_WITH is synonymous to AC_ARG_WITH in autoconf-2.13, and
+dnl similar to AC_ARG_WITH in autoconf 2.52...2.57 except that is doesn't
+dnl require excessive bracketing.
+ifdef([AC_HELP_STRING],
+[AC_DEFUN([AC_LIB_ARG_WITH], [AC_ARG_WITH([$1],[[$2]],[$3],[$4])])],
+[AC_DEFUN([AC_][LIB_ARG_WITH], [AC_ARG_WITH([$1],[$2],[$3],[$4])])])
+
+dnl AC_LIB_PREFIX adds to the CPPFLAGS and LDFLAGS the flags that are needed
+dnl to access previously installed libraries. The basic assumption is that
+dnl a user will want packages to use other packages he previously installed
+dnl with the same --prefix option.
+dnl This macro is not needed if only AC_LIB_LINKFLAGS is used to locate
+dnl libraries, but is otherwise very convenient.
+AC_DEFUN([AC_LIB_PREFIX],
+[
+  AC_BEFORE([$0], [AC_LIB_LINKFLAGS])
+  AC_REQUIRE([AC_PROG_CC])
+  AC_REQUIRE([AC_CANONICAL_HOST])
+  AC_REQUIRE([AC_LIB_PREPARE_PREFIX])
+  dnl By default, look in $includedir and $libdir.
+  use_additional=yes
+  AC_LIB_WITH_FINAL_PREFIX([
+    eval additional_includedir=\"$includedir\"
+    eval additional_libdir=\"$libdir\"
+  ])
+  AC_LIB_ARG_WITH([lib-prefix],
+[  --with-lib-prefix[=DIR] search for libraries in DIR/include and DIR/lib
+  --without-lib-prefix    don't search for libraries in includedir and libdir],
+[
+    if test "X$withval" = "Xno"; then
+      use_additional=no
+    else
+      if test "X$withval" = "X"; then
+        AC_LIB_WITH_FINAL_PREFIX([
+          eval additional_includedir=\"$includedir\"
+          eval additional_libdir=\"$libdir\"
+        ])
+      else
+        additional_includedir="$withval/include"
+        additional_libdir="$withval/lib"
+      fi
+    fi
+])
+  if test $use_additional = yes; then
+    dnl Potentially add $additional_includedir to $CPPFLAGS.
+    dnl But don't add it
+    dnl   1. if it's the standard /usr/include,
+    dnl   2. if it's already present in $CPPFLAGS,
+    dnl   3. if it's /usr/local/include and we are using GCC on Linux,
+    dnl   4. if it doesn't exist as a directory.
+    if test "X$additional_includedir" != "X/usr/include"; then
+      haveit=
+      for x in $CPPFLAGS; do
+        AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+        if test "X$x" = "X-I$additional_includedir"; then
+          haveit=yes
+          break
+        fi
+      done
+      if test -z "$haveit"; then
+        if test "X$additional_includedir" = "X/usr/local/include"; then
+          if test -n "$GCC"; then
+            case $host_os in
+              linux* | gnu* | k*bsd*-gnu) haveit=yes;;
+            esac
+          fi
+        fi
+        if test -z "$haveit"; then
+          if test -d "$additional_includedir"; then
+            dnl Really add $additional_includedir to $CPPFLAGS.
+            CPPFLAGS="${CPPFLAGS}${CPPFLAGS:+ }-I$additional_includedir"
+          fi
+        fi
+      fi
+    fi
+    dnl Potentially add $additional_libdir to $LDFLAGS.
+    dnl But don't add it
+    dnl   1. if it's the standard /usr/lib,
+    dnl   2. if it's already present in $LDFLAGS,
+    dnl   3. if it's /usr/local/lib and we are using GCC on Linux,
+    dnl   4. if it doesn't exist as a directory.
+    if test "X$additional_libdir" != "X/usr/lib"; then
+      haveit=
+      for x in $LDFLAGS; do
+        AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+        if test "X$x" = "X-L$additional_libdir"; then
+          haveit=yes
+          break
+        fi
+      done
+      if test -z "$haveit"; then
+        if test "X$additional_libdir" = "X/usr/local/lib"; then
+          if test -n "$GCC"; then
+            case $host_os in
+              linux*) haveit=yes;;
+            esac
+          fi
+        fi
+        if test -z "$haveit"; then
+          if test -d "$additional_libdir"; then
+            dnl Really add $additional_libdir to $LDFLAGS.
+            LDFLAGS="${LDFLAGS}${LDFLAGS:+ }-L$additional_libdir"
+          fi
+        fi
+      fi
+    fi
+  fi
+])
+
+dnl AC_LIB_PREPARE_PREFIX creates variables acl_final_prefix,
+dnl acl_final_exec_prefix, containing the values to which $prefix and
+dnl $exec_prefix will expand at the end of the configure script.
+AC_DEFUN([AC_LIB_PREPARE_PREFIX],
+[
+  dnl Unfortunately, prefix and exec_prefix get only finally determined
+  dnl at the end of configure.
+  if test "X$prefix" = "XNONE"; then
+    acl_final_prefix="$ac_default_prefix"
+  else
+    acl_final_prefix="$prefix"
+  fi
+  if test "X$exec_prefix" = "XNONE"; then
+    acl_final_exec_prefix='${prefix}'
+  else
+    acl_final_exec_prefix="$exec_prefix"
+  fi
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  eval acl_final_exec_prefix=\"$acl_final_exec_prefix\"
+  prefix="$acl_save_prefix"
+])
+
+dnl AC_LIB_WITH_FINAL_PREFIX([statement]) evaluates statement, with the
+dnl variables prefix and exec_prefix bound to the values they will have
+dnl at the end of the configure script.
+AC_DEFUN([AC_LIB_WITH_FINAL_PREFIX],
+[
+  acl_save_prefix="$prefix"
+  prefix="$acl_final_prefix"
+  acl_save_exec_prefix="$exec_prefix"
+  exec_prefix="$acl_final_exec_prefix"
+  $1
+  exec_prefix="$acl_save_exec_prefix"
+  prefix="$acl_save_prefix"
+])
+
+# lib-link.m4 serial 5 (gettext-0.14.2)
+dnl Copyright (C) 2001-2005 Free Software Foundation, Inc.
+dnl This file is free software; the Free Software Foundation
+dnl gives unlimited permission to copy and/or distribute it,
+dnl with or without modifications, as long as this notice is preserved.
+
+dnl From Bruno Haible.
+
+dnl AC_LIB_LINKFLAGS(name [, dependencies]) searches for libname and
+dnl the libraries corresponding to explicit and implicit dependencies.
+dnl Sets and AC_SUBSTs the LIB${NAME} and LTLIB${NAME} variables and
+dnl augments the CPPFLAGS variable.
+AC_DEFUN([AC_LIB_LINKFLAGS],
+[
+  AC_REQUIRE([AC_LIB_PREPARE_PREFIX])
+  AC_REQUIRE([AC_LIB_RPATH])
+  define([Name],[translit([$1],[./-], [___])])
+  define([NAME],[translit([$1],[abcdefghijklmnopqrstuvwxyz./-],
+                               [ABCDEFGHIJKLMNOPQRSTUVWXYZ___])])
+  AC_CACHE_CHECK([how to link with lib[]$1], [ac_cv_lib[]Name[]_libs], [
+    AC_LIB_LINKFLAGS_BODY([$1], [$2])
+    ac_cv_lib[]Name[]_libs="$LIB[]NAME"
+    ac_cv_lib[]Name[]_ltlibs="$LTLIB[]NAME"
+    ac_cv_lib[]Name[]_cppflags="$INC[]NAME"
+  ])
+  LIB[]NAME="$ac_cv_lib[]Name[]_libs"
+  LTLIB[]NAME="$ac_cv_lib[]Name[]_ltlibs"
+  INC[]NAME="$ac_cv_lib[]Name[]_cppflags"
+  AC_LIB_APPENDTOVAR([CPPFLAGS], [$INC]NAME)
+  AC_SUBST([LIB]NAME)
+  AC_SUBST([LTLIB]NAME)
+  dnl Also set HAVE_LIB[]NAME so that AC_LIB_HAVE_LINKFLAGS can reuse the
+  dnl results of this search when this library appears as a dependency.
+  HAVE_LIB[]NAME=yes
+  undefine([Name])
+  undefine([NAME])
+])
+
+dnl AC_LIB_HAVE_LINKFLAGS(name, dependencies, includes, testcode)
+dnl searches for libname and the libraries corresponding to explicit and
+dnl implicit dependencies, together with the specified include files and
+dnl the ability to compile and link the specified testcode. If found, it
+dnl sets and AC_SUBSTs HAVE_LIB${NAME}=yes and the LIB${NAME} and
+dnl LTLIB${NAME} variables and augments the CPPFLAGS variable, and
+dnl #defines HAVE_LIB${NAME} to 1. Otherwise, it sets and AC_SUBSTs
+dnl HAVE_LIB${NAME}=no and LIB${NAME} and LTLIB${NAME} to empty.
+AC_DEFUN([AC_LIB_HAVE_LINKFLAGS],
+[
+  AC_REQUIRE([AC_LIB_PREPARE_PREFIX])
+  AC_REQUIRE([AC_LIB_RPATH])
+  define([Name],[translit([$1],[./-], [___])])
+  define([NAME],[translit([$1],[abcdefghijklmnopqrstuvwxyz./-],
+                               [ABCDEFGHIJKLMNOPQRSTUVWXYZ___])])
+
+  dnl Search for lib[]Name and define LIB[]NAME, LTLIB[]NAME and INC[]NAME
+  dnl accordingly.
+  AC_LIB_LINKFLAGS_BODY([$1], [$2])
+
+  dnl Add $INC[]NAME to CPPFLAGS before performing the following checks,
+  dnl because if the user has installed lib[]Name and not disabled its use
+  dnl via --without-lib[]Name-prefix, he wants to use it.
+  ac_save_CPPFLAGS="$CPPFLAGS"
+  AC_LIB_APPENDTOVAR([CPPFLAGS], [$INC]NAME)
+
+  AC_CACHE_CHECK([for lib[]$1], [ac_cv_lib[]Name], [
+    ac_save_LIBS="$LIBS"
+    LIBS="$LIBS $LIB[]NAME"
+    AC_TRY_LINK([$3], [$4], [ac_cv_lib[]Name=yes], [ac_cv_lib[]Name=no])
+    LIBS="$ac_save_LIBS"
+  ])
+  if test "$ac_cv_lib[]Name" = yes; then
+    HAVE_LIB[]NAME=yes
+    AC_DEFINE([HAVE_LIB]NAME, 1, [Define if you have the $1 library.])
+    AC_MSG_CHECKING([how to link with lib[]$1])
+    AC_MSG_RESULT([$LIB[]NAME])
+  else
+    HAVE_LIB[]NAME=no
+    dnl If $LIB[]NAME didn't lead to a usable library, we don't need
+    dnl $INC[]NAME either.
+    CPPFLAGS="$ac_save_CPPFLAGS"
+    LIB[]NAME=
+    LTLIB[]NAME=
+  fi
+  AC_SUBST([HAVE_LIB]NAME)
+  AC_SUBST([LIB]NAME)
+  AC_SUBST([LTLIB]NAME)
+  undefine([Name])
+  undefine([NAME])
+])
+
+dnl Determine the platform dependent parameters needed to use rpath:
+dnl libext, shlibext, hardcode_libdir_flag_spec, hardcode_libdir_separator,
+dnl hardcode_direct, hardcode_minus_L.
+AC_DEFUN([AC_LIB_RPATH],
+[
+  AC_REQUIRE([AC_PROG_CC])                dnl we use $CC, $GCC, $LDFLAGS
+  AC_REQUIRE([AC_LIB_PROG_LD])            dnl we use $LD, $with_gnu_ld
+  AC_REQUIRE([AC_CANONICAL_HOST])         dnl we use $host
+  AC_REQUIRE([AC_CONFIG_AUX_DIR_DEFAULT]) dnl we use $ac_aux_dir
+  AC_CACHE_CHECK([for shared library run path origin], acl_cv_rpath, [
+    CC="$CC" GCC="$GCC" LDFLAGS="$LDFLAGS" LD="$LD" with_gnu_ld="$with_gnu_ld" \
+    ${CONFIG_SHELL-/bin/sh} "$ac_aux_dir/config.rpath" "$host" > conftest.sh
+    . ./conftest.sh
+    rm -f ./conftest.sh
+    acl_cv_rpath=done
+  ])
+  wl="$acl_cv_wl"
+  libext="$acl_cv_libext"
+  shlibext="$acl_cv_shlibext"
+  hardcode_libdir_flag_spec="$acl_cv_hardcode_libdir_flag_spec"
+  hardcode_libdir_separator="$acl_cv_hardcode_libdir_separator"
+  hardcode_direct="$acl_cv_hardcode_direct"
+  hardcode_minus_L="$acl_cv_hardcode_minus_L"
+  dnl Determine whether the user wants rpath handling at all.
+  AC_ARG_ENABLE(rpath,
+    [  --disable-rpath         do not hardcode runtime library paths],
+    :, enable_rpath=yes)
+])
+
+dnl AC_LIB_LINKFLAGS_BODY(name [, dependencies]) searches for libname and
+dnl the libraries corresponding to explicit and implicit dependencies.
+dnl Sets the LIB${NAME}, LTLIB${NAME} and INC${NAME} variables.
+AC_DEFUN([AC_LIB_LINKFLAGS_BODY],
+[
+  define([NAME],[translit([$1],[abcdefghijklmnopqrstuvwxyz./-],
+                               [ABCDEFGHIJKLMNOPQRSTUVWXYZ___])])
+  dnl By default, look in $includedir and $libdir.
+  use_additional=yes
+  AC_LIB_WITH_FINAL_PREFIX([
+    eval additional_includedir=\"$includedir\"
+    eval additional_libdir=\"$libdir\"
+  ])
+  AC_LIB_ARG_WITH([lib$1-prefix],
+[  --with-lib$1-prefix[=DIR]  search for lib$1 in DIR/include and DIR/lib
+  --without-lib$1-prefix     don't search for lib$1 in includedir and libdir],
+[
+    if test "X$withval" = "Xno"; then
+      use_additional=no
+    else
+      if test "X$withval" = "X"; then
+        AC_LIB_WITH_FINAL_PREFIX([
+          eval additional_includedir=\"$includedir\"
+          eval additional_libdir=\"$libdir\"
+        ])
+      else
+        additional_includedir="$withval/include"
+        additional_libdir="$withval/lib"
+      fi
+    fi
+])
+  dnl Search the library and its dependencies in $additional_libdir and
+  dnl $LDFLAGS. Using breadth-first-seach.
+  LIB[]NAME=
+  LTLIB[]NAME=
+  INC[]NAME=
+  rpathdirs=
+  ltrpathdirs=
+  names_already_handled=
+  names_next_round='$1 $2'
+  while test -n "$names_next_round"; do
+    names_this_round="$names_next_round"
+    names_next_round=
+    for name in $names_this_round; do
+      already_handled=
+      for n in $names_already_handled; do
+        if test "$n" = "$name"; then
+          already_handled=yes
+          break
+        fi
+      done
+      if test -z "$already_handled"; then
+        names_already_handled="$names_already_handled $name"
+        dnl See if it was already located by an earlier AC_LIB_LINKFLAGS
+        dnl or AC_LIB_HAVE_LINKFLAGS call.
+        uppername=`echo "$name" | sed -e 'y|abcdefghijklmnopqrstuvwxyz./-|ABCDEFGHIJKLMNOPQRSTUVWXYZ___|'`
+        eval value=\"\$HAVE_LIB$uppername\"
+        if test -n "$value"; then
+          if test "$value" = yes; then
+            eval value=\"\$LIB$uppername\"
+            test -z "$value" || LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$value"
+            eval value=\"\$LTLIB$uppername\"
+            test -z "$value" || LTLIB[]NAME="${LTLIB[]NAME}${LTLIB[]NAME:+ }$value"
+          else
+            dnl An earlier call to AC_LIB_HAVE_LINKFLAGS has determined
+            dnl that this library doesn't exist. So just drop it.
+            :
+          fi
+        else
+          dnl Search the library lib$name in $additional_libdir and $LDFLAGS
+          dnl and the already constructed $LIBNAME/$LTLIBNAME.
+          found_dir=
+          found_la=
+          found_so=
+          found_a=
+          if test $use_additional = yes; then
+            if test -n "$shlibext" && test -f "$additional_libdir/lib$name.$shlibext"; then
+              found_dir="$additional_libdir"
+              found_so="$additional_libdir/lib$name.$shlibext"
+              if test -f "$additional_libdir/lib$name.la"; then
+                found_la="$additional_libdir/lib$name.la"
+              fi
+            else
+              if test -f "$additional_libdir/lib$name.$libext"; then
+                found_dir="$additional_libdir"
+                found_a="$additional_libdir/lib$name.$libext"
+                if test -f "$additional_libdir/lib$name.la"; then
+                  found_la="$additional_libdir/lib$name.la"
+                fi
+              fi
+            fi
+          fi
+          if test "X$found_dir" = "X"; then
+            for x in $LDFLAGS $LTLIB[]NAME; do
+              AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+              case "$x" in
+                -L*)
+                  dir=`echo "X$x" | sed -e 's/^X-L//'`
+                  if test -n "$shlibext" && test -f "$dir/lib$name.$shlibext"; then
+                    found_dir="$dir"
+                    found_so="$dir/lib$name.$shlibext"
+                    if test -f "$dir/lib$name.la"; then
+                      found_la="$dir/lib$name.la"
+                    fi
+                  else
+                    if test -f "$dir/lib$name.$libext"; then
+                      found_dir="$dir"
+                      found_a="$dir/lib$name.$libext"
+                      if test -f "$dir/lib$name.la"; then
+                        found_la="$dir/lib$name.la"
+                      fi
+                    fi
+                  fi
+                  ;;
+              esac
+              if test "X$found_dir" != "X"; then
+                break
+              fi
+            done
+          fi
+          if test "X$found_dir" != "X"; then
+            dnl Found the library.
+            LTLIB[]NAME="${LTLIB[]NAME}${LTLIB[]NAME:+ }-L$found_dir -l$name"
+            if test "X$found_so" != "X"; then
+              dnl Linking with a shared library. We attempt to hardcode its
+              dnl directory into the executable's runpath, unless it's the
+              dnl standard /usr/lib.
+              if test "$enable_rpath" = no || test "X$found_dir" = "X/usr/lib"; then
+                dnl No hardcoding is needed.
+                LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$found_so"
+              else
+                dnl Use an explicit option to hardcode DIR into the resulting
+                dnl binary.
+                dnl Potentially add DIR to ltrpathdirs.
+                dnl The ltrpathdirs will be appended to $LTLIBNAME at the end.
+                haveit=
+                for x in $ltrpathdirs; do
+                  if test "X$x" = "X$found_dir"; then
+                    haveit=yes
+                    break
+                  fi
+                done
+                if test -z "$haveit"; then
+                  ltrpathdirs="$ltrpathdirs $found_dir"
+                fi
+                dnl The hardcoding into $LIBNAME is system dependent.
+                if test "$hardcode_direct" = yes; then
+                  dnl Using DIR/libNAME.so during linking hardcodes DIR into the
+                  dnl resulting binary.
+                  LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$found_so"
+                else
+                  if test -n "$hardcode_libdir_flag_spec" && test "$hardcode_minus_L" = no; then
+                    dnl Use an explicit option to hardcode DIR into the resulting
+                    dnl binary.
+                    LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$found_so"
+                    dnl Potentially add DIR to rpathdirs.
+                    dnl The rpathdirs will be appended to $LIBNAME at the end.
+                    haveit=
+                    for x in $rpathdirs; do
+                      if test "X$x" = "X$found_dir"; then
+                        haveit=yes
+                        break
+                      fi
+                    done
+                    if test -z "$haveit"; then
+                      rpathdirs="$rpathdirs $found_dir"
+                    fi
+                  else
+                    dnl Rely on "-L$found_dir".
+                    dnl But don't add it if it's already contained in the LDFLAGS
+                    dnl or the already constructed $LIBNAME
+                    haveit=
+                    for x in $LDFLAGS $LIB[]NAME; do
+                      AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+                      if test "X$x" = "X-L$found_dir"; then
+                        haveit=yes
+                        break
+                      fi
+                    done
+                    if test -z "$haveit"; then
+                      LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }-L$found_dir"
+                    fi
+                    if test "$hardcode_minus_L" != no; then
+                      dnl FIXME: Not sure whether we should use
+                      dnl "-L$found_dir -l$name" or "-L$found_dir $found_so"
+                      dnl here.
+                      LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$found_so"
+                    else
+                      dnl We cannot use $hardcode_runpath_var and LD_RUN_PATH
+                      dnl here, because this doesn't fit in flags passed to the
+                      dnl compiler. So give up. No hardcoding. This affects only
+                      dnl very old systems.
+                      dnl FIXME: Not sure whether we should use
+                      dnl "-L$found_dir -l$name" or "-L$found_dir $found_so"
+                      dnl here.
+                      LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }-l$name"
+                    fi
+                  fi
+                fi
+              fi
+            else
+              if test "X$found_a" != "X"; then
+                dnl Linking with a static library.
+                LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$found_a"
+              else
+                dnl We shouldn't come here, but anyway it's good to have a
+                dnl fallback.
+                LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }-L$found_dir -l$name"
+              fi
+            fi
+            dnl Assume the include files are nearby.
+            additional_includedir=
+            case "$found_dir" in
+              */lib | */lib/)
+                basedir=`echo "X$found_dir" | sed -e 's,^X,,' -e 's,/lib/*$,,'`
+                additional_includedir="$basedir/include"
+                ;;
+            esac
+            if test "X$additional_includedir" != "X"; then
+              dnl Potentially add $additional_includedir to $INCNAME.
+              dnl But don't add it
+              dnl   1. if it's the standard /usr/include,
+              dnl   2. if it's /usr/local/include and we are using GCC on Linux,
+              dnl   3. if it's already present in $CPPFLAGS or the already
+              dnl      constructed $INCNAME,
+              dnl   4. if it doesn't exist as a directory.
+              if test "X$additional_includedir" != "X/usr/include"; then
+                haveit=
+                if test "X$additional_includedir" = "X/usr/local/include"; then
+                  if test -n "$GCC"; then
+                    case $host_os in
+                      linux* | gnu* | k*bsd*-gnu) haveit=yes;;
+                    esac
+                  fi
+                fi
+                if test -z "$haveit"; then
+                  for x in $CPPFLAGS $INC[]NAME; do
+                    AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+                    if test "X$x" = "X-I$additional_includedir"; then
+                      haveit=yes
+                      break
+                    fi
+                  done
+                  if test -z "$haveit"; then
+                    if test -d "$additional_includedir"; then
+                      dnl Really add $additional_includedir to $INCNAME.
+                      INC[]NAME="${INC[]NAME}${INC[]NAME:+ }-I$additional_includedir"
+                    fi
+                  fi
+                fi
+              fi
+            fi
+            dnl Look for dependencies.
+            if test -n "$found_la"; then
+              dnl Read the .la file. It defines the variables
+              dnl dlname, library_names, old_library, dependency_libs, current,
+              dnl age, revision, installed, dlopen, dlpreopen, libdir.
+              save_libdir="$libdir"
+              case "$found_la" in
+                */* | *\\*) . "$found_la" ;;
+                *) . "./$found_la" ;;
+              esac
+              libdir="$save_libdir"
+              dnl We use only dependency_libs.
+              for dep in $dependency_libs; do
+                case "$dep" in
+                  -L*)
+                    additional_libdir=`echo "X$dep" | sed -e 's/^X-L//'`
+                    dnl Potentially add $additional_libdir to $LIBNAME and $LTLIBNAME.
+                    dnl But don't add it
+                    dnl   1. if it's the standard /usr/lib,
+                    dnl   2. if it's /usr/local/lib and we are using GCC on Linux,
+                    dnl   3. if it's already present in $LDFLAGS or the already
+                    dnl      constructed $LIBNAME,
+                    dnl   4. if it doesn't exist as a directory.
+                    if test "X$additional_libdir" != "X/usr/lib"; then
+                      haveit=
+                      if test "X$additional_libdir" = "X/usr/local/lib"; then
+                        if test -n "$GCC"; then
+                          case $host_os in
+                            linux* | gnu* | k*bsd*-gnu) haveit=yes;;
+                          esac
+                        fi
+                      fi
+                      if test -z "$haveit"; then
+                        haveit=
+                        for x in $LDFLAGS $LIB[]NAME; do
+                          AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+                          if test "X$x" = "X-L$additional_libdir"; then
+                            haveit=yes
+                            break
+                          fi
+                        done
+                        if test -z "$haveit"; then
+                          if test -d "$additional_libdir"; then
+                            dnl Really add $additional_libdir to $LIBNAME.
+                            LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }-L$additional_libdir"
+                          fi
+                        fi
+                        haveit=
+                        for x in $LDFLAGS $LTLIB[]NAME; do
+                          AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+                          if test "X$x" = "X-L$additional_libdir"; then
+                            haveit=yes
+                            break
+                          fi
+                        done
+                        if test -z "$haveit"; then
+                          if test -d "$additional_libdir"; then
+                            dnl Really add $additional_libdir to $LTLIBNAME.
+                            LTLIB[]NAME="${LTLIB[]NAME}${LTLIB[]NAME:+ }-L$additional_libdir"
+                          fi
+                        fi
+                      fi
+                    fi
+                    ;;
+                  -R*)
+                    dir=`echo "X$dep" | sed -e 's/^X-R//'`
+                    if test "$enable_rpath" != no; then
+                      dnl Potentially add DIR to rpathdirs.
+                      dnl The rpathdirs will be appended to $LIBNAME at the end.
+                      haveit=
+                      for x in $rpathdirs; do
+                        if test "X$x" = "X$dir"; then
+                          haveit=yes
+                          break
+                        fi
+                      done
+                      if test -z "$haveit"; then
+                        rpathdirs="$rpathdirs $dir"
+                      fi
+                      dnl Potentially add DIR to ltrpathdirs.
+                      dnl The ltrpathdirs will be appended to $LTLIBNAME at the end.
+                      haveit=
+                      for x in $ltrpathdirs; do
+                        if test "X$x" = "X$dir"; then
+                          haveit=yes
+                          break
+                        fi
+                      done
+                      if test -z "$haveit"; then
+                        ltrpathdirs="$ltrpathdirs $dir"
+                      fi
+                    fi
+                    ;;
+                  -l*)
+                    dnl Handle this in the next round.
+                    names_next_round="$names_next_round "`echo "X$dep" | sed -e 's/^X-l//'`
+                    ;;
+                  *.la)
+                    dnl Handle this in the next round. Throw away the .la's
+                    dnl directory; it is already contained in a preceding -L
+                    dnl option.
+                    names_next_round="$names_next_round "`echo "X$dep" | sed -e 's,^X.*/,,' -e 's,^lib,,' -e 's,\.la$,,'`
+                    ;;
+                  *)
+                    dnl Most likely an immediate library name.
+                    LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$dep"
+                    LTLIB[]NAME="${LTLIB[]NAME}${LTLIB[]NAME:+ }$dep"
+                    ;;
+                esac
+              done
+            fi
+          else
+            dnl Didn't find the library; assume it is in the system directories
+            dnl known to the linker and runtime loader. (All the system
+            dnl directories known to the linker should also be known to the
+            dnl runtime loader, otherwise the system is severely misconfigured.)
+            LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }-l$name"
+            LTLIB[]NAME="${LTLIB[]NAME}${LTLIB[]NAME:+ }-l$name"
+          fi
+        fi
+      fi
+    done
+  done
+  if test "X$rpathdirs" != "X"; then
+    if test -n "$hardcode_libdir_separator"; then
+      dnl Weird platform: only the last -rpath option counts, the user must
+      dnl pass all path elements in one option. We can arrange that for a
+      dnl single library, but not when more than one $LIBNAMEs are used.
+      alldirs=
+      for found_dir in $rpathdirs; do
+        alldirs="${alldirs}${alldirs:+$hardcode_libdir_separator}$found_dir"
+      done
+      dnl Note: hardcode_libdir_flag_spec uses $libdir and $wl.
+      acl_save_libdir="$libdir"
+      libdir="$alldirs"
+      eval flag=\"$hardcode_libdir_flag_spec\"
+      libdir="$acl_save_libdir"
+      LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$flag"
+    else
+      dnl The -rpath options are cumulative.
+      for found_dir in $rpathdirs; do
+        acl_save_libdir="$libdir"
+        libdir="$found_dir"
+        eval flag=\"$hardcode_libdir_flag_spec\"
+        libdir="$acl_save_libdir"
+        LIB[]NAME="${LIB[]NAME}${LIB[]NAME:+ }$flag"
+      done
+    fi
+  fi
+  if test "X$ltrpathdirs" != "X"; then
+    dnl When using libtool, the option that works for both libraries and
+    dnl executables is -R. The -R options are cumulative.
+    for found_dir in $ltrpathdirs; do
+      LTLIB[]NAME="${LTLIB[]NAME}${LTLIB[]NAME:+ }-R$found_dir"
+    done
+  fi
+])
+
+dnl AC_LIB_APPENDTOVAR(VAR, CONTENTS) appends the elements of CONTENTS to VAR,
+dnl unless already present in VAR.
+dnl Works only for CPPFLAGS, not for LIB* variables because that sometimes
+dnl contains two or three consecutive elements that belong together.
+AC_DEFUN([AC_LIB_APPENDTOVAR],
+[
+  for element in [$2]; do
+    haveit=
+    for x in $[$1]; do
+      AC_LIB_WITH_FINAL_PREFIX([eval x=\"$x\"])
+      if test "X$x" = "X$element"; then
+        haveit=yes
+        break
+      fi
+    done
+    if test -z "$haveit"; then
+      [$1]="${[$1]}${[$1]:+ }$element"
+    fi
+  done
+])
+
+# lib-ld.m4 serial 3 (gettext-0.13)
+dnl Copyright (C) 1996-2003 Free Software Foundation, Inc.
+dnl This file is free software; the Free Software Foundation
+dnl gives unlimited permission to copy and/or distribute it,
+dnl with or without modifications, as long as this notice is preserved.
+
+dnl Subroutines of libtool.m4,
+dnl with replacements s/AC_/AC_LIB/ and s/lt_cv/acl_cv/ to avoid collision
+dnl with libtool.m4.
+
+dnl From libtool-1.4. Sets the variable with_gnu_ld to yes or no.
+AC_DEFUN([AC_LIB_PROG_LD_GNU],
+[AC_CACHE_CHECK([if the linker ($LD) is GNU ld], acl_cv_prog_gnu_ld,
+[# I'd rather use --version here, but apparently some GNU ld's only accept -v.
+case `$LD -v 2>&1 </dev/null` in
+*GNU* | *'with BFD'*)
+  acl_cv_prog_gnu_ld=yes ;;
+*)
+  acl_cv_prog_gnu_ld=no ;;
+esac])
+with_gnu_ld=$acl_cv_prog_gnu_ld
+])
+
+dnl From libtool-1.4. Sets the variable LD.
+AC_DEFUN([AC_LIB_PROG_LD],
+[AC_ARG_WITH(gnu-ld,
+[  --with-gnu-ld           assume the C compiler uses GNU ld [default=no]],
+test "$withval" = no || with_gnu_ld=yes, with_gnu_ld=no)
+AC_REQUIRE([AC_PROG_CC])dnl
+AC_REQUIRE([AC_CANONICAL_HOST])dnl
+# Prepare PATH_SEPARATOR.
+# The user is always right.
+if test "${PATH_SEPARATOR+set}" != set; then
+  echo "#! /bin/sh" >conf$$.sh
+  echo  "exit 0"   >>conf$$.sh
+  chmod +x conf$$.sh
+  if (PATH="/nonexistent;."; conf$$.sh) >/dev/null 2>&1; then
+    PATH_SEPARATOR=';'
+  else
+    PATH_SEPARATOR=:
+  fi
+  rm -f conf$$.sh
+fi
+ac_prog=ld
+if test "$GCC" = yes; then
+  # Check if gcc -print-prog-name=ld gives a path.
+  AC_MSG_CHECKING([for ld used by GCC])
+  case $host in
+  *-*-mingw*)
+    # gcc leaves a trailing carriage return which upsets mingw
+    ac_prog=`($CC -print-prog-name=ld) 2>&5 | tr -d '\015'` ;;
+  *)
+    ac_prog=`($CC -print-prog-name=ld) 2>&5` ;;
+  esac
+  case $ac_prog in
+    # Accept absolute paths.
+    [[\\/]* | [A-Za-z]:[\\/]*)]
+      [re_direlt='/[^/][^/]*/\.\./']
+      # Canonicalize the path of ld
+      ac_prog=`echo $ac_prog| sed 's%\\\\%/%g'`
+      while echo $ac_prog | grep "$re_direlt" > /dev/null 2>&1; do
+	ac_prog=`echo $ac_prog| sed "s%$re_direlt%/%"`
+      done
+      test -z "$LD" && LD="$ac_prog"
+      ;;
+  "")
+    # If it fails, then pretend we aren't using GCC.
+    ac_prog=ld
+    ;;
+  *)
+    # If it is relative, then search for the first ld in PATH.
+    with_gnu_ld=unknown
+    ;;
+  esac
+elif test "$with_gnu_ld" = yes; then
+  AC_MSG_CHECKING([for GNU ld])
+else
+  AC_MSG_CHECKING([for non-GNU ld])
+fi
+AC_CACHE_VAL(acl_cv_path_LD,
+[if test -z "$LD"; then
+  IFS="${IFS= 	}"; ac_save_ifs="$IFS"; IFS="${IFS}${PATH_SEPARATOR-:}"
+  for ac_dir in $PATH; do
+    test -z "$ac_dir" && ac_dir=.
+    if test -f "$ac_dir/$ac_prog" || test -f "$ac_dir/$ac_prog$ac_exeext"; then
+      acl_cv_path_LD="$ac_dir/$ac_prog"
+      # Check to see if the program is GNU ld.  I'd rather use --version,
+      # but apparently some GNU ld's only accept -v.
+      # Break only if it was the GNU/non-GNU ld that we prefer.
+      case `"$acl_cv_path_LD" -v 2>&1 < /dev/null` in
+      *GNU* | *'with BFD'*)
+	test "$with_gnu_ld" != no && break ;;
+      *)
+	test "$with_gnu_ld" != yes && break ;;
+      esac
+    fi
+  done
+  IFS="$ac_save_ifs"
+else
+  acl_cv_path_LD="$LD" # Let the user override the test with a path.
+fi])
+LD="$acl_cv_path_LD"
+if test -n "$LD"; then
+  AC_MSG_RESULT($LD)
+else
+  AC_MSG_RESULT(no)
+fi
+test -z "$LD" && AC_MSG_ERROR([no acceptable ld found in \$PATH])
+AC_LIB_PROG_LD_GNU
+])
+
+# Do all the work for Automake.  This macro actually does too much --
+# some checks are only needed if your package does certain things.
+# But this isn't really a big deal.
+
+# serial 1
+
+dnl Usage:
+dnl AM_INIT_AUTOMAKE(package,version, [no-define])
+
+AC_DEFUN([AM_INIT_AUTOMAKE],
+[AC_REQUIRE([AM_SET_CURRENT_AUTOMAKE_VERSION])dnl
+AC_REQUIRE([AC_PROG_INSTALL])
+PACKAGE=[$1]
+AC_SUBST(PACKAGE)
+VERSION=[$2]
+AC_SUBST(VERSION)
+dnl test to see if srcdir already configured
+if test "`cd $srcdir && pwd`" != "`pwd`" && test -f $srcdir/config.status; then
+  AC_MSG_ERROR([source directory already configured; run "make distclean" there first])
+fi
+ifelse([$3],,
+AC_DEFINE_UNQUOTED(PACKAGE, "$PACKAGE", [Name of package])
+AC_DEFINE_UNQUOTED(VERSION, "$VERSION", [Version number of package]))
+AC_REQUIRE([AM_SANITY_CHECK])
+AC_REQUIRE([AC_ARG_PROGRAM])
+dnl FIXME This is truly gross.
+missing_dir=`cd $ac_aux_dir && pwd`
+AM_MISSING_PROG(ACLOCAL, aclocal-${am__api_version}, $missing_dir)
+AM_MISSING_PROG(AUTOCONF, autoconf, $missing_dir)
+AM_MISSING_PROG(AUTOMAKE, automake-${am__api_version}, $missing_dir)
+AM_MISSING_PROG(AUTOHEADER, autoheader, $missing_dir)
+AM_MISSING_PROG(MAKEINFO, makeinfo, $missing_dir)
+AC_REQUIRE([AC_PROG_MAKE_SET])])
+
+# Copyright 2002  Free Software Foundation, Inc.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+
+# AM_AUTOMAKE_VERSION(VERSION)
+# ----------------------------
+# Automake X.Y traces this macro to ensure aclocal.m4 has been
+# generated from the m4 files accompanying Automake X.Y.
+AC_DEFUN([AM_AUTOMAKE_VERSION],[am__api_version="1.4"])
+
+# AM_SET_CURRENT_AUTOMAKE_VERSION
+# -------------------------------
+# Call AM_AUTOMAKE_VERSION so it can be traced.
+# This function is AC_REQUIREd by AC_INIT_AUTOMAKE.
+AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
+	 [AM_AUTOMAKE_VERSION([1.4-p6])])
+
+#
+# Check to make sure that the build environment is sane.
+#
+
+AC_DEFUN([AM_SANITY_CHECK],
+[AC_MSG_CHECKING([whether build environment is sane])
+# Just in case
+sleep 1
+echo timestamp > conftestfile
+# Do `set' in a subshell so we don't clobber the current shell's
+# arguments.  Must try -L first in case configure is actually a
+# symlink; some systems play weird games with the mod time of symlinks
+# (eg FreeBSD returns the mod time of the symlink's containing
+# directory).
+if (
+   set X `ls -Lt $srcdir/configure conftestfile 2> /dev/null`
+   if test "[$]*" = "X"; then
+      # -L didn't work.
+      set X `ls -t $srcdir/configure conftestfile`
+   fi
+   if test "[$]*" != "X $srcdir/configure conftestfile" \
+      && test "[$]*" != "X conftestfile $srcdir/configure"; then
+
+      # If neither matched, then we have a broken ls.  This can happen
+      # if, for instance, CONFIG_SHELL is bash and it inherits a
+      # broken ls alias from the environment.  This has actually
+      # happened.  Such a system could not be considered "sane".
+      AC_MSG_ERROR([ls -t appears to fail.  Make sure there is not a broken
+alias in your environment])
+   fi
+
+   test "[$]2" = conftestfile
+   )
+then
+   # Ok.
+   :
+else
+   AC_MSG_ERROR([newly created file is older than distributed files!
+Check your system clock])
+fi
+rm -f conftest*
+AC_MSG_RESULT(yes)])
+
+dnl AM_MISSING_PROG(NAME, PROGRAM, DIRECTORY)
+dnl The program must properly implement --version.
+AC_DEFUN([AM_MISSING_PROG],
+[AC_MSG_CHECKING(for working $2)
+# Run test in a subshell; some versions of sh will print an error if
+# an executable is not found, even if stderr is redirected.
+# Redirect stdin to placate older versions of autoconf.  Sigh.
+if ($2 --version) < /dev/null > /dev/null 2>&1; then
+   $1=$2
+   AC_MSG_RESULT(found)
+else
+   $1="$3/missing $2"
+   AC_MSG_RESULT(missing)
+fi
+AC_SUBST($1)])
+
+# Like AC_CONFIG_HEADER, but automatically create stamp file.
+
+AC_DEFUN([AM_CONFIG_HEADER],
+[AC_PREREQ([2.12])
+AC_CONFIG_HEADER([$1])
+dnl When config.status generates a header, we must update the stamp-h file.
+dnl This file resides in the same directory as the config header
+dnl that is generated.  We must strip everything past the first ":",
+dnl and everything past the last "/".
+AC_OUTPUT_COMMANDS(changequote(<<,>>)dnl
+ifelse(patsubst(<<$1>>, <<[^ ]>>, <<>>), <<>>,
+<<test -z "<<$>>CONFIG_HEADERS" || echo timestamp > patsubst(<<$1>>, <<^\([^:]*/\)?.*>>, <<\1>>)stamp-h<<>>dnl>>,
+<<am_indx=1
+for am_file in <<$1>>; do
+  case " <<$>>CONFIG_HEADERS " in
+  *" <<$>>am_file "*<<)>>
+    echo timestamp > `echo <<$>>am_file | sed -e 's%:.*%%' -e 's%[^/]*$%%'`stamp-h$am_indx
+    ;;
+  esac
+  am_indx=`expr "<<$>>am_indx" + 1`
+done<<>>dnl>>)
+changequote([,]))])
+
+# Configure paths for GTK+
+# Owen Taylor     97-11-3
+
+dnl AM_PATH_GTK([MINIMUM-VERSION, [ACTION-IF-FOUND [, ACTION-IF-NOT-FOUND [, MODULES]]]])
+dnl Test for GTK, and define GTK_CFLAGS and GTK_LIBS
+dnl
+AC_DEFUN(AM_PATH_GTK,
+[dnl 
+dnl Get the cflags and libraries from the gtk-config script
+dnl
+AC_ARG_WITH(gtk-prefix,[  --with-gtk-prefix=PFX   Prefix where GTK is installed (optional)],
+            gtk_config_prefix="$withval", gtk_config_prefix="")
+AC_ARG_WITH(gtk-exec-prefix,[  --with-gtk-exec-prefix=PFX Exec prefix where GTK is installed (optional)],
+            gtk_config_exec_prefix="$withval", gtk_config_exec_prefix="")
+AC_ARG_ENABLE(gtktest, [  --disable-gtktest       Do not try to compile and run a test GTK program],
+		    , enable_gtktest=yes)
+
+  for module in . $4
+  do
+      case "$module" in
+         gthread) 
+             gtk_config_args="$gtk_config_args gthread"
+         ;;
+      esac
+  done
+
+  if test x$gtk_config_exec_prefix != x ; then
+     gtk_config_args="$gtk_config_args --exec-prefix=$gtk_config_exec_prefix"
+     if test x${GTK_CONFIG+set} != xset ; then
+        GTK_CONFIG=$gtk_config_exec_prefix/bin/gtk-config
+     fi
+  fi
+  if test x$gtk_config_prefix != x ; then
+     gtk_config_args="$gtk_config_args --prefix=$gtk_config_prefix"
+     if test x${GTK_CONFIG+set} != xset ; then
+        GTK_CONFIG=$gtk_config_prefix/bin/gtk-config
+     fi
+  fi
+
+  AC_PATH_PROG(GTK_CONFIG, gtk-config, no)
+  min_gtk_version=ifelse([$1], ,0.99.7,$1)
+  AC_MSG_CHECKING(for GTK - version >= $min_gtk_version)
+  no_gtk=""
+  if test "$GTK_CONFIG" = "no" ; then
+    no_gtk=yes
+  else
+    GTK_CFLAGS=`$GTK_CONFIG $gtk_config_args --cflags`
+    GTK_LIBS=`$GTK_CONFIG $gtk_config_args --libs`
+    gtk_config_major_version=`$GTK_CONFIG $gtk_config_args --version | \
+           sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\1/'`
+    gtk_config_minor_version=`$GTK_CONFIG $gtk_config_args --version | \
+           sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\2/'`
+    gtk_config_micro_version=`$GTK_CONFIG $gtk_config_args --version | \
+           sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\3/'`
+    if test "x$enable_gtktest" = "xyes" ; then
+      ac_save_CFLAGS="$CFLAGS"
+      ac_save_LIBS="$LIBS"
+      CFLAGS="$CFLAGS $GTK_CFLAGS"
+      LIBS="$GTK_LIBS $LIBS"
+dnl
+dnl Now check if the installed GTK is sufficiently new. (Also sanity
+dnl checks the results of gtk-config to some extent
+dnl
+      rm -f conf.gtktest
+      AC_TRY_RUN([
+#include <gtk/gtk.h>
+#include <stdio.h>
+#include <stdlib.h>
+
+int 
+main ()
+{
+  int major, minor, micro;
+  char *tmp_version;
+
+  system ("touch conf.gtktest");
+
+  /* HP/UX 9 (%@#!) writes to sscanf strings */
+  tmp_version = g_strdup("$min_gtk_version");
+  if (sscanf(tmp_version, "%d.%d.%d", &major, &minor, &micro) != 3) {
+     printf("%s, bad version string\n", "$min_gtk_version");
+     exit(1);
+   }
+
+  if ((gtk_major_version != $gtk_config_major_version) ||
+      (gtk_minor_version != $gtk_config_minor_version) ||
+      (gtk_micro_version != $gtk_config_micro_version))
+    {
+      printf("\n*** 'gtk-config --version' returned %d.%d.%d, but GTK+ (%d.%d.%d)\n", 
+             $gtk_config_major_version, $gtk_config_minor_version, $gtk_config_micro_version,
+             gtk_major_version, gtk_minor_version, gtk_micro_version);
+      printf ("*** was found! If gtk-config was correct, then it is best\n");
+      printf ("*** to remove the old version of GTK+. You may also be able to fix the error\n");
+      printf("*** by modifying your LD_LIBRARY_PATH enviroment variable, or by editing\n");
+      printf("*** /etc/ld.so.conf. Make sure you have run ldconfig if that is\n");
+      printf("*** required on your system.\n");
+      printf("*** If gtk-config was wrong, set the environment variable GTK_CONFIG\n");
+      printf("*** to point to the correct copy of gtk-config, and remove the file config.cache\n");
+      printf("*** before re-running configure\n");
+    } 
+#if defined (GTK_MAJOR_VERSION) && defined (GTK_MINOR_VERSION) && defined (GTK_MICRO_VERSION)
+  else if ((gtk_major_version != GTK_MAJOR_VERSION) ||
+	   (gtk_minor_version != GTK_MINOR_VERSION) ||
+           (gtk_micro_version != GTK_MICRO_VERSION))
+    {
+      printf("*** GTK+ header files (version %d.%d.%d) do not match\n",
+	     GTK_MAJOR_VERSION, GTK_MINOR_VERSION, GTK_MICRO_VERSION);
+      printf("*** library (version %d.%d.%d)\n",
+	     gtk_major_version, gtk_minor_version, gtk_micro_version);
+    }
+#endif /* defined (GTK_MAJOR_VERSION) ... */
+  else
+    {
+      if ((gtk_major_version > major) ||
+        ((gtk_major_version == major) && (gtk_minor_version > minor)) ||
+        ((gtk_major_version == major) && (gtk_minor_version == minor) && (gtk_micro_version >= micro)))
+      {
+        return 0;
+       }
+     else
+      {
+        printf("\n*** An old version of GTK+ (%d.%d.%d) was found.\n",
+               gtk_major_version, gtk_minor_version, gtk_micro_version);
+        printf("*** You need a version of GTK+ newer than %d.%d.%d. The latest version of\n",
+	       major, minor, micro);
+        printf("*** GTK+ is always available from ftp://ftp.gtk.org.\n");
+        printf("***\n");
+        printf("*** If you have already installed a sufficiently new version, this error\n");
+        printf("*** probably means that the wrong copy of the gtk-config shell script is\n");
+        printf("*** being found. The easiest way to fix this is to remove the old version\n");
+        printf("*** of GTK+, but you can also set the GTK_CONFIG environment to point to the\n");
+        printf("*** correct copy of gtk-config. (In this case, you will have to\n");
+        printf("*** modify your LD_LIBRARY_PATH enviroment variable, or edit /etc/ld.so.conf\n");
+        printf("*** so that the correct libraries are found at run-time))\n");
+      }
+    }
+  return 1;
+}
+],, no_gtk=yes,[echo $ac_n "cross compiling; assumed OK... $ac_c"])
+       CFLAGS="$ac_save_CFLAGS"
+       LIBS="$ac_save_LIBS"
+     fi
+  fi
+  if test "x$no_gtk" = x ; then
+     AC_MSG_RESULT(yes)
+     ifelse([$2], , :, [$2])     
+  else
+     AC_MSG_RESULT(no)
+     if test "$GTK_CONFIG" = "no" ; then
+       echo "*** The gtk-config script installed by GTK could not be found"
+       echo "*** If GTK was installed in PREFIX, make sure PREFIX/bin is in"
+       echo "*** your path, or set the GTK_CONFIG environment variable to the"
+       echo "*** full path to gtk-config."
+     else
+       if test -f conf.gtktest ; then
+        :
+       else
+          echo "*** Could not run GTK test program, checking why..."
+          CFLAGS="$CFLAGS $GTK_CFLAGS"
+          LIBS="$LIBS $GTK_LIBS"
+          AC_TRY_LINK([
+#include <gtk/gtk.h>
+#include <stdio.h>
+],      [ return ((gtk_major_version) || (gtk_minor_version) || (gtk_micro_version)); ],
+        [ echo "*** The test program compiled, but did not run. This usually means"
+          echo "*** that the run-time linker is not finding GTK or finding the wrong"
+          echo "*** version of GTK. If it is not finding GTK, you'll need to set your"
+          echo "*** LD_LIBRARY_PATH environment variable, or edit /etc/ld.so.conf to point"
+          echo "*** to the installed location  Also, make sure you have run ldconfig if that"
+          echo "*** is required on your system"
+	  echo "***"
+          echo "*** If you have an old version installed, it is best to remove it, although"
+          echo "*** you may also be able to get things to work by modifying LD_LIBRARY_PATH"
+          echo "***"
+          echo "*** If you have a RedHat 5.0 system, you should remove the GTK package that"
+          echo "*** came with the system with the command"
+          echo "***"
+          echo "***    rpm --erase --nodeps gtk gtk-devel" ],
+        [ echo "*** The test program failed to compile or link. See the file config.log for the"
+          echo "*** exact error that occured. This usually means GTK was incorrectly installed"
+          echo "*** or that you have moved GTK since it was installed. In the latter case, you"
+          echo "*** may want to edit the gtk-config script: $GTK_CONFIG" ])
+          CFLAGS="$ac_save_CFLAGS"
+          LIBS="$ac_save_LIBS"
+       fi
+     fi
+     GTK_CFLAGS=""
+     GTK_LIBS=""
+     ifelse([$3], , :, [$3])
+  fi
+  AC_SUBST(GTK_CFLAGS)
+  AC_SUBST(GTK_LIBS)
+  rm -f conf.gtktest
+])
+

Added: thinnx/trunk/config.guess
===================================================================
--- thinnx/trunk/config.guess	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/config.guess	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,1453 @@
+#! /bin/sh
+# Attempt to guess a canonical system name.
+#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
+#   2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
+
+timestamp='2004-11-12'
+
+# This file is free software; you can redistribute it and/or modify it
+# under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+# General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.
+#
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
+
+# Originally written by Per Bothner <per at bothner.com>.
+# Please send patches to <config-patches at gnu.org>.  Submit a context
+# diff and a properly formatted ChangeLog entry.
+#
+# This script attempts to guess a canonical system name similar to
+# config.sub.  If it succeeds, it prints the system name on stdout, and
+# exits with 0.  Otherwise, it exits with 1.
+#
+# The plan is that this can be called by configure scripts if you
+# don't specify an explicit build system type.
+
+me=`echo "$0" | sed -e 's,.*/,,'`
+
+usage="\
+Usage: $0 [OPTION]
+
+Output the configuration name of the system \`$me' is run on.
+
+Operation modes:
+  -h, --help         print this help, then exit
+  -t, --time-stamp   print date of last modification, then exit
+  -v, --version      print version number, then exit
+
+Report bugs and patches to <config-patches at gnu.org>."
+
+version="\
+GNU config.guess ($timestamp)
+
+Originally written by Per Bothner.
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004
+Free Software Foundation, Inc.
+
+This is free software; see the source for copying conditions.  There is NO
+warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
+
+help="
+Try \`$me --help' for more information."
+
+# Parse command line
+while test $# -gt 0 ; do
+  case $1 in
+    --time-stamp | --time* | -t )
+       echo "$timestamp" ; exit 0 ;;
+    --version | -v )
+       echo "$version" ; exit 0 ;;
+    --help | --h* | -h )
+       echo "$usage"; exit 0 ;;
+    -- )     # Stop option processing
+       shift; break ;;
+    - )	# Use stdin as input.
+       break ;;
+    -* )
+       echo "$me: invalid option $1$help" >&2
+       exit 1 ;;
+    * )
+       break ;;
+  esac
+done
+
+if test $# != 0; then
+  echo "$me: too many arguments$help" >&2
+  exit 1
+fi
+
+trap 'exit 1' 1 2 15
+
+# CC_FOR_BUILD -- compiler used by this script. Note that the use of a
+# compiler to aid in system detection is discouraged as it requires
+# temporary files to be created and, as you can see below, it is a
+# headache to deal with in a portable fashion.
+
+# Historically, `CC_FOR_BUILD' used to be named `HOST_CC'. We still
+# use `HOST_CC' if defined, but it is deprecated.
+
+# Portable tmp directory creation inspired by the Autoconf team.
+
+set_cc_for_build='
+trap "exitcode=\$?; (rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null) && exit \$exitcode" 0 ;
+trap "rm -f \$tmpfiles 2>/dev/null; rmdir \$tmp 2>/dev/null; exit 1" 1 2 13 15 ;
+: ${TMPDIR=/tmp} ;
+ { tmp=`(umask 077 && mktemp -d -q "$TMPDIR/cgXXXXXX") 2>/dev/null` && test -n "$tmp" && test -d "$tmp" ; } ||
+ { test -n "$RANDOM" && tmp=$TMPDIR/cg$$-$RANDOM && (umask 077 && mkdir $tmp) ; } ||
+ { tmp=$TMPDIR/cg-$$ && (umask 077 && mkdir $tmp) && echo "Warning: creating insecure temp directory" >&2 ; } ||
+ { echo "$me: cannot create a temporary directory in $TMPDIR" >&2 ; exit 1 ; } ;
+dummy=$tmp/dummy ;
+tmpfiles="$dummy.c $dummy.o $dummy.rel $dummy" ;
+case $CC_FOR_BUILD,$HOST_CC,$CC in
+ ,,)    echo "int x;" > $dummy.c ;
+	for c in cc gcc c89 c99 ; do
+	  if ($c -c -o $dummy.o $dummy.c) >/dev/null 2>&1 ; then
+	     CC_FOR_BUILD="$c"; break ;
+	  fi ;
+	done ;
+	if test x"$CC_FOR_BUILD" = x ; then
+	  CC_FOR_BUILD=no_compiler_found ;
+	fi
+	;;
+ ,,*)   CC_FOR_BUILD=$CC ;;
+ ,*,*)  CC_FOR_BUILD=$HOST_CC ;;
+esac ;'
+
+# This is needed to find uname on a Pyramid OSx when run in the BSD universe.
+# (ghazi at noc.rutgers.edu 1994-08-24)
+if (test -f /.attbin/uname) >/dev/null 2>&1 ; then
+	PATH=$PATH:/.attbin ; export PATH
+fi
+
+UNAME_MACHINE=`(uname -m) 2>/dev/null` || UNAME_MACHINE=unknown
+UNAME_RELEASE=`(uname -r) 2>/dev/null` || UNAME_RELEASE=unknown
+UNAME_SYSTEM=`(uname -s) 2>/dev/null`  || UNAME_SYSTEM=unknown
+UNAME_VERSION=`(uname -v) 2>/dev/null` || UNAME_VERSION=unknown
+
+# Note: order is significant - the case branches are not exclusive.
+
+case "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" in
+    *:NetBSD:*:*)
+	# NetBSD (nbsd) targets should (where applicable) match one or
+	# more of the tupples: *-*-netbsdelf*, *-*-netbsdaout*,
+	# *-*-netbsdecoff* and *-*-netbsd*.  For targets that recently
+	# switched to ELF, *-*-netbsd* would select the old
+	# object file format.  This provides both forward
+	# compatibility and a consistent mechanism for selecting the
+	# object file format.
+	#
+	# Note: NetBSD doesn't particularly care about the vendor
+	# portion of the name.  We always set it to "unknown".
+	sysctl="sysctl -n hw.machine_arch"
+	UNAME_MACHINE_ARCH=`(/sbin/$sysctl 2>/dev/null || \
+	    /usr/sbin/$sysctl 2>/dev/null || echo unknown)`
+	case "${UNAME_MACHINE_ARCH}" in
+	    armeb) machine=armeb-unknown ;;
+	    arm*) machine=arm-unknown ;;
+	    sh3el) machine=shl-unknown ;;
+	    sh3eb) machine=sh-unknown ;;
+	    *) machine=${UNAME_MACHINE_ARCH}-unknown ;;
+	esac
+	# The Operating System including object format, if it has switched
+	# to ELF recently, or will in the future.
+	case "${UNAME_MACHINE_ARCH}" in
+	    arm*|i386|m68k|ns32k|sh3*|sparc|vax)
+		eval $set_cc_for_build
+		if echo __ELF__ | $CC_FOR_BUILD -E - 2>/dev/null \
+			| grep __ELF__ >/dev/null
+		then
+		    # Once all utilities can be ECOFF (netbsdecoff) or a.out (netbsdaout).
+		    # Return netbsd for either.  FIX?
+		    os=netbsd
+		else
+		    os=netbsdelf
+		fi
+		;;
+	    *)
+	        os=netbsd
+		;;
+	esac
+	# The OS release
+	# Debian GNU/NetBSD machines have a different userland, and
+	# thus, need a distinct triplet. However, they do not need
+	# kernel version information, so it can be replaced with a
+	# suitable tag, in the style of linux-gnu.
+	case "${UNAME_VERSION}" in
+	    Debian*)
+		release='-gnu'
+		;;
+	    *)
+		release=`echo ${UNAME_RELEASE}|sed -e 's/[-_].*/\./'`
+		;;
+	esac
+	# Since CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM:
+	# contains redundant information, the shorter form:
+	# CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM is used.
+	echo "${machine}-${os}${release}"
+	exit 0 ;;
+    amd64:OpenBSD:*:*)
+	echo x86_64-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    amiga:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    cats:OpenBSD:*:*)
+	echo arm-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    hp300:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    luna88k:OpenBSD:*:*)
+    	echo m88k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mac68k:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    macppc:OpenBSD:*:*)
+	echo powerpc-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mvme68k:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mvme88k:OpenBSD:*:*)
+	echo m88k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    mvmeppc:OpenBSD:*:*)
+	echo powerpc-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    sgi:OpenBSD:*:*)
+	echo mips64-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    sun3:OpenBSD:*:*)
+	echo m68k-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    *:OpenBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-openbsd${UNAME_RELEASE}
+	exit 0 ;;
+    *:ekkoBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-ekkobsd${UNAME_RELEASE}
+	exit 0 ;;
+    macppc:MirBSD:*:*)
+	echo powerppc-unknown-mirbsd${UNAME_RELEASE}
+	exit 0 ;;
+    *:MirBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-mirbsd${UNAME_RELEASE}
+	exit 0 ;;
+    alpha:OSF1:*:*)
+	case $UNAME_RELEASE in
+	*4.0)
+		UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $3}'`
+		;;
+	*5.*)
+	        UNAME_RELEASE=`/usr/sbin/sizer -v | awk '{print $4}'`
+		;;
+	esac
+	# According to Compaq, /usr/sbin/psrinfo has been available on
+	# OSF/1 and Tru64 systems produced since 1995.  I hope that
+	# covers most systems running today.  This code pipes the CPU
+	# types through head -n 1, so we only detect the type of CPU 0.
+	ALPHA_CPU_TYPE=`/usr/sbin/psrinfo -v | sed -n -e 's/^  The alpha \(.*\) processor.*$/\1/p' | head -n 1`
+	case "$ALPHA_CPU_TYPE" in
+	    "EV4 (21064)")
+		UNAME_MACHINE="alpha" ;;
+	    "EV4.5 (21064)")
+		UNAME_MACHINE="alpha" ;;
+	    "LCA4 (21066/21068)")
+		UNAME_MACHINE="alpha" ;;
+	    "EV5 (21164)")
+		UNAME_MACHINE="alphaev5" ;;
+	    "EV5.6 (21164A)")
+		UNAME_MACHINE="alphaev56" ;;
+	    "EV5.6 (21164PC)")
+		UNAME_MACHINE="alphapca56" ;;
+	    "EV5.7 (21164PC)")
+		UNAME_MACHINE="alphapca57" ;;
+	    "EV6 (21264)")
+		UNAME_MACHINE="alphaev6" ;;
+	    "EV6.7 (21264A)")
+		UNAME_MACHINE="alphaev67" ;;
+	    "EV6.8CB (21264C)")
+		UNAME_MACHINE="alphaev68" ;;
+	    "EV6.8AL (21264B)")
+		UNAME_MACHINE="alphaev68" ;;
+	    "EV6.8CX (21264D)")
+		UNAME_MACHINE="alphaev68" ;;
+	    "EV6.9A (21264/EV69A)")
+		UNAME_MACHINE="alphaev69" ;;
+	    "EV7 (21364)")
+		UNAME_MACHINE="alphaev7" ;;
+	    "EV7.9 (21364A)")
+		UNAME_MACHINE="alphaev79" ;;
+	esac
+	# A Pn.n version is a patched version.
+	# A Vn.n version is a released version.
+	# A Tn.n version is a released field test version.
+	# A Xn.n version is an unreleased experimental baselevel.
+	# 1.2 uses "1.2" for uname -r.
+	echo ${UNAME_MACHINE}-dec-osf`echo ${UNAME_RELEASE} | sed -e 's/^[PVTX]//' | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
+	exit 0 ;;
+    Alpha\ *:Windows_NT*:*)
+	# How do we know it's Interix rather than the generic POSIX subsystem?
+	# Should we change UNAME_MACHINE based on the output of uname instead
+	# of the specific Alpha model?
+	echo alpha-pc-interix
+	exit 0 ;;
+    21064:Windows_NT:50:3)
+	echo alpha-dec-winnt3.5
+	exit 0 ;;
+    Amiga*:UNIX_System_V:4.0:*)
+	echo m68k-unknown-sysv4
+	exit 0;;
+    *:[Aa]miga[Oo][Ss]:*:*)
+	echo ${UNAME_MACHINE}-unknown-amigaos
+	exit 0 ;;
+    *:[Mm]orph[Oo][Ss]:*:*)
+	echo ${UNAME_MACHINE}-unknown-morphos
+	exit 0 ;;
+    *:OS/390:*:*)
+	echo i370-ibm-openedition
+	exit 0 ;;
+    *:z/VM:*:*)
+	echo s390-ibm-zvmoe
+	exit 0 ;;
+    *:OS400:*:*)
+        echo powerpc-ibm-os400
+	exit 0 ;;
+    arm:RISC*:1.[012]*:*|arm:riscix:1.[012]*:*)
+	echo arm-acorn-riscix${UNAME_RELEASE}
+	exit 0;;
+    SR2?01:HI-UX/MPP:*:* | SR8000:HI-UX/MPP:*:*)
+	echo hppa1.1-hitachi-hiuxmpp
+	exit 0;;
+    Pyramid*:OSx*:*:* | MIS*:OSx*:*:* | MIS*:SMP_DC-OSx*:*:*)
+	# akee at wpdis03.wpafb.af.mil (Earle F. Ake) contributed MIS and NILE.
+	if test "`(/bin/universe) 2>/dev/null`" = att ; then
+		echo pyramid-pyramid-sysv3
+	else
+		echo pyramid-pyramid-bsd
+	fi
+	exit 0 ;;
+    NILE*:*:*:dcosx)
+	echo pyramid-pyramid-svr4
+	exit 0 ;;
+    DRS?6000:unix:4.0:6*)
+	echo sparc-icl-nx6
+	exit 0 ;;
+    DRS?6000:UNIX_SV:4.2*:7* | DRS?6000:isis:4.2*:7*)
+	case `/usr/bin/uname -p` in
+	    sparc) echo sparc-icl-nx7 && exit 0 ;;
+	esac ;;
+    sun4H:SunOS:5.*:*)
+	echo sparc-hal-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    sun4*:SunOS:5.*:* | tadpole*:SunOS:5.*:*)
+	echo sparc-sun-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    i86pc:SunOS:5.*:*)
+	echo i386-pc-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    sun4*:SunOS:6*:*)
+	# According to config.sub, this is the proper way to canonicalize
+	# SunOS6.  Hard to guess exactly what SunOS6 will be like, but
+	# it's likely to be more like Solaris than SunOS4.
+	echo sparc-sun-solaris3`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    sun4*:SunOS:*:*)
+	case "`/usr/bin/arch -k`" in
+	    Series*|S4*)
+		UNAME_RELEASE=`uname -v`
+		;;
+	esac
+	# Japanese Language versions have a version number like `4.1.3-JL'.
+	echo sparc-sun-sunos`echo ${UNAME_RELEASE}|sed -e 's/-/_/'`
+	exit 0 ;;
+    sun3*:SunOS:*:*)
+	echo m68k-sun-sunos${UNAME_RELEASE}
+	exit 0 ;;
+    sun*:*:4.2BSD:*)
+	UNAME_RELEASE=`(sed 1q /etc/motd | awk '{print substr($5,1,3)}') 2>/dev/null`
+	test "x${UNAME_RELEASE}" = "x" && UNAME_RELEASE=3
+	case "`/bin/arch`" in
+	    sun3)
+		echo m68k-sun-sunos${UNAME_RELEASE}
+		;;
+	    sun4)
+		echo sparc-sun-sunos${UNAME_RELEASE}
+		;;
+	esac
+	exit 0 ;;
+    aushp:SunOS:*:*)
+	echo sparc-auspex-sunos${UNAME_RELEASE}
+	exit 0 ;;
+    # The situation for MiNT is a little confusing.  The machine name
+    # can be virtually everything (everything which is not
+    # "atarist" or "atariste" at least should have a processor
+    # > m68000).  The system name ranges from "MiNT" over "FreeMiNT"
+    # to the lowercase version "mint" (or "freemint").  Finally
+    # the system name "TOS" denotes a system which is actually not
+    # MiNT.  But MiNT is downward compatible to TOS, so this should
+    # be no problem.
+    atarist[e]:*MiNT:*:* | atarist[e]:*mint:*:* | atarist[e]:*TOS:*:*)
+        echo m68k-atari-mint${UNAME_RELEASE}
+	exit 0 ;;
+    atari*:*MiNT:*:* | atari*:*mint:*:* | atarist[e]:*TOS:*:*)
+	echo m68k-atari-mint${UNAME_RELEASE}
+        exit 0 ;;
+    *falcon*:*MiNT:*:* | *falcon*:*mint:*:* | *falcon*:*TOS:*:*)
+        echo m68k-atari-mint${UNAME_RELEASE}
+	exit 0 ;;
+    milan*:*MiNT:*:* | milan*:*mint:*:* | *milan*:*TOS:*:*)
+        echo m68k-milan-mint${UNAME_RELEASE}
+        exit 0 ;;
+    hades*:*MiNT:*:* | hades*:*mint:*:* | *hades*:*TOS:*:*)
+        echo m68k-hades-mint${UNAME_RELEASE}
+        exit 0 ;;
+    *:*MiNT:*:* | *:*mint:*:* | *:*TOS:*:*)
+        echo m68k-unknown-mint${UNAME_RELEASE}
+        exit 0 ;;
+    m68k:machten:*:*)
+	echo m68k-apple-machten${UNAME_RELEASE}
+	exit 0 ;;
+    powerpc:machten:*:*)
+	echo powerpc-apple-machten${UNAME_RELEASE}
+	exit 0 ;;
+    RISC*:Mach:*:*)
+	echo mips-dec-mach_bsd4.3
+	exit 0 ;;
+    RISC*:ULTRIX:*:*)
+	echo mips-dec-ultrix${UNAME_RELEASE}
+	exit 0 ;;
+    VAX*:ULTRIX*:*:*)
+	echo vax-dec-ultrix${UNAME_RELEASE}
+	exit 0 ;;
+    2020:CLIX:*:* | 2430:CLIX:*:*)
+	echo clipper-intergraph-clix${UNAME_RELEASE}
+	exit 0 ;;
+    mips:*:*:UMIPS | mips:*:*:RISCos)
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+#ifdef __cplusplus
+#include <stdio.h>  /* for printf() prototype */
+	int main (int argc, char *argv[]) {
+#else
+	int main (argc, argv) int argc; char *argv[]; {
+#endif
+	#if defined (host_mips) && defined (MIPSEB)
+	#if defined (SYSTYPE_SYSV)
+	  printf ("mips-mips-riscos%ssysv\n", argv[1]); exit (0);
+	#endif
+	#if defined (SYSTYPE_SVR4)
+	  printf ("mips-mips-riscos%ssvr4\n", argv[1]); exit (0);
+	#endif
+	#if defined (SYSTYPE_BSD43) || defined(SYSTYPE_BSD)
+	  printf ("mips-mips-riscos%sbsd\n", argv[1]); exit (0);
+	#endif
+	#endif
+	  exit (-1);
+	}
+EOF
+	$CC_FOR_BUILD -o $dummy $dummy.c \
+	  && $dummy `echo "${UNAME_RELEASE}" | sed -n 's/\([0-9]*\).*/\1/p'` \
+	  && exit 0
+	echo mips-mips-riscos${UNAME_RELEASE}
+	exit 0 ;;
+    Motorola:PowerMAX_OS:*:*)
+	echo powerpc-motorola-powermax
+	exit 0 ;;
+    Motorola:*:4.3:PL8-*)
+	echo powerpc-harris-powermax
+	exit 0 ;;
+    Night_Hawk:*:*:PowerMAX_OS | Synergy:PowerMAX_OS:*:*)
+	echo powerpc-harris-powermax
+	exit 0 ;;
+    Night_Hawk:Power_UNIX:*:*)
+	echo powerpc-harris-powerunix
+	exit 0 ;;
+    m88k:CX/UX:7*:*)
+	echo m88k-harris-cxux7
+	exit 0 ;;
+    m88k:*:4*:R4*)
+	echo m88k-motorola-sysv4
+	exit 0 ;;
+    m88k:*:3*:R3*)
+	echo m88k-motorola-sysv3
+	exit 0 ;;
+    AViiON:dgux:*:*)
+        # DG/UX returns AViiON for all architectures
+        UNAME_PROCESSOR=`/usr/bin/uname -p`
+	if [ $UNAME_PROCESSOR = mc88100 ] || [ $UNAME_PROCESSOR = mc88110 ]
+	then
+	    if [ ${TARGET_BINARY_INTERFACE}x = m88kdguxelfx ] || \
+	       [ ${TARGET_BINARY_INTERFACE}x = x ]
+	    then
+		echo m88k-dg-dgux${UNAME_RELEASE}
+	    else
+		echo m88k-dg-dguxbcs${UNAME_RELEASE}
+	    fi
+	else
+	    echo i586-dg-dgux${UNAME_RELEASE}
+	fi
+ 	exit 0 ;;
+    M88*:DolphinOS:*:*)	# DolphinOS (SVR3)
+	echo m88k-dolphin-sysv3
+	exit 0 ;;
+    M88*:*:R3*:*)
+	# Delta 88k system running SVR3
+	echo m88k-motorola-sysv3
+	exit 0 ;;
+    XD88*:*:*:*) # Tektronix XD88 system running UTekV (SVR3)
+	echo m88k-tektronix-sysv3
+	exit 0 ;;
+    Tek43[0-9][0-9]:UTek:*:*) # Tektronix 4300 system running UTek (BSD)
+	echo m68k-tektronix-bsd
+	exit 0 ;;
+    *:IRIX*:*:*)
+	echo mips-sgi-irix`echo ${UNAME_RELEASE}|sed -e 's/-/_/g'`
+	exit 0 ;;
+    ????????:AIX?:[12].1:2)   # AIX 2.2.1 or AIX 2.1.1 is RT/PC AIX.
+	echo romp-ibm-aix      # uname -m gives an 8 hex-code CPU id
+	exit 0 ;;              # Note that: echo "'`uname -s`'" gives 'AIX '
+    i*86:AIX:*:*)
+	echo i386-ibm-aix
+	exit 0 ;;
+    ia64:AIX:*:*)
+	if [ -x /usr/bin/oslevel ] ; then
+		IBM_REV=`/usr/bin/oslevel`
+	else
+		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
+	fi
+	echo ${UNAME_MACHINE}-ibm-aix${IBM_REV}
+	exit 0 ;;
+    *:AIX:2:3)
+	if grep bos325 /usr/include/stdio.h >/dev/null 2>&1; then
+		eval $set_cc_for_build
+		sed 's/^		//' << EOF >$dummy.c
+		#include <sys/systemcfg.h>
+
+		main()
+			{
+			if (!__power_pc())
+				exit(1);
+			puts("powerpc-ibm-aix3.2.5");
+			exit(0);
+			}
+EOF
+		$CC_FOR_BUILD -o $dummy $dummy.c && $dummy && exit 0
+		echo rs6000-ibm-aix3.2.5
+	elif grep bos324 /usr/include/stdio.h >/dev/null 2>&1; then
+		echo rs6000-ibm-aix3.2.4
+	else
+		echo rs6000-ibm-aix3.2
+	fi
+	exit 0 ;;
+    *:AIX:*:[45])
+	IBM_CPU_ID=`/usr/sbin/lsdev -C -c processor -S available | sed 1q | awk '{ print $1 }'`
+	if /usr/sbin/lsattr -El ${IBM_CPU_ID} | grep ' POWER' >/dev/null 2>&1; then
+		IBM_ARCH=rs6000
+	else
+		IBM_ARCH=powerpc
+	fi
+	if [ -x /usr/bin/oslevel ] ; then
+		IBM_REV=`/usr/bin/oslevel`
+	else
+		IBM_REV=${UNAME_VERSION}.${UNAME_RELEASE}
+	fi
+	echo ${IBM_ARCH}-ibm-aix${IBM_REV}
+	exit 0 ;;
+    *:AIX:*:*)
+	echo rs6000-ibm-aix
+	exit 0 ;;
+    ibmrt:4.4BSD:*|romp-ibm:BSD:*)
+	echo romp-ibm-bsd4.4
+	exit 0 ;;
+    ibmrt:*BSD:*|romp-ibm:BSD:*)            # covers RT/PC BSD and
+	echo romp-ibm-bsd${UNAME_RELEASE}   # 4.3 with uname added to
+	exit 0 ;;                           # report: romp-ibm BSD 4.3
+    *:BOSX:*:*)
+	echo rs6000-bull-bosx
+	exit 0 ;;
+    DPX/2?00:B.O.S.:*:*)
+	echo m68k-bull-sysv3
+	exit 0 ;;
+    9000/[34]??:4.3bsd:1.*:*)
+	echo m68k-hp-bsd
+	exit 0 ;;
+    hp300:4.4BSD:*:* | 9000/[34]??:4.3bsd:2.*:*)
+	echo m68k-hp-bsd4.4
+	exit 0 ;;
+    9000/[34678]??:HP-UX:*:*)
+	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
+	case "${UNAME_MACHINE}" in
+	    9000/31? )            HP_ARCH=m68000 ;;
+	    9000/[34]?? )         HP_ARCH=m68k ;;
+	    9000/[678][0-9][0-9])
+		if [ -x /usr/bin/getconf ]; then
+		    sc_cpu_version=`/usr/bin/getconf SC_CPU_VERSION 2>/dev/null`
+                    sc_kernel_bits=`/usr/bin/getconf SC_KERNEL_BITS 2>/dev/null`
+                    case "${sc_cpu_version}" in
+                      523) HP_ARCH="hppa1.0" ;; # CPU_PA_RISC1_0
+                      528) HP_ARCH="hppa1.1" ;; # CPU_PA_RISC1_1
+                      532)                      # CPU_PA_RISC2_0
+                        case "${sc_kernel_bits}" in
+                          32) HP_ARCH="hppa2.0n" ;;
+                          64) HP_ARCH="hppa2.0w" ;;
+			  '') HP_ARCH="hppa2.0" ;;   # HP-UX 10.20
+                        esac ;;
+                    esac
+		fi
+		if [ "${HP_ARCH}" = "" ]; then
+		    eval $set_cc_for_build
+		    sed 's/^              //' << EOF >$dummy.c
+
+              #define _HPUX_SOURCE
+              #include <stdlib.h>
+              #include <unistd.h>
+
+              int main ()
+              {
+              #if defined(_SC_KERNEL_BITS)
+                  long bits = sysconf(_SC_KERNEL_BITS);
+              #endif
+                  long cpu  = sysconf (_SC_CPU_VERSION);
+
+                  switch (cpu)
+              	{
+              	case CPU_PA_RISC1_0: puts ("hppa1.0"); break;
+              	case CPU_PA_RISC1_1: puts ("hppa1.1"); break;
+              	case CPU_PA_RISC2_0:
+              #if defined(_SC_KERNEL_BITS)
+              	    switch (bits)
+              		{
+              		case 64: puts ("hppa2.0w"); break;
+              		case 32: puts ("hppa2.0n"); break;
+              		default: puts ("hppa2.0"); break;
+              		} break;
+              #else  /* !defined(_SC_KERNEL_BITS) */
+              	    puts ("hppa2.0"); break;
+              #endif
+              	default: puts ("hppa1.0"); break;
+              	}
+                  exit (0);
+              }
+EOF
+		    (CCOPTS= $CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null) && HP_ARCH=`$dummy`
+		    test -z "$HP_ARCH" && HP_ARCH=hppa
+		fi ;;
+	esac
+	if [ ${HP_ARCH} = "hppa2.0w" ]
+	then
+	    # avoid double evaluation of $set_cc_for_build
+	    test -n "$CC_FOR_BUILD" || eval $set_cc_for_build
+	    if echo __LP64__ | (CCOPTS= $CC_FOR_BUILD -E -) | grep __LP64__ >/dev/null
+	    then
+		HP_ARCH="hppa2.0w"
+	    else
+		HP_ARCH="hppa64"
+	    fi
+	fi
+	echo ${HP_ARCH}-hp-hpux${HPUX_REV}
+	exit 0 ;;
+    ia64:HP-UX:*:*)
+	HPUX_REV=`echo ${UNAME_RELEASE}|sed -e 's/[^.]*.[0B]*//'`
+	echo ia64-hp-hpux${HPUX_REV}
+	exit 0 ;;
+    3050*:HI-UX:*:*)
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#include <unistd.h>
+	int
+	main ()
+	{
+	  long cpu = sysconf (_SC_CPU_VERSION);
+	  /* The order matters, because CPU_IS_HP_MC68K erroneously returns
+	     true for CPU_PA_RISC1_0.  CPU_IS_PA_RISC returns correct
+	     results, however.  */
+	  if (CPU_IS_PA_RISC (cpu))
+	    {
+	      switch (cpu)
+		{
+		  case CPU_PA_RISC1_0: puts ("hppa1.0-hitachi-hiuxwe2"); break;
+		  case CPU_PA_RISC1_1: puts ("hppa1.1-hitachi-hiuxwe2"); break;
+		  case CPU_PA_RISC2_0: puts ("hppa2.0-hitachi-hiuxwe2"); break;
+		  default: puts ("hppa-hitachi-hiuxwe2"); break;
+		}
+	    }
+	  else if (CPU_IS_HP_MC68K (cpu))
+	    puts ("m68k-hitachi-hiuxwe2");
+	  else puts ("unknown-hitachi-hiuxwe2");
+	  exit (0);
+	}
+EOF
+	$CC_FOR_BUILD -o $dummy $dummy.c && $dummy && exit 0
+	echo unknown-hitachi-hiuxwe2
+	exit 0 ;;
+    9000/7??:4.3bsd:*:* | 9000/8?[79]:4.3bsd:*:* )
+	echo hppa1.1-hp-bsd
+	exit 0 ;;
+    9000/8??:4.3bsd:*:*)
+	echo hppa1.0-hp-bsd
+	exit 0 ;;
+    *9??*:MPE/iX:*:* | *3000*:MPE/iX:*:*)
+	echo hppa1.0-hp-mpeix
+	exit 0 ;;
+    hp7??:OSF1:*:* | hp8?[79]:OSF1:*:* )
+	echo hppa1.1-hp-osf
+	exit 0 ;;
+    hp8??:OSF1:*:*)
+	echo hppa1.0-hp-osf
+	exit 0 ;;
+    i*86:OSF1:*:*)
+	if [ -x /usr/sbin/sysversion ] ; then
+	    echo ${UNAME_MACHINE}-unknown-osf1mk
+	else
+	    echo ${UNAME_MACHINE}-unknown-osf1
+	fi
+	exit 0 ;;
+    parisc*:Lites*:*:*)
+	echo hppa1.1-hp-lites
+	exit 0 ;;
+    C1*:ConvexOS:*:* | convex:ConvexOS:C1*:*)
+	echo c1-convex-bsd
+        exit 0 ;;
+    C2*:ConvexOS:*:* | convex:ConvexOS:C2*:*)
+	if getsysinfo -f scalar_acc
+	then echo c32-convex-bsd
+	else echo c2-convex-bsd
+	fi
+        exit 0 ;;
+    C34*:ConvexOS:*:* | convex:ConvexOS:C34*:*)
+	echo c34-convex-bsd
+        exit 0 ;;
+    C38*:ConvexOS:*:* | convex:ConvexOS:C38*:*)
+	echo c38-convex-bsd
+        exit 0 ;;
+    C4*:ConvexOS:*:* | convex:ConvexOS:C4*:*)
+	echo c4-convex-bsd
+        exit 0 ;;
+    CRAY*Y-MP:*:*:*)
+	echo ymp-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*[A-Z]90:*:*:*)
+	echo ${UNAME_MACHINE}-cray-unicos${UNAME_RELEASE} \
+	| sed -e 's/CRAY.*\([A-Z]90\)/\1/' \
+	      -e y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/ \
+	      -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*TS:*:*:*)
+	echo t90-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*T3E:*:*:*)
+	echo alphaev5-cray-unicosmk${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    CRAY*SV1:*:*:*)
+	echo sv1-cray-unicos${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    *:UNICOS/mp:*:*)
+	echo craynv-cray-unicosmp${UNAME_RELEASE} | sed -e 's/\.[^.]*$/.X/'
+	exit 0 ;;
+    F30[01]:UNIX_System_V:*:* | F700:UNIX_System_V:*:*)
+	FUJITSU_PROC=`uname -m | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz'`
+        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+        FUJITSU_REL=`echo ${UNAME_RELEASE} | sed -e 's/ /_/'`
+        echo "${FUJITSU_PROC}-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+        exit 0 ;;
+    5000:UNIX_System_V:4.*:*)
+        FUJITSU_SYS=`uname -p | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/\///'`
+        FUJITSU_REL=`echo ${UNAME_RELEASE} | tr 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' 'abcdefghijklmnopqrstuvwxyz' | sed -e 's/ /_/'`
+        echo "sparc-fujitsu-${FUJITSU_SYS}${FUJITSU_REL}"
+	exit 0 ;;
+    i*86:BSD/386:*:* | i*86:BSD/OS:*:* | *:Ascend\ Embedded/OS:*:*)
+	echo ${UNAME_MACHINE}-pc-bsdi${UNAME_RELEASE}
+	exit 0 ;;
+    sparc*:BSD/OS:*:*)
+	echo sparc-unknown-bsdi${UNAME_RELEASE}
+	exit 0 ;;
+    *:BSD/OS:*:*)
+	echo ${UNAME_MACHINE}-unknown-bsdi${UNAME_RELEASE}
+	exit 0 ;;
+    *:FreeBSD:*:*)
+	echo ${UNAME_MACHINE}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
+	exit 0 ;;
+    i*:CYGWIN*:*)
+	echo ${UNAME_MACHINE}-pc-cygwin
+	exit 0 ;;
+    i*:MINGW*:*)
+	echo ${UNAME_MACHINE}-pc-mingw32
+	exit 0 ;;
+    i*:PW*:*)
+	echo ${UNAME_MACHINE}-pc-pw32
+	exit 0 ;;
+    x86:Interix*:[34]*)
+	echo i586-pc-interix${UNAME_RELEASE}|sed -e 's/\..*//'
+	exit 0 ;;
+    [345]86:Windows_95:* | [345]86:Windows_98:* | [345]86:Windows_NT:*)
+	echo i${UNAME_MACHINE}-pc-mks
+	exit 0 ;;
+    i*:Windows_NT*:* | Pentium*:Windows_NT*:*)
+	# How do we know it's Interix rather than the generic POSIX subsystem?
+	# It also conflicts with pre-2.0 versions of AT&T UWIN. Should we
+	# UNAME_MACHINE based on the output of uname instead of i386?
+	echo i586-pc-interix
+	exit 0 ;;
+    i*:UWIN*:*)
+	echo ${UNAME_MACHINE}-pc-uwin
+	exit 0 ;;
+    p*:CYGWIN*:*)
+	echo powerpcle-unknown-cygwin
+	exit 0 ;;
+    prep*:SunOS:5.*:*)
+	echo powerpcle-unknown-solaris2`echo ${UNAME_RELEASE}|sed -e 's/[^.]*//'`
+	exit 0 ;;
+    *:GNU:*:*)
+	# the GNU system
+	echo `echo ${UNAME_MACHINE}|sed -e 's,[-/].*$,,'`-unknown-gnu`echo ${UNAME_RELEASE}|sed -e 's,/.*$,,'`
+	exit 0 ;;
+    *:GNU/*:*:*)
+	# other systems with GNU libc and userland
+	echo ${UNAME_MACHINE}-unknown-`echo ${UNAME_SYSTEM} | sed 's,^[^/]*/,,' | tr '[A-Z]' '[a-z]'``echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`-gnu
+	exit 0 ;;
+    i*86:Minix:*:*)
+	echo ${UNAME_MACHINE}-pc-minix
+	exit 0 ;;
+    arm*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    cris:Linux:*:*)
+	echo cris-axis-linux-gnu
+	exit 0 ;;
+    crisv32:Linux:*:*)
+	echo crisv32-axis-linux-gnu
+	exit 0 ;;
+    frv:Linux:*:*)
+    	echo frv-unknown-linux-gnu
+	exit 0 ;;
+    ia64:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    m32r*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    m68*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    mips:Linux:*:*)
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#undef CPU
+	#undef mips
+	#undef mipsel
+	#if defined(__MIPSEL__) || defined(__MIPSEL) || defined(_MIPSEL) || defined(MIPSEL)
+	CPU=mipsel
+	#else
+	#if defined(__MIPSEB__) || defined(__MIPSEB) || defined(_MIPSEB) || defined(MIPSEB)
+	CPU=mips
+	#else
+	CPU=
+	#endif
+	#endif
+EOF
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^CPU=`
+	test x"${CPU}" != x && echo "${CPU}-unknown-linux-gnu" && exit 0
+	;;
+    mips64:Linux:*:*)
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#undef CPU
+	#undef mips64
+	#undef mips64el
+	#if defined(__MIPSEL__) || defined(__MIPSEL) || defined(_MIPSEL) || defined(MIPSEL)
+	CPU=mips64el
+	#else
+	#if defined(__MIPSEB__) || defined(__MIPSEB) || defined(_MIPSEB) || defined(MIPSEB)
+	CPU=mips64
+	#else
+	CPU=
+	#endif
+	#endif
+EOF
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^CPU=`
+	test x"${CPU}" != x && echo "${CPU}-unknown-linux-gnu" && exit 0
+	;;
+    ppc:Linux:*:*)
+	echo powerpc-unknown-linux-gnu
+	exit 0 ;;
+    ppc64:Linux:*:*)
+	echo powerpc64-unknown-linux-gnu
+	exit 0 ;;
+    alpha:Linux:*:*)
+	case `sed -n '/^cpu model/s/^.*: \(.*\)/\1/p' < /proc/cpuinfo` in
+	  EV5)   UNAME_MACHINE=alphaev5 ;;
+	  EV56)  UNAME_MACHINE=alphaev56 ;;
+	  PCA56) UNAME_MACHINE=alphapca56 ;;
+	  PCA57) UNAME_MACHINE=alphapca56 ;;
+	  EV6)   UNAME_MACHINE=alphaev6 ;;
+	  EV67)  UNAME_MACHINE=alphaev67 ;;
+	  EV68*) UNAME_MACHINE=alphaev68 ;;
+        esac
+	objdump --private-headers /bin/sh | grep ld.so.1 >/dev/null
+	if test "$?" = 0 ; then LIBC="libc1" ; else LIBC="" ; fi
+	echo ${UNAME_MACHINE}-unknown-linux-gnu${LIBC}
+	exit 0 ;;
+    parisc:Linux:*:* | hppa:Linux:*:*)
+	# Look for CPU level
+	case `grep '^cpu[^a-z]*:' /proc/cpuinfo 2>/dev/null | cut -d' ' -f2` in
+	  PA7*) echo hppa1.1-unknown-linux-gnu ;;
+	  PA8*) echo hppa2.0-unknown-linux-gnu ;;
+	  *)    echo hppa-unknown-linux-gnu ;;
+	esac
+	exit 0 ;;
+    parisc64:Linux:*:* | hppa64:Linux:*:*)
+	echo hppa64-unknown-linux-gnu
+	exit 0 ;;
+    s390:Linux:*:* | s390x:Linux:*:*)
+	echo ${UNAME_MACHINE}-ibm-linux
+	exit 0 ;;
+    sh64*:Linux:*:*)
+    	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    sh*:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    sparc:Linux:*:* | sparc64:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-gnu
+	exit 0 ;;
+    x86_64:Linux:*:*)
+	echo x86_64-unknown-linux-gnu
+	exit 0 ;;
+    i*86:Linux:*:*)
+	# The BFD linker knows what the default object file format is, so
+	# first see if it will tell us. cd to the root directory to prevent
+	# problems with other programs or directories called `ld' in the path.
+	# Set LC_ALL=C to ensure ld outputs messages in English.
+	ld_supported_targets=`cd /; LC_ALL=C ld --help 2>&1 \
+			 | sed -ne '/supported targets:/!d
+				    s/[ 	][ 	]*/ /g
+				    s/.*supported targets: *//
+				    s/ .*//
+				    p'`
+        case "$ld_supported_targets" in
+	  elf32-i386)
+		TENTATIVE="${UNAME_MACHINE}-pc-linux-gnu"
+		;;
+	  a.out-i386-linux)
+		echo "${UNAME_MACHINE}-pc-linux-gnuaout"
+		exit 0 ;;
+	  coff-i386)
+		echo "${UNAME_MACHINE}-pc-linux-gnucoff"
+		exit 0 ;;
+	  "")
+		# Either a pre-BFD a.out linker (linux-gnuoldld) or
+		# one that does not give us useful --help.
+		echo "${UNAME_MACHINE}-pc-linux-gnuoldld"
+		exit 0 ;;
+	esac
+	# Determine whether the default compiler is a.out or elf
+	eval $set_cc_for_build
+	sed 's/^	//' << EOF >$dummy.c
+	#include <features.h>
+	#ifdef __ELF__
+	# ifdef __GLIBC__
+	#  if __GLIBC__ >= 2
+	LIBC=gnu
+	#  else
+	LIBC=gnulibc1
+	#  endif
+	# else
+	LIBC=gnulibc1
+	# endif
+	#else
+	#ifdef __INTEL_COMPILER
+	LIBC=gnu
+	#else
+	LIBC=gnuaout
+	#endif
+	#endif
+	#ifdef __dietlibc__
+	LIBC=dietlibc
+	#endif
+EOF
+	eval `$CC_FOR_BUILD -E $dummy.c 2>/dev/null | grep ^LIBC=`
+	test x"${LIBC}" != x && echo "${UNAME_MACHINE}-pc-linux-${LIBC}" && exit 0
+	test x"${TENTATIVE}" != x && echo "${TENTATIVE}" && exit 0
+	;;
+    i*86:DYNIX/ptx:4*:*)
+	# ptx 4.0 does uname -s correctly, with DYNIX/ptx in there.
+	# earlier versions are messed up and put the nodename in both
+	# sysname and nodename.
+	echo i386-sequent-sysv4
+	exit 0 ;;
+    i*86:UNIX_SV:4.2MP:2.*)
+        # Unixware is an offshoot of SVR4, but it has its own version
+        # number series starting with 2...
+        # I am not positive that other SVR4 systems won't match this,
+	# I just have to hope.  -- rms.
+        # Use sysv4.2uw... so that sysv4* matches it.
+	echo ${UNAME_MACHINE}-pc-sysv4.2uw${UNAME_VERSION}
+	exit 0 ;;
+    i*86:OS/2:*:*)
+	# If we were able to find `uname', then EMX Unix compatibility
+	# is probably installed.
+	echo ${UNAME_MACHINE}-pc-os2-emx
+	exit 0 ;;
+    i*86:XTS-300:*:STOP)
+	echo ${UNAME_MACHINE}-unknown-stop
+	exit 0 ;;
+    i*86:atheos:*:*)
+	echo ${UNAME_MACHINE}-unknown-atheos
+	exit 0 ;;
+	i*86:syllable:*:*)
+	echo ${UNAME_MACHINE}-pc-syllable
+	exit 0 ;;
+    i*86:LynxOS:2.*:* | i*86:LynxOS:3.[01]*:* | i*86:LynxOS:4.0*:*)
+	echo i386-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    i*86:*DOS:*:*)
+	echo ${UNAME_MACHINE}-pc-msdosdjgpp
+	exit 0 ;;
+    i*86:*:4.*:* | i*86:SYSTEM_V:4.*:*)
+	UNAME_REL=`echo ${UNAME_RELEASE} | sed 's/\/MP$//'`
+	if grep Novell /usr/include/link.h >/dev/null 2>/dev/null; then
+		echo ${UNAME_MACHINE}-univel-sysv${UNAME_REL}
+	else
+		echo ${UNAME_MACHINE}-pc-sysv${UNAME_REL}
+	fi
+	exit 0 ;;
+    i*86:*:5:[78]*)
+	case `/bin/uname -X | grep "^Machine"` in
+	    *486*)	     UNAME_MACHINE=i486 ;;
+	    *Pentium)	     UNAME_MACHINE=i586 ;;
+	    *Pent*|*Celeron) UNAME_MACHINE=i686 ;;
+	esac
+	echo ${UNAME_MACHINE}-unknown-sysv${UNAME_RELEASE}${UNAME_SYSTEM}${UNAME_VERSION}
+	exit 0 ;;
+    i*86:*:3.2:*)
+	if test -f /usr/options/cb.name; then
+		UNAME_REL=`sed -n 's/.*Version //p' </usr/options/cb.name`
+		echo ${UNAME_MACHINE}-pc-isc$UNAME_REL
+	elif /bin/uname -X 2>/dev/null >/dev/null ; then
+		UNAME_REL=`(/bin/uname -X|grep Release|sed -e 's/.*= //')`
+		(/bin/uname -X|grep i80486 >/dev/null) && UNAME_MACHINE=i486
+		(/bin/uname -X|grep '^Machine.*Pentium' >/dev/null) \
+			&& UNAME_MACHINE=i586
+		(/bin/uname -X|grep '^Machine.*Pent *II' >/dev/null) \
+			&& UNAME_MACHINE=i686
+		(/bin/uname -X|grep '^Machine.*Pentium Pro' >/dev/null) \
+			&& UNAME_MACHINE=i686
+		echo ${UNAME_MACHINE}-pc-sco$UNAME_REL
+	else
+		echo ${UNAME_MACHINE}-pc-sysv32
+	fi
+	exit 0 ;;
+    pc:*:*:*)
+	# Left here for compatibility:
+        # uname -m prints for DJGPP always 'pc', but it prints nothing about
+        # the processor, so we play safe by assuming i386.
+	echo i386-pc-msdosdjgpp
+        exit 0 ;;
+    Intel:Mach:3*:*)
+	echo i386-pc-mach3
+	exit 0 ;;
+    paragon:*:*:*)
+	echo i860-intel-osf1
+	exit 0 ;;
+    i860:*:4.*:*) # i860-SVR4
+	if grep Stardent /usr/include/sys/uadmin.h >/dev/null 2>&1 ; then
+	  echo i860-stardent-sysv${UNAME_RELEASE} # Stardent Vistra i860-SVR4
+	else # Add other i860-SVR4 vendors below as they are discovered.
+	  echo i860-unknown-sysv${UNAME_RELEASE}  # Unknown i860-SVR4
+	fi
+	exit 0 ;;
+    mini*:CTIX:SYS*5:*)
+	# "miniframe"
+	echo m68010-convergent-sysv
+	exit 0 ;;
+    mc68k:UNIX:SYSTEM5:3.51m)
+	echo m68k-convergent-sysv
+	exit 0 ;;
+    M680?0:D-NIX:5.3:*)
+	echo m68k-diab-dnix
+	exit 0 ;;
+    M68*:*:R3V[5678]*:*)
+	test -r /sysV68 && echo 'm68k-motorola-sysv' && exit 0 ;;
+    3[345]??:*:4.0:3.0 | 3[34]??A:*:4.0:3.0 | 3[34]??,*:*:4.0:3.0 | 3[34]??/*:*:4.0:3.0 | 4400:*:4.0:3.0 | 4850:*:4.0:3.0 | SKA40:*:4.0:3.0 | SDS2:*:4.0:3.0 | SHG2:*:4.0:3.0 | S7501*:*:4.0:3.0)
+	OS_REL=''
+	test -r /etc/.relid \
+	&& OS_REL=.`sed -n 's/[^ ]* [^ ]* \([0-9][0-9]\).*/\1/p' < /etc/.relid`
+	/bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+	  && echo i486-ncr-sysv4.3${OS_REL} && exit 0
+	/bin/uname -p 2>/dev/null | /bin/grep entium >/dev/null \
+	  && echo i586-ncr-sysv4.3${OS_REL} && exit 0 ;;
+    3[34]??:*:4.0:* | 3[34]??,*:*:4.0:*)
+        /bin/uname -p 2>/dev/null | grep 86 >/dev/null \
+          && echo i486-ncr-sysv4 && exit 0 ;;
+    m68*:LynxOS:2.*:* | m68*:LynxOS:3.0*:*)
+	echo m68k-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    mc68030:UNIX_System_V:4.*:*)
+	echo m68k-atari-sysv4
+	exit 0 ;;
+    TSUNAMI:LynxOS:2.*:*)
+	echo sparc-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    rs6000:LynxOS:2.*:*)
+	echo rs6000-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    PowerPC:LynxOS:2.*:* | PowerPC:LynxOS:3.[01]*:* | PowerPC:LynxOS:4.0*:*)
+	echo powerpc-unknown-lynxos${UNAME_RELEASE}
+	exit 0 ;;
+    SM[BE]S:UNIX_SV:*:*)
+	echo mips-dde-sysv${UNAME_RELEASE}
+	exit 0 ;;
+    RM*:ReliantUNIX-*:*:*)
+	echo mips-sni-sysv4
+	exit 0 ;;
+    RM*:SINIX-*:*:*)
+	echo mips-sni-sysv4
+	exit 0 ;;
+    *:SINIX-*:*:*)
+	if uname -p 2>/dev/null >/dev/null ; then
+		UNAME_MACHINE=`(uname -p) 2>/dev/null`
+		echo ${UNAME_MACHINE}-sni-sysv4
+	else
+		echo ns32k-sni-sysv
+	fi
+	exit 0 ;;
+    PENTIUM:*:4.0*:*) # Unisys `ClearPath HMP IX 4000' SVR4/MP effort
+                      # says <Richard.M.Bartel at ccMail.Census.GOV>
+        echo i586-unisys-sysv4
+        exit 0 ;;
+    *:UNIX_System_V:4*:FTX*)
+	# From Gerald Hewes <hewes at openmarket.com>.
+	# How about differentiating between stratus architectures? -djm
+	echo hppa1.1-stratus-sysv4
+	exit 0 ;;
+    *:*:*:FTX*)
+	# From seanf at swdc.stratus.com.
+	echo i860-stratus-sysv4
+	exit 0 ;;
+    *:VOS:*:*)
+	# From Paul.Green at stratus.com.
+	echo hppa1.1-stratus-vos
+	exit 0 ;;
+    mc68*:A/UX:*:*)
+	echo m68k-apple-aux${UNAME_RELEASE}
+	exit 0 ;;
+    news*:NEWS-OS:6*:*)
+	echo mips-sony-newsos6
+	exit 0 ;;
+    R[34]000:*System_V*:*:* | R4000:UNIX_SYSV:*:* | R*000:UNIX_SV:*:*)
+	if [ -d /usr/nec ]; then
+	        echo mips-nec-sysv${UNAME_RELEASE}
+	else
+	        echo mips-unknown-sysv${UNAME_RELEASE}
+	fi
+        exit 0 ;;
+    BeBox:BeOS:*:*)	# BeOS running on hardware made by Be, PPC only.
+	echo powerpc-be-beos
+	exit 0 ;;
+    BeMac:BeOS:*:*)	# BeOS running on Mac or Mac clone, PPC only.
+	echo powerpc-apple-beos
+	exit 0 ;;
+    BePC:BeOS:*:*)	# BeOS running on Intel PC compatible.
+	echo i586-pc-beos
+	exit 0 ;;
+    SX-4:SUPER-UX:*:*)
+	echo sx4-nec-superux${UNAME_RELEASE}
+	exit 0 ;;
+    SX-5:SUPER-UX:*:*)
+	echo sx5-nec-superux${UNAME_RELEASE}
+	exit 0 ;;
+    SX-6:SUPER-UX:*:*)
+	echo sx6-nec-superux${UNAME_RELEASE}
+	exit 0 ;;
+    Power*:Rhapsody:*:*)
+	echo powerpc-apple-rhapsody${UNAME_RELEASE}
+	exit 0 ;;
+    *:Rhapsody:*:*)
+	echo ${UNAME_MACHINE}-apple-rhapsody${UNAME_RELEASE}
+	exit 0 ;;
+    *:Darwin:*:*)
+	UNAME_PROCESSOR=`uname -p` || UNAME_PROCESSOR=unknown
+	case $UNAME_PROCESSOR in
+	    *86) UNAME_PROCESSOR=i686 ;;
+	    unknown) UNAME_PROCESSOR=powerpc ;;
+	esac
+	echo ${UNAME_PROCESSOR}-apple-darwin${UNAME_RELEASE}
+	exit 0 ;;
+    *:procnto*:*:* | *:QNX:[0123456789]*:*)
+	UNAME_PROCESSOR=`uname -p`
+	if test "$UNAME_PROCESSOR" = "x86"; then
+		UNAME_PROCESSOR=i386
+		UNAME_MACHINE=pc
+	fi
+	echo ${UNAME_PROCESSOR}-${UNAME_MACHINE}-nto-qnx${UNAME_RELEASE}
+	exit 0 ;;
+    *:QNX:*:4*)
+	echo i386-pc-qnx
+	exit 0 ;;
+    NSR-?:NONSTOP_KERNEL:*:*)
+	echo nsr-tandem-nsk${UNAME_RELEASE}
+	exit 0 ;;
+    *:NonStop-UX:*:*)
+	echo mips-compaq-nonstopux
+	exit 0 ;;
+    BS2000:POSIX*:*:*)
+	echo bs2000-siemens-sysv
+	exit 0 ;;
+    DS/*:UNIX_System_V:*:*)
+	echo ${UNAME_MACHINE}-${UNAME_SYSTEM}-${UNAME_RELEASE}
+	exit 0 ;;
+    *:Plan9:*:*)
+	# "uname -m" is not consistent, so use $cputype instead. 386
+	# is converted to i386 for consistency with other x86
+	# operating systems.
+	if test "$cputype" = "386"; then
+	    UNAME_MACHINE=i386
+	else
+	    UNAME_MACHINE="$cputype"
+	fi
+	echo ${UNAME_MACHINE}-unknown-plan9
+	exit 0 ;;
+    *:TOPS-10:*:*)
+	echo pdp10-unknown-tops10
+	exit 0 ;;
+    *:TENEX:*:*)
+	echo pdp10-unknown-tenex
+	exit 0 ;;
+    KS10:TOPS-20:*:* | KL10:TOPS-20:*:* | TYPE4:TOPS-20:*:*)
+	echo pdp10-dec-tops20
+	exit 0 ;;
+    XKL-1:TOPS-20:*:* | TYPE5:TOPS-20:*:*)
+	echo pdp10-xkl-tops20
+	exit 0 ;;
+    *:TOPS-20:*:*)
+	echo pdp10-unknown-tops20
+	exit 0 ;;
+    *:ITS:*:*)
+	echo pdp10-unknown-its
+	exit 0 ;;
+    SEI:*:*:SEIUX)
+        echo mips-sei-seiux${UNAME_RELEASE}
+	exit 0 ;;
+    *:DragonFly:*:*)
+	echo ${UNAME_MACHINE}-unknown-dragonfly`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
+	exit 0 ;;
+    *:*VMS:*:*)
+    	UNAME_MACHINE=`(uname -p) 2>/dev/null`
+	case "${UNAME_MACHINE}" in
+	    A*) echo alpha-dec-vms && exit 0 ;;
+	    I*) echo ia64-dec-vms && exit 0 ;;
+	    V*) echo vax-dec-vms && exit 0 ;;
+	esac ;;
+    *:XENIX:*:SysV)
+	echo i386-pc-xenix
+	exit 0 ;;
+esac
+
+#echo '(No uname command or uname output not recognized.)' 1>&2
+#echo "${UNAME_MACHINE}:${UNAME_SYSTEM}:${UNAME_RELEASE}:${UNAME_VERSION}" 1>&2
+
+eval $set_cc_for_build
+cat >$dummy.c <<EOF
+#ifdef _SEQUENT_
+# include <sys/types.h>
+# include <sys/utsname.h>
+#endif
+main ()
+{
+#if defined (sony)
+#if defined (MIPSEB)
+  /* BFD wants "bsd" instead of "newsos".  Perhaps BFD should be changed,
+     I don't know....  */
+  printf ("mips-sony-bsd\n"); exit (0);
+#else
+#include <sys/param.h>
+  printf ("m68k-sony-newsos%s\n",
+#ifdef NEWSOS4
+          "4"
+#else
+	  ""
+#endif
+         ); exit (0);
+#endif
+#endif
+
+#if defined (__arm) && defined (__acorn) && defined (__unix)
+  printf ("arm-acorn-riscix"); exit (0);
+#endif
+
+#if defined (hp300) && !defined (hpux)
+  printf ("m68k-hp-bsd\n"); exit (0);
+#endif
+
+#if defined (NeXT)
+#if !defined (__ARCHITECTURE__)
+#define __ARCHITECTURE__ "m68k"
+#endif
+  int version;
+  version=`(hostinfo | sed -n 's/.*NeXT Mach \([0-9]*\).*/\1/p') 2>/dev/null`;
+  if (version < 4)
+    printf ("%s-next-nextstep%d\n", __ARCHITECTURE__, version);
+  else
+    printf ("%s-next-openstep%d\n", __ARCHITECTURE__, version);
+  exit (0);
+#endif
+
+#if defined (MULTIMAX) || defined (n16)
+#if defined (UMAXV)
+  printf ("ns32k-encore-sysv\n"); exit (0);
+#else
+#if defined (CMU)
+  printf ("ns32k-encore-mach\n"); exit (0);
+#else
+  printf ("ns32k-encore-bsd\n"); exit (0);
+#endif
+#endif
+#endif
+
+#if defined (__386BSD__)
+  printf ("i386-pc-bsd\n"); exit (0);
+#endif
+
+#if defined (sequent)
+#if defined (i386)
+  printf ("i386-sequent-dynix\n"); exit (0);
+#endif
+#if defined (ns32000)
+  printf ("ns32k-sequent-dynix\n"); exit (0);
+#endif
+#endif
+
+#if defined (_SEQUENT_)
+    struct utsname un;
+
+    uname(&un);
+
+    if (strncmp(un.version, "V2", 2) == 0) {
+	printf ("i386-sequent-ptx2\n"); exit (0);
+    }
+    if (strncmp(un.version, "V1", 2) == 0) { /* XXX is V1 correct? */
+	printf ("i386-sequent-ptx1\n"); exit (0);
+    }
+    printf ("i386-sequent-ptx\n"); exit (0);
+
+#endif
+
+#if defined (vax)
+# if !defined (ultrix)
+#  include <sys/param.h>
+#  if defined (BSD)
+#   if BSD == 43
+      printf ("vax-dec-bsd4.3\n"); exit (0);
+#   else
+#    if BSD == 199006
+      printf ("vax-dec-bsd4.3reno\n"); exit (0);
+#    else
+      printf ("vax-dec-bsd\n"); exit (0);
+#    endif
+#   endif
+#  else
+    printf ("vax-dec-bsd\n"); exit (0);
+#  endif
+# else
+    printf ("vax-dec-ultrix\n"); exit (0);
+# endif
+#endif
+
+#if defined (alliant) && defined (i860)
+  printf ("i860-alliant-bsd\n"); exit (0);
+#endif
+
+  exit (1);
+}
+EOF
+
+$CC_FOR_BUILD -o $dummy $dummy.c 2>/dev/null && $dummy && exit 0
+
+# Apollos put the system type in the environment.
+
+test -d /usr/apollo && { echo ${ISP}-apollo-${SYSTYPE}; exit 0; }
+
+# Convex versions that predate uname can use getsysinfo(1)
+
+if [ -x /usr/convex/getsysinfo ]
+then
+    case `getsysinfo -f cpu_type` in
+    c1*)
+	echo c1-convex-bsd
+	exit 0 ;;
+    c2*)
+	if getsysinfo -f scalar_acc
+	then echo c32-convex-bsd
+	else echo c2-convex-bsd
+	fi
+	exit 0 ;;
+    c34*)
+	echo c34-convex-bsd
+	exit 0 ;;
+    c38*)
+	echo c38-convex-bsd
+	exit 0 ;;
+    c4*)
+	echo c4-convex-bsd
+	exit 0 ;;
+    esac
+fi
+
+cat >&2 <<EOF
+$0: unable to guess system type
+
+This script, last modified $timestamp, has failed to recognize
+the operating system you are using. It is advised that you
+download the most up to date version of the config scripts from
+
+    ftp://ftp.gnu.org/pub/gnu/config/
+
+If the version you run ($0) is already up to date, please
+send the following data and any information you think might be
+pertinent to <config-patches at gnu.org> in order to provide the needed
+information to handle your system.
+
+config.guess timestamp = $timestamp
+
+uname -m = `(uname -m) 2>/dev/null || echo unknown`
+uname -r = `(uname -r) 2>/dev/null || echo unknown`
+uname -s = `(uname -s) 2>/dev/null || echo unknown`
+uname -v = `(uname -v) 2>/dev/null || echo unknown`
+
+/usr/bin/uname -p = `(/usr/bin/uname -p) 2>/dev/null`
+/bin/uname -X     = `(/bin/uname -X) 2>/dev/null`
+
+hostinfo               = `(hostinfo) 2>/dev/null`
+/bin/universe          = `(/bin/universe) 2>/dev/null`
+/usr/bin/arch -k       = `(/usr/bin/arch -k) 2>/dev/null`
+/bin/arch              = `(/bin/arch) 2>/dev/null`
+/usr/bin/oslevel       = `(/usr/bin/oslevel) 2>/dev/null`
+/usr/convex/getsysinfo = `(/usr/convex/getsysinfo) 2>/dev/null`
+
+UNAME_MACHINE = ${UNAME_MACHINE}
+UNAME_RELEASE = ${UNAME_RELEASE}
+UNAME_SYSTEM  = ${UNAME_SYSTEM}
+UNAME_VERSION = ${UNAME_VERSION}
+EOF
+
+exit 1
+
+# Local variables:
+# eval: (add-hook 'write-file-hooks 'time-stamp)
+# time-stamp-start: "timestamp='"
+# time-stamp-format: "%:y-%02m-%02d"
+# time-stamp-end: "'"
+# End:


Property changes on: thinnx/trunk/config.guess
___________________________________________________________________
Name: svn:executable
   + *

Added: thinnx/trunk/config.h.in
===================================================================
--- thinnx/trunk/config.h.in	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/config.h.in	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,93 @@
+/* config.h.in.  Generated from configure.ac by autoheader.  */
+
+/* Define to 1 if you have the <alloca.h> header file. */
+#undef HAVE_ALLOCA_H
+
+/* Define to 1 if you have the <dirent.h> header file. */
+#undef HAVE_DIRENT_H
+
+/* Define to 1 if you have the <fcntl.h> header file. */
+#undef HAVE_FCNTL_H
+
+/* Define to 1 if you have the <inttypes.h> header file. */
+#undef HAVE_INTTYPES_H
+
+/* Define to 1 if you have the <locale.h> header file. */
+#undef HAVE_LOCALE_H
+
+/* Define to 1 if you have the <memory.h> header file. */
+#undef HAVE_MEMORY_H
+
+/* Define to 1 if you have the <ndir.h> header file. */
+#undef HAVE_NDIR_H
+
+/* Define to 1 if you have the <stdint.h> header file. */
+#undef HAVE_STDINT_H
+
+/* Define to 1 if you have the <stdlib.h> header file. */
+#undef HAVE_STDLIB_H
+
+/* Define to 1 if you have the <strings.h> header file. */
+#undef HAVE_STRINGS_H
+
+/* Define to 1 if you have the <string.h> header file. */
+#undef HAVE_STRING_H
+
+/* Define to 1 if you have the <sys/mkdev.h> header file. */
+#undef HAVE_SYS_MKDEV_H
+
+/* Define to 1 if you have the <sys/ndir.h> header file. */
+#undef HAVE_SYS_NDIR_H
+
+/* Define to 1 if you have the <sys/param.h> header file. */
+#undef HAVE_SYS_PARAM_H
+
+/* Define to 1 if you have the <sys/stat.h> header file. */
+#undef HAVE_SYS_STAT_H
+
+/* Define to 1 if you have the <sys/sysmacros.h> header file. */
+#undef HAVE_SYS_SYSMACROS_H
+
+/* Define to 1 if you have the <sys/time.h> header file. */
+#undef HAVE_SYS_TIME_H
+
+/* Define to 1 if you have the <sys/types.h> header file. */
+#undef HAVE_SYS_TYPES_H
+
+/* Define to 1 if you have the <time.h> header file. */
+#undef HAVE_TIME_H
+
+/* Define to 1 if you have the <unistd.h> header file. */
+#undef HAVE_UNISTD_H
+
+/* Define to 1 if `major', `minor', and `makedev' are declared in <mkdev.h>.
+   */
+#undef MAJOR_IN_MKDEV
+
+/* Define to 1 if `major', `minor', and `makedev' are declared in
+   <sysmacros.h>. */
+#undef MAJOR_IN_SYSMACROS
+
+/* Name of package */
+#undef PACKAGE
+
+/* Define to the address where bug reports for this package should be sent. */
+#undef PACKAGE_BUGREPORT
+
+/* Define to the full name of this package. */
+#undef PACKAGE_NAME
+
+/* Define to the full name and version of this package. */
+#undef PACKAGE_STRING
+
+/* Define to the one symbol short name of this package. */
+#undef PACKAGE_TARNAME
+
+/* Define to the version of this package. */
+#undef PACKAGE_VERSION
+
+/* Define to 1 if you have the ANSI C header files. */
+#undef STDC_HEADERS
+
+/* Version number of package */
+#undef VERSION

Added: thinnx/trunk/config.sub
===================================================================
--- thinnx/trunk/config.sub	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/config.sub	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,1566 @@
+#! /bin/sh
+# Configuration validation subroutine script.
+#   Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999,
+#   2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
+
+timestamp='2004-11-30'
+
+# This file is (in principle) common to ALL GNU software.
+# The presence of a machine in this file suggests that SOME GNU software
+# can handle that machine.  It does not imply ALL GNU software can.
+#
+# This file is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330,
+# Boston, MA 02111-1307, USA.
+
+# As a special exception to the GNU General Public License, if you
+# distribute this file as part of a program that contains a
+# configuration script generated by Autoconf, you may include it under
+# the same distribution terms that you use for the rest of that program.
+
+# Please send patches to <config-patches at gnu.org>.  Submit a context
+# diff and a properly formatted ChangeLog entry.
+#
+# Configuration subroutine to validate and canonicalize a configuration type.
+# Supply the specified configuration type as an argument.
+# If it is invalid, we print an error message on stderr and exit with code 1.
+# Otherwise, we print the canonical config type on stdout and succeed.
+
+# This file is supposed to be the same for all GNU packages
+# and recognize all the CPU types, system types and aliases
+# that are meaningful with *any* GNU software.
+# Each package is responsible for reporting which valid configurations
+# it does not support.  The user should be able to distinguish
+# a failure to support a valid configuration from a meaningless
+# configuration.
+
+# The goal of this file is to map all the various variations of a given
+# machine specification into a single specification in the form:
+#	CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM
+# or in some cases, the newer four-part form:
+#	CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM
+# It is wrong to echo any other type of specification.
+
+me=`echo "$0" | sed -e 's,.*/,,'`
+
+usage="\
+Usage: $0 [OPTION] CPU-MFR-OPSYS
+       $0 [OPTION] ALIAS
+
+Canonicalize a configuration name.
+
+Operation modes:
+  -h, --help         print this help, then exit
+  -t, --time-stamp   print date of last modification, then exit
+  -v, --version      print version number, then exit
+
+Report bugs and patches to <config-patches at gnu.org>."
+
+version="\
+GNU config.sub ($timestamp)
+
+Copyright (C) 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004
+Free Software Foundation, Inc.
+
+This is free software; see the source for copying conditions.  There is NO
+warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE."
+
+help="
+Try \`$me --help' for more information."
+
+# Parse command line
+while test $# -gt 0 ; do
+  case $1 in
+    --time-stamp | --time* | -t )
+       echo "$timestamp" ; exit 0 ;;
+    --version | -v )
+       echo "$version" ; exit 0 ;;
+    --help | --h* | -h )
+       echo "$usage"; exit 0 ;;
+    -- )     # Stop option processing
+       shift; break ;;
+    - )	# Use stdin as input.
+       break ;;
+    -* )
+       echo "$me: invalid option $1$help"
+       exit 1 ;;
+
+    *local*)
+       # First pass through any local machine types.
+       echo $1
+       exit 0;;
+
+    * )
+       break ;;
+  esac
+done
+
+case $# in
+ 0) echo "$me: missing argument$help" >&2
+    exit 1;;
+ 1) ;;
+ *) echo "$me: too many arguments$help" >&2
+    exit 1;;
+esac
+
+# Separate what the user gave into CPU-COMPANY and OS or KERNEL-OS (if any).
+# Here we must recognize all the valid KERNEL-OS combinations.
+maybe_os=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\2/'`
+case $maybe_os in
+  nto-qnx* | linux-gnu* | linux-dietlibc | linux-uclibc* | uclinux-uclibc* | uclinux-gnu* | \
+  kfreebsd*-gnu* | knetbsd*-gnu* | netbsd*-gnu* | storm-chaos* | os2-emx* | rtmk-nova*)
+    os=-$maybe_os
+    basic_machine=`echo $1 | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`
+    ;;
+  *)
+    basic_machine=`echo $1 | sed 's/-[^-]*$//'`
+    if [ $basic_machine != $1 ]
+    then os=`echo $1 | sed 's/.*-/-/'`
+    else os=; fi
+    ;;
+esac
+
+### Let's recognize common machines as not being operating systems so
+### that things like config.sub decstation-3100 work.  We also
+### recognize some manufacturers as not being operating systems, so we
+### can provide default operating systems below.
+case $os in
+	-sun*os*)
+		# Prevent following clause from handling this invalid input.
+		;;
+	-dec* | -mips* | -sequent* | -encore* | -pc532* | -sgi* | -sony* | \
+	-att* | -7300* | -3300* | -delta* | -motorola* | -sun[234]* | \
+	-unicom* | -ibm* | -next | -hp | -isi* | -apollo | -altos* | \
+	-convergent* | -ncr* | -news | -32* | -3600* | -3100* | -hitachi* |\
+	-c[123]* | -convex* | -sun | -crds | -omron* | -dg | -ultra | -tti* | \
+	-harris | -dolphin | -highlevel | -gould | -cbm | -ns | -masscomp | \
+	-apple | -axis | -knuth | -cray)
+		os=
+		basic_machine=$1
+		;;
+	-sim | -cisco | -oki | -wec | -winbond)
+		os=
+		basic_machine=$1
+		;;
+	-scout)
+		;;
+	-wrs)
+		os=-vxworks
+		basic_machine=$1
+		;;
+	-chorusos*)
+		os=-chorusos
+		basic_machine=$1
+		;;
+ 	-chorusrdb)
+ 		os=-chorusrdb
+		basic_machine=$1
+ 		;;
+	-hiux*)
+		os=-hiuxwe2
+		;;
+	-sco5)
+		os=-sco3.2v5
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco4)
+		os=-sco3.2v4
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco3.2.[4-9]*)
+		os=`echo $os | sed -e 's/sco3.2./sco3.2v/'`
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco3.2v[4-9]*)
+		# Don't forget version if it is 3.2v4 or newer.
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-sco*)
+		os=-sco3.2v2
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-udk*)
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-isc)
+		os=-isc2.2
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-clix*)
+		basic_machine=clipper-intergraph
+		;;
+	-isc*)
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-pc/'`
+		;;
+	-lynx*)
+		os=-lynxos
+		;;
+	-ptx*)
+		basic_machine=`echo $1 | sed -e 's/86-.*/86-sequent/'`
+		;;
+	-windowsnt*)
+		os=`echo $os | sed -e 's/windowsnt/winnt/'`
+		;;
+	-psos*)
+		os=-psos
+		;;
+	-mint | -mint[0-9]*)
+		basic_machine=m68k-atari
+		os=-mint
+		;;
+esac
+
+# Decode aliases for certain CPU-COMPANY combinations.
+case $basic_machine in
+	# Recognize the basic CPU types without company name.
+	# Some are omitted here because they have special meanings below.
+	1750a | 580 \
+	| a29k \
+	| alpha | alphaev[4-8] | alphaev56 | alphaev6[78] | alphapca5[67] \
+	| alpha64 | alpha64ev[4-8] | alpha64ev56 | alpha64ev6[78] | alpha64pca5[67] \
+	| am33_2.0 \
+	| arc | arm | arm[bl]e | arme[lb] | armv[2345] | armv[345][lb] | avr \
+	| c4x | clipper \
+	| d10v | d30v | dlx | dsp16xx \
+	| fr30 | frv \
+	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
+	| i370 | i860 | i960 | ia64 \
+	| ip2k | iq2000 \
+	| m32r | m32rle | m68000 | m68k | m88k | mcore \
+	| mips | mipsbe | mipseb | mipsel | mipsle \
+	| mips16 \
+	| mips64 | mips64el \
+	| mips64vr | mips64vrel \
+	| mips64orion | mips64orionel \
+	| mips64vr4100 | mips64vr4100el \
+	| mips64vr4300 | mips64vr4300el \
+	| mips64vr5000 | mips64vr5000el \
+	| mipsisa32 | mipsisa32el \
+	| mipsisa32r2 | mipsisa32r2el \
+	| mipsisa64 | mipsisa64el \
+	| mipsisa64r2 | mipsisa64r2el \
+	| mipsisa64sb1 | mipsisa64sb1el \
+	| mipsisa64sr71k | mipsisa64sr71kel \
+	| mipstx39 | mipstx39el \
+	| mn10200 | mn10300 \
+	| msp430 \
+	| ns16k | ns32k \
+	| openrisc | or32 \
+	| pdp10 | pdp11 | pj | pjl \
+	| powerpc | powerpc64 | powerpc64le | powerpcle | ppcbe \
+	| pyramid \
+	| sh | sh[1234] | sh[23]e | sh[34]eb | shbe | shle | sh[1234]le | sh3ele \
+	| sh64 | sh64le \
+	| sparc | sparc64 | sparc86x | sparclet | sparclite | sparcv8 | sparcv9 | sparcv9b \
+	| strongarm \
+	| tahoe | thumb | tic4x | tic80 | tron \
+	| v850 | v850e \
+	| we32k \
+	| x86 | xscale | xscalee[bl] | xstormy16 | xtensa \
+	| z8k)
+		basic_machine=$basic_machine-unknown
+		;;
+	m6811 | m68hc11 | m6812 | m68hc12)
+		# Motorola 68HC11/12.
+		basic_machine=$basic_machine-unknown
+		os=-none
+		;;
+	m88110 | m680[12346]0 | m683?2 | m68360 | m5200 | v70 | w65 | z8k)
+		;;
+
+	# We use `pc' rather than `unknown'
+	# because (1) that's what they normally are, and
+	# (2) the word "unknown" tends to confuse beginning users.
+	i*86 | x86_64)
+	  basic_machine=$basic_machine-pc
+	  ;;
+	# Object if more than one company name word.
+	*-*-*)
+		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
+		exit 1
+		;;
+	# Recognize the basic CPU types with company name.
+	580-* \
+	| a29k-* \
+	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
+	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
+	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* \
+	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
+	| avr-* \
+	| bs2000-* \
+	| c[123]* | c30-* | [cjt]90-* | c4x-* | c54x-* | c55x-* | c6x-* \
+	| clipper-* | craynv-* | cydra-* \
+	| d10v-* | d30v-* | dlx-* \
+	| elxsi-* \
+	| f30[01]-* | f700-* | fr30-* | frv-* | fx80-* \
+	| h8300-* | h8500-* \
+	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
+	| i*86-* | i860-* | i960-* | ia64-* \
+	| ip2k-* | iq2000-* \
+	| m32r-* | m32rle-* \
+	| m68000-* | m680[012346]0-* | m68360-* | m683?2-* | m68k-* \
+	| m88110-* | m88k-* | mcore-* \
+	| mips-* | mipsbe-* | mipseb-* | mipsel-* | mipsle-* \
+	| mips16-* \
+	| mips64-* | mips64el-* \
+	| mips64vr-* | mips64vrel-* \
+	| mips64orion-* | mips64orionel-* \
+	| mips64vr4100-* | mips64vr4100el-* \
+	| mips64vr4300-* | mips64vr4300el-* \
+	| mips64vr5000-* | mips64vr5000el-* \
+	| mipsisa32-* | mipsisa32el-* \
+	| mipsisa32r2-* | mipsisa32r2el-* \
+	| mipsisa64-* | mipsisa64el-* \
+	| mipsisa64r2-* | mipsisa64r2el-* \
+	| mipsisa64sb1-* | mipsisa64sb1el-* \
+	| mipsisa64sr71k-* | mipsisa64sr71kel-* \
+	| mipstx39-* | mipstx39el-* \
+	| mmix-* \
+	| msp430-* \
+	| none-* | np1-* | ns16k-* | ns32k-* \
+	| orion-* \
+	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
+	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* | ppcbe-* \
+	| pyramid-* \
+	| romp-* | rs6000-* \
+	| sh-* | sh[1234]-* | sh[23]e-* | sh[34]eb-* | shbe-* \
+	| shle-* | sh[1234]le-* | sh3ele-* | sh64-* | sh64le-* \
+	| sparc-* | sparc64-* | sparc86x-* | sparclet-* | sparclite-* \
+	| sparcv8-* | sparcv9-* | sparcv9b-* | strongarm-* | sv1-* | sx?-* \
+	| tahoe-* | thumb-* \
+	| tic30-* | tic4x-* | tic54x-* | tic55x-* | tic6x-* | tic80-* \
+	| tron-* \
+	| v850-* | v850e-* | vax-* \
+	| we32k-* \
+	| x86-* | x86_64-* | xps100-* | xscale-* | xscalee[bl]-* \
+	| xstormy16-* | xtensa-* \
+	| ymp-* \
+	| z8k-*)
+		;;
+	# Recognize the various machine names and aliases which stand
+	# for a CPU type and a company and sometimes even an OS.
+	386bsd)
+		basic_machine=i386-unknown
+		os=-bsd
+		;;
+	3b1 | 7300 | 7300-att | att-7300 | pc7300 | safari | unixpc)
+		basic_machine=m68000-att
+		;;
+	3b*)
+		basic_machine=we32k-att
+		;;
+	a29khif)
+		basic_machine=a29k-amd
+		os=-udi
+		;;
+    	abacus)
+		basic_machine=abacus-unknown
+		;;
+	adobe68k)
+		basic_machine=m68010-adobe
+		os=-scout
+		;;
+	alliant | fx80)
+		basic_machine=fx80-alliant
+		;;
+	altos | altos3068)
+		basic_machine=m68k-altos
+		;;
+	am29k)
+		basic_machine=a29k-none
+		os=-bsd
+		;;
+	amd64)
+		basic_machine=x86_64-pc
+		;;
+	amd64-*)
+		basic_machine=x86_64-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	amdahl)
+		basic_machine=580-amdahl
+		os=-sysv
+		;;
+	amiga | amiga-*)
+		basic_machine=m68k-unknown
+		;;
+	amigaos | amigados)
+		basic_machine=m68k-unknown
+		os=-amigaos
+		;;
+	amigaunix | amix)
+		basic_machine=m68k-unknown
+		os=-sysv4
+		;;
+	apollo68)
+		basic_machine=m68k-apollo
+		os=-sysv
+		;;
+	apollo68bsd)
+		basic_machine=m68k-apollo
+		os=-bsd
+		;;
+	aux)
+		basic_machine=m68k-apple
+		os=-aux
+		;;
+	balance)
+		basic_machine=ns32k-sequent
+		os=-dynix
+		;;
+	c90)
+		basic_machine=c90-cray
+		os=-unicos
+		;;
+	convex-c1)
+		basic_machine=c1-convex
+		os=-bsd
+		;;
+	convex-c2)
+		basic_machine=c2-convex
+		os=-bsd
+		;;
+	convex-c32)
+		basic_machine=c32-convex
+		os=-bsd
+		;;
+	convex-c34)
+		basic_machine=c34-convex
+		os=-bsd
+		;;
+	convex-c38)
+		basic_machine=c38-convex
+		os=-bsd
+		;;
+	cray | j90)
+		basic_machine=j90-cray
+		os=-unicos
+		;;
+	craynv)
+		basic_machine=craynv-cray
+		os=-unicosmp
+		;;
+	cr16c)
+		basic_machine=cr16c-unknown
+		os=-elf
+		;;
+	crds | unos)
+		basic_machine=m68k-crds
+		;;
+	crisv32 | crisv32-* | etraxfs*)
+		basic_machine=crisv32-axis
+		;;
+	cris | cris-* | etrax*)
+		basic_machine=cris-axis
+		;;
+	crx)
+		basic_machine=crx-unknown
+		os=-elf
+		;;
+	da30 | da30-*)
+		basic_machine=m68k-da30
+		;;
+	decstation | decstation-3100 | pmax | pmax-* | pmin | dec3100 | decstatn)
+		basic_machine=mips-dec
+		;;
+	decsystem10* | dec10*)
+		basic_machine=pdp10-dec
+		os=-tops10
+		;;
+	decsystem20* | dec20*)
+		basic_machine=pdp10-dec
+		os=-tops20
+		;;
+	delta | 3300 | motorola-3300 | motorola-delta \
+	      | 3300-motorola | delta-motorola)
+		basic_machine=m68k-motorola
+		;;
+	delta88)
+		basic_machine=m88k-motorola
+		os=-sysv3
+		;;
+	djgpp)
+		basic_machine=i586-pc
+		os=-msdosdjgpp
+		;;
+	dpx20 | dpx20-*)
+		basic_machine=rs6000-bull
+		os=-bosx
+		;;
+	dpx2* | dpx2*-bull)
+		basic_machine=m68k-bull
+		os=-sysv3
+		;;
+	ebmon29k)
+		basic_machine=a29k-amd
+		os=-ebmon
+		;;
+	elxsi)
+		basic_machine=elxsi-elxsi
+		os=-bsd
+		;;
+	encore | umax | mmax)
+		basic_machine=ns32k-encore
+		;;
+	es1800 | OSE68k | ose68k | ose | OSE)
+		basic_machine=m68k-ericsson
+		os=-ose
+		;;
+	fx2800)
+		basic_machine=i860-alliant
+		;;
+	genix)
+		basic_machine=ns32k-ns
+		;;
+	gmicro)
+		basic_machine=tron-gmicro
+		os=-sysv
+		;;
+	go32)
+		basic_machine=i386-pc
+		os=-go32
+		;;
+	h3050r* | hiux*)
+		basic_machine=hppa1.1-hitachi
+		os=-hiuxwe2
+		;;
+	h8300hms)
+		basic_machine=h8300-hitachi
+		os=-hms
+		;;
+	h8300xray)
+		basic_machine=h8300-hitachi
+		os=-xray
+		;;
+	h8500hms)
+		basic_machine=h8500-hitachi
+		os=-hms
+		;;
+	harris)
+		basic_machine=m88k-harris
+		os=-sysv3
+		;;
+	hp300-*)
+		basic_machine=m68k-hp
+		;;
+	hp300bsd)
+		basic_machine=m68k-hp
+		os=-bsd
+		;;
+	hp300hpux)
+		basic_machine=m68k-hp
+		os=-hpux
+		;;
+	hp3k9[0-9][0-9] | hp9[0-9][0-9])
+		basic_machine=hppa1.0-hp
+		;;
+	hp9k2[0-9][0-9] | hp9k31[0-9])
+		basic_machine=m68000-hp
+		;;
+	hp9k3[2-9][0-9])
+		basic_machine=m68k-hp
+		;;
+	hp9k6[0-9][0-9] | hp6[0-9][0-9])
+		basic_machine=hppa1.0-hp
+		;;
+	hp9k7[0-79][0-9] | hp7[0-79][0-9])
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k78[0-9] | hp78[0-9])
+		# FIXME: really hppa2.0-hp
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k8[67]1 | hp8[67]1 | hp9k80[24] | hp80[24] | hp9k8[78]9 | hp8[78]9 | hp9k893 | hp893)
+		# FIXME: really hppa2.0-hp
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k8[0-9][13679] | hp8[0-9][13679])
+		basic_machine=hppa1.1-hp
+		;;
+	hp9k8[0-9][0-9] | hp8[0-9][0-9])
+		basic_machine=hppa1.0-hp
+		;;
+	hppa-next)
+		os=-nextstep3
+		;;
+	hppaosf)
+		basic_machine=hppa1.1-hp
+		os=-osf
+		;;
+	hppro)
+		basic_machine=hppa1.1-hp
+		os=-proelf
+		;;
+	i370-ibm* | ibm*)
+		basic_machine=i370-ibm
+		;;
+# I'm not sure what "Sysv32" means.  Should this be sysv3.2?
+	i*86v32)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-sysv32
+		;;
+	i*86v4*)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-sysv4
+		;;
+	i*86v)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-sysv
+		;;
+	i*86sol2)
+		basic_machine=`echo $1 | sed -e 's/86.*/86-pc/'`
+		os=-solaris2
+		;;
+	i386mach)
+		basic_machine=i386-mach
+		os=-mach
+		;;
+	i386-vsta | vsta)
+		basic_machine=i386-unknown
+		os=-vsta
+		;;
+	iris | iris4d)
+		basic_machine=mips-sgi
+		case $os in
+		    -irix*)
+			;;
+		    *)
+			os=-irix4
+			;;
+		esac
+		;;
+	isi68 | isi)
+		basic_machine=m68k-isi
+		os=-sysv
+		;;
+	m88k-omron*)
+		basic_machine=m88k-omron
+		;;
+	magnum | m3230)
+		basic_machine=mips-mips
+		os=-sysv
+		;;
+	merlin)
+		basic_machine=ns32k-utek
+		os=-sysv
+		;;
+	mingw32)
+		basic_machine=i386-pc
+		os=-mingw32
+		;;
+	miniframe)
+		basic_machine=m68000-convergent
+		;;
+	*mint | -mint[0-9]* | *MiNT | *MiNT[0-9]*)
+		basic_machine=m68k-atari
+		os=-mint
+		;;
+	mips3*-*)
+		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`
+		;;
+	mips3*)
+		basic_machine=`echo $basic_machine | sed -e 's/mips3/mips64/'`-unknown
+		;;
+	monitor)
+		basic_machine=m68k-rom68k
+		os=-coff
+		;;
+	morphos)
+		basic_machine=powerpc-unknown
+		os=-morphos
+		;;
+	msdos)
+		basic_machine=i386-pc
+		os=-msdos
+		;;
+	mvs)
+		basic_machine=i370-ibm
+		os=-mvs
+		;;
+	ncr3000)
+		basic_machine=i486-ncr
+		os=-sysv4
+		;;
+	netbsd386)
+		basic_machine=i386-unknown
+		os=-netbsd
+		;;
+	netwinder)
+		basic_machine=armv4l-rebel
+		os=-linux
+		;;
+	news | news700 | news800 | news900)
+		basic_machine=m68k-sony
+		os=-newsos
+		;;
+	news1000)
+		basic_machine=m68030-sony
+		os=-newsos
+		;;
+	news-3600 | risc-news)
+		basic_machine=mips-sony
+		os=-newsos
+		;;
+	necv70)
+		basic_machine=v70-nec
+		os=-sysv
+		;;
+	next | m*-next )
+		basic_machine=m68k-next
+		case $os in
+		    -nextstep* )
+			;;
+		    -ns2*)
+		      os=-nextstep2
+			;;
+		    *)
+		      os=-nextstep3
+			;;
+		esac
+		;;
+	nh3000)
+		basic_machine=m68k-harris
+		os=-cxux
+		;;
+	nh[45]000)
+		basic_machine=m88k-harris
+		os=-cxux
+		;;
+	nindy960)
+		basic_machine=i960-intel
+		os=-nindy
+		;;
+	mon960)
+		basic_machine=i960-intel
+		os=-mon960
+		;;
+	nonstopux)
+		basic_machine=mips-compaq
+		os=-nonstopux
+		;;
+	np1)
+		basic_machine=np1-gould
+		;;
+	nsr-tandem)
+		basic_machine=nsr-tandem
+		;;
+	op50n-* | op60c-*)
+		basic_machine=hppa1.1-oki
+		os=-proelf
+		;;
+	or32 | or32-*)
+		basic_machine=or32-unknown
+		os=-coff
+		;;
+	os400)
+		basic_machine=powerpc-ibm
+		os=-os400
+		;;
+	OSE68000 | ose68000)
+		basic_machine=m68000-ericsson
+		os=-ose
+		;;
+	os68k)
+		basic_machine=m68k-none
+		os=-os68k
+		;;
+	pa-hitachi)
+		basic_machine=hppa1.1-hitachi
+		os=-hiuxwe2
+		;;
+	paragon)
+		basic_machine=i860-intel
+		os=-osf
+		;;
+	pbd)
+		basic_machine=sparc-tti
+		;;
+	pbb)
+		basic_machine=m68k-tti
+		;;
+	pc532 | pc532-*)
+		basic_machine=ns32k-pc532
+		;;
+	pentium | p5 | k5 | k6 | nexgen | viac3)
+		basic_machine=i586-pc
+		;;
+	pentiumpro | p6 | 6x86 | athlon | athlon_*)
+		basic_machine=i686-pc
+		;;
+	pentiumii | pentium2 | pentiumiii | pentium3)
+		basic_machine=i686-pc
+		;;
+	pentium4)
+		basic_machine=i786-pc
+		;;
+	pentium-* | p5-* | k5-* | k6-* | nexgen-* | viac3-*)
+		basic_machine=i586-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	pentiumpro-* | p6-* | 6x86-* | athlon-*)
+		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	pentiumii-* | pentium2-* | pentiumiii-* | pentium3-*)
+		basic_machine=i686-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	pentium4-*)
+		basic_machine=i786-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	pn)
+		basic_machine=pn-gould
+		;;
+	power)	basic_machine=power-ibm
+		;;
+	ppc)	basic_machine=powerpc-unknown
+		;;
+	ppc-*)	basic_machine=powerpc-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ppcle | powerpclittle | ppc-le | powerpc-little)
+		basic_machine=powerpcle-unknown
+		;;
+	ppcle-* | powerpclittle-*)
+		basic_machine=powerpcle-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ppc64)	basic_machine=powerpc64-unknown
+		;;
+	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
+		basic_machine=powerpc64le-unknown
+		;;
+	ppc64le-* | powerpc64little-*)
+		basic_machine=powerpc64le-`echo $basic_machine | sed 's/^[^-]*-//'`
+		;;
+	ps2)
+		basic_machine=i386-ibm
+		;;
+	pw32)
+		basic_machine=i586-unknown
+		os=-pw32
+		;;
+	rom68k)
+		basic_machine=m68k-rom68k
+		os=-coff
+		;;
+	rm[46]00)
+		basic_machine=mips-siemens
+		;;
+	rtpc | rtpc-*)
+		basic_machine=romp-ibm
+		;;
+	s390 | s390-*)
+		basic_machine=s390-ibm
+		;;
+	s390x | s390x-*)
+		basic_machine=s390x-ibm
+		;;
+	sa29200)
+		basic_machine=a29k-amd
+		os=-udi
+		;;
+	sb1)
+		basic_machine=mipsisa64sb1-unknown
+		;;
+	sb1el)
+		basic_machine=mipsisa64sb1el-unknown
+		;;
+	sei)
+		basic_machine=mips-sei
+		os=-seiux
+		;;
+	sequent)
+		basic_machine=i386-sequent
+		;;
+	sh)
+		basic_machine=sh-hitachi
+		os=-hms
+		;;
+	sh64)
+		basic_machine=sh64-unknown
+		;;
+	sparclite-wrs | simso-wrs)
+		basic_machine=sparclite-wrs
+		os=-vxworks
+		;;
+	sps7)
+		basic_machine=m68k-bull
+		os=-sysv2
+		;;
+	spur)
+		basic_machine=spur-unknown
+		;;
+	st2000)
+		basic_machine=m68k-tandem
+		;;
+	stratus)
+		basic_machine=i860-stratus
+		os=-sysv4
+		;;
+	sun2)
+		basic_machine=m68000-sun
+		;;
+	sun2os3)
+		basic_machine=m68000-sun
+		os=-sunos3
+		;;
+	sun2os4)
+		basic_machine=m68000-sun
+		os=-sunos4
+		;;
+	sun3os3)
+		basic_machine=m68k-sun
+		os=-sunos3
+		;;
+	sun3os4)
+		basic_machine=m68k-sun
+		os=-sunos4
+		;;
+	sun4os3)
+		basic_machine=sparc-sun
+		os=-sunos3
+		;;
+	sun4os4)
+		basic_machine=sparc-sun
+		os=-sunos4
+		;;
+	sun4sol2)
+		basic_machine=sparc-sun
+		os=-solaris2
+		;;
+	sun3 | sun3-*)
+		basic_machine=m68k-sun
+		;;
+	sun4)
+		basic_machine=sparc-sun
+		;;
+	sun386 | sun386i | roadrunner)
+		basic_machine=i386-sun
+		;;
+	sv1)
+		basic_machine=sv1-cray
+		os=-unicos
+		;;
+	symmetry)
+		basic_machine=i386-sequent
+		os=-dynix
+		;;
+	t3e)
+		basic_machine=alphaev5-cray
+		os=-unicos
+		;;
+	t90)
+		basic_machine=t90-cray
+		os=-unicos
+		;;
+	tic54x | c54x*)
+		basic_machine=tic54x-unknown
+		os=-coff
+		;;
+	tic55x | c55x*)
+		basic_machine=tic55x-unknown
+		os=-coff
+		;;
+	tic6x | c6x*)
+		basic_machine=tic6x-unknown
+		os=-coff
+		;;
+	tx39)
+		basic_machine=mipstx39-unknown
+		;;
+	tx39el)
+		basic_machine=mipstx39el-unknown
+		;;
+	toad1)
+		basic_machine=pdp10-xkl
+		os=-tops20
+		;;
+	tower | tower-32)
+		basic_machine=m68k-ncr
+		;;
+	tpf)
+		basic_machine=s390x-ibm
+		os=-tpf
+		;;
+	udi29k)
+		basic_machine=a29k-amd
+		os=-udi
+		;;
+	ultra3)
+		basic_machine=a29k-nyu
+		os=-sym1
+		;;
+	v810 | necv810)
+		basic_machine=v810-nec
+		os=-none
+		;;
+	vaxv)
+		basic_machine=vax-dec
+		os=-sysv
+		;;
+	vms)
+		basic_machine=vax-dec
+		os=-vms
+		;;
+	vpp*|vx|vx-*)
+		basic_machine=f301-fujitsu
+		;;
+	vxworks960)
+		basic_machine=i960-wrs
+		os=-vxworks
+		;;
+	vxworks68)
+		basic_machine=m68k-wrs
+		os=-vxworks
+		;;
+	vxworks29k)
+		basic_machine=a29k-wrs
+		os=-vxworks
+		;;
+	w65*)
+		basic_machine=w65-wdc
+		os=-none
+		;;
+	w89k-*)
+		basic_machine=hppa1.1-winbond
+		os=-proelf
+		;;
+	xbox)
+		basic_machine=i686-pc
+		os=-mingw32
+		;;
+	xps | xps100)
+		basic_machine=xps100-honeywell
+		;;
+	ymp)
+		basic_machine=ymp-cray
+		os=-unicos
+		;;
+	z8k-*-coff)
+		basic_machine=z8k-unknown
+		os=-sim
+		;;
+	none)
+		basic_machine=none-none
+		os=-none
+		;;
+
+# Here we handle the default manufacturer of certain CPU types.  It is in
+# some cases the only manufacturer, in others, it is the most popular.
+	w89k)
+		basic_machine=hppa1.1-winbond
+		;;
+	op50n)
+		basic_machine=hppa1.1-oki
+		;;
+	op60c)
+		basic_machine=hppa1.1-oki
+		;;
+	romp)
+		basic_machine=romp-ibm
+		;;
+	mmix)
+		basic_machine=mmix-knuth
+		;;
+	rs6000)
+		basic_machine=rs6000-ibm
+		;;
+	vax)
+		basic_machine=vax-dec
+		;;
+	pdp10)
+		# there are many clones, so DEC is not a safe bet
+		basic_machine=pdp10-unknown
+		;;
+	pdp11)
+		basic_machine=pdp11-dec
+		;;
+	we32k)
+		basic_machine=we32k-att
+		;;
+	sh3 | sh4 | sh[34]eb | sh[1234]le | sh[23]ele)
+		basic_machine=sh-unknown
+		;;
+	sh64)
+		basic_machine=sh64-unknown
+		;;
+	sparc | sparcv8 | sparcv9 | sparcv9b)
+		basic_machine=sparc-sun
+		;;
+	cydra)
+		basic_machine=cydra-cydrome
+		;;
+	orion)
+		basic_machine=orion-highlevel
+		;;
+	orion105)
+		basic_machine=clipper-highlevel
+		;;
+	mac | mpw | mac-mpw)
+		basic_machine=m68k-apple
+		;;
+	pmac | pmac-mpw)
+		basic_machine=powerpc-apple
+		;;
+	*-unknown)
+		# Make sure to match an already-canonicalized machine name.
+		;;
+	*)
+		echo Invalid configuration \`$1\': machine \`$basic_machine\' not recognized 1>&2
+		exit 1
+		;;
+esac
+
+# Here we canonicalize certain aliases for manufacturers.
+case $basic_machine in
+	*-digital*)
+		basic_machine=`echo $basic_machine | sed 's/digital.*/dec/'`
+		;;
+	*-commodore*)
+		basic_machine=`echo $basic_machine | sed 's/commodore.*/cbm/'`
+		;;
+	*)
+		;;
+esac
+
+# Decode manufacturer-specific aliases for certain operating systems.
+
+if [ x"$os" != x"" ]
+then
+case $os in
+        # First match some system type aliases
+        # that might get confused with valid system types.
+	# -solaris* is a basic system type, with this one exception.
+	-solaris1 | -solaris1.*)
+		os=`echo $os | sed -e 's|solaris1|sunos4|'`
+		;;
+	-solaris)
+		os=-solaris2
+		;;
+	-svr4*)
+		os=-sysv4
+		;;
+	-unixware*)
+		os=-sysv4.2uw
+		;;
+	-gnu/linux*)
+		os=`echo $os | sed -e 's|gnu/linux|linux-gnu|'`
+		;;
+	# First accept the basic system types.
+	# The portable systems comes first.
+	# Each alternative MUST END IN A *, to match a version number.
+	# -sysv* is not here because it comes later, after sysvr4.
+	-gnu* | -bsd* | -mach* | -minix* | -genix* | -ultrix* | -irix* \
+	      | -*vms* | -sco* | -esix* | -isc* | -aix* | -sunos | -sunos[34]*\
+	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -solaris* | -sym* \
+	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
+	      | -aos* \
+	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
+	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
+	      | -hiux* | -386bsd* | -knetbsd* | -mirbsd* | -netbsd* | -openbsd* \
+	      | -ekkobsd* | -kfreebsd* | -freebsd* | -riscix* | -lynxos* \
+	      | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
+	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
+	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
+	      | -chorusos* | -chorusrdb* \
+	      | -cygwin* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
+	      | -mingw32* | -linux-gnu* | -linux-uclibc* | -uxpv* | -beos* | -mpeix* | -udk* \
+	      | -interix* | -uwin* | -mks* | -rhapsody* | -darwin* | -opened* \
+	      | -openstep* | -oskit* | -conix* | -pw32* | -nonstopux* \
+	      | -storm-chaos* | -tops10* | -tenex* | -tops20* | -its* \
+	      | -os2* | -vos* | -palmos* | -uclinux* | -nucleus* \
+	      | -morphos* | -superux* | -rtmk* | -rtmk-nova* | -windiss* \
+	      | -powermax* | -dnix* | -nx6 | -nx7 | -sei* | -dragonfly*)
+	# Remember, each alternative MUST END IN *, to match a version number.
+		;;
+	-qnx*)
+		case $basic_machine in
+		    x86-* | i*86-*)
+			;;
+		    *)
+			os=-nto$os
+			;;
+		esac
+		;;
+	-nto-qnx*)
+		;;
+	-nto*)
+		os=`echo $os | sed -e 's|nto|nto-qnx|'`
+		;;
+	-sim | -es1800* | -hms* | -xray | -os68k* | -none* | -v88r* \
+	      | -windows* | -osx | -abug | -netware* | -os9* | -beos* \
+	      | -macos* | -mpw* | -magic* | -mmixware* | -mon960* | -lnews*)
+		;;
+	-mac*)
+		os=`echo $os | sed -e 's|mac|macos|'`
+		;;
+	-linux-dietlibc)
+		os=-linux-dietlibc
+		;;
+	-linux*)
+		os=`echo $os | sed -e 's|linux|linux-gnu|'`
+		;;
+	-sunos5*)
+		os=`echo $os | sed -e 's|sunos5|solaris2|'`
+		;;
+	-sunos6*)
+		os=`echo $os | sed -e 's|sunos6|solaris3|'`
+		;;
+	-opened*)
+		os=-openedition
+		;;
+        -os400*)
+		os=-os400
+		;;
+	-wince*)
+		os=-wince
+		;;
+	-osfrose*)
+		os=-osfrose
+		;;
+	-osf*)
+		os=-osf
+		;;
+	-utek*)
+		os=-bsd
+		;;
+	-dynix*)
+		os=-bsd
+		;;
+	-acis*)
+		os=-aos
+		;;
+	-atheos*)
+		os=-atheos
+		;;
+	-syllable*)
+		os=-syllable
+		;;
+	-386bsd)
+		os=-bsd
+		;;
+	-ctix* | -uts*)
+		os=-sysv
+		;;
+	-nova*)
+		os=-rtmk-nova
+		;;
+	-ns2 )
+		os=-nextstep2
+		;;
+	-nsk*)
+		os=-nsk
+		;;
+	# Preserve the version number of sinix5.
+	-sinix5.*)
+		os=`echo $os | sed -e 's|sinix|sysv|'`
+		;;
+	-sinix*)
+		os=-sysv4
+		;;
+        -tpf*)
+		os=-tpf
+		;;
+	-triton*)
+		os=-sysv3
+		;;
+	-oss*)
+		os=-sysv3
+		;;
+	-svr4)
+		os=-sysv4
+		;;
+	-svr3)
+		os=-sysv3
+		;;
+	-sysvr4)
+		os=-sysv4
+		;;
+	# This must come after -sysvr4.
+	-sysv*)
+		;;
+	-ose*)
+		os=-ose
+		;;
+	-es1800*)
+		os=-ose
+		;;
+	-xenix)
+		os=-xenix
+		;;
+	-*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
+		os=-mint
+		;;
+	-aros*)
+		os=-aros
+		;;
+	-kaos*)
+		os=-kaos
+		;;
+	-zvmoe)
+		os=-zvmoe
+		;;
+	-none)
+		;;
+	*)
+		# Get rid of the `-' at the beginning of $os.
+		os=`echo $os | sed 's/[^-]*-//'`
+		echo Invalid configuration \`$1\': system \`$os\' not recognized 1>&2
+		exit 1
+		;;
+esac
+else
+
+# Here we handle the default operating systems that come with various machines.
+# The value should be what the vendor currently ships out the door with their
+# machine or put another way, the most popular os provided with the machine.
+
+# Note that if you're going to try to match "-MANUFACTURER" here (say,
+# "-sun"), then you have to tell the case statement up towards the top
+# that MANUFACTURER isn't an operating system.  Otherwise, code above
+# will signal an error saying that MANUFACTURER isn't an operating
+# system, and we'll never get to this point.
+
+case $basic_machine in
+	*-acorn)
+		os=-riscix1.2
+		;;
+	arm*-rebel)
+		os=-linux
+		;;
+	arm*-semi)
+		os=-aout
+		;;
+    c4x-* | tic4x-*)
+        os=-coff
+        ;;
+	# This must come before the *-dec entry.
+	pdp10-*)
+		os=-tops20
+		;;
+	pdp11-*)
+		os=-none
+		;;
+	*-dec | vax-*)
+		os=-ultrix4.2
+		;;
+	m68*-apollo)
+		os=-domain
+		;;
+	i386-sun)
+		os=-sunos4.0.2
+		;;
+	m68000-sun)
+		os=-sunos3
+		# This also exists in the configure program, but was not the
+		# default.
+		# os=-sunos4
+		;;
+	m68*-cisco)
+		os=-aout
+		;;
+	mips*-cisco)
+		os=-elf
+		;;
+	mips*-*)
+		os=-elf
+		;;
+	or32-*)
+		os=-coff
+		;;
+	*-tti)	# must be before sparc entry or we get the wrong os.
+		os=-sysv3
+		;;
+	sparc-* | *-sun)
+		os=-sunos4.1.1
+		;;
+	*-be)
+		os=-beos
+		;;
+	*-ibm)
+		os=-aix
+		;;
+    	*-knuth)
+		os=-mmixware
+		;;
+	*-wec)
+		os=-proelf
+		;;
+	*-winbond)
+		os=-proelf
+		;;
+	*-oki)
+		os=-proelf
+		;;
+	*-hp)
+		os=-hpux
+		;;
+	*-hitachi)
+		os=-hiux
+		;;
+	i860-* | *-att | *-ncr | *-altos | *-motorola | *-convergent)
+		os=-sysv
+		;;
+	*-cbm)
+		os=-amigaos
+		;;
+	*-dg)
+		os=-dgux
+		;;
+	*-dolphin)
+		os=-sysv3
+		;;
+	m68k-ccur)
+		os=-rtu
+		;;
+	m88k-omron*)
+		os=-luna
+		;;
+	*-next )
+		os=-nextstep
+		;;
+	*-sequent)
+		os=-ptx
+		;;
+	*-crds)
+		os=-unos
+		;;
+	*-ns)
+		os=-genix
+		;;
+	i370-*)
+		os=-mvs
+		;;
+	*-next)
+		os=-nextstep3
+		;;
+	*-gould)
+		os=-sysv
+		;;
+	*-highlevel)
+		os=-bsd
+		;;
+	*-encore)
+		os=-bsd
+		;;
+	*-sgi)
+		os=-irix
+		;;
+	*-siemens)
+		os=-sysv4
+		;;
+	*-masscomp)
+		os=-rtu
+		;;
+	f30[01]-fujitsu | f700-fujitsu)
+		os=-uxpv
+		;;
+	*-rom68k)
+		os=-coff
+		;;
+	*-*bug)
+		os=-coff
+		;;
+	*-apple)
+		os=-macos
+		;;
+	*-atari*)
+		os=-mint
+		;;
+	*)
+		os=-none
+		;;
+esac
+fi
+
+# Here we handle the case where we know the os, and the CPU type, but not the
+# manufacturer.  We pick the logical manufacturer.
+vendor=unknown
+case $basic_machine in
+	*-unknown)
+		case $os in
+			-riscix*)
+				vendor=acorn
+				;;
+			-sunos*)
+				vendor=sun
+				;;
+			-aix*)
+				vendor=ibm
+				;;
+			-beos*)
+				vendor=be
+				;;
+			-hpux*)
+				vendor=hp
+				;;
+			-mpeix*)
+				vendor=hp
+				;;
+			-hiux*)
+				vendor=hitachi
+				;;
+			-unos*)
+				vendor=crds
+				;;
+			-dgux*)
+				vendor=dg
+				;;
+			-luna*)
+				vendor=omron
+				;;
+			-genix*)
+				vendor=ns
+				;;
+			-mvs* | -opened*)
+				vendor=ibm
+				;;
+			-os400*)
+				vendor=ibm
+				;;
+			-ptx*)
+				vendor=sequent
+				;;
+			-tpf*)
+				vendor=ibm
+				;;
+			-vxsim* | -vxworks* | -windiss*)
+				vendor=wrs
+				;;
+			-aux*)
+				vendor=apple
+				;;
+			-hms*)
+				vendor=hitachi
+				;;
+			-mpw* | -macos*)
+				vendor=apple
+				;;
+			-*mint | -mint[0-9]* | -*MiNT | -MiNT[0-9]*)
+				vendor=atari
+				;;
+			-vos*)
+				vendor=stratus
+				;;
+		esac
+		basic_machine=`echo $basic_machine | sed "s/unknown/$vendor/"`
+		;;
+esac
+
+echo $basic_machine$os
+exit 0
+
+# Local variables:
+# eval: (add-hook 'write-file-hooks 'time-stamp)
+# time-stamp-start: "timestamp='"
+# time-stamp-format: "%:y-%02m-%02d"
+# time-stamp-end: "'"
+# End:


Property changes on: thinnx/trunk/config.sub
___________________________________________________________________
Name: svn:executable
   + *

Added: thinnx/trunk/configure.ac
===================================================================
--- thinnx/trunk/configure.ac	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/configure.ac	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,34 @@
+dnl Process this file with autoconf to produce a configure script.
+
+AC_INIT(thinnx/thinnx.c)
+dnl Every other copy of the package version number gets its value from here
+AM_INIT_AUTOMAKE(thinnx, 0.1.0)
+
+dnl create a config.h file (Automake will add -DHAVE_CONFIG_H)
+AM_CONFIG_HEADER(config.h)
+
+AC_SUBST(VERSION)
+
+ISODATE=`date +%Y-%m-%d`
+AC_SUBST(ISODATE)
+
+AC_CANONICAL_HOST
+
+dnl Checks for programs.
+AC_PROG_INSTALL
+AC_PROG_CC
+
+dnl Checks for libraries.
+AM_PATH_GTK(1.2.0,, AC_MSG_ERROR(Can't find GTK+ 1.2 or better))
+
+dnl Checks for header files.
+AC_HEADER_STDC
+AC_CHECK_HEADERS(unistd.h sys/param.h sys/time.h time.h sys/mkdev.h sys/sysmacros.h string.h memory.h fcntl.h dirent.h sys/ndir.h ndir.h alloca.h locale.h )
+
+AC_HEADER_MAJOR
+
+dnl Checks for typedefs, structures, and compiler characteristics.
+
+dnl Checks for library functions.
+
+AC_OUTPUT(Makefile m4/Makefile thinnx/Makefile)

Added: thinnx/trunk/install-sh
===================================================================
--- thinnx/trunk/install-sh	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/install-sh	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,269 @@
+#!/bin/sh
+#
+# install - install a program, script, or datafile
+#
+# This originates from X11R5 (mit/util/scripts/install.sh), which was
+# later released in X11R6 (xc/config/util/install.sh) with the
+# following copyright and license.
+#
+# Copyright (C) 1994 X Consortium
+#
+# Permission is hereby granted, free of charge, to any person obtaining a copy
+# of this software and associated documentation files (the "Software"), to
+# deal in the Software without restriction, including without limitation the
+# rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
+# sell copies of the Software, and to permit persons to whom the Software is
+# furnished to do so, subject to the following conditions:
+#
+# The above copyright notice and this permission notice shall be included in
+# all copies or substantial portions of the Software.
+#
+# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL THE
+# X CONSORTIUM BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
+# AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNEC-
+# TION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+#
+# Except as contained in this notice, the name of the X Consortium shall not
+# be used in advertising or otherwise to promote the sale, use or other deal-
+# ings in this Software without prior written authorization from the X Consor-
+# tium.
+#
+#
+# FSF changes to this file are in the public domain.
+#
+# Calling this script install-sh is preferred over install.sh, to prevent
+# `make' implicit rules from creating a file called install from it
+# when there is no Makefile.
+#
+# This script is compatible with the BSD install script, but was written
+# from scratch.  It can only install one file at a time, a restriction
+# shared with many OS's install programs.
+
+
+# set DOITPROG to echo to test this script
+
+# Don't use :- since 4.3BSD and earlier shells don't like it.
+doit="${DOITPROG-}"
+
+
+# put in absolute paths if you don't have them in your path; or use env. vars.
+
+mvprog="${MVPROG-mv}"
+cpprog="${CPPROG-cp}"
+chmodprog="${CHMODPROG-chmod}"
+chownprog="${CHOWNPROG-chown}"
+chgrpprog="${CHGRPPROG-chgrp}"
+stripprog="${STRIPPROG-strip}"
+rmprog="${RMPROG-rm}"
+mkdirprog="${MKDIRPROG-mkdir}"
+
+transformbasename=""
+transform_arg=""
+instcmd="$mvprog"
+chmodcmd="$chmodprog 0755"
+chowncmd=""
+chgrpcmd=""
+stripcmd=""
+rmcmd="$rmprog -f"
+mvcmd="$mvprog"
+src=""
+dst=""
+dir_arg=""
+
+while [ x"$1" != x ]; do
+    case $1 in
+	-c) instcmd="$cpprog"
+	    shift
+	    continue;;
+
+	-d) dir_arg=true
+	    shift
+	    continue;;
+
+	-m) chmodcmd="$chmodprog $2"
+	    shift
+	    shift
+	    continue;;
+
+	-o) chowncmd="$chownprog $2"
+	    shift
+	    shift
+	    continue;;
+
+	-g) chgrpcmd="$chgrpprog $2"
+	    shift
+	    shift
+	    continue;;
+
+	-s) stripcmd="$stripprog"
+	    shift
+	    continue;;
+
+	-t=*) transformarg=`echo $1 | sed 's/-t=//'`
+	    shift
+	    continue;;
+
+	-b=*) transformbasename=`echo $1 | sed 's/-b=//'`
+	    shift
+	    continue;;
+
+	*)  if [ x"$src" = x ]
+	    then
+		src=$1
+	    else
+		# this colon is to work around a 386BSD /bin/sh bug
+		:
+		dst=$1
+	    fi
+	    shift
+	    continue;;
+    esac
+done
+
+if [ x"$src" = x ]
+then
+	echo "install:	no input file specified"
+	exit 1
+else
+	true
+fi
+
+if [ x"$dir_arg" != x ]; then
+	dst=$src
+	src=""
+	
+	if [ -d $dst ]; then
+		instcmd=:
+		chmodcmd=""
+	else
+		instcmd=mkdir
+	fi
+else
+
+# Waiting for this to be detected by the "$instcmd $src $dsttmp" command
+# might cause directories to be created, which would be especially bad 
+# if $src (and thus $dsttmp) contains '*'.
+
+	if [ -f $src -o -d $src ]
+	then
+		true
+	else
+		echo "install:  $src does not exist"
+		exit 1
+	fi
+	
+	if [ x"$dst" = x ]
+	then
+		echo "install:	no destination specified"
+		exit 1
+	else
+		true
+	fi
+
+# If destination is a directory, append the input filename; if your system
+# does not like double slashes in filenames, you may need to add some logic
+
+	if [ -d $dst ]
+	then
+		dst="$dst"/`basename $src`
+	else
+		true
+	fi
+fi
+
+## this sed command emulates the dirname command
+dstdir=`echo $dst | sed -e 's,[^/]*$,,;s,/$,,;s,^$,.,'`
+
+# Make sure that the destination directory exists.
+#  this part is taken from Noah Friedman's mkinstalldirs script
+
+# Skip lots of stat calls in the usual case.
+if [ ! -d "$dstdir" ]; then
+defaultIFS=' 	
+'
+IFS="${IFS-${defaultIFS}}"
+
+oIFS="${IFS}"
+# Some sh's can't handle IFS=/ for some reason.
+IFS='%'
+set - `echo ${dstdir} | sed -e 's@/@%@g' -e 's@^%@/@'`
+IFS="${oIFS}"
+
+pathcomp=''
+
+while [ $# -ne 0 ] ; do
+	pathcomp="${pathcomp}${1}"
+	shift
+
+	if [ ! -d "${pathcomp}" ] ;
+        then
+		$mkdirprog "${pathcomp}"
+	else
+		true
+	fi
+
+	pathcomp="${pathcomp}/"
+done
+fi
+
+if [ x"$dir_arg" != x ]
+then
+	$doit $instcmd $dst &&
+
+	if [ x"$chowncmd" != x ]; then $doit $chowncmd $dst; else true ; fi &&
+	if [ x"$chgrpcmd" != x ]; then $doit $chgrpcmd $dst; else true ; fi &&
+	if [ x"$stripcmd" != x ]; then $doit $stripcmd $dst; else true ; fi &&
+	if [ x"$chmodcmd" != x ]; then $doit $chmodcmd $dst; else true ; fi
+else
+
+# If we're going to rename the final executable, determine the name now.
+
+	if [ x"$transformarg" = x ] 
+	then
+		dstfile=`basename $dst`
+	else
+		dstfile=`basename $dst $transformbasename | 
+			sed $transformarg`$transformbasename
+	fi
+
+# don't allow the sed command to completely eliminate the filename
+
+	if [ x"$dstfile" = x ] 
+	then
+		dstfile=`basename $dst`
+	else
+		true
+	fi
+
+# Make a temp file name in the proper directory.
+
+	dsttmp=$dstdir/#inst.$$#
+
+# Move or copy the file name to the temp name
+
+	$doit $instcmd $src $dsttmp &&
+
+	trap "rm -f ${dsttmp}" 0 &&
+
+# and set any options; do chmod last to preserve setuid bits
+
+# If any of these fail, we abort the whole thing.  If we want to
+# ignore errors from any of these, just make sure not to ignore
+# errors from the above "$doit $instcmd $src $dsttmp" command.
+
+	if [ x"$chowncmd" != x ]; then $doit $chowncmd $dsttmp; else true;fi &&
+	if [ x"$chgrpcmd" != x ]; then $doit $chgrpcmd $dsttmp; else true;fi &&
+	if [ x"$stripcmd" != x ]; then $doit $stripcmd $dsttmp; else true;fi &&
+	if [ x"$chmodcmd" != x ]; then $doit $chmodcmd $dsttmp; else true;fi &&
+
+# Now rename the file to the real destination.
+
+	$doit $rmcmd -f $dstdir/$dstfile &&
+	$doit $mvcmd $dsttmp $dstdir/$dstfile 
+
+fi &&
+
+
+exit 0


Property changes on: thinnx/trunk/install-sh
___________________________________________________________________
Name: svn:executable
   + *

Added: thinnx/trunk/m4/Makefile.am
===================================================================
--- thinnx/trunk/m4/Makefile.am	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/m4/Makefile.am	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1 @@
+EXTRA_DIST = gtk.m4
\ No newline at end of file

Added: thinnx/trunk/m4/gtk.m4
===================================================================
--- thinnx/trunk/m4/gtk.m4	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/m4/gtk.m4	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,194 @@
+# Configure paths for GTK+
+# Owen Taylor     97-11-3
+
+dnl AM_PATH_GTK([MINIMUM-VERSION, [ACTION-IF-FOUND [, ACTION-IF-NOT-FOUND [, MODULES]]]])
+dnl Test for GTK, and define GTK_CFLAGS and GTK_LIBS
+dnl
+AC_DEFUN(AM_PATH_GTK,
+[dnl 
+dnl Get the cflags and libraries from the gtk-config script
+dnl
+AC_ARG_WITH(gtk-prefix,[  --with-gtk-prefix=PFX   Prefix where GTK is installed (optional)],
+            gtk_config_prefix="$withval", gtk_config_prefix="")
+AC_ARG_WITH(gtk-exec-prefix,[  --with-gtk-exec-prefix=PFX Exec prefix where GTK is installed (optional)],
+            gtk_config_exec_prefix="$withval", gtk_config_exec_prefix="")
+AC_ARG_ENABLE(gtktest, [  --disable-gtktest       Do not try to compile and run a test GTK program],
+		    , enable_gtktest=yes)
+
+  for module in . $4
+  do
+      case "$module" in
+         gthread) 
+             gtk_config_args="$gtk_config_args gthread"
+         ;;
+      esac
+  done
+
+  if test x$gtk_config_exec_prefix != x ; then
+     gtk_config_args="$gtk_config_args --exec-prefix=$gtk_config_exec_prefix"
+     if test x${GTK_CONFIG+set} != xset ; then
+        GTK_CONFIG=$gtk_config_exec_prefix/bin/gtk-config
+     fi
+  fi
+  if test x$gtk_config_prefix != x ; then
+     gtk_config_args="$gtk_config_args --prefix=$gtk_config_prefix"
+     if test x${GTK_CONFIG+set} != xset ; then
+        GTK_CONFIG=$gtk_config_prefix/bin/gtk-config
+     fi
+  fi
+
+  AC_PATH_PROG(GTK_CONFIG, gtk-config, no)
+  min_gtk_version=ifelse([$1], ,0.99.7,$1)
+  AC_MSG_CHECKING(for GTK - version >= $min_gtk_version)
+  no_gtk=""
+  if test "$GTK_CONFIG" = "no" ; then
+    no_gtk=yes
+  else
+    GTK_CFLAGS=`$GTK_CONFIG $gtk_config_args --cflags`
+    GTK_LIBS=`$GTK_CONFIG $gtk_config_args --libs`
+    gtk_config_major_version=`$GTK_CONFIG $gtk_config_args --version | \
+           sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\1/'`
+    gtk_config_minor_version=`$GTK_CONFIG $gtk_config_args --version | \
+           sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\2/'`
+    gtk_config_micro_version=`$GTK_CONFIG $gtk_config_args --version | \
+           sed 's/\([[0-9]]*\).\([[0-9]]*\).\([[0-9]]*\)/\3/'`
+    if test "x$enable_gtktest" = "xyes" ; then
+      ac_save_CFLAGS="$CFLAGS"
+      ac_save_LIBS="$LIBS"
+      CFLAGS="$CFLAGS $GTK_CFLAGS"
+      LIBS="$GTK_LIBS $LIBS"
+dnl
+dnl Now check if the installed GTK is sufficiently new. (Also sanity
+dnl checks the results of gtk-config to some extent
+dnl
+      rm -f conf.gtktest
+      AC_TRY_RUN([
+#include <gtk/gtk.h>
+#include <stdio.h>
+#include <stdlib.h>
+
+int 
+main ()
+{
+  int major, minor, micro;
+  char *tmp_version;
+
+  system ("touch conf.gtktest");
+
+  /* HP/UX 9 (%@#!) writes to sscanf strings */
+  tmp_version = g_strdup("$min_gtk_version");
+  if (sscanf(tmp_version, "%d.%d.%d", &major, &minor, &micro) != 3) {
+     printf("%s, bad version string\n", "$min_gtk_version");
+     exit(1);
+   }
+
+  if ((gtk_major_version != $gtk_config_major_version) ||
+      (gtk_minor_version != $gtk_config_minor_version) ||
+      (gtk_micro_version != $gtk_config_micro_version))
+    {
+      printf("\n*** 'gtk-config --version' returned %d.%d.%d, but GTK+ (%d.%d.%d)\n", 
+             $gtk_config_major_version, $gtk_config_minor_version, $gtk_config_micro_version,
+             gtk_major_version, gtk_minor_version, gtk_micro_version);
+      printf ("*** was found! If gtk-config was correct, then it is best\n");
+      printf ("*** to remove the old version of GTK+. You may also be able to fix the error\n");
+      printf("*** by modifying your LD_LIBRARY_PATH enviroment variable, or by editing\n");
+      printf("*** /etc/ld.so.conf. Make sure you have run ldconfig if that is\n");
+      printf("*** required on your system.\n");
+      printf("*** If gtk-config was wrong, set the environment variable GTK_CONFIG\n");
+      printf("*** to point to the correct copy of gtk-config, and remove the file config.cache\n");
+      printf("*** before re-running configure\n");
+    } 
+#if defined (GTK_MAJOR_VERSION) && defined (GTK_MINOR_VERSION) && defined (GTK_MICRO_VERSION)
+  else if ((gtk_major_version != GTK_MAJOR_VERSION) ||
+	   (gtk_minor_version != GTK_MINOR_VERSION) ||
+           (gtk_micro_version != GTK_MICRO_VERSION))
+    {
+      printf("*** GTK+ header files (version %d.%d.%d) do not match\n",
+	     GTK_MAJOR_VERSION, GTK_MINOR_VERSION, GTK_MICRO_VERSION);
+      printf("*** library (version %d.%d.%d)\n",
+	     gtk_major_version, gtk_minor_version, gtk_micro_version);
+    }
+#endif /* defined (GTK_MAJOR_VERSION) ... */
+  else
+    {
+      if ((gtk_major_version > major) ||
+        ((gtk_major_version == major) && (gtk_minor_version > minor)) ||
+        ((gtk_major_version == major) && (gtk_minor_version == minor) && (gtk_micro_version >= micro)))
+      {
+        return 0;
+       }
+     else
+      {
+        printf("\n*** An old version of GTK+ (%d.%d.%d) was found.\n",
+               gtk_major_version, gtk_minor_version, gtk_micro_version);
+        printf("*** You need a version of GTK+ newer than %d.%d.%d. The latest version of\n",
+	       major, minor, micro);
+        printf("*** GTK+ is always available from ftp://ftp.gtk.org.\n");
+        printf("***\n");
+        printf("*** If you have already installed a sufficiently new version, this error\n");
+        printf("*** probably means that the wrong copy of the gtk-config shell script is\n");
+        printf("*** being found. The easiest way to fix this is to remove the old version\n");
+        printf("*** of GTK+, but you can also set the GTK_CONFIG environment to point to the\n");
+        printf("*** correct copy of gtk-config. (In this case, you will have to\n");
+        printf("*** modify your LD_LIBRARY_PATH enviroment variable, or edit /etc/ld.so.conf\n");
+        printf("*** so that the correct libraries are found at run-time))\n");
+      }
+    }
+  return 1;
+}
+],, no_gtk=yes,[echo $ac_n "cross compiling; assumed OK... $ac_c"])
+       CFLAGS="$ac_save_CFLAGS"
+       LIBS="$ac_save_LIBS"
+     fi
+  fi
+  if test "x$no_gtk" = x ; then
+     AC_MSG_RESULT(yes)
+     ifelse([$2], , :, [$2])     
+  else
+     AC_MSG_RESULT(no)
+     if test "$GTK_CONFIG" = "no" ; then
+       echo "*** The gtk-config script installed by GTK could not be found"
+       echo "*** If GTK was installed in PREFIX, make sure PREFIX/bin is in"
+       echo "*** your path, or set the GTK_CONFIG environment variable to the"
+       echo "*** full path to gtk-config."
+     else
+       if test -f conf.gtktest ; then
+        :
+       else
+          echo "*** Could not run GTK test program, checking why..."
+          CFLAGS="$CFLAGS $GTK_CFLAGS"
+          LIBS="$LIBS $GTK_LIBS"
+          AC_TRY_LINK([
+#include <gtk/gtk.h>
+#include <stdio.h>
+],      [ return ((gtk_major_version) || (gtk_minor_version) || (gtk_micro_version)); ],
+        [ echo "*** The test program compiled, but did not run. This usually means"
+          echo "*** that the run-time linker is not finding GTK or finding the wrong"
+          echo "*** version of GTK. If it is not finding GTK, you'll need to set your"
+          echo "*** LD_LIBRARY_PATH environment variable, or edit /etc/ld.so.conf to point"
+          echo "*** to the installed location  Also, make sure you have run ldconfig if that"
+          echo "*** is required on your system"
+	  echo "***"
+          echo "*** If you have an old version installed, it is best to remove it, although"
+          echo "*** you may also be able to get things to work by modifying LD_LIBRARY_PATH"
+          echo "***"
+          echo "*** If you have a RedHat 5.0 system, you should remove the GTK package that"
+          echo "*** came with the system with the command"
+          echo "***"
+          echo "***    rpm --erase --nodeps gtk gtk-devel" ],
+        [ echo "*** The test program failed to compile or link. See the file config.log for the"
+          echo "*** exact error that occured. This usually means GTK was incorrectly installed"
+          echo "*** or that you have moved GTK since it was installed. In the latter case, you"
+          echo "*** may want to edit the gtk-config script: $GTK_CONFIG" ])
+          CFLAGS="$ac_save_CFLAGS"
+          LIBS="$ac_save_LIBS"
+       fi
+     fi
+     GTK_CFLAGS=""
+     GTK_LIBS=""
+     ifelse([$3], , :, [$3])
+  fi
+  AC_SUBST(GTK_CFLAGS)
+  AC_SUBST(GTK_LIBS)
+  rm -f conf.gtktest
+])

Added: thinnx/trunk/missing
===================================================================
--- thinnx/trunk/missing	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/missing	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,198 @@
+#! /bin/sh
+# Common stub for a few missing GNU programs while installing.
+# Copyright (C) 1996, 1997, 2001, 2002 Free Software Foundation, Inc.
+# Franc,ois Pinard <pinard at iro.umontreal.ca>, 1996.
+
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2, or (at your option)
+# any later version.
+
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
+# 02111-1307, USA.
+
+if test $# -eq 0; then
+  echo 1>&2 "Try \`$0 --help' for more information"
+  exit 1
+fi
+
+# In the cases where this matters, `missing' is being run in the
+# srcdir already.
+if test -f configure.in; then
+  configure_ac=configure.ac
+else
+  configure_ac=configure.in
+fi
+
+case "$1" in
+
+  -h|--h|--he|--hel|--help)
+    echo "\
+$0 [OPTION]... PROGRAM [ARGUMENT]...
+
+Handle \`PROGRAM [ARGUMENT]...' for when PROGRAM is missing, or return an
+error status if there is no known handling for PROGRAM.
+
+Options:
+  -h, --help      display this help and exit
+  -v, --version   output version information and exit
+
+Supported PROGRAM values:
+  aclocal      touch file \`aclocal.m4'
+  autoconf     touch file \`configure'
+  autoheader   touch file \`config.h.in'
+  automake     touch all \`Makefile.in' files
+  bison        create \`y.tab.[ch]', if possible, from existing .[ch]
+  flex         create \`lex.yy.c', if possible, from existing .c
+  lex          create \`lex.yy.c', if possible, from existing .c
+  makeinfo     touch the output file
+  yacc         create \`y.tab.[ch]', if possible, from existing .[ch]"
+    ;;
+
+  -v|--v|--ve|--ver|--vers|--versi|--versio|--version)
+    echo "missing - GNU libit 0.0"
+    ;;
+
+  -*)
+    echo 1>&2 "$0: Unknown \`$1' option"
+    echo 1>&2 "Try \`$0 --help' for more information"
+    exit 1
+    ;;
+
+  aclocal*)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`acinclude.m4' or \`$configure_ac'.  You might want
+         to install the \`Automake' and \`Perl' packages.  Grab them from
+         any GNU archive site."
+    touch aclocal.m4
+    ;;
+
+  autoconf)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`$configure_ac'.  You might want to install the
+         \`Autoconf' and \`GNU m4' packages.  Grab them from any GNU
+         archive site."
+    touch configure
+    ;;
+
+  autoheader)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`acconfig.h' or \`$configure_ac'.  You might want
+         to install the \`Autoconf' and \`GNU m4' packages.  Grab them
+         from any GNU archive site."
+    files=`sed -n 's/^[ ]*A[CM]_CONFIG_HEADER(\([^)]*\)).*/\1/p' $configure_ac`
+    test -z "$files" && files="config.h"
+    touch_files=
+    for f in $files; do
+      case "$f" in
+      *:*) touch_files="$touch_files "`echo "$f" |
+				       sed -e 's/^[^:]*://' -e 's/:.*//'`;;
+      *) touch_files="$touch_files $f.in";;
+      esac
+    done
+    touch $touch_files
+    ;;
+
+  automake*)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified \`Makefile.am', \`acinclude.m4' or \`$configure_ac'.
+         You might want to install the \`Automake' and \`Perl' packages.
+         Grab them from any GNU archive site."
+    find . -type f -name Makefile.am -print |
+	   sed 's/\.am$/.in/' |
+	   while read f; do touch "$f"; done
+    ;;
+
+  bison|yacc)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified a \`.y' file.  You may need the \`Bison' package
+         in order for those modifications to take effect.  You can get
+         \`Bison' from any GNU archive site."
+    rm -f y.tab.c y.tab.h
+    if [ $# -ne 1 ]; then
+        eval LASTARG="\${$#}"
+	case "$LASTARG" in
+	*.y)
+	    SRCFILE=`echo "$LASTARG" | sed 's/y$/c/'`
+	    if [ -f "$SRCFILE" ]; then
+	         cp "$SRCFILE" y.tab.c
+	    fi
+	    SRCFILE=`echo "$LASTARG" | sed 's/y$/h/'`
+	    if [ -f "$SRCFILE" ]; then
+	         cp "$SRCFILE" y.tab.h
+	    fi
+	  ;;
+	esac
+    fi
+    if [ ! -f y.tab.h ]; then
+	echo >y.tab.h
+    fi
+    if [ ! -f y.tab.c ]; then
+	echo 'main() { return 0; }' >y.tab.c
+    fi
+    ;;
+
+  lex|flex)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified a \`.l' file.  You may need the \`Flex' package
+         in order for those modifications to take effect.  You can get
+         \`Flex' from any GNU archive site."
+    rm -f lex.yy.c
+    if [ $# -ne 1 ]; then
+        eval LASTARG="\${$#}"
+	case "$LASTARG" in
+	*.l)
+	    SRCFILE=`echo "$LASTARG" | sed 's/l$/c/'`
+	    if [ -f "$SRCFILE" ]; then
+	         cp "$SRCFILE" lex.yy.c
+	    fi
+	  ;;
+	esac
+    fi
+    if [ ! -f lex.yy.c ]; then
+	echo 'main() { return 0; }' >lex.yy.c
+    fi
+    ;;
+
+  makeinfo)
+    echo 1>&2 "\
+WARNING: \`$1' is missing on your system.  You should only need it if
+         you modified a \`.texi' or \`.texinfo' file, or any other file
+         indirectly affecting the aspect of the manual.  The spurious
+         call might also be the consequence of using a buggy \`make' (AIX,
+         DU, IRIX).  You might want to install the \`Texinfo' package or
+         the \`GNU make' package.  Grab either from any GNU archive site."
+    file=`echo "$*" | sed -n 's/.*-o \([^ ]*\).*/\1/p'`
+    if test -z "$file"; then
+      file=`echo "$*" | sed 's/.* \([^ ]*\) *$/\1/'`
+      file=`sed -n '/^@setfilename/ { s/.* \([^ ]*\) *$/\1/; p; q; }' $file`
+    fi
+    touch $file
+    ;;
+
+  *)
+    echo 1>&2 "\
+WARNING: \`$1' is needed, and you do not seem to have it handy on your
+         system.  You might have modified some files without having the
+         proper tools for further handling them.  Check the \`README' file,
+         it often tells you about the needed prerequirements for installing
+         this package.  You may also peek at any GNU archive site, in case
+         some other package would contain this missing \`$1' program."
+    exit 1
+    ;;
+esac
+
+exit 0


Property changes on: thinnx/trunk/missing
___________________________________________________________________
Name: svn:executable
   + *

Added: thinnx/trunk/mkinstalldirs
===================================================================
--- thinnx/trunk/mkinstalldirs	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/mkinstalldirs	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,40 @@
+#! /bin/sh
+# mkinstalldirs --- make directory hierarchy
+# Author: Noah Friedman <friedman at prep.ai.mit.edu>
+# Created: 1993-05-16
+# Public domain
+
+# $Id: mkinstalldirs,v 1.13 1999/01/05 03:18:55 bje Exp $
+
+errstatus=0
+
+for file
+do
+   set fnord `echo ":$file" | sed -ne 's/^:\//#/;s/^://;s/\// /g;s/^#/\//;p'`
+   shift
+
+   pathcomp=
+   for d
+   do
+     pathcomp="$pathcomp$d"
+     case "$pathcomp" in
+       -* ) pathcomp=./$pathcomp ;;
+     esac
+
+     if test ! -d "$pathcomp"; then
+        echo "mkdir $pathcomp"
+
+        mkdir "$pathcomp" || lasterr=$?
+
+        if test ! -d "$pathcomp"; then
+  	  errstatus=$lasterr
+        fi
+     fi
+
+     pathcomp="$pathcomp/"
+   done
+done
+
+exit $errstatus
+
+# mkinstalldirs ends here


Property changes on: thinnx/trunk/mkinstalldirs
___________________________________________________________________
Name: svn:executable
   + *

Added: thinnx/trunk/stamp-h.in
===================================================================
--- thinnx/trunk/stamp-h.in	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/stamp-h.in	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1 @@
+timestamp

Added: thinnx/trunk/thinnx/Makefile.am
===================================================================
--- thinnx/trunk/thinnx/Makefile.am	2005-03-13 16:48:01 UTC (rev 52)
+++ thinnx/trunk/thinnx/Makefile.am	2005-03-13 16:51:24 UTC (rev 53)
@@ -0,0 +1,15 @@
+AM_CFLAGS = -g -O2 -Wall
+INCLUDES = ${GTK_CFLAGS}
+
+bin_PROGRAMS = thinnx
+
+thinnx_SOURCES = thinnx.c
+thinnx_LDADD = ${GTK_LIBS}
+
+# same as the used by thinstation ones, should be changed to
+# ${datadir} sometime soon?
+icondir = ${sysconfdir}/icons
+icon_DATA = thinnx.xpm error.xpm
+
+confdir = ${sysconfdir}/thinnx
+conf_DATA = thinnx.conf.example



From kov at sheep.berlios.de  Sun Mar 13 17:56:41 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Sun, 13 Mar 2005 17:56:41 +0100
Subject: [Freenx-cvs] r54 - thinnx/trunk
Message-ID: <200503131656.j2DGuf9k021469@sheep.berlios.de>

Author: kov
Date: 2005-03-13 17:56:40 +0100 (Sun, 13 Mar 2005)
New Revision: 54

Added:
   thinnx/trunk/INSTALL
Removed:
   thinnx/trunk/nxclient/
Log:
nxclient here? uh?
missed INSTALL on last svn add


Added: thinnx/trunk/INSTALL
===================================================================
--- thinnx/trunk/INSTALL	2005-03-13 16:51:24 UTC (rev 53)
+++ thinnx/trunk/INSTALL	2005-03-13 16:56:40 UTC (rev 54)
@@ -0,0 +1,182 @@
+Basic Installation
+==================
+
+   These are generic installation instructions.
+
+   The `configure' shell script attempts to guess correct values for
+various system-dependent variables used during compilation.  It uses
+those values to create a `Makefile' in each directory of the package.
+It may also create one or more `.h' files containing system-dependent
+definitions.  Finally, it creates a shell script `config.status' that
+you can run in the future to recreate the current configuration, a file
+`config.cache' that saves the results of its tests to speed up
+reconfiguring, and a file `config.log' containing compiler output
+(useful mainly for debugging `configure').
+
+   If you need to do unusual things to compile the package, please try
+to figure out how `configure' could check whether to do them, and mail
+diffs or instructions to the address given in the `README' so they can
+be considered for the next release.  If at some point `config.cache'
+contains results you don't want to keep, you may remove or edit it.
+
+   The file `configure.in' is used to create `configure' by a program
+called `autoconf'.  You only need `configure.in' if you want to change
+it or regenerate `configure' using a newer version of `autoconf'.
+
+The simplest way to compile this package is:
+
+  1. `cd' to the directory containing the package's source code and type
+     `./configure' to configure the package for your system.  If you're
+     using `csh' on an old version of System V, you might need to type
+     `sh ./configure' instead to prevent `csh' from trying to execute
+     `configure' itself.
+
+     Running `configure' takes awhile.  While running, it prints some
+     messages telling which features it is checking for.
+
+  2. Type `make' to compile the package.
+
+  3. Optionally, type `make check' to run any self-tests that come with
+     the package.
+
+  4. Type `make install' to install the programs and any data files and
+     documentation.
+
+  5. You can remove the program binaries and object files from the
+     source code directory by typing `make clean'.  To also remove the
+     files that `configure' created (so you can compile the package for
+     a different kind of computer), type `make distclean'.  There is
+     also a `make maintainer-clean' target, but that is intended mainly
+     for the package's developers.  If you use it, you may have to get
+     all sorts of other programs in order to regenerate files that came
+     with the distribution.
+
+Compilers and Options
+=====================
+
+   Some systems require unusual options for compilation or linking that
+the `configure' script does not know about.  You can give `configure'
+initial values for variables by setting them in the environment.  Using
+a Bourne-compatible shell, you can do that on the command line like
+this:
+     CC=c89 CFLAGS=-O2 LIBS=-lposix ./configure
+
+Or on systems that have the `env' program, you can do it like this:
+     env CPPFLAGS=-I/usr/local/include LDFLAGS=-s ./configure
+
+Compiling For Multiple Architectures
+====================================
+
+   You can compile the package for more than one kind of computer at the
+same time, by placing the object files for each architecture in their
+own directory.  To do this, you must use a version of `make' that
+supports the `VPATH' variable, such as GNU `make'.  `cd' to the
+directory where you want the object files and executables to go and run
+the `configure' script.  `configure' automatically checks for the
+source code in the directory that `configure' is in and in `..'.
+
+   If you have to use a `make' that does not supports the `VPATH'
+variable, you have to compile the package for one architecture at a time
+in the source code directory.  After you have installed the package for
+one architecture, use `make distclean' before reconfiguring for another
+architecture.
+
+Installation Names
+==================
+
+   By default, `make install' will install the package's files in
+`/usr/local/bin', `/usr/local/man', etc.  You can specify an
+installation prefix other than `/usr/local' by giving `configure' the
+option `--prefix=PATH'.
+
+   You can specify separate installation prefixes for
+architecture-specific files and architecture-independent files.  If you
+give `configure' the option `--exec-prefix=PATH', the package will use
+PATH as the prefix for installing programs and libraries.
+Documentation and other data files will still use the regular prefix.
+
+   In addition, if you use an unusual directory layout you can give
+options like `--bindir=PATH' to specify different values for particular
+kinds of files.  Run `configure --help' for a list of the directories
+you can set and what kinds of files go in them.
+
+   If the package supports it, you can cause programs to be installed
+with an extra prefix or suffix on their names by giving `configure' the
+option `--program-prefix=PREFIX' or `--program-suffix=SUFFIX'.
+
+Optional Features
+=================
+
+   Some packages pay attention to `--enable-FEATURE' options to
+`configure', where FEATURE indicates an optional part of the package.
+They may also pay attention to `--with-PACKAGE' options, where PACKAGE
+is something like `gnu-as' or `x' (for the X Window System).  The
+`README' should mention any `--enable-' and `--with-' options that the
+package recognizes.
+
+   For packages that use the X Window System, `configure' can usually
+find the X include and library files automatically, but if it doesn't,
+you can use the `configure' options `--x-includes=DIR' and
+`--x-libraries=DIR' to specify their locations.
+
+Specifying the System Type
+==========================
+
+   There may be some features `configure' can not figure out
+automatically, but needs to determine by the type of host the package
+will run on.  Usually `configure' can figure that out, but if it prints
+a message saying it can not guess the host type, give it the
+`--host=TYPE' option.  TYPE can either be a short name for the system
+type, such as `sun4', or a canonical name with three fields:
+     CPU-COMPANY-SYSTEM
+
+See the file `config.sub' for the possible values of each field.  If
+`config.sub' isn't included in this package, then this package doesn't
+need to know the host type.
+
+   If you are building compiler tools for cross-compiling, you can also
+use the `--target=TYPE' option to select the type of system they will
+produce code for and the `--build=TYPE' option to select the type of
+system on which you are compiling the package.
+
+Sharing Defaults
+================
+
+   If you want to set default values for `configure' scripts to share,
+you can create a site shell script called `config.site' that gives
+default values for variables like `CC', `cache_file', and `prefix'.
+`configure' looks for `PREFIX/share/config.site' if it exists, then
+`PREFIX/etc/config.site' if it exists.  Or, you can set the
+`CONFIG_SITE' environment variable to the location of the site script.
+A warning: not all `configure' scripts look for a site script.
+
+Operation Controls
+==================
+
+   `configure' recognizes the following options to control how it
+operates.
+
+`--cache-file=FILE'
+     Use and save the results of the tests in FILE instead of
+     `./config.cache'.  Set FILE to `/dev/null' to disable caching, for
+     debugging `configure'.
+
+`--help'
+     Print a summary of the options to `configure', and exit.
+
+`--quiet'
+`--silent'
+`-q'
+     Do not print messages saying which checks are being made.  To
+     suppress all normal output, redirect it to `/dev/null' (any error
+     messages will still be shown).
+
+`--srcdir=DIR'
+     Look for the package's source code in directory DIR.  Usually
+     `configure' can determine that directory automatically.
+
+`--version'
+     Print the version of Autoconf used to generate the `configure'
+     script, and exit.
+
+`configure' also accepts some other, not widely useful, options.



From freenx-cvs at berlios.de  Mon Mar 14 01:51:22 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Mon, 14 Mar 2005 01:51:22 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxserver
Message-ID: <4234E00A.mail1K8112NDI@lists.berlios.de>

User:      fabianx
Date:      2005-03-14 00:51:22 GMT
Modified:  .        nxserver
Log:
Implemented correct usage of option-flags in listing of suspended sessions.

Revision  Changes    Path
1.42      +5 -2      freenx/nxserver


rev 1.42, prev_rev 1.41
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.41
retrieving revision 1.42
diff -u -r1.41 -r1.42
--- nxserver	13 Mar 2005 15:39:33 -0000	1.41
+++ nxserver	14 Mar 2005 00:51:21 -0000	1.42
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.41 2005/03/13 15:39:33 fabianx Exp $
+# CVS: $Id: nxserver,v 1.42 2005/03/14 00:51:21 fabianx Exp $
 #
 
 # Read the config file
@@ -232,13 +232,16 @@
 		if egrep -q "^userName=$1$" $i && egrep -q "^status=$2$" $i #&& grep -q "screeninfo=$3" $i
 		then
 			CMDLINE=$(session_get_cmdline $i)
-			options="-R---PSA"
 			depth=$(getparam screeninfo | cut -d "x" -f3 | cut -d "+" -f1 )
 			geom=$(getparam screeninfo | cut -d "x" -f1,2) 
 			render=$(getparam screeninfo | cut -d "+" -f2 )
 			available="N/A"
 			udepth=$(echo $3 | cut -d "x" -f3 | cut -d "+" -f1 )
 			urender=$(echo $3 | cut -d "+" -f2 )
+			[ "$(getparam geometry)" = "fullscreen" ] && options="F"
+			[ "$(getparam geometry)" = "fullscreen" ] || options="-"
+			[ "$urender" = "render" ] && options="${options}R---PSA"
+			[ "$urender" = "render" ] || options="${options}----PSA"
 			[ "$udepth" = "$depth" -a "$urender" = "$render" ] && available=$(getparam status)
 			# FIXME: HACK !!! to keep compatibility with old snapshot version (Knoppix 3.6 based for example)
 			if [ -z "$4" -a "$available" != "N/A" ] 






From freenx-cvs at berlios.de  Mon Mar 14 01:56:35 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Mon, 14 Mar 2005 01:56:35 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <4234E143.mail2FS12QQ24@lists.berlios.de>

User:      fabianx
Date:      2005-03-14 00:56:35 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog nxserver
Log:
Fixed resume of multiple suspended sessions.

Explanation:

The nxclient sends "Suspended,Running" at the first attempt. At the second attempt it just sends "Suspended", but the code "thought" that it was an older client version that way. So there were no longer any resumable sessions.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.9  +1 -0      freenx/ChangeLog


rev 1.16.2.9, prev_rev 1.16.2.8
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.8
retrieving revision 1.16.2.9
diff -u -r1.16.2.8 -r1.16.2.9
--- ChangeLog	13 Mar 2005 15:35:27 -0000	1.16.2.8
+++ ChangeLog	14 Mar 2005 00:56:34 -0000	1.16.2.9
@@ -7,6 +7,7 @@
 	* Fixed error message shown to user, when session startup fails.
 	* Fixed handling of /tmp/.X*-lock files.
 	* Fixed handling of not closed sessions in "Terminating" status.
+	* Fixed resume of multiple suspended sessions.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.24.2.5  +3 -3      freenx/nxserver


rev 1.24.2.5, prev_rev 1.24.2.4
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.24.2.4
retrieving revision 1.24.2.5
diff -u -r1.24.2.4 -r1.24.2.5
--- nxserver	13 Mar 2005 15:35:27 -0000	1.24.2.4
+++ nxserver	14 Mar 2005 00:56:34 -0000	1.24.2.5
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.24.2.4 2005/03/13 15:35:27 fabianx Exp $
+# CVS: $Id: nxserver,v 1.24.2.5 2005/03/14 00:56:34 fabianx Exp $
 #
 
 # Read the config file
@@ -773,10 +773,10 @@
 
 			status=$(getparam status)
 
-			if [ "$status" = "Suspended" ]
+			if [ "$status" = "Suspended" -a -n "$(getparam screeninfo)" ]
 			then
 				session_list_user_suspended "$USER" "Suspended" "$(getparam screeninfo)" "$(getparam type)" | log_tee
-			elif [ "$status" = "Suspended,Running" ] # since 1.4.0-5
+			elif [ "$status" = "Suspended,Running" -o "$status" = "Suspended" ] # since 1.4.0-5
 			then
 				# disabled due to problems with 1.4.0-5 client
 				#session_list_user_suspended "$USER" 'Suspended$|^status=Running$' "$(getparam geometry)" "$(getparam type)" | log_tee






From freenx-cvs at berlios.de  Mon Mar 14 02:17:10 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Mon, 14 Mar 2005 02:17:10 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified 2 files
Message-ID: <4234E616.mail5NW11D3J3@lists.berlios.de>

User:      fabianx
Date:      2005-03-14 01:17:09 GMT
Modified:  .        ChangeLog nxserver
Log:
Fixed resume of multiple suspended sessions.

Explanation:

The nxclient sends "Suspended,Running" at the first attempt. At the second attempt it just sends "Suspended", but the code "thought" that it was an older client version that way. So there were no longer any resumable sessions.

(ported from 0.3.0-bugfixes branch)

Revision  Changes    Path
1.38      +1 -0      freenx/ChangeLog


rev 1.38, prev_rev 1.37
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.37
retrieving revision 1.38
diff -u -r1.37 -r1.38
--- ChangeLog	13 Mar 2005 15:39:33 -0000	1.37
+++ ChangeLog	14 Mar 2005 01:17:09 -0000	1.38
@@ -27,6 +27,7 @@
 	* Fixed error message shown to user, when session startup fails.
 	* Fixed handling of /tmp/.X*-lock files.
 	* Fixed handling of not closed sessions in "Terminating" status.
+	* Fixed resume of multiple suspended sessions.
 
 05.03.2005 FreeNX 0.3.0 "Chemnitzer LinuxTage Edition"
 	* Initial CVS checkin.



1.43      +3 -3      freenx/nxserver


rev 1.43, prev_rev 1.42
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.42
retrieving revision 1.43
diff -u -r1.42 -r1.43
--- nxserver	14 Mar 2005 00:51:21 -0000	1.42
+++ nxserver	14 Mar 2005 01:17:09 -0000	1.43
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.42 2005/03/14 00:51:21 fabianx Exp $
+# CVS: $Id: nxserver,v 1.43 2005/03/14 01:17:09 fabianx Exp $
 #
 
 # Read the config file
@@ -885,10 +885,10 @@
 
 			status=$(getparam status)
 
-			if [ "$status" = "Suspended" ]
+			if [ "$status" = "Suspended" -a -n "$(getparam screeninfo)" ]
 			then
 				session_list_user_suspended "$USER" "Suspended" "$(getparam screeninfo)" "$(getparam type)" | log_tee
-			elif [ "$status" = "Suspended,Running" ] # since 1.4.0-5
+			elif [ "$status" = "Suspended,Running" -o "$status" = "Suspended" ] # since 1.4.0-5
 			then
 				# disabled due to problems with 1.4.0-5 client
 				#session_list_user_suspended "$USER" 'Suspended$|^status=Running$' "$(getparam geometry)" "$(getparam type)" | log_tee






From freenx-cvs at berlios.de  Tue Mar 15 05:11:50 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Tue, 15 Mar 2005 05:11:50 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxprint
Message-ID: <42366086.mail5AY11RZ8F@lists.berlios.de>

User:      fabianx
Date:      2005-03-15 04:11:50 GMT
Added:     .        nxprint
Log:
Added nxprint component. (needed for printing support)

Usage:

nxprint --drivers

or

nxprint --printers

Revision  Changes    Path
1.1                  freenx/nxprint


rev 1.1, prev_rev 1.0
Index: nxprint
===================================================================
#!/bin/bash
#
# nxprint - Prints a list of available drivers or printers
# 
# Copyright (c) 2005 by Fabian Franz <freenx at fabian-franz.de>
#
# License: GPL, version 2
#
#

# disable foomatic by default
FOOMATIC="no"

HELP="no"
DRIVERS="no"
PRINTERS="no"

while [ "$1" ]
do
        case "$1" in
                --help) HELP="yes"; shift ;;
                --drivers|-d) DRIVERS="yes"; shift ;;
                --printers|-l) PRINTERS="yes"; shift ;;
                --) shift ; break ;;
                *) echo "Invalid flag $1" ; HELP="yes"; shift ; break ;;
        esac
done

[ "$DRIVERS" = "no" -a "$PRINTERS" = "no" ] && HELP="yes"

if [ "$HELP" = "yes" ]
then
        echo "nxprint - Prints a list of available drivers or printers"
	echo ""
        echo "Syntax: nxprint --help"
        echo "        nxprint --drivers"
        echo "        nxprint --printes"
        echo
        echo "  --drivers                prints a list of available CUPS drivers"
        echo "  --printers               prints a list of available CUPS printers"
        exit 0
fi

if [ "$DRIVERS" = "yes" ]
then
	echo "driver|Raw|Raw Queue|raw"
	{ 
        cd /usr/share/cups/model
        awk -F '"' '/*Manufacturer:/ { a[FILENAME]=$2 }
                    /*NickName:/ { b[FILENAME]=$2 } 
                    END { 
                       for (i in a) 
                          print "driver|" (a[i]=="ESP"?substr(b[i],0,index(b[i]," ")-1):a[i]) "|"b[i]"|"i
                    }' *.ppd
        } | sort

	if [ $FOOMATIC="yes" ]
	then
		# TODO: Add support for foomatic-style ppds
		:
	fi
fi

if [ "$PRINTERS" = "yes" ]
then
	lpstat -p | awk '{ print $1 "|" $2 }'
fi






From freenx-cvs at berlios.de  Tue Mar 15 22:12:54 2005
From: freenx-cvs at berlios.de (fux)
Date: Tue, 15 Mar 2005 22:12:54 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified INSTALL
Message-ID: <42374FD6.mail4Q618ZWR2@lists.berlios.de>

User:      fux
Date:      2005-03-15 21:12:54 GMT
Modified:  .        INSTALL
Log:
Added install-instructions for keymap-windows-installtion in nxdesktop

Revision  Changes    Path
1.5       +4 -0      freenx/INSTALL


rev 1.5, prev_rev 1.4
Index: INSTALL
===================================================================
RCS file: /cvsroot/freenx/freenx/INSTALL,v
retrieving revision 1.4
retrieving revision 1.5
diff -u -r1.4 -r1.5
--- INSTALL	15 Feb 2005 22:25:00 -0000	1.4
+++ INSTALL	15 Mar 2005 21:12:54 -0000	1.5
@@ -45,6 +45,10 @@
 cp -a nxviewer/nxviewer ${NXPREFIX}/bin
 cp -a nxviewer/nxpasswd ${NXPREFIX}/bin
 
+# windows-keymaps for nxdesktop RDP-sessions and keyboard layout != us
+cd nxdesktop
+make installkeymaps
+
 # scripts
 cp -a freenx*/nxnode ${NXPREFIX}/bin
 cp -a freenx*/nxserver ${NXPREFIX}/bin






From freenx-cvs at berlios.de  Tue Mar 15 22:29:42 2005
From: freenx-cvs at berlios.de (fux)
Date: Tue, 15 Mar 2005 22:29:42 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified 2 files
Message-ID: <423753C6.mail6RT1X7NK4@lists.berlios.de>

User:      fux
Date:      2005-03-15 21:29:42 GMT
Modified:  .        AUTHORS ChangeLog
Log:
fixed my emailadress

Revision  Changes    Path
1.4       +1 -1      freenx/AUTHORS


rev 1.4, prev_rev 1.3
Index: AUTHORS
===================================================================
RCS file: /cvsroot/freenx/freenx/AUTHORS,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -r1.3 -r1.4
--- AUTHORS	1 Feb 2005 00:33:43 -0000	1.3
+++ AUTHORS	15 Mar 2005 21:29:42 -0000	1.4
@@ -1,5 +1,5 @@
 Fabian Franz <freenx at fabian-franz.de>
 Rick Stout <zipsonic at gmail.com>
-Thorsten Sandfuchs <fux at akk.org>
+Thorsten Sandfuchs <fux at users.berlios.de>
 Kurt Pfeifle <pfeifle at kde.org>
 Jon Severinsson <jonno at users.berlios.de>



1.39      +1 -1      freenx/ChangeLog


rev 1.39, prev_rev 1.38
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.38
retrieving revision 1.39
diff -u -r1.38 -r1.39
--- ChangeLog	14 Mar 2005 01:17:09 -0000	1.38
+++ ChangeLog	15 Mar 2005 21:29:42 -0000	1.39
@@ -34,7 +34,7 @@
 	* Added unix-default as session type - by Kalev Lember 
 	  <kalev at smartlink.ee>
 	* Fixed nxclient loop - by "Neil Wilson" <neil at aldur.co.uk>.
-	* Several fixes by Thorsten Sandfuchs <fux at akk.org>.
+	* Several fixes by Thorsten Sandfuchs <fux at users.berlios.de>.
 	* Optional config file support (system- and user-wide)
 		- by Jon Severinsson <jonno at users.berlios.de>.
 	* Moved logfile to /var/log/nxserver.log.






From freenx-cvs at berlios.de  Wed Mar 16 09:03:07 2005
From: freenx-cvs at berlios.de (fux)
Date: Wed, 16 Mar 2005 09:03:07 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified nxnode
Message-ID: <4237E83B.mailDVK1L70MR@lists.berlios.de>

User:      fux
Date:      2005-03-16 08:03:07 GMT
Modified:  .        nxnode
Log:
fixed fullscreenmode in vnc-session and nxviewer-commandline
BUG: geometry-parameter is passed too, but doesn't seem to be intrepreted by nxviewer
BUG: keyboard-focus doesn't seem to be passed to the fullscreen nxviewer

Revision  Changes    Path
1.46      +4 -2      freenx/nxnode


rev 1.46, prev_rev 1.45
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.45
retrieving revision 1.46
diff -u -r1.45 -r1.46
--- nxnode	13 Mar 2005 13:15:43 -0000	1.45
+++ nxnode	16 Mar 2005 08:03:06 -0000	1.46
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.45 2005/03/13 13:15:43 fabianx Exp $
+# CVS: $Id: nxnode,v 1.46 2005/03/16 08:03:06 fux Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -235,6 +235,8 @@
 	[ -n "$geometry" ] && G="-geometry $geometry"
 	R=""
 	[ "$virtualdesktop" = "0" ] && R="-rootless"
+	vncfullscreen=""
+	[ "$geometry" == "fullscreen" ] && vncfullscreen="-fullscreen" && G=""
 
 	if [ "$type" = "windows" ]
 	then
@@ -251,7 +253,7 @@
 		[ "$SET_LD_LIBRARY_PATH" = "1" ] && export LD_LIBRARY_PATH="$AGENT_LIBRARY_PATH:$LD_LIBRARY_PATH"
 		mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/scripts/
 		echo "$agent_password" | $PATH_BIN/nxpasswd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd doit
-		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)"  $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
+		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $vncfullscreen $G  $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	elif [ -n "$R" -a "$ENABLE_ROOTLESS_MODE" != "1" ]
 	then
 		# nxproxy single application mode session






From freenx-cvs at berlios.de  Wed Mar 16 09:16:05 2005
From: freenx-cvs at berlios.de (fux)
Date: Wed, 16 Mar 2005 09:16:05 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified ChangeLog
Message-ID: <4237EB45.mailEWL14PKXW@lists.berlios.de>

User:      fux
Date:      2005-03-16 08:16:05 GMT
Modified:  .        ChangeLog
Log:
nxviewer-changes mentioned in the Changelog

Revision  Changes    Path
1.40      +2 -1      freenx/ChangeLog


rev 1.40, prev_rev 1.39
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.39
retrieving revision 1.40
diff -u -r1.39 -r1.40
--- ChangeLog	15 Mar 2005 21:29:42 -0000	1.39
+++ ChangeLog	16 Mar 2005 08:16:04 -0000	1.40
@@ -7,7 +7,7 @@
 	* Added initial support for sound (esd/artsd).
 	* Added optional support for utmp/wtmp/lastlog database.
 	* Removed support for OSS components prior version 1.4.0 in nxnode.
-	  Added -option option to nxagent/nxdesktop.
+	  Added -option option to nxagent/nxdesktop/nxviewer.
 	* Added forwarding to commercial server via destination port.
 	* Added more compatible getparam function
 	* Sets LD_PRELOAD for applications and LD_LIBRARY_PATH for nxagent/nxproxy by default.
@@ -17,6 +17,7 @@
 	* Added the SESSION_HISTORY directive. Session history will by default be kept for 30 days.
 	* Implemented DEFAULT_X_WM for unix-application virtual desktop mode.
 	* Implemented SESSION_LIMIT and SESSION_USER_LIMIT.
+	* Fixed nxviewer commandline for geometry and fullscreen-support
 
 11.03.2005 FreeNX 0.3.1
 	* Fixed keyboard mapping problems.






From freenx-cvs at berlios.de  Wed Mar 16 10:50:38 2005
From: freenx-cvs at berlios.de (fux)
Date: Wed, 16 Mar 2005 10:50:38 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified nxnode
Message-ID: <4238016E.mailNEF11PWT1@lists.berlios.de>

User:      fux
Date:      2005-03-16 09:50:37 GMT
Modified:  .        nxnode
Log:
vnc-fullscreen killed geometry for other sessions, fixed.

Revision  Changes    Path
1.47      +2 -2      freenx/nxnode


rev 1.47, prev_rev 1.46
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.46
retrieving revision 1.47
diff -u -r1.46 -r1.47
--- nxnode	16 Mar 2005 08:03:06 -0000	1.46
+++ nxnode	16 Mar 2005 09:50:37 -0000	1.47
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.46 2005/03/16 08:03:06 fux Exp $
+# CVS: $Id: nxnode,v 1.47 2005/03/16 09:50:37 fux Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -236,7 +236,7 @@
 	R=""
 	[ "$virtualdesktop" = "0" ] && R="-rootless"
 	vncfullscreen=""
-	[ "$geometry" == "fullscreen" ] && vncfullscreen="-fullscreen" && G=""
+	[ "$geometry" = "fullscreen" && "$type" = "vnc" ] && vncfullscreen="-fullscreen" && G=""
 
 	if [ "$type" = "windows" ]
 	then






From freenx-cvs at berlios.de  Wed Mar 16 11:57:08 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Wed, 16 Mar 2005 11:57:08 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified ChangeLog
Message-ID: <42381104.mail1LY1PDHE7@lists.berlios.de>

User:      fabianx
Date:      2005-03-16 10:57:08 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog
Log:
Changed ChangeLog to reflect that the stable 0.3.0 branch is not yet released.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.10 +1 -1      freenx/ChangeLog


rev 1.16.2.10, prev_rev 1.16.2.9
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.9
retrieving revision 1.16.2.10
diff -u -r1.16.2.9 -r1.16.2.10
--- ChangeLog	14 Mar 2005 00:56:34 -0000	1.16.2.9
+++ ChangeLog	16 Mar 2005 10:57:06 -0000	1.16.2.10
@@ -1,4 +1,4 @@
-11.03.2005 FreeNX 0.3.1
+XX.03.2005 FreeNX 0.3.1-CVS
 	* Fixed keyboard mapping problems.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.






From freenx-cvs at berlios.de  Wed Mar 16 11:59:24 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Wed, 16 Mar 2005 11:59:24 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified ChangeLog
Message-ID: <4238118C.mail1QY11GNXK@lists.berlios.de>

User:      fabianx
Date:      2005-03-16 10:59:24 GMT
Modified:  .        ChangeLog
Log:
Changed ChangeLog to reflect that the stable 0.3.0 branch is not yet released as 0.3.1.
(ported from 0.3.0-bugfixes branch)

Revision  Changes    Path
1.41      +1 -1      freenx/ChangeLog


rev 1.41, prev_rev 1.40
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.40
retrieving revision 1.41
diff -u -r1.40 -r1.41
--- ChangeLog	16 Mar 2005 08:16:04 -0000	1.40
+++ ChangeLog	16 Mar 2005 10:59:24 -0000	1.41
@@ -19,7 +19,7 @@
 	* Implemented SESSION_LIMIT and SESSION_USER_LIMIT.
 	* Fixed nxviewer commandline for geometry and fullscreen-support
 
-11.03.2005 FreeNX 0.3.1
+XX.03.2005 FreeNX 0.3.1-CVS
 	* Fixed keyboard mapping problems.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.






From freenx-cvs at berlios.de  Wed Mar 16 14:58:42 2005
From: freenx-cvs at berlios.de (jonno)
Date: Wed, 16 Mar 2005 14:58:42 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 5 files
Message-ID: <42383B92.mail88311M6FB@lists.berlios.de>

User:      jonno
Date:      2005-03-16 13:58:42 GMT
Modified:  .        ChangeLog node.conf.sample nxloadconfig nxnode
Modified:           nxserver
Log:
Added configurable verbosity of logging.

Revision  Changes    Path
1.42      +2 -0      freenx/ChangeLog


rev 1.42, prev_rev 1.41
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.41
retrieving revision 1.42
diff -u -r1.41 -r1.42
--- ChangeLog	16 Mar 2005 10:59:24 -0000	1.41
+++ ChangeLog	16 Mar 2005 13:58:42 -0000	1.42
@@ -18,6 +18,8 @@
 	* Implemented DEFAULT_X_WM for unix-application virtual desktop mode.
 	* Implemented SESSION_LIMIT and SESSION_USER_LIMIT.
 	* Fixed nxviewer commandline for geometry and fullscreen-support
+	* Added NX_LOG_LEVEL instead of NX_LOGGING, allowing less verbose logfile.
+	* Added SESSION_LOG_CLEAN for configurable removal of the temporary session directory.
 
 XX.03.2005 FreeNX 0.3.1-CVS
 	* Fixed keyboard mapping problems.



1.17      +19 -4     freenx/node.conf.sample


rev 1.17, prev_rev 1.16
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.16
retrieving revision 1.17
diff -u -r1.16 -r1.17
--- node.conf.sample	13 Mar 2005 15:12:16 -0000	1.16
+++ node.conf.sample	16 Mar 2005 13:58:42 -0000	1.17
@@ -37,19 +37,34 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.16 2005/03/13 15:12:16 fabianx Exp $
+# CVS: $Id: node.conf.sample,v 1.17 2005/03/16 13:58:42 jonno Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
 #########################################################################
 
-# Logfile directives
+# This directives controls the verbosity of the server-wide log.
+# 0: No Logging, 
+# 1: Errors
+# 2: Warnings
+# 3: Important information
+# 4: Server - Client communication
+# 5: Information
+# 6: Debugging information
+#NX_LOG_LEVEL=0
+
 # Before turning logging on, please make sure that NX_LOGFILE is 
 # writeable for the "nx" user
-#NX_LOGGING=0
 #NX_LOGFILE=/var/log/nxserver.log
 
-# Amount of seconds nxserver is to keep session data. The default of 2592000
+# This directive controls if the temporary session directory 
+# ($HOME/.nx/C-<hostname>-<display>-<session_id>) should be kept after a 
+# session has ended. A successfullty terminated session will be saved as 
+# T-C-<hostname>-<display>-<session_id> while a failed session will be saved 
+# as F-C-<hostname>-<display>-<session_id>.
+#SESSION_LOG_CLEAN=0
+
+# Amount of seconds nxserver is to keep session history. The default of 2592000
 # is equivalent to 30 days. If this is 0 no session history will be kept,
 # and a negative value denotes infinity.
 #SESSION_HISTORY=2592000



1.21      +8 -5      freenx/nxloadconfig


rev 1.21, prev_rev 1.20
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.20
retrieving revision 1.21
diff -u -r1.20 -r1.21
--- nxloadconfig	13 Mar 2005 15:12:16 -0000	1.20
+++ nxloadconfig	16 Mar 2005 13:58:42 -0000	1.21
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.20 2005/03/13 15:12:16 fabianx Exp $
+# CVS: $Id: nxloadconfig,v 1.21 2005/03/16 13:58:42 jonno Exp $
 #
 # ========================================================================
 
@@ -68,8 +68,9 @@
 # DO NOT EVER TOUCH THIS, edit $NX_ETC_DIR/node.conf instead
 #########################################################################
 
-NX_LOGGING=0
+NX_LOG_LEVEL=0
 NX_LOGFILE=/var/log/nxserver.log
+SESSION_LOG_CLEAN=1
 SESSION_HISTORY=2592000
 
 ENABLE_PASSDB_AUTHENTICATION="1"
@@ -209,12 +210,14 @@
 	[ -z "$SSH_AUTHORIZED_KEYS" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SSH_AUTHORIZED_KEYS=$SSH_AUTHORIZED_KEYS\"" 
 	
-	[ -z $(echo "$NX_LOGGING" | egrep "^[0|1]$") ] && \
-		ERROR="yes" && echo "Error: Invalid value \"NX_LOGGING=$NX_LOGGING\""
-	[ "$NX_LOGGING" = "1" -a ! -e "$NX_LOGFILE" ] && \
+	[ -z $(echo "$NX_LOG_LEVEL" | egrep "^[0-7]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"NX_LOG_LEVEL=$NX_LOG_LEVEL\""
+	[ "$NX_LOG_LEVEL" != "0" -a ! -e "$NX_LOGFILE" ] && \
 		WARNING="yes" && echo "Warning: Invalid value \"NX_LOGFILE=$NX_LOGFILE\"" \
 					  && echo "         No loggfile will be kept."
 		# How do I check if another user might write to a file? ( -w checks only current user)
+	[ -z $(echo "$SESSION_LOG_CLEAN" | egrep "^[0|1]$") ] && \
+		ERROR="yes" && echo "Error: Invalid value \"SESSION_LOG_CLEAN=$SESSION_LOG_CLEAN\""
 	[ -z $(echo "$SESSION_HISTORY" | egrep "^-?[0-9]+$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SESSION_HISTORY=$SESSION_HISTORY\""
 	



1.48      +16 -16    freenx/nxnode


rev 1.48, prev_rev 1.47
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.47
retrieving revision 1.48
diff -u -r1.47 -r1.48
--- nxnode	16 Mar 2005 09:50:37 -0000	1.47
+++ nxnode	16 Mar 2005 13:58:42 -0000	1.48
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.47 2005/03/16 09:50:37 fux Exp $
+# CVS: $Id: nxnode,v 1.48 2005/03/16 13:58:42 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -58,6 +58,12 @@
 	[ $UID -eq 0 ] || $(whoami)
 }
 
+node_abort()
+{
+	echo "$@" 1>&2
+	exit 1
+}
+
 getparam_sessionid()
 {
 	sessionid=$(getparam sessionid)
@@ -67,13 +73,6 @@
 	echo $sessionid
 }
 
-node_abort()
-{
-	echo "$@" 1>&2
-	exit 1
-}
-
-
 
 node_terminate_agent()
 {
@@ -102,15 +101,15 @@
 	# remove cookie
 	$COMMAND_XAUTH -v source $USER_FAKE_HOME/.nx/C-$sess_id/scripts/authority >/dev/null 2>&1
 	# FIXME: What to do on errors ... ?
-	# TODO: Add parsing of var ...
-	#mv $USER_FAKE_HOME/.nx/C-$1/ $USER_FAKE_HOME/.nx/F-C-$1/
-	rm -rf $USER_FAKE_HOME/.nx/C-$1/
+	[ "$SESSION_LOG_CLEAN" = "1" ] && rm -rf $USER_FAKE_HOME/.nx/C-$1/
+	[ "$SESSION_LOG_CLEAN" = "0" -a "$2" = "failed" ] && mv $USER_FAKE_HOME/.nx/C-$1/ $USER_FAKE_HOME/.nx/F-C-$1/
+	[ "$SESSION_LOG_CLEAN" = "0" -a "$2" != "failed" ] && mv $USER_FAKE_HOME/.nx/C-$1/ $USER_FAKE_HOME/.nx/T-C-$1/
 }
 
 node_fail_restore_session()
 {
 	echo "NX> 1004 Error: Could not resume session. nxagent process could not be found."
-	node_terminate_session "$sess_id"
+	node_terminate_session "$sess_id" "failed"
 	exit 1
 }
 
@@ -195,10 +194,10 @@
 	[ "$virtualdesktop" = "0" -a "$ENABLE_ROOTLESS_MODE" != "1" ] && export LD_PRELOAD="$APPLICATION_LIBRARY_PRELOAD:$LD_PRELOAD"
 	if [ "$ENABLE_DEFAULT_X_WM" = "1" -a "$virtualdesktop" = "1" -a "$type" = "unix-application" -a -x "$(find_app $DEFAULT_X_WM)" ]
 	then
-		DISPLAY=unix:$display $DEFAULT_X_WM >> $USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
+		DISPLAY=unix:$display $DEFAULT_X_WM 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 		WM_PID=$!
 	fi
-	DISPLAY=unix:$display $STARTX >>$USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
+	DISPLAY=unix:$display $STARTX 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	APP_PID=$!
 	mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/pids/
 	echo "$APP_PID" > $USER_FAKE_HOME/.nx/C-$sess_id/pids/applications
@@ -473,8 +472,9 @@
 		then
 			kill $TAIL_PID 2>/dev/null
 			echo "NX> 1004 Error:"
-			echo "Session '$sess_id' has failed after reaching usable state. Session directory '$USER_FAKE_HOME/.nx/F-C-$sess_id' will be not deleted to allow for further investigation."
-		#	mv $USER_FAKE_HOME/.nx/C-$sess_id/ $USER_FAKE_HOME/.nx/F-C-$sess_id/
+			echo "Session '$sess_id' has failed after reaching usable state."
+			[ "$SESSION_LOG_CLEAN" = "1" ] && rm -rf $USER_FAKE_HOME/.nx/C-$sess_id/
+			[ "$SESSION_LOG_CLEAN" = "1" ] || mv $USER_FAKE_HOME/.nx/C-$sess_id/ $USER_FAKE_HOME/.nx/F-C-$sess_id/
 			break
 		fi
 	done 



1.44      +35 -27    freenx/nxserver


rev 1.44, prev_rev 1.43
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.43
retrieving revision 1.44
diff -u -r1.43 -r1.44
--- nxserver	14 Mar 2005 01:17:09 -0000	1.43
+++ nxserver	16 Mar 2005 13:58:42 -0000	1.44
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.43 2005/03/14 01:17:09 fabianx Exp $
+# CVS: $Id: nxserver,v 1.44 2005/03/16 13:58:42 jonno Exp $
 #
 
 # Read the config file
@@ -388,20 +388,28 @@
 if [ $USER = "nxfree" -o "$USER" = "nx" ]
 then
 
+# Loglevels:
+# 1: Errors
+# 2: Warnings
+# 3: Important information
+# 4: Server - Client communication
+# 5: Information
+# 6: Debugging information
+
 log()
 {
-	[ "$NX_LOGGING" = "1" -a -w "$NX_LOGFILE" ] && echo "$@" >> "$NX_LOGFILE"
+	[ "$NX_LOG_LEVEL" -ge "$1" -a -w "$NX_LOGFILE" ] && shift && echo "$@" >> "$NX_LOGFILE"
 }
 
 log_tee()
 {
-	[ "$NX_LOGGING" = "1" -a -w "$NX_LOGFILE" ] && exec tee -a "$NX_LOGFILE"
-	[ "$NX_LOGGING" = "1" -a -w "$NX_LOGFILE" ] || exec cat -
+	[ "$NX_LOG_LEVEL" -ge "4" -a -w "$NX_LOGFILE" ] && exec tee -a "$NX_LOGFILE"
+	[ "$NX_LOG_LEVEL" -ge "4" -a -w "$NX_LOGFILE" ] || exec cat -
 }
 
 echo_x()
 {
-	log "$@"
+	log "4" "$@"
 	echo "$@"
 }
 
@@ -440,7 +448,7 @@
 			;;
 		esac
 	done
-	log "done."
+	log 5 "Info: Forwarding connection to NoMachine server done."
 	cat <&4 &
 	CAT_PID=$!
 	cat - >&3
@@ -451,11 +459,11 @@
 }
 
 # Start!
-log "-- NX SERVER START: $@"
+log 3 "-- NX SERVER START: $@"
 
 if [ "$ENABLE_SERVER_FORWARD" = "1" -a -n "$SERVER_FORWARD_HOST" ]
 then
-	log "Forwarding connection to $SERVER_FORWARD_HOST with secret key $SERVER_FORWARD_KEY."
+	log 3 "Info: Forwarding connection to $SERVER_FORWARD_HOST with secret key $SERVER_FORWARD_KEY."
 	ssh -i "$SERVER_FORWARD_KEY" "nx@$SERVER_FORWARD_HOST:$SERVER_FORWARD_PORT"
 	exit 0
 fi
@@ -463,9 +471,9 @@
 # forward the connection to commercial NoMachine server?
 if [ "$ENABLE_NOMACHINE_FORWARD_PORT" = "1" -a "$NOMACHINE_FORWARD_PORT" = "$(echo $SSH_CLIENT | cut -d' ' -f3)" -a -n "$NOMACHINE_SERVER" ]
 then
-	log "Info: Detected SSH destination port $NOMACHINE_FORWARD_PORT. Forwarding connection to commercial NoMachine server."
+	log 3 "Info: Detected SSH destination port $NOMACHINE_FORWARD_PORT. Forwarding connection to commercial NoMachine server."
 	exec $NOMACHINE_SERVER
-	log "Error: Forwarding to NoMachine Server $NOMACHINE_SERVER failed. Using FreeNX server instead."
+	log 1 "Error: Forwarding to NoMachine Server $NOMACHINE_SERVER failed. Using FreeNX server instead."
 fi
 
 echo_x "HELLO NXSERVER - Version $NX_VERSION $NX_LICENSE"
@@ -508,7 +516,7 @@
 				[ "$ENABLE_AUTORECONNECT_BEFORE_140" = "1" ] && ENABLE_AUTORECONNECT="1"
 			fi
 		;;
-		set*|SET)
+		set*|SET*)
 			if [ "$CMD" = "set auth_mode password" -o "$CMD" = "SET AUTH_MODE PASSWORD" ]
 			then
 				echo_x "Set auth_mode: password"
@@ -528,13 +536,13 @@
 			then
 				case "$USER" in
 					freenx.*)
-						log "Not forwarding connection. FreeNX user found."
+						log 3 "Info: Not forwarding connection. FreeNX user found."
 						USER=${USER##freenx.}
 					;;
 					*)
-						log -n "Forwarding connection to NoMachine server..."
+						log 3 "Info: Forwarding connection to NoMachine server"
 						server_forward_nomachine
-						log "failed."
+						log 1 "Error: Forwarding connection to NoMachine server failed."
 					;;
 				esac
 			fi
@@ -542,12 +550,12 @@
 			echo_x -n "NX> 102 Password: "
 			read -s PASS
 			echo_x ""
-			log -n "Auth method: "
+			log 6 -n "Info: Auth method: "
 			
 			# PASSDB based auth
 			if [ "$ENABLE_PASSDB_AUTHENTICATION" = "1" -a "$LOGIN_SUCCESS" = "0" ]
 			then
-				log -n "passdb "
+				log 6 -n "passdb "
 				if [ $(passdb_get_crypt_pass "$PASS") = $(passdb_get_pass "$USER") ]
 				then
 					LOGIN_SUCCESS="1"
@@ -558,7 +566,7 @@
 			# SSH based auth
 			if [ "$ENABLE_SSH_AUTHENTICATION" = "1" -a "$LOGIN_SUCCESS" = "0" ]
 			then
-				log -n "ssh "
+				log 6 -n "ssh "
 				echo "$PASS" | $PATH_BIN/nxnode-login -- ssh "$USER" "$SSHD_PORT" "$PATH_BIN/nxnode" --check > /dev/null 2>/dev/null
 				if [ $? -eq 0 ]
 				then
@@ -570,7 +578,7 @@
 			# SU based auth
 			if [ "$ENABLE_SU_AUTHENTICATION" = "1" -a "$LOGIN_SUCCESS" = "0" ]
 			then
-				log -n "su "
+				log 6 -n "su "
 				echo "$PASS" | $PATH_BIN/nxnode-login -- su "$USER" "" "$PATH_BIN/nxnode" --check > /dev/null 2>/dev/null
 				if [ $? -eq 0 ]
 				then
@@ -578,14 +586,14 @@
 					LOGIN_METHOD="SU"
 				fi
 			fi
-			log ""
 			
 			# Check if user in passdb
 			if [ "$ENABLE_USER_DB" = "1" ]
 			then
-				log "userdb check"
+				log 6 "userdb check"
 				passdb_user_exists "$USER" || LOGIN_SUCCESS="0"
 			fi
+			log 6 ""
 
 			if [ "$LOGIN_SUCCESS" = "1" ]
 			then
@@ -753,12 +761,12 @@
 	then 
 		if [ "$SSHD_CHECK_IP" = "1" ]
 		then
-			echo "NX> 504 Session startup failed. (Missing SSH_CLIENT environment variable)"
+			echo_x "NX> 504 Session startup failed. (Missing SSH_CLIENT environment variable)"
 			return 1
 		else
-			log "WARNING: Failed to determine the client IP."
-			log "WARNING: The SSH_CLIENT variable was not provided by SSHD."
-			log "WARNING: Please set SSHD_CHECK_IP=1 if you want to refuse the connection."
+			log 2 "Warning: Failed to determine the client IP."
+			log 2 "Warning: The SSH_CLIENT variable was not provided by SSHD."
+			log 2 "Warning: Please set SSHD_CHECK_IP=1 if you want to refuse the connection."
 		fi
 	fi
 
@@ -811,7 +819,7 @@
 	
 		uniqueid=$(echo $[$RANDOM*$RANDOM] | md5sum | cut -d" " -f1 | tr "[a-z]" "[A-Z]")
 		FULL_PARAMS="user=$USER&userip=$USERIP&uniqueid=$uniqueid&display=$SESS_DISPLAY&$PARAMS"
-		log "$FULL_PARAMS"
+		log 6 "$FULL_PARAMS"
 
 		# now update the session listing
 		CMDLINE="a=b&$FULL_PARAMS"
@@ -923,8 +931,8 @@
 			server_startrestore_session "resume"
 		;;
 		passwd)
-			echo "NX> 113 Changing password of user '$USER'"
-			echo -n "NX> 102 Current password:"
+			echo_x "NX> 113 Changing password of user '$USER'"
+			echo_x -n "NX> 102 Current password:"
 			read -s PASS
 			ENC_PASS=$(passdb_get_crypt_pass "$PASS")
 			REAL_PASS=$(passdb_get_pass "$USER")






From freenx-cvs at berlios.de  Wed Mar 16 15:02:38 2005
From: freenx-cvs at berlios.de (jonno)
Date: Wed, 16 Mar 2005 15:02:38 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified nxnode
Message-ID: <42383C7E.mail8D5113ZRW@lists.berlios.de>

User:      jonno
Date:      2005-03-16 14:02:38 GMT
Modified:  .        nxnode
Log:
nxnode now uses $COMMAND_SMBUMOUNT instead of smbumount

Revision  Changes    Path
1.49      +2 -2      freenx/nxnode


rev 1.49, prev_rev 1.48
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.48
retrieving revision 1.49
diff -u -r1.48 -r1.49
--- nxnode	16 Mar 2005 13:58:42 -0000	1.48
+++ nxnode	16 Mar 2005 14:02:38 -0000	1.49
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.48 2005/03/16 13:58:42 jonno Exp $
+# CVS: $Id: nxnode,v 1.49 2005/03/16 14:02:38 jonno Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -299,7 +299,7 @@
 	[ -e "$USER_FAKE_HOME/.nx/C-$sess_id/scripts/mpoint" ] || return
 	cat "$USER_FAKE_HOME/.nx/C-$sess_id/scripts/mpoint" | while read mpoint
 	do
-		smbumount "$mpoint" >/dev/null 2>/dev/null
+		$COMMAND_SMBUMOUNT "$mpoint" >/dev/null 2>/dev/null
 	done
 }
 






From freenx-cvs at berlios.de  Wed Mar 16 16:09:56 2005
From: freenx-cvs at berlios.de (jonno)
Date: Wed, 16 Mar 2005 16:09:56 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 2 files
Message-ID: <42384C44.mailB731TQ8KD@lists.berlios.de>

User:      jonno
Date:      2005-03-16 15:09:56 GMT
Modified:  .        nxloadconfig nxserver
Log:
Made two typos in my commit last time. Fixed now

Revision  Changes    Path
1.22      +2 -2      freenx/nxloadconfig


rev 1.22, prev_rev 1.21
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.21
retrieving revision 1.22
diff -u -r1.21 -r1.22
--- nxloadconfig	16 Mar 2005 13:58:42 -0000	1.21
+++ nxloadconfig	16 Mar 2005 15:09:56 -0000	1.22
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.21 2005/03/16 13:58:42 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.22 2005/03/16 15:09:56 jonno Exp $
 #
 # ========================================================================
 
@@ -210,7 +210,7 @@
 	[ -z "$SSH_AUTHORIZED_KEYS" ] && \
 		ERROR="yes" && echo "Error: Invalid value \"SSH_AUTHORIZED_KEYS=$SSH_AUTHORIZED_KEYS\"" 
 	
-	[ -z $(echo "$NX_LOG_LEVEL" | egrep "^[0-7]$") ] && \
+	[ -z $(echo "$NX_LOG_LEVEL" | egrep "^[0-6]$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"NX_LOG_LEVEL=$NX_LOG_LEVEL\""
 	[ "$NX_LOG_LEVEL" != "0" -a ! -e "$NX_LOGFILE" ] && \
 		WARNING="yes" && echo "Warning: Invalid value \"NX_LOGFILE=$NX_LOGFILE\"" \



1.45      +2 -2      freenx/nxserver


rev 1.45, prev_rev 1.44
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.44
retrieving revision 1.45
diff -u -r1.44 -r1.45
--- nxserver	16 Mar 2005 13:58:42 -0000	1.44
+++ nxserver	16 Mar 2005 15:09:56 -0000	1.45
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.44 2005/03/16 13:58:42 jonno Exp $
+# CVS: $Id: nxserver,v 1.45 2005/03/16 15:09:56 jonno Exp $
 #
 
 # Read the config file
@@ -516,7 +516,7 @@
 				[ "$ENABLE_AUTORECONNECT_BEFORE_140" = "1" ] && ENABLE_AUTORECONNECT="1"
 			fi
 		;;
-		set*|SET*)
+		set*|SET)
 			if [ "$CMD" = "set auth_mode password" -o "$CMD" = "SET AUTH_MODE PASSWORD" ]
 			then
 				echo_x "Set auth_mode: password"






From FabianFranz at gmx.de  Thu Mar 17 00:17:44 2005
From: FabianFranz at gmx.de (Fabian Franz)
Date: Thu, 17 Mar 2005 00:17:44 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 2 files
In-Reply-To: <42384C44.mailB731TQ8KD@lists.berlios.de>
References: <42384C44.mailB731TQ8KD@lists.berlios.de>
Message-ID: <200503170017.46876.FabianFranz@gmx.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Am Mittwoch, 16. M?rz 2005 16:09 schrieb jonno:
>  		;;
> -		set*|SET*)
> +		set*|SET)

Actually as far as I can see the previous version was correct ... and you just 
happened to have fixed a bug ;-).

cu

Fabian
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.4 (GNU/Linux)

iD8DBQFCOL6aI0lSH7CXz7MRAiy5AKCH/mbptMx3q98MDAFxpLpIv045NwCeKABZ
/T9gXlaO+u4gYyQA9J1jmIw=
=GF3z
-----END PGP SIGNATURE-----



From FabianFranz at gmx.de  Thu Mar 17 00:22:35 2005
From: FabianFranz at gmx.de (Fabian Franz)
Date: Thu, 17 Mar 2005 00:22:35 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified 5 files
In-Reply-To: <42383B92.mail88311M6FB@lists.berlios.de>
References: <42383B92.mail88311M6FB@lists.berlios.de>
Message-ID: <200503170022.38544.FabianFranz@gmx.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

> Added configurable verbosity of logging.

Very cool!

Though I found two "bugs" ;-).

> +node_abort()
> +{
> +	echo "$@" 1>&2
> +	exit 1
> +}
> +
>  getparam_sessionid()
>  {
>  	sessionid=$(getparam sessionid)
> @@ -67,13 +73,6 @@
>  	echo $sessionid
>  }
>
> -node_abort()
> -{
> -	echo "$@" 1>&2
> -	exit 1
> -}
> -
> -

Why do you do this cosmetical change? Any reason? I'm just asking, because I 
did not understand it.

>
> -		DISPLAY=unix:$display $DEFAULT_X_WM >>
> $USER_FAKE_HOME/.nx/C-$sess_id/session 2>&1 &
>+		DISPLAY=unix:$display
> $DEFAULT_X_WM 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session & WM_PID=$!

This is wrong in general. 2>> means that you are redirecting just stderr to 
the session file.

> -	DISPLAY=unix:$display $STARTX >>$USER_FAKE_HOME/.nx/C-$sess_id/session
> 2>&1 &
>+	DISPLAY=unix:$display $STARTX
> 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session & APP_PID=$!

The same here.

Could you please fix that?

cu

Fabian
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.4 (GNU/Linux)

iD8DBQFCOL+9I0lSH7CXz7MRAtQ2AJ4hJosdwCum2DqTQ5zHKR8+0R4FJACfZFE+
rRdxjUH8w8HqW2dkD++T8aI=
=2wVc
-----END PGP SIGNATURE-----



From freenx-cvs at berlios.de  Thu Mar 17 01:00:21 2005
From: freenx-cvs at berlios.de (fux)
Date: Thu, 17 Mar 2005 01:00:21 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified nxnode
Message-ID: <4238C895.mail24Z1W2YTZ@lists.berlios.de>

User:      fux
Date:      2005-03-17 00:00:20 GMT
Modified:  .        nxnode
Log:
fixed nxviewer closes BUG 3581 (keyboard-focus with -fullscreen)

Revision  Changes    Path
1.50      +3 -3      freenx/nxnode


rev 1.50, prev_rev 1.49
Index: nxnode
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode,v
retrieving revision 1.49
retrieving revision 1.50
diff -u -r1.49 -r1.50
--- nxnode	16 Mar 2005 14:02:38 -0000	1.49
+++ nxnode	17 Mar 2005 00:00:20 -0000	1.50
@@ -13,7 +13,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxnode,v 1.49 2005/03/16 14:02:38 jonno Exp $
+# CVS: $Id: nxnode,v 1.50 2005/03/17 00:00:20 fux Exp $
 #
 # 21.06.2004: - Full reconnection support
 
@@ -235,7 +235,7 @@
 	R=""
 	[ "$virtualdesktop" = "0" ] && R="-rootless"
 	vncfullscreen=""
-	[ "$geometry" = "fullscreen" && "$type" = "vnc" ] && vncfullscreen="-fullscreen" && G=""
+	[ "$geometry" = "fullscreen" -a "$type" = "vnc" ] && vncfullscreen="-fullscreen" && G=""
 
 	if [ "$type" = "windows" ]
 	then
@@ -252,7 +252,7 @@
 		[ "$SET_LD_LIBRARY_PATH" = "1" ] && export LD_LIBRARY_PATH="$AGENT_LIBRARY_PATH:$LD_LIBRARY_PATH"
 		mkdir -p $USER_FAKE_HOME/.nx/C-$sess_id/scripts/
 		echo "$agent_password" | $PATH_BIN/nxpasswd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd doit
-		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $vncfullscreen $G  $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
+		$PATH_BIN/nxviewer -encodings tight hextile copyrect raw -passwd $USER_FAKE_HOME/.nx/C-$sess_id/scripts/.passwd -name "NX - $user@$SERVER_NAME:$display - $session (GPL Edition)" -option "$USER_FAKE_HOME/.nx/C-$sess_id/options" $vncfullscreen $G $K $agent_server $AGENT_EXTRA_OPTIONS_RFB 2>>$USER_FAKE_HOME/.nx/C-$sess_id/session &
 	elif [ -n "$R" -a "$ENABLE_ROOTLESS_MODE" != "1" ]
 	then
 		# nxproxy single application mode session






From freenx-cvs at berlios.de  Fri Mar 18 00:21:15 2005
From: freenx-cvs at berlios.de (fux)
Date: Fri, 18 Mar 2005 00:21:15 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified 7 files
Message-ID: <423A10EB.mail2FK161037@lists.berlios.de>

User:      fux
Date:      2005-03-17 23:21:15 GMT
Modified:  .        ChangeLog node.conf.sample nxkeygen nxloadconfig
Modified:           nxnode-login nxserver nxsetup
Log:
added COMMAND_SSH & COMMAND_SSH_KEYGEN directives

Revision  Changes    Path
1.43      +1 -1      freenx/ChangeLog


rev 1.43, prev_rev 1.42
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.42
retrieving revision 1.43
diff -u -r1.42 -r1.43
--- ChangeLog	16 Mar 2005 13:58:42 -0000	1.42
+++ ChangeLog	17 Mar 2005 23:21:14 -0000	1.43
@@ -2,7 +2,7 @@
 	* Opened the 0.4.0 branch.
 	* Added initial support for filesharing via samba.
 	* Improvements to be more node.conf compatible.
-	* Added COMMAND_NETCAT directive
+	* Added COMMAND_NETCAT, COMMAND_SSH & COMMAND_SSH_KEYGEN directive
 	* Added support for 'nxloadconfig --check' to validate node.conf settings
 	* Added initial support for sound (esd/artsd).
 	* Added optional support for utmp/wtmp/lastlog database.



1.18      +6 -1      freenx/node.conf.sample


rev 1.18, prev_rev 1.17
Index: node.conf.sample
===================================================================
RCS file: /cvsroot/freenx/freenx/node.conf.sample,v
retrieving revision 1.17
retrieving revision 1.18
diff -u -r1.17 -r1.18
--- node.conf.sample	16 Mar 2005 13:58:42 -0000	1.17
+++ node.conf.sample	17 Mar 2005 23:21:14 -0000	1.18
@@ -37,7 +37,7 @@
 #
 #           https://mail.kde.org/mailman/listinfo/freenx-knx
 #
-# CVS: $Id: node.conf.sample,v 1.17 2005/03/16 13:58:42 jonno Exp $
+# CVS: $Id: node.conf.sample,v 1.18 2005/03/17 23:21:14 fux Exp $
 
 #########################################################################
 # FreeNX specific node.conf directives
@@ -166,6 +166,11 @@
 
 # The key that contains the name of the complete path of the 'netcat' command. 
 #COMMAND_NETCAT=netcat
+
+# The key that contains the name of the complete path of the 'ssh' and 
+# 'ssh-keygen' command. 
+#COMMAND_SSH=ssh
+#COMMAND_SSH_KEYGEN=ssh-keygen
 
 # If enabled writes entries via the COMMAND_SESSREG program 
 # into utmp/wtmp/lastlog database.



1.11      +2 -2      freenx/nxkeygen


rev 1.11, prev_rev 1.10
Index: nxkeygen
===================================================================
RCS file: /cvsroot/freenx/freenx/nxkeygen,v
retrieving revision 1.10
retrieving revision 1.11
diff -u -r1.10 -r1.11
--- nxkeygen	11 Mar 2005 16:53:01 -0000	1.10
+++ nxkeygen	17 Mar 2005 23:21:14 -0000	1.11
@@ -11,7 +11,7 @@
 # Copyright	(c) 2004 Gentoo Foundation
 #		Released under v2 of the GNU GPL
 #
-# CVS: $Id: nxkeygen,v 1.10 2005/03/11 16:53:01 jonno Exp $
+# CVS: $Id: nxkeygen,v 1.11 2005/03/17 23:21:14 fux Exp $
 #
 # ========================================================================
 
@@ -27,7 +27,7 @@
 {
 	# create a new key
 	umask 002
-	ssh-keygen -q -t dsa -N '' -f ${NX_KEY_DIR}/local.id_dsa
+	$COMMAND_SSH_KEYGEN -q -t dsa -N '' -f ${NX_KEY_DIR}/local.id_dsa
 
 	# backup the existing keys
 	



1.23      +9 -1      freenx/nxloadconfig


rev 1.23, prev_rev 1.22
Index: nxloadconfig
===================================================================
RCS file: /cvsroot/freenx/freenx/nxloadconfig,v
retrieving revision 1.22
retrieving revision 1.23
diff -u -r1.22 -r1.23
--- nxloadconfig	16 Mar 2005 15:09:56 -0000	1.22
+++ nxloadconfig	17 Mar 2005 23:21:14 -0000	1.23
@@ -5,7 +5,7 @@
 #
 # License: GPL, version 2
 #
-# CVS: $Id: nxloadconfig,v 1.22 2005/03/16 15:09:56 jonno Exp $
+# CVS: $Id: nxloadconfig,v 1.23 2005/03/17 23:21:14 fux Exp $
 #
 # ========================================================================
 
@@ -106,6 +106,8 @@
 ARTSD_BIN_PRELOAD="artsdsp"
 
 COMMAND_NETCAT=netcat
+COMMAND_SSH=ssh
+COMMAND_SSH_KEYGEN=ssh-keygen
 
 ENABLE_USESSION="0"
 COMMAND_SESSREG="sessreg"
@@ -283,6 +285,12 @@
 	
 	! which "$COMMAND_NETCAT" >/dev/null 2>&1 && \
 		ERROR="yes" && echo "Error: Invalid value \"COMMAND_NETCAT=$COMMAND_NETCAT\""
+
+	! which "$COMMAND_SSH" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_SSH=$COMMAND_SSH\""
+
+	! which "$COMMAND_SSH_KEYGEN" >/dev/null 2>&1 && \
+		ERROR="yes" && echo "Error: Invalid value \"COMMAND_SSH_KEYGEN=$COMMAND_SSH_KEYGEN\""
 	
 	[ -z $(echo "$ENABLE_USESSION" | egrep "^[0|1]$") ] && \
 		ERROR="yes" && echo "Error: Invalid value \"ENABLE_USESSION=$ENABLE_USESSION\""



1.10      +3 -2      freenx/nxnode-login


rev 1.10, prev_rev 1.9
Index: nxnode-login
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode-login,v
retrieving revision 1.9
retrieving revision 1.10
diff -u -r1.9 -r1.10
--- nxnode-login	11 Mar 2005 00:50:15 -0000	1.9
+++ nxnode-login	17 Mar 2005 23:21:14 -0000	1.10
@@ -3,7 +3,7 @@
 # Copyright (c) 2004 by Fabian Franz.
 # License: GPL, version 2
 #
-# CVS: $Id: nxnode-login,v 1.9 2005/03/11 00:50:15 fabianx Exp $
+# CVS: $Id: nxnode-login,v 1.10 2005/03/17 23:21:14 fux Exp $
 #
 
 # Syntax: nxnode-login {ssh|su} user ssh-port executable command tosend
@@ -14,6 +14,7 @@
 set executable [lindex $argv 3]
 set command [lindex $argv 4]
 set tosend [lindex $argv 5]
+catch {set command_ssh $env(COMMAND_SSH)}
 
 expect_user -re "(.*)\n" 
 set password $expect_out(1,string)
@@ -21,7 +22,7 @@
 set stty_init "raw icrnl"
 
 if { "$auth_method"=="ssh" } { 
-	set pid [spawn -noecho ssh -2 -l "$user" "127.0.0.1" -o "NumberOfPasswordPrompts 1" -p "$port" "$executable $command" ]
+	set pid [spawn -noecho $command_ssh -2 -l "$user" "127.0.0.1" -o "NumberOfPasswordPrompts 1" -p "$port" "$executable $command" ]
 } elseif { "$auth_method"=="su" } {
 	set pid [spawn -noecho su - "$user" -c "$executable $command" ]
 } else {



1.46      +6 -4      freenx/nxserver


rev 1.46, prev_rev 1.45
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.45
retrieving revision 1.46
diff -u -r1.45 -r1.46
--- nxserver	16 Mar 2005 15:09:56 -0000	1.45
+++ nxserver	17 Mar 2005 23:21:14 -0000	1.46
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.45 2005/03/16 15:09:56 jonno Exp $
+# CVS: $Id: nxserver,v 1.46 2005/03/17 23:21:14 fux Exp $
 #
 
 # Read the config file
@@ -464,7 +464,7 @@
 if [ "$ENABLE_SERVER_FORWARD" = "1" -a -n "$SERVER_FORWARD_HOST" ]
 then
 	log 3 "Info: Forwarding connection to $SERVER_FORWARD_HOST with secret key $SERVER_FORWARD_KEY."
-	ssh -i "$SERVER_FORWARD_KEY" "nx@$SERVER_FORWARD_HOST:$SERVER_FORWARD_PORT"
+	$COMMAND_SSH -i "$SERVER_FORWARD_KEY" "nx@$SERVER_FORWARD_HOST:$SERVER_FORWARD_PORT"
 	exit 0
 fi
 
@@ -562,11 +562,12 @@
 					LOGIN_METHOD="PASSDB"
 				fi
 			fi
-			
+
 			# SSH based auth
 			if [ "$ENABLE_SSH_AUTHENTICATION" = "1" -a "$LOGIN_SUCCESS" = "0" ]
 			then
 				log 6 -n "ssh "
+				export COMMAND_SSH			
 				echo "$PASS" | $PATH_BIN/nxnode-login -- ssh "$USER" "$SSHD_PORT" "$PATH_BIN/nxnode" --check > /dev/null 2>/dev/null
 				if [ $? -eq 0 ]
 				then
@@ -649,12 +650,13 @@
 	# Use nxnode-login?
 	if [ "$LOGIN_METHOD" = "SSH" ]
 	then
+	    export COMMAND_SSH
 	    echo "$PASS" | $PATH_BIN/nxnode-login -- ssh "$USER" "$SSHD_PORT" "$PATH_BIN/nxnode" "$CMD" "$@" 2>&1 | log_tee
 	elif [ "$LOGIN_METHOD" = "SU" ]
 	then
 	    echo "$PASS" | $PATH_BIN/nxnode-login -- su "$USER" "" "$PATH_BIN/nxnode" "$CMD" "$@" 2>&1 | log_tee
 	else 
-	    echo "$@" | ssh -l "$USER" 127.0.0.1 -p $SSHD_PORT -x -2 -i $NX_ETC_DIR/users.id_dsa -o 'PubkeyAuthentication yes' -o 'RSAAuthentication yes' -o 'RhostsAuthentication no' -o 'PasswordAuthentication no' -o 'RhostsRSAAuthentication no' -o 'StrictHostKeyChecking no' $PATH_BIN/nxnode "$CMD" | log_tee
+	    echo "$@" | $COMMAND_SSH -l "$USER" 127.0.0.1 -p $SSHD_PORT -x -2 -i $NX_ETC_DIR/users.id_dsa -o 'PubkeyAuthentication yes' -o 'RSAAuthentication yes' -o 'RhostsAuthentication no' -o 'PasswordAuthentication no' -o 'RhostsRSAAuthentication no' -o 'StrictHostKeyChecking no' $PATH_BIN/nxnode "$CMD" | log_tee
 	fi
 }
 



1.20      +4 -4      freenx/nxsetup


rev 1.20, prev_rev 1.19
Index: nxsetup
===================================================================
RCS file: /cvsroot/freenx/freenx/nxsetup,v
retrieving revision 1.19
retrieving revision 1.20
diff -u -r1.19 -r1.20
--- nxsetup	11 Mar 2005 16:53:02 -0000	1.19
+++ nxsetup	17 Mar 2005 23:21:15 -0000	1.20
@@ -5,7 +5,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxsetup,v 1.19 2005/03/11 16:53:02 jonno Exp $ 
+# CVS: $Id: nxsetup,v 1.20 2005/03/17 23:21:15 fux Exp $ 
 #
 
 HELP="no"
@@ -101,8 +101,8 @@
 	then 
 		echo -n "Starting ssh service ..."
 		# Generate Host keys if they are not available, yet
-		[ -e /etc/ssh/ssh_host_rsa_key ] || ssh-keygen -q -t rsa -f /etc/ssh/ssh_host_rsa_key -C '' -N ''
-		[ -e /etc/ssh/ssh_host_dsa_key ] || ssh-keygen -q -t dsa -f /etc/ssh/ssh_host_dsa_key -C '' -N ''
+		[ -e /etc/ssh/ssh_host_rsa_key ] || $COMMAND_SSH_KEYGEN -q -t rsa -f /etc/ssh/ssh_host_rsa_key -C '' -N ''
+		[ -e /etc/ssh/ssh_host_dsa_key ] || $COMMAND_SSH_KEYGEN -q -t dsa -f /etc/ssh/ssh_host_dsa_key -C '' -N ''
 		/etc/init.d/ssh start
 		echo "done"
 	fi
@@ -115,7 +115,7 @@
 	
 	if [ ! -f $NX_ETC_DIR/users.id_dsa ]
 	then
-		ssh-keygen -f $NX_ETC_DIR/users.id_dsa -t dsa -N ""
+		$COMMAND_SSH_KEYGEN -f $NX_ETC_DIR/users.id_dsa -t dsa -N ""
 	fi
 	
 	echo -n "Setting up $NX_SESS_DIR ..."






From freenx-cvs at berlios.de  Fri Mar 18 00:27:48 2005
From: freenx-cvs at berlios.de (fux)
Date: Fri, 18 Mar 2005 00:27:48 +0100
Subject: [Freenx-cvs] CVS: freenx - fux modified nxnode-login
Message-ID: <423A1274.mail2ZB11BO53@lists.berlios.de>

User:      fux
Date:      2005-03-17 23:27:48 GMT
Modified:  .        nxnode-login
Log:
default for command_ssh

Revision  Changes    Path
1.11      +2 -1      freenx/nxnode-login


rev 1.11, prev_rev 1.10
Index: nxnode-login
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode-login,v
retrieving revision 1.10
retrieving revision 1.11
diff -u -r1.10 -r1.11
--- nxnode-login	17 Mar 2005 23:21:14 -0000	1.10
+++ nxnode-login	17 Mar 2005 23:27:48 -0000	1.11
@@ -3,7 +3,7 @@
 # Copyright (c) 2004 by Fabian Franz.
 # License: GPL, version 2
 #
-# CVS: $Id: nxnode-login,v 1.10 2005/03/17 23:21:14 fux Exp $
+# CVS: $Id: nxnode-login,v 1.11 2005/03/17 23:27:48 fux Exp $
 #
 
 # Syntax: nxnode-login {ssh|su} user ssh-port executable command tosend
@@ -14,6 +14,7 @@
 set executable [lindex $argv 3]
 set command [lindex $argv 4]
 set tosend [lindex $argv 5]
+set command_ssh "ssh"
 catch {set command_ssh $env(COMMAND_SSH)}
 
 expect_user -re "(.*)\n" 






From kov at sheep.berlios.de  Fri Mar 18 20:20:24 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Fri, 18 Mar 2005 20:20:24 +0100
Subject: [Freenx-cvs] r55 - thinnx/trunk/thinnx
Message-ID: <200503181920.j2IJKO67009435@sheep.berlios.de>

Author: kov
Date: 2005-03-18 20:20:19 +0100 (Fri, 18 Mar 2005)
New Revision: 55

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
report incorrect login/password for any error code that comes when
an error happens after password is given


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-13 16:56:40 UTC (rev 54)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-18 19:20:19 UTC (rev 55)
@@ -755,12 +755,9 @@
 	}
       else
 	{
-	  if (!strcmp (buffer, "NX> 404"))
-	    {
-	      message_dialog ("Login ou senha incorretos!");
-	      exit (1);
-	    }
-	  
+	  message_dialog ("Login ou senha incorretos!");
+	  exit (1);
+
 	  protocol_error ("you mean I did not log in successfully?");
 	}
 



From kov at sheep.berlios.de  Fri Mar 18 20:21:18 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Fri, 18 Mar 2005 20:21:18 +0100
Subject: [Freenx-cvs] r56 - thinnx/trunk/thinnx
Message-ID: <200503181921.j2IJLI7h009538@sheep.berlios.de>

Author: kov
Date: 2005-03-18 20:21:16 +0100 (Fri, 18 Mar 2005)
New Revision: 56

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
no need for protocol error, because of last fix


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-18 19:20:19 UTC (rev 55)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-18 19:21:16 UTC (rev 56)
@@ -757,8 +757,6 @@
 	{
 	  message_dialog ("Login ou senha incorretos!");
 	  exit (1);
-
-	  protocol_error ("you mean I did not log in successfully?");
 	}
 
       buffer = read_code (out);



From kov at sheep.berlios.de  Fri Mar 18 23:04:47 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Fri, 18 Mar 2005 23:04:47 +0100
Subject: [Freenx-cvs] r57 - thinnx/trunk/thinnx
Message-ID: <200503182204.j2IM4lxZ023918@sheep.berlios.de>

Author: kov
Date: 2005-03-18 23:04:46 +0100 (Fri, 18 Mar 2005)
New Revision: 57

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
supports restoring session automatically if there's only 1 session
to be restored (it will otherwise probably break =D)


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-18 19:21:16 UTC (rev 56)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-18 22:04:46 UTC (rev 57)
@@ -153,6 +153,15 @@
 }
 
 void
+drop_lines (gint fd, gint max)
+{
+  gint count;
+
+  for (count = 0; count < max; count++)
+    drop_line (fd);
+}
+
+void
 protocol_error (gchar *msg)
 {
   flush_buffer (buffer);
@@ -319,7 +328,7 @@
 }
 
 gchar*
-get_info_after_colon (gchar *buffer)
+get_info_after_char (gchar *buffer, gchar c)
 {
   gchar *split_str;
   gchar *retval;
@@ -327,7 +336,7 @@
   printf ("%s", buffer);
 
   split_str = buffer+(strlen(buffer) - 1);
-  while (*(split_str-1) != ':')
+  while (*(split_str-1) != c)
     *split_str--;
 
   retval = g_strdup (split_str);
@@ -336,6 +345,18 @@
   return retval;
 }
 
+gchar*
+get_info_after_colon (gchar *buffer)
+{
+  return get_info_after_char (buffer, ':');
+}
+
+gchar*
+get_restore_id (gchar *line)
+{
+  return get_info_after_char (line, '\t');
+}
+
 /* Handle session start information */  
 gchar *
 get_session_info (gint out, gchar *code)
@@ -388,6 +409,8 @@
   
   gchar **nxssh_argv = (gchar**) g_malloc (sizeof(gchar*) * 9);
 
+  gchar *restore_id = NULL;
+
   pid_t pid;
 
   int parent_pipe[2];	/* For talking to the parent */
@@ -762,22 +785,51 @@
       buffer = read_code (out);
       if (!strcmp (buffer, "NX> 105"))
 	{
-	  gchar *cmdline;
+	  gchar *m;
 
 	  flush_buffer (buffer);
 	  drop_chars (out, 1);
 
-	  cmdline = g_strdup_printf ("startsession --session=\"%s\" --type=\"%s\" --cache=\"8M\" --images=\"32M\" --cookie=\"%s\" --link=\"%s\" --kbtype=\"%s\" --nodelay=\"1\" --backingstore=\"never\" --geometry=\"%s\" --media=\"0\" --agent_server=\"\" --agent_user=\"\" --agent_password=\"\" --screeninfo=\"%s\" --encryption=\"%d\"", session, type, cookie, link, kbdtype, geometry, screeninfo, use_ssl);
-	  write_line (in, cmdline);
-	  g_free (cmdline);
+	  m = g_strdup_printf ("list %s", user);
+	  write_line (in, m);
+	  g_free (m);
 
-	  drop_line (out);
-	  drop_line (out);
-	  drop_line (out);
+	  drop_lines (out, 5);
+
+	  while (1)
+	    {
+	      buffer = read_code (out);
+	      if (!strcmp (buffer, "NX> 105"))
+		{
+		  flush_buffer (buffer);
+		  drop_chars (out, 1);
+		  break;
+		}
+
+	      flush_buffer (buffer);
+	      buffer = read_line (out);
+	      restore_id = get_restore_id (buffer);
+	    }
 	}
       else
 	protocol_error ("session startup, buddy, I don't want problems!");
+      
 
+      {
+	gchar *cmdline;
+	
+	if (!restore_id)
+	  cmdline = g_strdup_printf ("startsession --session=\"%s\" --type=\"%s\" --cache=\"8M\" --images=\"32M\" --cookie=\"%s\" --link=\"%s\" --kbtype=\"%s\" --nodelay=\"1\" --backingstore=\"never\" --geometry=\"%s\" --media=\"0\" --agent_server=\"\" --agent_user=\"\" --agent_password=\"\" --screeninfo=\"%s\" --encryption=\"%d\"", session, type, cookie, link, kbdtype, geometry, screeninfo, use_ssl);
+	else
+	  cmdline = g_strdup_printf ("restoresession --session=\"%s\" --type=\"%s\" --cache=\"8M\" --images=\"32M\" --cookie=\"%s\" --link=\"%s\" --kbtype=\"%s\" --nodelay=\"1\" --backingstore=\"never\" --geometry=\"%s\" --media=\"0\" --agent_server=\"\" --agent_user=\"\" --agent_password=\"\" --screeninfo=\"%s\" --encryption=\"%d\" --id=\"%s\"", session, type, cookie, link, kbdtype, geometry, screeninfo, use_ssl, restore_id);
+	
+	write_line (in, cmdline);
+	g_free (cmdline);
+	cmdline = NULL;
+	
+	drop_lines (out, 3);
+      }
+
       session_id = get_session_info (out, "NX> 700");
       session_display = get_session_info (out, "NX> 705");
       drop_line (out); /* 703 (session type) */



From kov at sheep.berlios.de  Fri Mar 18 23:09:38 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Fri, 18 Mar 2005 23:09:38 +0100
Subject: [Freenx-cvs] r58 - thinnx/trunk/thinnx
Message-ID: <200503182209.j2IM9cjm024153@sheep.berlios.de>

Author: kov
Date: 2005-03-18 23:09:37 +0100 (Fri, 18 Mar 2005)
New Revision: 58

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
I don't think we need a clear button: removing


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-18 22:04:46 UTC (rev 57)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-18 22:09:37 UTC (rev 58)
@@ -199,7 +199,6 @@
   GtkWidget *pass_entry;
 
   GtkWidget *connect_button;
-  GtkWidget *clear_button;
 
   dialog = gtk_window_new (GTK_WINDOW_TOPLEVEL);
 #if GTK_MAJOR_VERSION == 2
@@ -245,11 +244,6 @@
   hbox = gtk_hbox_new (TRUE, 6);
   gtk_box_pack_start_defaults (GTK_BOX(vbox), hbox);
 
-  clear_button = gtk_button_new_with_label ("Limpar");
-  gtk_signal_connect (GTK_OBJECT(clear_button), "clicked",
-		      GTK_SIGNAL_FUNC(clear_dialog), NULL);
-  gtk_box_pack_start_defaults (GTK_BOX(hbox), clear_button);
-
   connect_button = gtk_button_new_with_label ("Conectar!");
   gtk_signal_connect (GTK_OBJECT(connect_button), "clicked",
 		      GTK_SIGNAL_FUNC(gtk_main_quit), NULL);



From freenx-cvs at berlios.de  Sun Mar 20 17:47:17 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Sun, 20 Mar 2005 17:47:17 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified ChangeLog
Message-ID: <423DA915.mailDNG1ZQ4RL@lists.berlios.de>

User:      fabianx
Date:      2005-03-20 16:47:17 GMT
Modified:  .        Tag: FreeNX-0_3_0-bugfixes ChangeLog
Log:
Added release tag.

Revision  Changes    Path
No                   revision



No                   revision



1.16.2.11 +1 -1      freenx/ChangeLog


rev 1.16.2.11, prev_rev 1.16.2.10
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.16.2.10
retrieving revision 1.16.2.11
diff -u -r1.16.2.10 -r1.16.2.11
--- ChangeLog	16 Mar 2005 10:57:06 -0000	1.16.2.10
+++ ChangeLog	20 Mar 2005 16:47:17 -0000	1.16.2.11
@@ -1,4 +1,4 @@
-XX.03.2005 FreeNX 0.3.1-CVS
+20.03.2005 FreeNX 0.3.1 "Bugfix Edition"
 	* Fixed keyboard mapping problems.
 	* Fixed unix-custom mode; now allowing parameters to be passed.
 	* Fixed password prompt detection support in nxnode-login.






From freenx-cvs at berlios.de  Mon Mar 21 13:50:36 2005
From: freenx-cvs at berlios.de (jonno)
Date: Mon, 21 Mar 2005 13:50:36 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified nxserver
Message-ID: <423EC31C.mailLT01GY5RA@lists.berlios.de>

User:      jonno
Date:      2005-03-21 12:50:36 GMT
Modified:  .        nxserver
Log:
Fixed the SET AUTHMODE bug I stumbled on earlier.
This is very non-critical, as no one has reported any trouble with it.

Revision  Changes    Path
1.47      +2 -2      freenx/nxserver


rev 1.47, prev_rev 1.46
Index: nxserver
===================================================================
RCS file: /cvsroot/freenx/freenx/nxserver,v
retrieving revision 1.46
retrieving revision 1.47
diff -u -r1.46 -r1.47
--- nxserver	17 Mar 2005 23:21:14 -0000	1.46
+++ nxserver	21 Mar 2005 12:50:36 -0000	1.47
@@ -11,7 +11,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxserver,v 1.46 2005/03/17 23:21:14 fux Exp $
+# CVS: $Id: nxserver,v 1.47 2005/03/21 12:50:36 jonno Exp $
 #
 
 # Read the config file
@@ -516,7 +516,7 @@
 				[ "$ENABLE_AUTORECONNECT_BEFORE_140" = "1" ] && ENABLE_AUTORECONNECT="1"
 			fi
 		;;
-		set*|SET)
+		"set auth_mode*"|"SET AUTH_MODE*")
 			if [ "$CMD" = "set auth_mode password" -o "$CMD" = "SET AUTH_MODE PASSWORD" ]
 			then
 				echo_x "Set auth_mode: password"






From freenx-cvs at berlios.de  Mon Mar 21 14:00:21 2005
From: freenx-cvs at berlios.de (jonno)
Date: Mon, 21 Mar 2005 14:00:21 +0100
Subject: [Freenx-cvs] CVS: freenx - jonno modified nxnode-login
Message-ID: <423EC565.mailMBK11HJ1X@lists.berlios.de>

User:      jonno
Date:      2005-03-21 13:00:21 GMT
Modified:  .        nxnode-login
Log:
When using passdb authentification X11-forwarding is explicitly disabled (by use of -x), but when using SSHD authentification it was not.
This could potentially cause problems if X11-forwarding is messed up, and X11-forwarding is now always explicitly disabled.

Revision  Changes    Path
1.12      +2 -2      freenx/nxnode-login


rev 1.12, prev_rev 1.11
Index: nxnode-login
===================================================================
RCS file: /cvsroot/freenx/freenx/nxnode-login,v
retrieving revision 1.11
retrieving revision 1.12
diff -u -r1.11 -r1.12
--- nxnode-login	17 Mar 2005 23:27:48 -0000	1.11
+++ nxnode-login	21 Mar 2005 13:00:21 -0000	1.12
@@ -3,7 +3,7 @@
 # Copyright (c) 2004 by Fabian Franz.
 # License: GPL, version 2
 #
-# CVS: $Id: nxnode-login,v 1.11 2005/03/17 23:27:48 fux Exp $
+# CVS: $Id: nxnode-login,v 1.12 2005/03/21 13:00:21 jonno Exp $
 #
 
 # Syntax: nxnode-login {ssh|su} user ssh-port executable command tosend
@@ -23,7 +23,7 @@
 set stty_init "raw icrnl"
 
 if { "$auth_method"=="ssh" } { 
-	set pid [spawn -noecho $command_ssh -2 -l "$user" "127.0.0.1" -o "NumberOfPasswordPrompts 1" -p "$port" "$executable $command" ]
+	set pid [spawn -noecho $command_ssh -2 -x -l "$user" "127.0.0.1" -o "NumberOfPasswordPrompts 1" -p "$port" "$executable $command" ]
 } elseif { "$auth_method"=="su" } {
 	set pid [spawn -noecho su - "$user" -c "$executable $command" ]
 } else {






From kov at sheep.berlios.de  Tue Mar 22 02:54:03 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Tue, 22 Mar 2005 02:54:03 +0100
Subject: [Freenx-cvs] r60 - thinnx/trunk/thinnx
Message-ID: <200503220154.j2M1s3Eb028379@sheep.berlios.de>

Author: kov
Date: 2005-03-22 02:53:41 +0100 (Tue, 22 Mar 2005)
New Revision: 60

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
first try at finishing ssl implementation


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-22 00:30:52 UTC (rev 59)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-22 01:53:41 UTC (rev 60)
@@ -767,6 +767,7 @@
 	}
       else
 	{
+	  flush_buffer (buffer);
 	  message_dialog ("Login ou senha incorretos!");
 	  exit (1);
 	}
@@ -816,7 +817,7 @@
 	g_free (cmdline);
 	cmdline = NULL;
 	
-	drop_lines (out, 3);
+	drop_lines (out, 4);
       }
 
       session_id = get_session_info (out, "NX> 700");
@@ -842,48 +843,50 @@
       /* now prepare to run nxproxy */
       {
 	FILE *options;
-
+		
 	gchar *dirname;
 	gchar *fname;
 	gchar *cmdline;
-
+		
 	dirname = g_strdup_printf ("%s/.nx/S-%s", homedir, session_id);
 	fname = g_strdup_printf ("%s/options", dirname);
-
+		
 	g_print ("Dir: %s\nFname: %s\n", dirname, fname);
-
+		
 	if (mkdir (dirname, 0777) == -1)
 	  {
 	    /* BOMB or handle 'directory already exists' */
 	  }
 	g_free (dirname);
-
+		
 	if (use_ssl)
-	  buffer = g_strdup_printf ("cookie=%s,root=%s/.nx,session=%s,id=%s,listen=20000:%d", pcookie, homedir, session, session_id, 12345); /* last arg should be a free port */
+	  buffer = g_strdup_printf ("cookie=%s,root=%s/.nx,session=%s,id=%s,listen=%d:%s", pcookie, homedir, session, session_id, 8008, session_display);
 	else
 	  buffer = g_strdup_printf ("cookie=%s,root=%s/.nx,session=%s,id=%s,connect=%s:%s", pcookie, homedir, session, session_id, host, session_display);
-
+		
 	options = fopen (fname, "w");
 	fwrite (buffer, sizeof(char), strlen (buffer), options);
 	fclose (options);
-
+		
 	g_free (buffer);
-
+		
 	cmdline = g_strdup_printf (BINDIR"/nxproxy -S options=%s:%s", fname, session_display);
 	system (cmdline);
 	g_free (cmdline);
-
+		
 	g_free (fname);
       }
     }
 
-  write_line (in, "exit");
+  write_line (in, "bye");
   drop_line (out);
+
+  if (use_ssl)
+    write_line (in, "switch");
+
   drop_line (out);
   drop_line (out);
   drop_line (out);
 
-  wait (&pid);
-
   return 0;
 }



From kov at sheep.berlios.de  Tue Mar 22 01:31:21 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Tue, 22 Mar 2005 01:31:21 +0100
Subject: [Freenx-cvs] r59 - thinnx/trunk/thinnx
Message-ID: <200503220031.j2M0VLGk018566@sheep.berlios.de>

Author: kov
Date: 2005-03-22 01:30:52 +0100 (Tue, 22 Mar 2005)
New Revision: 59

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
no need for clear_dialog as we're not using a 'clear' button anymore


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-18 22:09:37 UTC (rev 58)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-22 00:30:52 UTC (rev 59)
@@ -176,11 +176,6 @@
 }
 
 void
-clear_dialog (GtkWidget *w, gpointer data)
-{
-}
-
-void
 input_dialog (gchar **user, gchar **pass)
 {
   GtkWidget *dialog;



From freenx-cvs at berlios.de  Thu Mar 24 02:33:27 2005
From: freenx-cvs at berlios.de (fabianx)
Date: Thu, 24 Mar 2005 02:33:27 +0100
Subject: [Freenx-cvs] CVS: freenx - fabianx modified nxclient
Message-ID: <424218E7.mailHXU1E1JR7@lists.berlios.de>

User:      fabianx
Date:      2005-03-24 01:33:26 GMT
Modified:  .        nxclient
Log:
Added initial support for --printer <printername> to nxclient.

Note: The support is not finished yet as the "Configure" dialog still needs to be created.

Also added some more comments where suitable.

Revision  Changes    Path
1.4       +131 -2    freenx/nxclient


rev 1.4, prev_rev 1.3
Index: nxclient
===================================================================
RCS file: /cvsroot/freenx/freenx/nxclient,v
retrieving revision 1.3
retrieving revision 1.4
diff -u -r1.3 -r1.4
--- nxclient	11 Feb 2005 15:43:33 -0000	1.3
+++ nxclient	24 Mar 2005 01:33:19 -0000	1.4
@@ -9,7 +9,7 @@
 #       but we set it to a "good value" anyway in case 
 #       it does check it someday.
 #
-# CVS: $Id: nxclient,v 1.3 2005/02/11 15:43:33 fabianx Exp $
+# CVS: $Id: nxclient,v 1.4 2005/03/24 01:33:19 fabianx Exp $
 #
 # ========================================================================
 
@@ -19,7 +19,7 @@
 [ -x "$NXCLIENT" -a "$(file -bi $NXCLIENT)" != 'application/x-shellscript' ] \
 	&& exec ${NXCLIENT} "$@"
 
-TEMP=`getopt -a -o d: --long local,noautokill,dialog:,caption:,message:,display: -n $(basename $0) -- "$@"`
+TEMP=`getopt -a -o d: --long local,noautokill,dialog:,caption:,message:,display:,printer: -n $(basename $0) -- "$@"`
 
 if [ $? != 0 ] ; then echo "Terminating..." >&2 ; exit 1 ; fi
 
@@ -31,6 +31,7 @@
 DIALOG_MESSAGE=""
 DIALOG_LOCAL=""
 DIALOG_NOAUTOKILL=""
+DIALOG_PRINTER=""
 
 while true
 do
@@ -41,6 +42,7 @@
 		--local) DIALOG_LOCAL="yes"; shift ;;
 		--noautokill) DIALOG_NOAUTOKILL="yes"; shift ;;
 		--display) DISPLAY="$2"; shift 2 ;;
+		--printer) DIALOG_PRINTER="$2"; shift 2 ; break ;;
 		--) shift ; break ;;
                 *) echo "Internal error!" ; exit 1; ;;
 	esac
@@ -48,6 +50,9 @@
 
 export DISPLAY
 
+# if --printer is set, the dialog type is overridden
+[ -n "$DIALOG_PRINTER" ] && DIALOG_TYPE="printer"
+
 if [ -x /usr/bin/Xdialog ] 
 then
 	dialog_interface="xdialog"
@@ -58,6 +63,62 @@
 	[ -z "$xmessage" ] && xmessage="/usr/X11R6/bin/xmessage"
 fi
 
+#
+# utility functions for all interfaces
+#
+
+# utility_printer "get|set|getlist|getvendlist|getdrvlist"
+#
+#	get <name> - gets the current driver for name
+#	set <name> <driver> <description> - sets the current driver and description for name
+#	getvendlist - gets a list of vendors
+#	getdrvlist <vendor> - gets a list of drivers for vendor
+#	getlist - gets a list of drivers
+
+#
+# drivers.cache has the following format:
+#	
+#	driver|<printername>|<ppdfile>|<description>
+#
+
+#
+# Example: IFS='|' DEFAULT_PRINTER=( $(utility_printer get <myprinter>) )
+# 	  
+#	You can then select ${DEFAULT_PRINTER[1]} for <printername>.
+# 
+
+utility_printer()
+{
+	UTILITY_DRIVERS_CACHE="$HOME/.nx/config/drivers.cache"
+	[ -n "$USER_FAKE_HOME" ] && UTILITY_DRIVERS_CACHE="$USER_FAKE_HOME/.nx/config/drivers.cache"
+	UTILITY_NXPRINT="nxprint"
+	[ -n "$PATH_BIN" ] && UTILITY_NXPRINT="$PATH_BIN/nxprint"
+	case "$1" in 
+		get)
+			grep "driver|$2|" "$UTILITY_DRIVERS_CACHE" 2>/dev/null
+		;;
+		set)
+			# FIXME: Handle possible race conditions?
+			grep -v "driver|$2|" "$UTILITY_DRIVERS_CACHE" 2>/dev/null > $UTILITY_DRIVERS_CACHE.tmp
+			echo "driver|$2|$3|$4" >> $UTILITY_DRIVERS_CACHE.tmp
+			mv -f $UTILITY_DRIVERS_CACHE.tmp $UTILITY_DRIVERS_CACHE
+		;;
+		getvendlist)
+			$UTILITY_NXPRINT -d | awk -F'|' '{ print $2 }' | uniq
+		;;
+		getdrvlist)
+			$UTILITY_NXPRINT -d | awk -F'|' '($2=="'$2'") { print $4 }'
+		;;
+		getlist)
+			$UTILITY_NXPRINT -d
+		;;
+	esac
+}
+
+#
+# xmessage dialog interface
+#
+
 xmessage_ok()
 {
 	$xmessage -buttons "Ok:0" -center "$DIALOG_MESSAGE"
@@ -85,6 +146,20 @@
 	return 0 # Give cancel on close ...
 }
 
+xmessage_printer_ask()
+{
+	$xmessage -buttons "Ok:0,Configure:1,Cancel:2" -center "$DIALOG_MESSAGE"
+}
+
+xmessage_printer()
+{
+	:
+}
+
+#
+# xdialog interface
+#
+
 xdialog_ok()
 {
 	$DIALOG --title "$DIALOG_CAPTION" --msgbox "$DIALOG_MESSAGE" 0 0
@@ -121,6 +196,54 @@
         return 0 # Give cancel on close ...
 }
 
+xdialog_printer_ask()
+{
+		$DIALOG --title "$DIALOG_CAPTION" --buttons-style text --ok-label "Ok" --cancel-label "Configure" --yesno "$DIALOG_MESSAGE\n\nClose window to cancel." 400x250
+	RC=$?
+	[ $RC -eq 255 ] && return 2
+	return $RC
+}
+
+xdialog_printer()
+{
+	:
+}
+
+#
+# helper functions
+#
+
+helper_dialog_printer()
+{
+	IFS="|" PRINTER_INFORMATION=( $(utility_printer get "$DIALOG_PRINTER") )
+	PRINTER_CONFIGURE="yes"
+	[ -z "$DIALOG_CAPTION" ] && DIALOG_CAPTION="NX Printer configuration for $DIALOG_PRINTER"
+	
+	# Do we have old printer information present?
+	if [ -n "$PRINTER_INFORMATION" ]
+	then
+		DIALOG_MESSAGE=$(echo -e "Found driver for printer $DIALOG_PRINTER.\n\nOld choice was: ${PRINTER_INFORMATION[3]}.\n\nIf you want to keep the settings click on 'Ok' \n- else click on 'Configure'.") ${dialog_interface}_printer_ask
+		RC=$?
+		# bail out with exit code 2 in case the user cancelled the operation
+		[ $RC -eq 2 ] && exit 2
+		[ $RC -eq 0 ] && PRINTER_CONFIGURE="no"
+	fi
+
+	if [ "$PRINTER_CONFIGURE" = "yes" ]
+	then
+		DIALOG_MESSAGE="Not implemented." ${dialog_interface}_ok
+	fi
+
+	# echo the choosen <ppdfile> to stdout
+	echo "${PRINTER_INFORMATION[2]}"
+			
+	exit 0
+}
+
+#
+# main case statement
+#
+
 case $DIALOG_TYPE in 
 	ok)
 		${dialog_interface}_ok
@@ -137,9 +260,15 @@
 	quit)
 		${dialog_interface}_quit
 	;;
+	printer)
+		helper_dialog_printer
+	;;
 esac
 
+#
 # Time for exit code checks :)
+#
+
 RC=$?
 	[ $RC -eq 2 ] && kill -TERM $PPID
 	[ $RC -eq 3 ] && kill -HUP $PPID






From kov at sheep.berlios.de  Thu Mar 31 03:12:43 2005
From: kov at sheep.berlios.de (Gustavo Noronha Silva at BerliOS)
Date: Thu, 31 Mar 2005 03:12:43 +0200
Subject: [Freenx-cvs] r61 - thinnx/trunk/thinnx
Message-ID: <200503310112.j2V1ChFL028810@sheep.berlios.de>

Author: kov
Date: 2005-03-31 03:12:31 +0200 (Thu, 31 Mar 2005)
New Revision: 61

Modified:
   thinnx/trunk/thinnx/thinnx.c
Log:
try to avoid segfault when xauth list returns nothing useful


Modified: thinnx/trunk/thinnx/thinnx.c
===================================================================
--- thinnx/trunk/thinnx/thinnx.c	2005-03-22 01:53:41 UTC (rev 60)
+++ thinnx/trunk/thinnx/thinnx.c	2005-03-31 01:12:31 UTC (rev 61)
@@ -475,6 +475,13 @@
     pclose (xauth_output);
     g_free (tmp);
 
+    if (!strcmp (xauth, ""))
+      {
+	message_dialog ("N?o foi poss?vel obter um cookie de autentica??o\n"
+			"do servidor X. Imposs?vel continuar.");
+	exit (1);
+      }
+
     cookie = g_strdup (xauth);
   }
 



From freenx-cvs at berlios.de  Thu Mar 31 09:40:11 2005
From: freenx-cvs at berlios.de (fux)
Date: Thu, 31 Mar 2005 09:40:11 +0200
Subject: [Freenx-cvs] CVS: freenx - fux modified nxsetup
Message-ID: <424BA95B.mailID1CW2WH@lists.berlios.de>

User:      fux
Date:      2005-03-31 07:40:11 GMT
Modified:  .        nxsetup
Log:
enshured correct permission on $SSH_AUTHORIZED_KEYS

Revision  Changes    Path
1.21      +2 -1      freenx/nxsetup


rev 1.21, prev_rev 1.20
Index: nxsetup
===================================================================
RCS file: /cvsroot/freenx/freenx/nxsetup,v
retrieving revision 1.20
retrieving revision 1.21
diff -u -r1.20 -r1.21
--- nxsetup	17 Mar 2005 23:21:15 -0000	1.20
+++ nxsetup	31 Mar 2005 07:40:11 -0000	1.21
@@ -5,7 +5,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxsetup,v 1.20 2005/03/17 23:21:15 fux Exp $ 
+# CVS: $Id: nxsetup,v 1.21 2005/03/31 07:40:11 fux Exp $ 
 #
 
 HELP="no"
@@ -177,6 +177,7 @@
 	chown -R nx:root $NX_ETC_DIR
 	chown -R nx:root $NX_HOME_DIR
 	chown nx:root "$NX_LOGFILE"
+	chmod 600 $NX_HOME_DIR/.ssh/$SSH_AUTHORIZED_KEYS
 	echo "done"
 }
 






From freenx-cvs at berlios.de  Thu Mar 31 10:17:57 2005
From: freenx-cvs at berlios.de (fux)
Date: Thu, 31 Mar 2005 10:17:57 +0200
Subject: [Freenx-cvs] CVS: freenx - fux modified 2 files
Message-ID: <424BB235.mail1O81TM3J0@lists.berlios.de>

User:      fux
Date:      2005-03-31 08:17:56 GMT
Modified:  .        ChangeLog nxsetup
Log:
Added "--ssh2" cmdline switch for commercial ssh2-server support in nxsetup

Revision  Changes    Path
1.44      +1 -0      freenx/ChangeLog


rev 1.44, prev_rev 1.43
Index: ChangeLog
===================================================================
RCS file: /cvsroot/freenx/freenx/ChangeLog,v
retrieving revision 1.43
retrieving revision 1.44
diff -u -r1.43 -r1.44
--- ChangeLog	17 Mar 2005 23:21:14 -0000	1.43
+++ ChangeLog	31 Mar 2005 08:17:56 -0000	1.44
@@ -20,6 +20,7 @@
 	* Fixed nxviewer commandline for geometry and fullscreen-support
 	* Added NX_LOG_LEVEL instead of NX_LOGGING, allowing less verbose logfile.
 	* Added SESSION_LOG_CLEAN for configurable removal of the temporary session directory.
+	* Added "--ssh2" cmdline switch for commercial ssh2-server support in nxsetup
 
 XX.03.2005 FreeNX 0.3.1-CVS
 	* Fixed keyboard mapping problems.



1.22      +36 -1     freenx/nxsetup


rev 1.22, prev_rev 1.21
Index: nxsetup
===================================================================
RCS file: /cvsroot/freenx/freenx/nxsetup,v
retrieving revision 1.21
retrieving revision 1.22
diff -u -r1.21 -r1.22
--- nxsetup	31 Mar 2005 07:40:11 -0000	1.21
+++ nxsetup	31 Mar 2005 08:17:56 -0000	1.22
@@ -5,7 +5,7 @@
 #
 # License: GNU GPL, version 2
 #
-# CVS: $Id: nxsetup,v 1.21 2005/03/31 07:40:11 fux Exp $ 
+# CVS: $Id: nxsetup,v 1.22 2005/03/31 08:17:56 fux Exp $ 
 #
 
 HELP="no"
@@ -15,6 +15,7 @@
 CLEAN="no"
 UNINSTALL="no"
 PURGE="no"
+SETUP_SSH2_KEY="no"
 
 while [ "$1" ]
 do
@@ -22,6 +23,7 @@
 		--help) HELP="yes"; shift ;;
 		--install) INSTALL="yes"; shift ;;
 		--setup-nomachine-key) SETUP_NOMACHINE_KEY="yes"; shift ;;
+		--ssh2) SETUP_SSH2_KEY="yes"; shift;;
 		--uid) SETUP_UID=$2; shift 2 ;;
 		--clean) CLEAN="yes"; shift ;;
 		--uninstall) UNINSTALL="yes"; shift ;;
@@ -37,6 +39,7 @@
 [ "$INSTALL" = "yes" -a "$CLEAN" = "no" -a "$PURGE" = "yes" ] && HELP="yes"
 [ "$UNINSTALL" = "yes" ] && [ "$SETUP_NOMACHINE_KEY" = "yes" -o -n "$SETUP_UID" -o "$CLEAN" = "yes" ] && HELP="yes"
 [ "$UNINSTALL" = "yes" -a "$CLEAN" = "yes" ] && HELP="yes"
+[ "$SETUP_SSH2_KEY" = "yes" -a "$SETUP_NOMACHINE_KEY" = "no" ] && HELP=yes"
 
 if [ "$HELP" = "yes" ]
 then
@@ -51,6 +54,8 @@
 	echo "                         client. This is not as secure, but it simplifies the "
 	echo "                         configuration of clients."
 	echo "                         Use this option at your own risk."
+	echo "  --ssh2		       additionally create commercial pubkey-support, beware"
+	echo "			       own _commercial_ ssh2-key is not supported!."
 	echo "  --uid <number>         The nx user will be given the uid <number>."
 	echo "  --clean                Performs an uninstall prior to the installation"
 	echo "  --uninstall            Remove log and session files, as well as the nx user"
@@ -162,6 +167,36 @@
 			# generate a new key, backup the old and copy it to $SSH_AUTHORIZED_KEYS
 			$PATH_BIN/nxkeygen
 		fi
+	fi
+
+	# commercial ssh2-server uses other authentification-files
+	# as they are more or less static, I don't integrated these variable
+	# in node.conf, you have to change them here, if you like
+	SSH2_AUTHORIZATION="authorization"
+	SSH2_PUBKEY="nx_user.id.pub"
+	SSH2_HOME_DIR="$NX_HOME_DIR/.ssh2"
+	if [ ! -f "${SSH2_HOME_DIR}/$SSH2_PUBKEY" -a "$SETUP_SSH2_KEY" = "yes" -a "$SETUP_NOMACHINE_KEY" = "yes" ]
+	then
+		mkdir -p $SSH2_HOME_DIR
+		chmod 700 $SSH2_HOME_DIR
+		
+		cat >  ${SSH2_HOME_DIR}/$SSH2_PUBKEY <<EOF
+---- BEGIN SSH2 PUBLIC KEY ----
+Comment: "1024-bit DSA, converted from OpenSSH by root at localhost"
+AAAAB3NzaC1kc3MAAACBAJe/0DNBePG9dYLWq7cJ0SqyRf1iiZN/IbzrmBvgPTZnBa5FT/
+0Lcj39sRYt1paAlhchwUmwwIiSZaON5JnJOZ6jKkjWIuJ9MdTGfdvtY1aLwDMpxUVoGwEa
+KWOyin02IPWYSkDQb6cceuG9NfPulS9iuytdx0zIzqvGqfvudtufAAAAFQCwosRXR2QA8O
+SgFWSO6+kGrRJKiwAAAIEAjgvVNAYWSrnFD+cghyJbyx60AAjKtxZ0r/Pn9k94Qt2rvQoM
+nGgt/zU0v/y4hzg+g3JNEmO1PdHh/wDPVOxlZ6Hb5F4IQnENaAZ9uTZiFGqhBO1c8Wwjiq
+/MFZy3jZaidarLJvVs8EeT4mZcWxwm7nIVD4lRU2wQ2lj4aTPcepMAAACANlgcCuA4wrC+
+3Cic9CFkqiwO/Rn1vk8dvGuEQqFJ6f6LVfPfRTfaQU7TGVLk2CzY4dasrwxJ1f6FsT8DHT
+NGnxELPKRuLstGrFY/PR7KeafeFZDf+fJ3mbX5nxrld3wi5titTnX+8s4IKv29HJguPvOK
+/SI7cjzA+SqNfD7qEo8=
+---- END SSH2 PUBLIC KEY ----
+EOF
+		echo "Key $SSH2_PUBKEY" >> ${SSH2_HOME_DIR}/$SSH2_AUTHORIZATION
+		echo "Options no-port-forwarding,no-x11-forwarding,no-agent-forwarding,command=\"$PATH_BIN/nxserver\"" >> ${SSH2_HOME_DIR}/$SSH2_AUTHORIZATION
+		chmod 600 ${SSH2_HOME_DIR}/$SSH2_AUTHORIZATION ${SSH2_HOME_DIR}/$SSH2_PUBKEY
 	fi
 	
 	if [ ! -f $NX_HOME_DIR/.ssh/known_hosts ]






